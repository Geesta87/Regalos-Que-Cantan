<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" name="viewport"/>
    <title>Dogfathers Plus - Premium Mobile Dog Grooming</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Premium mobile dog grooming service - we come to you! Book appointments, earn rewards, and keep your furry friends looking their best.">
    <meta name="application-name" content="Dogfathers Plus">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Dogfathers Plus">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#13a4ec" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0d1117" media="(prefers-color-scheme: dark)">
    <meta name="msapplication-TileColor" content="#13a4ec">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%2313a4ec' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3EðŸ•%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%2313a4ec' width='180' height='180' rx='40'/%3E%3Ctext x='90' y='125' font-size='100' text-anchor='middle' fill='white'%3EðŸ•%3C/text%3E%3C/svg%3E">
    
    <!-- Preconnect for performance -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        "primary": "#13a4ec",
                        "admin-primary": "#c9a962",
                        "admin-accent": "#2a9d8f",
                        "admin-bg": "#f8f6f3",
                        "admin-sidebar": "#fdfcfa",
                        "background-light": "#f6f7f8",
                        "background-dark": "#0d1117",
                        "surface-light": "#ffffff",
                        "surface-dark": "#161b22",
                        "text-main-light": "#0d171b",
                        "text-main-dark": "#f0f6fc",
                        "text-sub-light": "#4c809a",
                        "text-sub-dark": "#8b949e",
                        "border-light": "#cfdfe7",
                        "border-dark": "#30363d",
                        // Groomer Tech Purple Theme
                        "groomer-primary": "#2a7a77",
                        "tech-purple": "#8b5cf6",
                        "tech-magenta": "#d946ef",
                        "groomer-bg": "#f9f7f6",
                        "groomer-dark": "#1a1d23",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400; }
        .fill-1 { font-variation-settings: 'FILL' 1; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* Toast animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast-enter { animation: slideIn 0.3s ease-out; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        /* Loading spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        /* Dark mode transitions */
        * { transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
        /* Better touch targets */
        .touch-target { min-height: 44px; min-width: 44px; }
        
        /* Groomer Portal Glass & Gradient Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .dark .glass-card {
            background: rgba(42, 47, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .groomer-gradient-bg {
            background-color: #f9f7f6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(139, 92, 246, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(217, 70, 239, 0.1) 0px, transparent 50%),
                radial-gradient(at 50% 50%, rgba(42, 122, 119, 0.05) 0px, transparent 50%);
        }
        .dark .groomer-gradient-bg {
            background-color: #1a1d23;
            background-image: 
                radial-gradient(at 0% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(217, 70, 239, 0.12) 0px, transparent 50%);
        }
        .soft-lift {
            box-shadow: 0 8px 24px -8px rgba(139, 92, 246, 0.15);
            transition: all 0.3s ease;
        }
        .soft-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px -6px rgba(139, 92, 246, 0.22);
        }
        
        /* Mobile Modal Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes scaleUp {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-scale-up { animation: scaleUp 0.2s ease-out; }
        
        /* Mobile Touch Feedback */
        @media (hover: none) {
            .soft-lift:hover { transform: none; }
            .soft-lift:active { transform: scale(0.98); }
        }
        
        /* PWA & Mobile Optimizations */
        html, body { 
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
            -webkit-touch-callout: none; /* Disable callout on long press */
        }
        
        /* Safe area insets for notched devices */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-left { padding-left: env(safe-area-inset-left); }
        .safe-right { padding-right: env(safe-area-inset-right); }
        
        /* PWA standalone mode adjustments */
        @media (display-mode: standalone) {
            .pwa-hide { display: none !important; }
            body { padding-top: env(safe-area-inset-top); }
        }
        
        /* Prevent text selection on UI elements */
        button, .no-select { 
            -webkit-user-select: none; 
            user-select: none; 
        }
        
        /* Smooth scrolling for iOS */
        .scroll-smooth { 
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth;
        }
        
        /* Active state for touch feedback */
        button:active, .touch-active:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        /* Fix for iOS input zoom */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Pull to refresh indicator (optional) */
        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            transition: transform 0.2s;
            z-index: 9999;
        }
        .pull-indicator.visible {
            transform: translateX(-50%) translateY(20px);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-main-light dark:text-text-main-dark min-h-screen">
    <div id="app"></div>
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 safe-right"></div>
    <div id="confirm-modal"></div>
    <div id="loading-overlay" class="hidden fixed inset-0 z-[200] bg-black/50 flex items-center justify-center">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-8 flex flex-col items-center gap-4 shadow-2xl">
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full spinner"></div>
            <p class="text-sm font-medium text-text-sub-light dark:text-text-sub-dark">Loading...</p>
        </div>
    </div>
    <script>
        // =============================================
        // SUPABASE CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://cxtxkyitvybmyflsjexr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4dHhreWl0dnlibXlmbHNqZXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzEwMzcsImV4cCI6MjA4MTg0NzAzN30.wNt6chJJxCXsvNZxIVhPDeqllj4U3J7aQP2udxfbqBY';
        
        let supabaseClient = null;
        
        // Initialize Supabase client
        function initSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase client created');
                    return true;
                } else {
                    console.error('Supabase library not loaded');
                    return false;
                }
            } catch (e) {
                console.error('Failed to create Supabase client:', e);
                return false;
            }
        }
        
        // Try to initialize Supabase
        initSupabase();

        // Function to update Supabase config
        function updateSupabaseConfig(url, key) {
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            location.reload();
        }

        // Show config modal if key seems invalid
        function showConfigModal() {
            const modal = document.createElement('div');
            modal.id = 'config-modal';
            modal.className = 'fixed inset-0 z-[300] bg-black/70 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Configure Supabase</h2>
                    <p class="text-slate-600 mb-6">Enter your Supabase credentials from Dashboard > Settings > API</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Project URL</label>
                            <input type="url" id="config-url" value="${SUPABASE_URL}" placeholder="https://xxxxx.supabase.co" 
                                class="w-full h-12 px-4 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Anon Public Key</label>
                            <input type="text" id="config-key" value="${SUPABASE_ANON_KEY.includes('placeholder') ? '' : SUPABASE_ANON_KEY}" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." 
                                class="w-full h-12 px-4 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary outline-none font-mono text-xs">
                        </div>
                        <button onclick="saveConfig()" class="w-full h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors mt-4">
                            Save & Reload
                        </button>
                        <button onclick="document.getElementById('config-modal').remove()" class="w-full h-10 text-slate-500 hover:text-slate-700 font-medium">
                            Skip (Use Demo Mode)
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveConfig() {
            const url = document.getElementById('config-url').value.trim();
            const key = document.getElementById('config-key').value.trim();
            if (url && key) {
                updateSupabaseConfig(url, key);
            }
        }

        // =============================================
        // STATE MANAGEMENT
        // =============================================
        let state = { 
            currentUser: null,
            session: null,
            currentTab: 'dashboard', 
            authTab: 'login', 
            showMobileMenu: false, 
            showBookingModal: false,
            bookingPreselect: null, // { petId, serviceId, serviceName } for pre-selecting options 
            storeCategory: 'all',
            darkMode: localStorage.getItem('darkMode') === 'true',
            rememberMe: localStorage.getItem('rememberMe') === 'true',
            showPassword: false,
            isLoading: false,
            confirmDialog: null,
            // PWA
            showInstallPrompt: false,
            isPWA: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true,
            // Onboarding
            showOnboarding: false,
            onboardingStep: 1,
            showAdminLogin: false,
            // Edit Modals
            editModal: null, // { type: 'pet'|'appointment'|'product'|'reward'|'profile', data: {...} }
            groomingServiceModal: null, // Modal for adding/editing grooming services
            editItems: {}, // Temporary storage for items to edit
            onboardingData: {
                address: '',
                city: '',
                state: 'CA',
                zip: '',
                petName: '',
                petBreed: '',
                petBreedOther: '',
                petWeight: '',
                petGender: 'male',
                petBirthMonth: '',
                petBirthYear: '',
                petPhoto: '',
                petNotes: ''
            },
            // Data from Supabase
            services: [],
            products: [],
            rewards: [],
            pets: [],
            appointments: [],
            rideAlongPackages: [],
            businessHours: [],
            allAppointments: [], // For admin
            allCustomers: [], // For admin
            rideAlongInquiries: [], // For admin - customer inquiries
            rewardRedemptions: [], // For admin - redemption history
            // Groomer system
            groomers: [], // List of users with role='groomer' (for admin)
            groomerAppointments: [], // Appointments assigned to logged-in groomer
            showGroomerLogin: false, // Toggle groomer login page
            // Groomer management modals
            showAddGroomerModal: false,
            showEditGroomerModal: false,
            showGroomerScheduleModal: false,
            editingGroomer: null, // Groomer being edited
            viewingGroomerSchedule: null, // Groomer whose schedule is being viewed
            adminScheduleMonth: null, // Current month being viewed in admin groomer schedule (0-11)
            adminScheduleYear: null, // Current year being viewed in admin groomer schedule
            adminScheduleSelectedDate: null, // Selected date in admin groomer schedule
            // Admin Services/Products sub-tab
            adminServicesSubTab: 'grooming', // 'grooming' | 'products' | 'ridealongs' | 'education'
            // Admin Loyalty sub-tab
            loyaltySubTab: 'rewards', // 'rewards' | 'redemptions' | 'customers'
            // Dashboard filters
            dashboardScheduleFilter: 'all', // 'all' | 'confirmed' | 'pending' | 'in_progress'
            dashboardScheduleView: 'day', // 'day' | 'week' | 'month'
            groomerFilter: 'active', // 'all' | 'active' | 'inactive'
            productFilter: 'all', // 'all' | 'active' | 'inactive'
            // Appointments tab filters
            appointmentSearchQuery: '',
            appointmentStatusFilter: '',
            appointmentPage: 1,
            filteredAppointmentsCount: 0,
            // Quick View Modal
            quickViewAppointment: null,
            // Customer tab
            customerSearchQuery: '',
            customerSort: 'name', // 'name' | 'points' | 'recent'
            customerPage: 1,
            customerDetailModal: null,
            // Password Reset
            showForgotPassword: false,
            showResetPassword: false, // For setting new password after email link
            showChangePassword: false, // For logged-in users changing password
            forgotPasswordEmail: '',
            resetPasswordToken: null,
            // Smart Location Booking
            smartBookingData: null, // { recommended, goodOptions, available, customerCoords }
            selectedBookingDate: null, // Currently selected date from smart picker
            customerBookingCoords: null, // Geocoded customer address for booking
            // Phase 1: Data Integrity Modals
            petDeletionBlocked: null, // { petId, petName, appointments[] } - when pet has active appointments
            cancelAppointmentModal: null, // { appointmentId, reason } - cancel with reason capture
            groomerDeactivationBlocked: null, // { groomerId, groomerName, appointments[] } - when groomer has assignments
            // Phase 2: Notifications
            notifications: [],
            unreadNotifications: 0,
            showNotifications: false,
            // Phase 2: Groomer Availability
            groomerAvailability: [], // Current groomer's weekly schedule
            groomerTimeOffRequests: [], // Current groomer's time off requests
            pendingTimeOffRequests: [], // For admin - pending requests to review
            showTimeOffModal: false,
            // Phase 2: Redemption Fulfillment
            pendingRedemptions: [], // For admin - redemptions to fulfill
            showRedemptionModal: null, // { redemption, action: 'fulfill' | 'cancel' }
            // Phase 2: Groomer Portal Enhancements
            groomerTab: 'dashboard', // 'dashboard' | 'schedule' | 'messages'
            // Groomer completion modal
            showCompleteAppointmentModal: false,
            completingAppointmentId: null,
            completingAppointmentData: null,
            groomerMessages: [], // Messages for groomer
            unreadGroomerMessages: 0,
            activeConversation: null, // Current conversation ID
            // Phase 2: Admin Messages
            adminMessages: [], // Messages for admin
            adminActiveConversation: null,
            // Phase 3: Groomer Schedule Calendar
            scheduleViewMode: 'monthly', // 'today' | 'weekly' | 'monthly'
            selectedCalendarDate: null, // Currently selected date (YYYY-MM-DD)
            calendarStartDate: null, // Start of visible calendar range
            showDayPanel: false, // Is day detail panel open
            selectedAppointment: null, // Full appointment detail view
            showAppointmentDetail: false, // Is appointment detail modal open
            // Phase 4: Admin Appointment Creation
            showAdminAddAppointment: false, // Show add appointment modal
            adminAppointmentStep: 1, // 1=customer, 2=pet, 3=appointment
            adminCustomerSearch: '', // Search query for customer
            adminCustomerSearchResults: [], // Search results
            adminSelectedCustomer: null, // Selected/created customer
            adminSelectedPet: null, // Selected/created pet
            adminNewCustomer: null, // New customer being created inline
            adminNewPet: null, // New pet being created inline
            // Phase 5: Photo Capture
            showBeforePhotoModal: false, // Show before photo capture modal
            beforePhotoAppointmentId: null, // Appointment ID for before photo
            beforePhotoAppointmentData: null, // Appointment data for before photo modal
            capturedBeforePhoto: null, // Base64 captured before photo
            capturedAfterPhoto: null, // Base64 captured after photo
            photoUploadProgress: 0, // Upload progress percentage
            // Phase 6: Pet Profile Quick View
            showPetProfile: false, // Show pet profile modal
            selectedPetProfile: null, // Selected pet data for profile view
            petAppointmentHistory: [], // Appointment history for selected pet
            // Phase 7: Quick Text Templates
            showQuickTemplates: false, // Show quick templates picker
            mobileTab: null, // Mobile tab state for dashboard
            showMobileMenu: false, // Mobile menu state
            showQuickActions: false, // Quick actions menu state
            // Phase 8: History Tab
            historyFilter: 'all', // 'all' | 'completed' | 'cancelled' | 'upcoming'
            historySearch: '', // Search query for history
            historyDateRange: 'all' // 'all' | 'week' | 'month' | 'custom'
        };

        // Initialize dark mode
        if (state.darkMode) document.documentElement.classList.add('dark');

        const LOGO_MAIN = 'https://storage.googleapis.com/msgsndr/5ZO7GDI0tRsPLerwiyMJ/media/69471b85aca6ab5d44c15e0b.jpg';
        const LOGO_ACADEMY = 'https://storage.googleapis.com/msgsndr/5ZO7GDI0tRsPLerwiyMJ/media/6830663caca6ab25bac0a498.png';
        
        // =============================================
        // TIME FORMATTING - PACIFIC TIME (LOS ANGELES)
        // =============================================
        const TIMEZONE = 'America/Los_Angeles';
        
        // Format time string (HH:MM:SS or HH:MM) to 12-hour format in Pacific Time
        function formatTime(timeStr) {
            if (!timeStr) return 'TBD';
            // If it's already a simple time like "09:00" or "09:00:00", convert to 12-hour
            const timeParts = timeStr.split(':');
            if (timeParts.length >= 2) {
                let hours = parseInt(timeParts[0], 10);
                const minutes = timeParts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                return `${hours}:${minutes} ${ampm}`;
            }
            return timeStr;
        }
        
        // Format date string (YYYY-MM-DD) to readable format
        function formatDate(dateStr, options = { weekday: 'short', month: 'short', day: 'numeric' }) {
            if (!dateStr) return 'TBD';
            // Parse date in local timezone to avoid off-by-one errors
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', options);
        }
        
        // Format date and time together
        function formatDateTime(dateStr, timeStr) {
            return `${formatDate(dateStr)} at ${formatTime(timeStr)}`;
        }
        
        // Get today's date in YYYY-MM-DD format (Pacific Time)
        function getTodayPacific() {
            return new Date().toLocaleDateString('en-CA', { timeZone: TIMEZONE });
        }
        
        // Get current time in Pacific timezone as HH:MM string
        function getCurrentTimePacific() {
            return new Date().toLocaleTimeString('en-US', { 
                timeZone: TIMEZONE,
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }
        
        // Get current hour in Pacific timezone (0-23)
        function getCurrentHourPacific() {
            const timeStr = new Date().toLocaleTimeString('en-US', { 
                timeZone: TIMEZONE,
                hour: '2-digit', 
                hour12: false 
            });
            return parseInt(timeStr);
        }
        
        // Get a Date object adjusted for Pacific timezone calculations
        function getNowPacific() {
            // Create a date string in Pacific time, then parse it
            const pacificDateStr = new Date().toLocaleString('en-US', { timeZone: TIMEZONE });
            return new Date(pacificDateStr);
        }
        
        // Check if a date string is today (Pacific Time)
        function isToday(dateStr) {
            return dateStr === getTodayPacific();
        }
        
        // Format timestamp to readable time
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                timeZone: TIMEZONE,
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        
        // Show service description when dropdown changes (Recommendation #3)
        function showServiceDescription(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const description = selectedOption?.dataset?.description || 'Complete grooming service tailored to your pet\'s needs.';
            const descBox = document.getElementById('service-desc-text');
            if (descBox) {
                descBox.textContent = description;
            }
        }

        // =============================================
        // CALENDAR HELPER FUNCTIONS
        // =============================================
        
        // Get start of week (Monday) for a given date
        function getWeekStart(dateStr) {
            const date = dateStr ? new Date(dateStr + 'T12:00:00') : new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
            const monday = new Date(date.setDate(diff));
            return monday.toISOString().split('T')[0];
        }
        
        // Get array of 7 dates for a week starting from given date
        function getWeekDates(startDateStr) {
            const dates = [];
            const startDate = new Date(startDateStr + 'T12:00:00');
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        // Get array of dates for a month grid (includes padding days)
        function getMonthDates(year, month) {
            const dates = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Get the Monday before or on the first day
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Monday-based
            
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDay);
            
            // Generate 6 weeks (42 days) to cover all possibilities
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push({
                    dateStr: date.toISOString().split('T')[0],
                    isCurrentMonth: date.getMonth() === month,
                    isToday: date.toISOString().split('T')[0] === getTodayPacific()
                });
            }
            return dates;
        }
        
        // Get appointments for a specific date
        function getAppointmentsForDate(dateStr) {
            const appointments = state.groomerAppointments || [];
            return appointments.filter(a => a.appointment_date === dateStr)
                .sort((a, b) => (a.start_time || '').localeCompare(b.start_time || ''));
        }
        
        // Get appointment counts grouped by date
        function getAppointmentCountsByDate() {
            const appointments = state.groomerAppointments || [];
            const counts = {};
            appointments.forEach(a => {
                if (a.appointment_date && a.status !== 'cancelled') {
                    counts[a.appointment_date] = (counts[a.appointment_date] || 0) + 1;
                }
            });
            return counts;
        }
        
        // Navigate calendar
        function goToPreviousWeek() {
            const current = state.calendarStartDate || getWeekStart(getTodayPacific());
            const date = new Date(current + 'T12:00:00');
            date.setDate(date.getDate() - 7);
            state.calendarStartDate = date.toISOString().split('T')[0];
            state.selectedCalendarDate = null;
            state.showDayPanel = false;
            render();
        }
        
        function goToNextWeek() {
            const current = state.calendarStartDate || getWeekStart(getTodayPacific());
            const date = new Date(current + 'T12:00:00');
            date.setDate(date.getDate() + 7);
            state.calendarStartDate = date.toISOString().split('T')[0];
            state.selectedCalendarDate = null;
            state.showDayPanel = false;
            render();
        }
        
        function goToCalendarToday() {
            state.calendarStartDate = getWeekStart(getTodayPacific());
            state.selectedCalendarDate = getTodayPacific();
            state.showDayPanel = true;
            render();
        }
        
        function selectCalendarDate(dateStr) {
            state.selectedCalendarDate = dateStr;
            state.showDayPanel = true;
            state.selectedAppointment = null;
            state.showAppointmentDetail = false;
            render();
        }
        
        function closeDayPanel() {
            state.showDayPanel = false;
            state.selectedCalendarDate = null;
            state.selectedAppointment = null;
            state.showAppointmentDetail = false;
            render();
        }
        
        function openAppointmentDetail(appointmentId) {
            const appointments = state.groomerAppointments || [];
            state.selectedAppointment = appointments.find(a => a.id === appointmentId);
            state.showAppointmentDetail = true;
            render();
        }
        
        function closeAppointmentDetail() {
            state.selectedAppointment = null;
            state.showAppointmentDetail = false;
            render();
        }
        
        // Get week range label (e.g., "Jan 20 - 26, 2025")
        function getWeekRangeLabel(startDateStr) {
            const start = new Date(startDateStr + 'T12:00:00');
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            
            const startMonth = start.toLocaleDateString('en-US', { month: 'short' });
            const endMonth = end.toLocaleDateString('en-US', { month: 'short' });
            const startDay = start.getDate();
            const endDay = end.getDate();
            const year = end.getFullYear();
            
            if (startMonth === endMonth) {
                return `${startMonth} ${startDay} - ${endDay}, ${year}`;
            } else {
                return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
            }
        }

        // Predefined groomer specialties
        const GROOMER_SPECIALTIES = [
            { id: 'large_dogs', label: 'Large Dogs (50+ lbs)', icon: 'ðŸ•' },
            { id: 'small_breeds', label: 'Small Breeds (under 25 lbs)', icon: 'ðŸ©' },
            { id: 'anxious_pets', label: 'Anxious/Nervous Pets', icon: 'ðŸ˜°' },
            { id: 'puppies', label: 'Puppies (under 1 year)', icon: 'ðŸ¶' },
            { id: 'senior_dogs', label: 'Senior Dogs (7+ years)', icon: 'ðŸ¦®' },
            { id: 'dematting', label: 'Dematting & Tangles', icon: 'âœ‚ï¸' },
            { id: 'breed_cuts', label: 'Breed-Specific Cuts', icon: 'ðŸ’‡' },
            { id: 'cats', label: 'Cats', icon: 'ðŸ±' }
        ];

        // =============================================
        // SMART LOCATION-BASED BOOKING SYSTEM
        // =============================================
        
        // Default travel fee tiers (will be loaded from database)
        let travelFeeTiers = [
            { tier_order: 1, min_distance_miles: 0, max_distance_miles: 5, fee_amount: 0, label: 'In Your Area', color_class: 'text-emerald-600', icon: 'star' },
            { tier_order: 2, min_distance_miles: 5, max_distance_miles: 10, fee_amount: 10, label: 'Nearby', color_class: 'text-blue-600', icon: 'near_me' },
            { tier_order: 3, min_distance_miles: 10, max_distance_miles: 15, fee_amount: 20, label: 'Moderate Distance', color_class: 'text-amber-600', icon: 'directions_car' },
            { tier_order: 4, min_distance_miles: 15, max_distance_miles: 25, fee_amount: 35, label: 'Extended Area', color_class: 'text-orange-600', icon: 'route' },
            { tier_order: 5, min_distance_miles: 25, max_distance_miles: 999, fee_amount: -1, label: 'Outside Service Area', color_class: 'text-red-600', icon: 'wrong_location' }
        ];
        
        // Business home base (default - will be loaded from settings)
        let businessHomeBase = { latitude: 34.2381, longitude: -118.5365, address: 'Northridge, CA' };
        let smartBookingSettings = { enabled: true, max_service_radius_miles: 25 };
        
        // Cache for geocoded addresses
        const geocodeCache = new Map();
        
        // Load smart booking settings from database
        async function loadSmartBookingSettings() {
            try {
                // Load travel fee tiers
                const { data: tiers, error: tiersError } = await supabaseClient
                    .from('travel_fee_tiers')
                    .select('*')
                    .eq('is_active', true)
                    .order('tier_order');
                
                if (!tiersError && tiers && tiers.length > 0) {
                    travelFeeTiers = tiers;
                    console.log('Loaded travel fee tiers:', tiers.length);
                }
                
                // Load business settings
                const { data: settings, error: settingsError } = await supabaseClient
                    .from('business_settings')
                    .select('*')
                    .eq('setting_key', 'smart_booking')
                    .single();
                
                if (!settingsError && settings) {
                    const value = settings.setting_value;
                    smartBookingSettings = {
                        enabled: value.enabled ?? true,
                        max_service_radius_miles: value.max_service_radius_miles ?? 25
                    };
                    if (value.home_base) {
                        businessHomeBase = value.home_base;
                    }
                    console.log('Loaded smart booking settings:', smartBookingSettings);
                }
            } catch (err) {
                console.log('Smart booking settings not available, using defaults');
            }
        }
        
        // Haversine formula - Calculate distance between two coordinates in miles
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            
            const R = 3959; // Earth's radius in miles
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            
            return Math.round(distance * 10) / 10; // Round to 1 decimal
        }
        
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }
        
        // Get travel fee tier for a given distance
        function getTravelFeeTier(distanceMiles) {
            if (distanceMiles === null || distanceMiles === undefined) {
                return travelFeeTiers[0]; // Default to first tier if no distance
            }
            
            for (const tier of travelFeeTiers) {
                if (distanceMiles >= tier.min_distance_miles && distanceMiles < tier.max_distance_miles) {
                    return tier;
                }
            }
            
            // Return last tier (out of area) if no match
            return travelFeeTiers[travelFeeTiers.length - 1];
        }
        
        // Geocode an address using OpenStreetMap Nominatim (free)
        async function geocodeAddress(address, city, state = 'CA', zip = '') {
            if (!address && !zip) return null;
            
            // Build full address string for cache key
            const fullAddress = [address, city, state, zip].filter(Boolean).join(', ');
            
            // Check cache first
            if (geocodeCache.has(fullAddress)) {
                console.log('Geocode cache hit:', fullAddress);
                return geocodeCache.get(fullAddress);
            }
            
            try {
                let response;
                
                // If we have a zip code, use structured query for better accuracy
                if (zip) {
                    const params = new URLSearchParams({
                        format: 'json',
                        street: address,
                        city: city || '',
                        state: state,
                        postalcode: zip,
                        country: 'us',
                        limit: '1'
                    });
                    response = await fetch(
                        `https://nominatim.openstreetmap.org/search?${params}`,
                        { headers: { 'User-Agent': 'DogfathersPlus-App/1.0' } }
                    );
                    
                    // If structured query fails, fall back to free-form
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const result = {
                                latitude: parseFloat(data[0].lat),
                                longitude: parseFloat(data[0].lon),
                                display_name: data[0].display_name
                            };
                            geocodeCache.set(fullAddress, result);
                            console.log('Geocoded (structured):', fullAddress, 'â†’', result.latitude, result.longitude);
                            return result;
                        }
                    }
                }
                
                // Free-form query (fallback or when no zip)
                const query = encodeURIComponent(fullAddress);
                response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&countrycodes=us`,
                    { headers: { 'User-Agent': 'DogfathersPlus-App/1.0' } }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const result = {
                            latitude: parseFloat(data[0].lat),
                            longitude: parseFloat(data[0].lon),
                            display_name: data[0].display_name
                        };
                        geocodeCache.set(fullAddress, result);
                        console.log('Geocoded (free-form):', fullAddress, 'â†’', result.latitude, result.longitude);
                        return result;
                    }
                }
            } catch (err) {
                console.warn('Nominatim geocoding failed:', err);
            }
            
            // Fallback: Try zip code centroid
            if (zip) {
                const centroid = await getZipCodeCentroid(zip);
                if (centroid) {
                    geocodeCache.set(fullAddress, centroid);
                    return centroid;
                }
            }
            
            return null;
        }
        
        // Get zip code centroid from database
        async function getZipCodeCentroid(zipCode) {
            if (!zipCode) return null;
            
            // Clean zip code (take first 5 digits)
            const zip = zipCode.toString().substring(0, 5);
            
            try {
                const { data, error } = await supabaseClient
                    .from('zip_code_centroids')
                    .select('*')
                    .eq('zip_code', zip)
                    .single();
                
                if (!error && data) {
                    return {
                        latitude: parseFloat(data.latitude),
                        longitude: parseFloat(data.longitude),
                        display_name: `${data.city}, ${data.state} ${zip}`
                    };
                }
            } catch (err) {
                console.warn('Zip centroid lookup failed:', err);
            }
            
            return null;
        }
        
        // Appointment slot configuration
        const APPOINTMENT_SLOTS = ['07:00', '09:00', '11:00', '13:00', '15:00', '17:00'];
        const SLOT_DURATION_MINUTES = 120;
        
        // Get smart date/time recommendations for booking (Multi-Groomer System)
        async function getSmartDateRecommendations(customerLat, customerLng, daysAhead = 30) {
            if (!customerLat || !customerLng) {
                console.log('No customer coordinates for smart booking');
                return { bestAvailable: [], moreAvailable: [], noCoordinates: true };
            }
            
            // Use Pacific timezone for all date calculations
            const todayStr = getTodayPacific(); // YYYY-MM-DD in Pacific time
            
            // Calculate end date (30 days from today in Pacific time)
            const todayParts = todayStr.split('-');
            const todayDate = new Date(todayParts[0], todayParts[1] - 1, todayParts[2], 12, 0, 0);
            todayDate.setDate(todayDate.getDate() + daysAhead);
            const endDateStr = todayDate.toISOString().split('T')[0];
            
            console.log('Smart booking date range (Pacific):', todayStr, 'to', endDateStr);
            
            try {
                // Try to use the database function first
                const { data: dbSlots, error: dbError } = await supabaseClient
                    .rpc('get_available_slots_multi_groomer', {
                        p_start_date: todayStr,
                        p_end_date: endDateStr,
                        p_customer_lat: customerLat,
                        p_customer_lng: customerLng
                    });
                
                if (!dbError && dbSlots && dbSlots.length > 0) {
                    console.log('Using database function for smart booking:', dbSlots.length, 'slots');
                    return processAvailableSlots(dbSlots, customerLat, customerLng);
                }
                
                // Fallback to JavaScript calculation if DB function not available
                console.log('Falling back to JS calculation for smart booking');
                return await calculateAvailableSlotsJS(customerLat, customerLng, todayStr, endDateStr);
                
            } catch (err) {
                console.error('Error in smart booking:', err);
                return await calculateAvailableSlotsJS(customerLat, customerLng, todayStr, endDateStr);
            }
        }
        
        // Process slots from database function
        function processAvailableSlots(slots, customerLat, customerLng) {
            // Separate into categories first, then sort each by date/time
            const bestSlots = slots.filter(s => s.distance_from_prev !== null && s.distance_from_prev < 10);
            const moreSlots = slots.filter(s => s.distance_from_prev === null || s.distance_from_prev >= 10);
            
            // Sort function: date first, then time
            const sortByDateTime = (a, b) => {
                if (a.slot_date !== b.slot_date) return a.slot_date.localeCompare(b.slot_date);
                return a.slot_time.localeCompare(b.slot_time);
            };
            
            // Sort each category by date/time (earliest first)
            bestSlots.sort(sortByDateTime);
            moreSlots.sort(sortByDateTime);
            
            // Format for display
            const bestAvailable = bestSlots
                .slice(0, 10)
                .map(s => formatSlotForDisplay(s))
                .filter(s => s !== null);
            
            const moreAvailable = moreSlots
                .slice(0, 20)
                .map(s => formatSlotForDisplay(s))
                .filter(s => s !== null);
            
            console.log('Smart booking results:', { bestAvailable: bestAvailable.length, moreAvailable: moreAvailable.length });
            
            return { bestAvailable, moreAvailable };
        }
        
        // Format slot for display
        function formatSlotForDisplay(slot) {
            // Null check
            if (!slot || !slot.slot_date || !slot.slot_time) {
                console.warn('Invalid slot in formatSlotForDisplay:', slot);
                return null;
            }
            
            const dateObj = new Date(slot.slot_date + 'T12:00:00');
            return {
                date: slot.slot_date,
                time: slot.slot_time.slice(0, 5), // "07:00:00" -> "07:00"
                groomerId: slot.groomer_id,
                groomerName: slot.groomer_name,
                distance: slot.distance_from_prev,
                dayOfWeek: dateObj.getDay(),
                dayName: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dateObj.getDay()],
                displayDate: dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                displayTime: formatTime(slot.slot_time)
            };
        }
        
        // JavaScript fallback calculation for available slots
        async function calculateAvailableSlotsJS(customerLat, customerLng, startDate, endDate) {
            console.log('calculateAvailableSlotsJS called with:', { customerLat, customerLng, startDate, endDate });
            
            // 1. Get all active groomers with their availability
            const { data: groomers, error: groomersError } = await supabaseClient
                .from('profiles')
                .select('id, full_name, home_latitude, home_longitude')
                .eq('role', 'groomer')
                .eq('is_active', true);
            
            console.log('Groomers found:', groomers?.length, groomers);
            
            if (groomersError || !groomers?.length) {
                console.error('No groomers found:', groomersError);
                return { bestAvailable: [], moreAvailable: [], error: true };
            }
            
            // 2. Get groomer availability schedules
            const { data: availability } = await supabaseClient
                .from('groomer_availability')
                .select('groomer_id, day_of_week, start_time, end_time, is_available')
                .eq('is_available', true);
            
            console.log('Groomer availability records:', availability?.length, availability);
            
            // 3. Get time off requests
            const { data: timeOff } = await supabaseClient
                .from('groomer_time_off')
                .select('groomer_id, start_date, end_date')
                .gte('end_date', startDate)
                .lte('start_date', endDate)
                .eq('status', 'approved');
            
            // 4. Get existing appointments
            const { data: appointments } = await supabaseClient
                .from('appointments')
                .select('id, appointment_date, start_time, assigned_groomer_id, latitude, longitude')
                .gte('appointment_date', startDate)
                .lte('appointment_date', endDate)
                .not('status', 'in', '("cancelled","no_show")');
            
            console.log('Existing appointments:', appointments?.length, appointments);
            
            // Build lookup maps
            const availabilityMap = {};
            (availability || []).forEach(a => {
                if (!availabilityMap[a.groomer_id]) availabilityMap[a.groomer_id] = {};
                availabilityMap[a.groomer_id][a.day_of_week] = a;
            });
            
            console.log('Availability map:', availabilityMap);
            
            const timeOffSet = new Set();
            (timeOff || []).forEach(t => {
                const start = new Date(t.start_date);
                const end = new Date(t.end_date);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    timeOffSet.add(`${t.groomer_id}_${d.toISOString().split('T')[0]}`);
                }
            });
            
            const bookedSlots = new Set();
            const appointmentsByGroomerDate = {};
            (appointments || []).forEach(a => {
                bookedSlots.add(`${a.assigned_groomer_id}_${a.appointment_date}_${a.start_time?.slice(0,5)}`);
                const key = `${a.assigned_groomer_id}_${a.appointment_date}`;
                if (!appointmentsByGroomerDate[key]) appointmentsByGroomerDate[key] = [];
                appointmentsByGroomerDate[key].push(a);
            });
            
            console.log('Booked slots:', [...bookedSlots]);
            
            // 5. Generate all available slots
            const allSlots = [];
            const currentDate = new Date(startDate + 'T12:00:00');
            const end = new Date(endDate + 'T12:00:00');
            
            // Get current time in PACIFIC TIMEZONE for filtering today's past slots
            const todayStr = getTodayPacific(); // YYYY-MM-DD in Pacific time
            const currentTimePacific = getCurrentTimePacific(); // HH:MM in Pacific time
            
            // Add 2 hour buffer - can't book within 2 hours (in Pacific time)
            const bufferHours = 2;
            const nowPacific = getNowPacific();
            const minBookableTime = new Date(nowPacific.getTime() + bufferHours * 60 * 60 * 1000);
            const minBookableHour = minBookableTime.getHours();
            const minBookableMinute = minBookableTime.getMinutes();
            const minBookableTimeStr = `${String(minBookableHour).padStart(2, '0')}:${String(minBookableMinute).padStart(2, '0')}`;
            
            console.log('PACIFIC TIME - Today:', todayStr, 'Current time:', currentTimePacific);
            console.log('Min bookable time (current + 2hr buffer):', minBookableTimeStr);
            console.log('Generating slots from', startDate, 'to', endDate);
            
            while (currentDate <= end) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay();
                const isToday = dateStr === todayStr;
                
                for (const groomer of groomers) {
                    // Check if groomer works this day
                    const groomerAvail = availabilityMap[groomer.id]?.[dayOfWeek];
                    if (!groomerAvail) {
                        continue;
                    }
                    
                    // Check for time off
                    if (timeOffSet.has(`${groomer.id}_${dateStr}`)) continue;
                    
                    // Check each slot
                    for (const slot of APPOINTMENT_SLOTS) {
                        // CRITICAL: Skip times that are less than 2 hours away for today
                        if (isToday && slot <= minBookableTimeStr) {
                            continue;
                        }
                        
                        // Check if within groomer's hours
                        if (slot < groomerAvail.start_time?.slice(0,5) || slot >= groomerAvail.end_time?.slice(0,5)) continue;
                        
                        // Check if already booked
                        if (bookedSlots.has(`${groomer.id}_${dateStr}_${slot}`)) continue;
                        
                        // Calculate distance from previous appointment or home base
                        const dayAppts = appointmentsByGroomerDate[`${groomer.id}_${dateStr}`] || [];
                        const prevAppt = dayAppts
                            .filter(a => a.start_time?.slice(0,5) < slot)
                            .sort((a, b) => b.start_time.localeCompare(a.start_time))[0];
                        
                        let distance = null;
                        let distanceSource = 'none';
                        
                        if (prevAppt?.latitude && prevAppt?.longitude) {
                            distance = calculateDistance(customerLat, customerLng, parseFloat(prevAppt.latitude), parseFloat(prevAppt.longitude));
                            distanceSource = 'prev_appt';
                        } else if (groomer.home_latitude && groomer.home_longitude) {
                            distance = calculateDistance(customerLat, customerLng, parseFloat(groomer.home_latitude), parseFloat(groomer.home_longitude));
                            distanceSource = 'home_base';
                        } else {
                            distance = calculateDistance(customerLat, customerLng, businessHomeBase.latitude, businessHomeBase.longitude);
                            distanceSource = 'business_default';
                        }
                        
                        // Debug log for first few slots
                        if (allSlots.length < 5) {
                            console.log(`Slot ${dateStr} ${slot} - ${groomer.full_name}: ${distance?.toFixed(1)} mi (${distanceSource})`);
                        }
                        
                        allSlots.push({
                            slot_date: dateStr,
                            slot_time: slot,
                            groomer_id: groomer.id,
                            groomer_name: groomer.full_name,
                            distance_from_prev: distance ? Math.round(distance * 100) / 100 : null
                        });
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('Total slots generated:', allSlots.length);
            if (allSlots.length > 0) {
                // Log distance distribution
                const under10 = allSlots.filter(s => s.distance_from_prev < 10).length;
                const over10 = allSlots.filter(s => s.distance_from_prev >= 10).length;
                console.log(`Distance distribution: ${under10} slots < 10mi (Best), ${over10} slots >= 10mi (More)`);
            }
            
            return processAvailableSlots(allSlots, customerLat, customerLng);
        }
        
        // Legacy function for compatibility - redirects to new system
        async function getSmartDateRecommendationsLegacy(customerLat, customerLng, daysAhead = 30) {
            const result = await getSmartDateRecommendations(customerLat, customerLng, daysAhead);
            
            // Convert new format to old format for backward compatibility
            if (result.bestAvailable || result.moreAvailable) {
                return {
                    recommended: result.bestAvailable || [],
                    goodOptions: [],
                    available: result.moreAvailable || [],
                    outOfArea: []
                };
            }
            return result;
        }
        
        // Store coordinates when creating/updating appointments
        async function geocodeAndStoreAppointmentLocation(appointmentId, address, city, zip) {
            const coords = await geocodeAddress(address, city, 'CA', zip);
            
            if (coords && appointmentId) {
                const { error } = await supabaseClient
                    .from('appointments')
                    .update({
                        latitude: coords.latitude,
                        longitude: coords.longitude
                    })
                    .eq('id', appointmentId);
                
                if (error) {
                    console.error('Failed to store appointment coordinates:', error);
                } else {
                    console.log('Stored appointment coordinates:', coords);
                }
            }
            
            return coords;
        }
        
        // Store coordinates when updating customer profile
        async function geocodeAndStoreProfileLocation(profileId, address, city, zip) {
            const coords = await geocodeAddress(address, city, 'CA', zip);
            
            if (coords && profileId) {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        latitude: coords.latitude,
                        longitude: coords.longitude,
                        address_geocoded_at: new Date().toISOString()
                    })
                    .eq('id', profileId);
                
                if (error) {
                    console.error('Failed to store profile coordinates:', error);
                } else {
                    console.log('Stored profile coordinates:', coords);
                    // Update local state
                    if (state.currentUser) {
                        state.currentUser.latitude = coords.latitude;
                        state.currentUser.longitude = coords.longitude;
                    }
                }
            }
            
            return coords;
        }
        
        // Format distance for display
        function formatDistance(miles) {
            if (miles === null || miles === undefined) return '';
            if (miles < 0.5) return '< 0.5 mi';
            return `${miles.toFixed(1)} mi`;
        }
        
        // Format travel fee for display
        function formatTravelFee(fee) {
            if (fee === null || fee === undefined || fee < 0) return '';
            if (fee === 0) return 'FREE';
            return `+$${fee}`;
        }

        // =============================================
        // SUPABASE DATA FUNCTIONS
        // =============================================
        
        // Initialize app - check for existing session
        async function initApp() {
            console.log('Initializing app...');
            
            try {
                showLoading();
                
                // Check for password recovery token in URL first
                if (checkForPasswordRecovery()) {
                    hideLoading();
                    render();
                    return; // Don't continue with normal init if in recovery mode
                }
                
                // Check for existing session
                if (supabaseClient) {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (sessionError) {
                        console.error('Session error:', sessionError);
                    }
                    
                    if (session) {
                        console.log('Found existing session');
                        state.session = session;
                        
                        // IMPORTANT: Restoring session = existing user, NEVER show onboarding
                        state.showOnboarding = false;
                        
                        await loadUserProfile(session.user.id);
                    }
                    
                    // Load public data
                    await loadPublicData();
                    
                    // Load smart booking settings
                    await loadSmartBookingSettings();
                    
                    // Set up real-time subscriptions for 2-way sync
                    setupRealtimeSubscriptions();
                }
                
                hideLoading();
                render();
                console.log('App initialized successfully');
            } catch (err) {
                console.error('Init error:', err);
                hideLoading();
                render();
            }
        }

        // =============================================
        // REAL-TIME SUBSCRIPTIONS (2-WAY SYNC)
        // =============================================
        function setupRealtimeSubscriptions() {
            if (!supabaseClient) return;
            
            try {
                // Subscribe to appointments changes
                supabaseClient
                    .channel('appointments-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, async (payload) => {
                        console.log('Appointment change:', payload.eventType);
                        await handleRealtimeUpdate('appointments', payload);
                    })
                    .subscribe((status) => {
                        console.log('Appointments subscription:', status);
                    });

                // Subscribe to pets changes
                supabaseClient
                    .channel('pets-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'pets' }, async (payload) => {
                        console.log('Pet change:', payload.eventType);
                        await handleRealtimeUpdate('pets', payload);
                    })
                    .subscribe();

                // Subscribe to products changes
                supabaseClient
                    .channel('products-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, async (payload) => {
                        console.log('Product change:', payload.eventType);
                        await handleRealtimeUpdate('products', payload);
                    })
                    .subscribe();

                // Subscribe to rewards changes
                supabaseClient
                    .channel('rewards-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'rewards' }, async (payload) => {
                        console.log('Reward change:', payload.eventType);
                        await handleRealtimeUpdate('rewards', payload);
                    })
                    .subscribe();

                // Subscribe to ride_along_packages changes
                supabaseClient
                    .channel('ridealongs-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ride_along_packages' }, async (payload) => {
                        console.log('Ride-along change:', payload.eventType);
                        await handleRealtimeUpdate('ride_along_packages', payload);
                    })
                    .subscribe();

                // Subscribe to profiles/customers changes (for admin)
                supabaseClient
                    .channel('profiles-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, async (payload) => {
                        console.log('Profile change:', payload.eventType);
                    await handleRealtimeUpdate('profiles', payload);
                })
                .subscribe();

            // Subscribe to services changes
            supabaseClient
                .channel('services-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'services' }, async (payload) => {
                    console.log('Service change:', payload.eventType);
                    await handleRealtimeUpdate('services', payload);
                })
                .subscribe();

            // Subscribe to reward_redemptions changes
            supabaseClient
                .channel('redemptions-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'reward_redemptions' }, async (payload) => {
                    console.log('Redemption change:', payload.eventType);
                    await handleRealtimeUpdate('reward_redemptions', payload);
                })
                .subscribe();

            // Subscribe to ride_along_inquiries changes
            supabaseClient
                .channel('inquiries-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'ride_along_inquiries' }, async (payload) => {
                    console.log('Inquiry change:', payload.eventType);
                    await handleRealtimeUpdate('ride_along_inquiries', payload);
                })
                .subscribe();
                
            console.log('Realtime subscriptions set up successfully');
            } catch (err) {
                console.error('Failed to set up realtime subscriptions:', err);
            }
        }

        // Handle real-time updates
        async function handleRealtimeUpdate(table, payload) {
            try {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                
                switch(table) {
                    case 'appointments':
                        // Reload appointments for admin, groomer, and customer views
                        if (state.currentUser?.role === 'admin') {
                            await loadAdminData();
                            
                            // Show specific notification based on status change
                            if (eventType === 'UPDATE' && newRecord?.status !== oldRecord?.status) {
                                const petName = newRecord.pet_name || 'Pet';
                                const groomerName = newRecord.groomer_name || 'Groomer';
                                
                                if (newRecord.status === 'in_progress') {
                                    showToast(`ðŸš€ ${groomerName} started grooming ${petName}`, 'info');
                                } else if (newRecord.status === 'completed') {
                                    showToast(`âœ… ${groomerName} completed ${petName}'s appointment`, 'success');
                                } else if (newRecord.status === 'cancelled') {
                                    showToast(`âŒ Appointment cancelled`, 'warning');
                                } else {
                                    showToast(`Appointment status: ${newRecord.status}`, 'info');
                                }
                            } else {
                                showToast(`Appointment ${eventType === 'INSERT' ? 'created' : eventType === 'UPDATE' ? 'updated' : 'changed'}`, 'info');
                            }
                        } else if (state.currentUser?.role === 'groomer') {
                            // Check if this appointment is assigned to current groomer
                            // Field is assigned_groomer_id in the database
                            const isMyAppointment = newRecord?.assigned_groomer_id === state.currentUser.id || 
                                                    oldRecord?.assigned_groomer_id === state.currentUser.id;
                            
                            // Check if this update was made by the current user (don't notify for own actions)
                            const isOwnAction = newRecord?.completed_by === state.currentUser.id ||
                                               (newRecord?.status === 'in_progress' && newRecord?.assigned_groomer_id === state.currentUser.id);
                            
                            console.log('Real-time groomer check:', {
                                eventType,
                                newGroomerId: newRecord?.assigned_groomer_id,
                                oldGroomerId: oldRecord?.assigned_groomer_id,
                                myId: state.currentUser.id,
                                isMyAppointment,
                                isOwnAction
                            });
                            
                            if (isMyAppointment) {
                                await loadGroomerData();
                                
                                // Don't show notifications for own actions (start/complete)
                                if (!isOwnAction) {
                                    // Show specific notification based on event
                                    if (eventType === 'INSERT' || (eventType === 'UPDATE' && newRecord?.assigned_groomer_id === state.currentUser.id && oldRecord?.assigned_groomer_id !== state.currentUser.id)) {
                                        showToast('ðŸ†• New appointment assigned to you!', 'success');
                                    } else if (eventType === 'UPDATE' && newRecord?.status === 'cancelled') {
                                        showToast('âŒ An appointment was cancelled', 'warning');
                                        // Close detail view if viewing this appointment
                                        if (state.selectedAppointment?.id === newRecord.id) {
                                            closeAppointmentDetail();
                                        }
                                    } else if (eventType === 'DELETE') {
                                        showToast('ðŸ—‘ï¸ Appointment removed', 'warning');
                                        if (state.selectedAppointment?.id === oldRecord.id) {
                                            closeAppointmentDetail();
                                        }
                                    }
                                    // Note: Removed generic "Appointment updated" toast to reduce noise
                                }
                                
                                render();
                            }
                        } else if (state.currentUser) {
                            await loadCustomerData(state.currentUser.id);
                            showToast(`Appointment ${eventType === 'INSERT' ? 'created' : eventType === 'UPDATE' ? 'updated' : 'changed'}`, 'info');
                        }
                        break;
                        
                    case 'pets':
                        // Update pets for the owner
                        if (state.currentUser && newRecord?.owner_id === state.currentUser.id) {
                            await loadCustomerData(state.currentUser.id);
                        }
                        // Admin sees all changes
                    if (state.currentUser?.role === 'admin') {
                        await loadAdminData();
                    }
                    break;
                    
                case 'products':
                    // Reload products for everyone
                    await loadPublicData();
                    if (state.currentUser?.role === 'admin') {
                        showToast('Products updated', 'info');
                    }
                    break;
                    
                case 'rewards':
                    // Reload rewards for everyone
                    await loadPublicData();
                    break;
                    
                case 'ride_along_packages':
                    // Reload packages for everyone
                    await loadPublicData();
                    break;
                    
                case 'profiles':
                    // Admin: reload customer list
                    if (state.currentUser?.role === 'admin') {
                        await loadAdminData();
                    }
                    // Customer: update own profile if changed
                    if (newRecord?.id === state.currentUser?.id) {
                        state.currentUser = {
                            ...state.currentUser,
                            name: newRecord.full_name,
                            phone: newRecord.phone,
                            loyaltyPoints: newRecord.loyalty_points,
                            address: newRecord.address,
                            city: newRecord.city,
                            zip: newRecord.zip_code
                        };
                    }
                    break;
                    
                case 'services':
                    // Reload services for ALL users (admin, customer, groomer)
                    // No notification needed - just silently update the data
                    console.log('Services updated via real-time:', eventType, newRecord?.name || oldRecord?.name);
                    await loadPublicData();
                    break;
                    
                case 'reward_redemptions':
                    // Admin sees all redemptions
                    if (state.currentUser?.role === 'admin') {
                        await loadAdminData();
                        showToast('New reward redemption received', 'info');
                    }
                    break;
                    
                case 'ride_along_inquiries':
                    // Admin sees all inquiries
                    if (state.currentUser?.role === 'admin') {
                        await loadAdminData();
                        showToast('New ride-along inquiry received', 'info');
                    }
                    break;
            }
            
            render();
            } catch (err) {
                console.error('Realtime update error:', err);
            }
        }

        // Manual refresh function for users
        async function refreshData() {
            showLoading();
            try {
                await loadPublicData();
                if (state.currentUser?.role === 'admin') {
                    await loadAdminData();
                } else if (state.currentUser) {
                    await loadCustomerData(state.currentUser.id);
                }
                showToast('Data refreshed!', 'success');
            } catch (err) {
                console.error('Refresh error:', err);
                showToast('Failed to refresh data', 'error');
            }
            hideLoading();
            render();
        }

        // Load user profile from database
        async function loadUserProfile(userId) {
            try {
                console.log('Loading profile for user:', userId);
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('Profile load error:', error);
                    // Don't return - try to continue
                }
                
                if (profile) {
                    console.log('Profile loaded:', profile);
                    state.currentUser = {
                        id: profile.id,
                        email: profile.email,
                        name: profile.full_name,
                        phone: profile.phone,
                        role: profile.role || 'customer',
                        loyaltyPoints: profile.loyalty_points || 0,
                        avatar: profile.avatar_url,
                        address: profile.address,
                        city: profile.city,
                        zip: profile.zip_code
                    };
                    
                    // Load user-specific data based on role
                    if (profile.role === 'admin') {
                        await loadAdminData();
                    } else if (profile.role === 'groomer') {
                        // FIX: Load groomer data on refresh
                        console.log('Loading groomer data for role: groomer');
                        await loadGroomerData();
                    } else {
                        await loadCustomerData(userId);
                    }
                    return true;
                } else {
                    console.log('No profile found for user');
                    return false;
                }
            } catch (err) {
                console.error('Failed to load user profile:', err);
                return false;
            }
        }

        // Load public data (services, products, etc)
        async function loadPublicData() {
            try {
                // Load ALL services (admin needs to see inactive too)
                // Filter for active-only in customer/groomer booking dropdowns
                const { data: services, error: servicesError } = await supabaseClient
                    .from('services')
                    .select('*')
                    .order('sort_order');
                if (servicesError) console.error('Services load error:', servicesError);
                state.services = services || [];
                console.log('Services loaded:', state.services.length, 'total');

                // Load products
                const { data: products, error: productsError } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('sort_order');
                if (productsError) console.error('Products load error:', productsError);
                state.products = products || [];

                // Load rewards
                const { data: rewards, error: rewardsError } = await supabaseClient
                    .from('rewards')
                    .select('*')
                    .eq('is_active', true);
                if (rewardsError) console.error('Rewards load error:', rewardsError);
                state.rewards = rewards || [];

                // Load ride-along packages
                const { data: packages, error: packagesError } = await supabaseClient
                    .from('ride_along_packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('sort_order');
                if (packagesError) console.error('Packages load error:', packagesError);
                state.rideAlongPackages = packages || [];

                // Load business hours
                const { data: hours, error: hoursError } = await supabaseClient
                    .from('business_hours')
                    .select('*')
                    .order('day_of_week');
                if (hoursError) console.error('Hours load error:', hoursError);
                state.businessHours = hours || [];
            } catch (err) {
                console.error('Failed to load public data:', err);
            }
        }

        // Load customer-specific data
        async function loadCustomerData(userId) {
            try {
                console.log('Loading customer data for:', userId);
                
                // Load pets
                const { data: pets, error: petsError } = await supabaseClient
                    .from('pets')
                    .select('*')
                    .eq('owner_id', userId)
                    .eq('is_active', true);
                if (petsError) console.error('Pets load error:', petsError);
                console.log('Pets loaded:', pets?.length || 0);
                state.pets = pets || [];

                // Load appointments with JOINs
                const { data: appointments, error: apptsError } = await supabaseClient
                    .from('appointments')
                    .select(`
                        *,
                        pet:pets(name, breed),
                        service:services(name)
                    `)
                    .eq('customer_id', userId)
                    .order('created_at', { ascending: false });
                if (apptsError) console.error('Appointments load error:', apptsError);
                console.log('Appointments loaded:', appointments?.length || 0, appointments);
                
                // Map appointments and resolve names from local state if JOIN failed
                state.appointments = (appointments || []).map(a => {
                    // Try to get names from JOIN first, then fall back to local state
                    let petName = a.pet?.name;
                    let petBreed = a.pet?.breed;
                    let serviceName = a.service?.name;
                    
                    // If JOIN didn't return pet data, look it up from local state
                    if (!petName && a.pet_id && state.pets.length > 0) {
                        const localPet = state.pets.find(p => p.id === a.pet_id);
                        if (localPet) {
                            petName = localPet.name;
                            petBreed = localPet.breed;
                        }
                    }
                    
                    // If JOIN didn't return service data, look it up from loaded services
                    if (!serviceName && a.service_id && state.services?.length > 0) {
                        const localService = state.services.find(s => s.id === a.service_id);
                        if (localService) {
                            serviceName = localService.name;
                        }
                    }
                    
                    return {
                        ...a,
                        petName: petName || 'Pet',
                        petBreed: petBreed || '',
                        serviceName: serviceName || 'Grooming'
                    };
                });

                // Note: Onboarding is only triggered after NEW signup, not here
                // Users can add pets/address from their dashboard if needed
                
                // Load notifications
                await loadNotifications();
            } catch (err) {
                console.error('Failed to load customer data:', err);
            }
        }

        // Load admin data
        async function loadAdminData() {
            try {
                console.log('Loading admin data...');
                
                // Load all appointments with customer, pet, service, and assigned groomer info
                // Note: groomer join uses explicit FK name because profiles is referenced twice
                const { data: appointments, error: apptsError } = await supabaseClient
                    .from('appointments')
                    .select(`
                        *,
                        customer:profiles!appointments_customer_id_fkey(full_name, email, phone, address, city),
                        pet:pets(name, breed, weight, grooming_notes, photo_url),
                        service:services(name, duration_minutes),
                        groomer:profiles!appointments_assigned_groomer_id_fkey(full_name, phone)
                    `)
                    .order('created_at', { ascending: false });
                
                if (apptsError) {
                    console.error('Admin appointments load error:', apptsError);
                    
                    // Try without groomer join (in case groomer-db-setup.sql hasn't been run)
                    console.log('Trying query without groomer join...');
                    const { data: appts2, error: err2 } = await supabaseClient
                        .from('appointments')
                        .select(`
                            *,
                            customer:profiles!appointments_customer_id_fkey(full_name, email, phone, address, city),
                            pet:pets(name, breed, weight, grooming_notes, photo_url),
                            service:services(name, duration_minutes)
                        `)
                        .order('created_at', { ascending: false });
                    
                    if (!err2 && appts2) {
                        console.log('Loaded appointments without groomer join:', appts2.length);
                        state.allAppointments = (appts2 || []).map(a => ({
                            ...a,
                            customerName: a.customer?.full_name || 'Customer',
                            customerEmail: a.customer?.email || '',
                            customerPhone: a.customer?.phone || '',
                            customerAddress: a.customer?.address || '',
                            customerCity: a.customer?.city || '',
                            petName: a.pet?.name || 'Pet',
                            petBreed: a.pet?.breed || '',
                            petWeight: a.pet?.weight || '',
                            petNotes: a.pet?.grooming_notes || '',
                            petPhoto: a.pet?.photo_url || '',
                            serviceName: a.service?.name || 'Grooming',
                            serviceDuration: a.service?.duration_minutes || 60,
                            groomerName: null, // Groomer system not set up yet
                            groomerPhone: null
                        }));
                    } else {
                        // Fallback: try simpler query without joins
                        console.log('Trying fallback query without joins...');
                        const { data: simpleAppts, error: simpleError } = await supabaseClient
                            .from('appointments')
                            .select('*')
                            .order('created_at', { ascending: false });
                    
                        if (simpleError) {
                            console.error('Fallback query also failed:', simpleError);
                            state.allAppointments = [];
                        } else {
                            console.log('Fallback appointments loaded:', simpleAppts?.length || 0);
                            
                            // Need to manually fetch related data
                            const mappedAppts = await Promise.all((simpleAppts || []).map(async (a) => {
                                let customerName = 'Customer', petName = 'Pet', petBreed = '', serviceName = 'Grooming', groomerName = null;
                                
                                // Fetch customer
                                if (a.customer_id) {
                                    const { data: cust } = await supabaseClient
                                        .from('profiles')
                                        .select('full_name, email, phone, address, city')
                                        .eq('id', a.customer_id)
                                        .single();
                                    if (cust) customerName = cust.full_name || 'Customer';
                                }
                                
                                // Fetch pet
                                if (a.pet_id) {
                                    const { data: pet } = await supabaseClient
                                        .from('pets')
                                        .select('name, breed, weight, grooming_notes, photo_url')
                                        .eq('id', a.pet_id)
                                        .single();
                                    if (pet) {
                                        petName = pet.name || 'Pet';
                                        petBreed = pet.breed || '';
                                    }
                                }
                                
                                // Fetch service
                                if (a.service_id) {
                                    const { data: svc } = await supabaseClient
                                        .from('services')
                                        .select('name')
                                        .eq('id', a.service_id)
                                        .single();
                                    if (svc) serviceName = svc.name || 'Grooming';
                                }
                                
                                // Fetch assigned groomer
                                if (a.assigned_groomer_id) {
                                    const { data: grm } = await supabaseClient
                                        .from('profiles')
                                        .select('full_name')
                                        .eq('id', a.assigned_groomer_id)
                                        .single();
                                    if (grm) groomerName = grm.full_name || 'Groomer';
                                }
                                
                                return { ...a, customerName, petName, petBreed, serviceName, groomerName };
                            }));
                            
                            state.allAppointments = mappedAppts;
                        }
                    }
                } else {
                    console.log('Admin appointments loaded:', appointments?.length || 0, appointments);
                    state.allAppointments = (appointments || []).map(a => ({
                        ...a,
                        customerName: a.customer?.full_name || 'Customer',
                        customerEmail: a.customer?.email || '',
                        customerPhone: a.customer?.phone || '',
                        customerAddress: a.customer?.address || '',
                        customerCity: a.customer?.city || '',
                        petName: a.pet?.name || 'Pet',
                        petBreed: a.pet?.breed || '',
                        petWeight: a.pet?.weight || '',
                        petNotes: a.pet?.grooming_notes || '',
                        petPhoto: a.pet?.photo_url || '',
                        serviceName: a.service?.name || 'Grooming',
                        serviceDuration: a.service?.duration_minutes || 60,
                        groomerName: a.groomer?.full_name || null,
                        groomerPhone: a.groomer?.phone || null
                    }));
                }

                // Load all customers
                const { data: customers, error: customersError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('role', 'customer')
                    .order('created_at', { ascending: false });
                if (customersError) console.error('Customers load error:', customersError);
                console.log('Customers loaded:', customers?.length || 0);
                state.allCustomers = customers || [];
                
                // Load all pets for customers
                const { data: allPets, error: petsError } = await supabaseClient
                    .from('pets')
                    .select('*')
                    .order('name', { ascending: true });
                if (petsError) console.error('Pets load error:', petsError);
                console.log('All pets loaded:', allPets?.length || 0);
                state.pets = allPets || [];
                
                // Load all groomers with full details
                const { data: groomers, error: groomersError } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name, phone, email, specialties, is_active, hired_date, admin_notes, created_at')
                    .eq('role', 'groomer')
                    .order('full_name', { ascending: true });
                if (groomersError) console.error('Groomers load error:', groomersError);
                console.log('Groomers loaded:', groomers?.length || 0);
                
                // Calculate stats for each groomer
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                console.log('Current month for stats:', currentMonth);
                console.log('All appointments with groomer IDs:', state.allAppointments.map(a => ({
                    id: a.id.substring(0, 8),
                    assigned_groomer_id: a.assigned_groomer_id?.substring(0, 8) || 'none',
                    date: a.appointment_date
                })));
                
                state.groomers = (groomers || []).map(g => {
                    // Count appointments assigned to this groomer this month
                    const groomerAppts = state.allAppointments.filter(a => {
                        if (a.assigned_groomer_id !== g.id) return false;
                        // Handle date - check if it starts with current month
                        if (!a.appointment_date) return false;
                        let dateStr = a.appointment_date;
                        // Fix malformed dates like "20026-01-28"
                        if (dateStr.length === 11 && dateStr.startsWith('20')) {
                            dateStr = dateStr.substring(1);
                        }
                        return dateStr.startsWith(currentMonth);
                    });
                    
                    console.log(`Groomer ${g.full_name} (${g.id.substring(0, 8)}) - Found ${groomerAppts.length} appointments this month`);
                    
                    const completedAppts = groomerAppts.filter(a => a.status === 'completed');
                    const monthRevenue = completedAppts.reduce((sum, a) => 
                        sum + (parseFloat(a.total_price) || 0), 0
                    );
                    
                    return {
                        ...g,
                        appointmentsThisMonth: groomerAppts.length,
                        completedThisMonth: completedAppts.length,
                        revenueThisMonth: monthRevenue,
                        // Parse specialties if stored as string
                        specialties: Array.isArray(g.specialties) ? g.specialties : 
                            (g.specialties ? JSON.parse(g.specialties) : [])
                    };
                });
                
                // Load ride-along inquiries
                const { data: inquiries, error: inquiriesError } = await supabaseClient
                    .from('ride_along_inquiries')
                    .select(`
                        *,
                        customer:profiles(full_name, email, phone),
                        package:ride_along_packages(name, price)
                    `)
                    .order('created_at', { ascending: false });
                if (inquiriesError) console.error('Inquiries load error:', inquiriesError);
                console.log('Inquiries loaded:', inquiries?.length || 0);
                state.rideAlongInquiries = (inquiries || []).map(i => ({
                    ...i,
                    customerName: i.customer?.full_name || 'Customer',
                    customerEmail: i.customer?.email || '',
                    customerPhone: i.customer?.phone || '',
                    packageName: i.package?.name || 'Package',
                    packagePrice: i.package?.price || 0
                }));
                
                // Load reward redemptions
                const { data: redemptions, error: redemptionsError } = await supabaseClient
                    .from('reward_redemptions')
                    .select(`
                        *,
                        customer:profiles(full_name, email),
                        reward:rewards(name, points_required)
                    `)
                    .order('created_at', { ascending: false });
                if (redemptionsError) console.error('Redemptions load error:', redemptionsError);
                console.log('Redemptions loaded:', redemptions?.length || 0);
                state.rewardRedemptions = (redemptions || []).map(r => ({
                    ...r,
                    customerName: r.customer?.full_name || 'Customer',
                    customerEmail: r.customer?.email || '',
                    rewardName: r.reward?.name || 'Reward',
                    pointsRequired: r.reward?.points_required || 0
                }));
                
                // Load notifications
                await loadNotifications();
                
                // Load pending redemptions for fulfillment queue
                await loadPendingRedemptions();
                
                // Load pending time off requests
                await loadPendingTimeOffRequests();
                
                // Load admin messages
                await loadAdminMessages();
            } catch (err) {
                console.error('Failed to load admin data:', err);
            }
        }

        // =============================================
        // GROOMER FUNCTIONS
        // =============================================

        // Load groomer's assigned appointments
        async function loadGroomerData() {
            try {
                console.log('Loading groomer data for user:', state.currentUser?.id);
                
                const { data: appointments, error: apptsError } = await supabaseClient
                    .from('appointments')
                    .select(`
                        *,
                        customer:profiles!appointments_customer_id_fkey(full_name, email, phone, address, city),
                        pet:pets(name, breed, weight, grooming_notes, photo_url),
                        service:services(name, duration_minutes, base_price)
                    `)
                    .eq('assigned_groomer_id', state.currentUser.id)
                    .in('status', ['pending', 'confirmed', 'in_progress', 'completed'])
                    .order('appointment_date', { ascending: true })
                    .order('start_time', { ascending: true });
                
                if (apptsError) {
                    console.error('Groomer appointments load error:', apptsError);
                    state.groomerAppointments = [];
                } else {
                    console.log('Groomer appointments loaded:', appointments?.length || 0);
                    console.log('Raw appointments data:', appointments?.map(a => ({
                        id: a.id?.substring(0, 8),
                        date: a.appointment_date,
                        time: a.start_time,
                        status: a.status,
                        assigned_groomer_id: a.assigned_groomer_id?.substring(0, 8)
                    })));
                    
                    state.groomerAppointments = (appointments || []).map(a => ({
                        ...a,
                        customerName: a.customer?.full_name || 'Customer',
                        customerEmail: a.customer?.email || '',
                        customerPhone: a.customer?.phone || '',
                        customerAddress: a.customer?.address || '',
                        customerCity: a.customer?.city || '',
                        petName: a.pet?.name || 'Pet',
                        petBreed: a.pet?.breed || '',
                        petWeight: a.pet?.weight || '',
                        petNotes: a.pet?.grooming_notes || '',
                        petPhoto: a.pet?.photo_url || '',
                        serviceName: a.service?.name || 'Grooming',
                        serviceDuration: a.service?.duration_minutes || 60,
                        servicePrice: a.service?.base_price || a.total_price || 0
                    }));
                }
                
                // Load notifications
                await loadNotifications();
                
                // Load groomer's availability
                await loadGroomerAvailability(state.currentUser.id);
            } catch (err) {
                console.error('Failed to load groomer data:', err);
            }
        }

        // Groomer login handler
        async function handleGroomerLogin(email, password) {
            showLoading();
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    hideLoading();
                    showToast(error.message, 'error');
                    return;
                }
                
                // Check if user has groomer role
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();
                
                if (profileError || !profile) {
                    hideLoading();
                    await supabaseClient.auth.signOut();
                    showToast('Profile not found', 'error');
                    return;
                }
                
                if (profile.role !== 'groomer') {
                    hideLoading();
                    await supabaseClient.auth.signOut();
                    showToast('Not authorized as groomer. Please use customer login.', 'error');
                    return;
                }
                
                // Set up groomer session
                state.currentUser = {
                    id: data.user.id,
                    email: profile.email,
                    name: profile.full_name || email.split('@')[0],
                    phone: profile.phone || '',
                    role: 'groomer'
                };
                state.session = data.session;
                state.showGroomerLogin = false;
                
                await loadPublicData();
                await loadGroomerData();
                setupRealtimeSubscriptions();
                
                hideLoading();
                showToast(`Welcome, ${state.currentUser.name}!`, 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Groomer login error:', err);
                showToast('Login failed: ' + err.message, 'error');
            }
        }

        // Admin assigns groomer to appointment
        async function assignGroomer(appointmentId, groomerId) {
            showLoading();
            
            try {
                const { error } = await supabaseClient
                    .from('appointments')
                    .update({
                        assigned_groomer_id: groomerId || null,
                        assigned_at: groomerId ? new Date().toISOString() : null
                    })
                    .eq('id', appointmentId);
                
                if (error) {
                    hideLoading();
                    showToast('Failed to assign groomer: ' + error.message, 'error');
                    return;
                }
                
                // Reload admin data
                await loadAdminData();
                hideLoading();
                
                const groomer = state.groomers.find(g => g.id === groomerId);
                showToast(groomerId ? `Assigned to ${groomer?.full_name || 'groomer'}` : 'Groomer unassigned', 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Assign groomer error:', err);
                showToast('Failed to assign groomer', 'error');
            }
        }

        // Groomer marks appointment as complete
        
        // Start Grooming - Show before photo modal first
        function startGroomingAppointment(appointmentId) {
            const apt = (state.groomerAppointments || []).find(a => a.id === appointmentId);
            if (!apt) {
                showToast('Appointment not found', 'error');
                return;
            }
            
            state.showBeforePhotoModal = true;
            state.beforePhotoAppointmentId = appointmentId;
            state.beforePhotoAppointmentData = apt;
            state.capturedBeforePhoto = null;
            render();
        }
        
        // Close before photo modal
        function closeBeforePhotoModal() {
            state.showBeforePhotoModal = false;
            state.beforePhotoAppointmentId = null;
            state.beforePhotoAppointmentData = null;
            state.capturedBeforePhoto = null;
            render();
        }
        
        // Skip before photo and start immediately
        async function skipBeforePhotoAndStart() {
            const appointmentId = state.beforePhotoAppointmentId;
            closeBeforePhotoModal();
            await groomerStartAppointment(appointmentId, null);
        }
        
        // Capture photo using device camera
        async function capturePhoto(type) {
            return new Promise((resolve, reject) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment'; // Use back camera on mobile
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        resolve(null);
                        return;
                    }
                    
                    try {
                        // Compress and convert to base64
                        const compressed = await compressImage(file, 1200, 0.8);
                        
                        if (type === 'before') {
                            state.capturedBeforePhoto = compressed;
                        } else {
                            state.capturedAfterPhoto = compressed;
                        }
                        render();
                        resolve(compressed);
                    } catch (err) {
                        console.error('Photo capture error:', err);
                        reject(err);
                    }
                };
                
                input.click();
            });
        }
        
        // Compress image to reduce size
        async function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Upload photo to Supabase Storage
        async function uploadPhotoToStorage(base64Data, appointmentId, photoType) {
            try {
                // Convert base64 to blob
                const response = await fetch(base64Data);
                const blob = await response.blob();
                
                // Generate unique filename
                const timestamp = Date.now();
                const filename = `${appointmentId}_${photoType}_${timestamp}.jpg`;
                const filePath = `appointment-photos/${filename}`;
                
                // Upload to Supabase Storage
                const { data, error } = await supabaseClient.storage
                    .from('grooming-photos')
                    .upload(filePath, blob, {
                        contentType: 'image/jpeg',
                        upsert: true
                    });
                
                if (error) {
                    console.error('Storage upload error:', error);
                    // If bucket doesn't exist, show helpful message
                    if (error.message.includes('bucket') || error.message.includes('not found')) {
                        console.log('Note: Storage bucket "grooming-photos" may need to be created in Supabase');
                    }
                    return null;
                }
                
                // Get public URL
                const { data: urlData } = supabaseClient.storage
                    .from('grooming-photos')
                    .getPublicUrl(filePath);
                
                return urlData?.publicUrl || null;
                
            } catch (err) {
                console.error('Photo upload error:', err);
                return null;
            }
        }
        
        // Start appointment with optional before photo
        async function startWithBeforePhoto() {
            const appointmentId = state.beforePhotoAppointmentId;
            const beforePhoto = state.capturedBeforePhoto;
            
            closeBeforePhotoModal();
            await groomerStartAppointment(appointmentId, beforePhoto);
        }
        
        // Groomer starts an appointment (status: confirmed â†’ in_progress)
        async function groomerStartAppointment(appointmentId, beforePhotoBase64 = null) {
            showLoading();
            
            try {
                // Upload before photo if captured
                let beforePhotoUrl = null;
                if (beforePhotoBase64) {
                    beforePhotoUrl = await uploadPhotoToStorage(beforePhotoBase64, appointmentId, 'before');
                }
                
                // Build update data
                const updateData = {
                    status: 'in_progress',
                    started_at: new Date().toISOString()
                };
                
                // Add before photo URL if uploaded
                if (beforePhotoUrl) {
                    updateData.before_photo_url = beforePhotoUrl;
                }
                
                // Direct database update (bypasses RPC functions that may not exist)
                const { error } = await supabaseClient
                    .from('appointments')
                    .update(updateData)
                    .eq('id', appointmentId)
                    .eq('assigned_groomer_id', state.currentUser.id);
                
                if (error) {
                    hideLoading();
                    showToast('Failed to start appointment: ' + error.message, 'error');
                    return;
                }
                
                // Close appointment detail modal if open
                if (state.showAppointmentDetail) {
                    state.showAppointmentDetail = false;
                    state.selectedAppointment = null;
                }
                
                // Reload groomer data
                await loadGroomerData(state.currentUser.id);
                hideLoading();
                showToast(beforePhotoUrl ? 'ðŸ“¸ Photo saved! Appointment started.' : 'ðŸš€ Appointment started! Timer is running.', 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Start appointment error:', err);
                showToast('Failed to start appointment', 'error');
            }
        }
        
        // Groomer completes an appointment with notes (status: in_progress â†’ completed)
        async function groomerCompleteAppointment(appointmentId, providedNotes = null, afterPhotoBase64 = null) {
            // Use provided notes or try to get from DOM element
            const notesEl = document.getElementById(`groomer-notes-${appointmentId}`) || 
                           document.getElementById('modal-groomer-notes-' + appointmentId) ||
                           document.getElementById('completion-notes');
            const groomerNotes = providedNotes || notesEl?.value?.trim() || null;
            
            // Use the direct update method (more reliable without RPC functions)
            await groomerMarkComplete(appointmentId, groomerNotes, afterPhotoBase64);
        }
        
        // Legacy groomer mark complete (fallback, also used for pending â†’ completed edge case)
        async function groomerMarkComplete(appointmentId, groomerNotes = null, afterPhotoBase64 = null) {
            showLoading();
            
            try {
                // Find the appointment to get customer_id
                const appointment = state.groomerAppointments.find(a => a.id === appointmentId);
                
                if (!appointment) {
                    hideLoading();
                    showToast('Appointment not found', 'error');
                    return;
                }
                
                // Upload after photo if captured
                let afterPhotoUrl = null;
                if (afterPhotoBase64) {
                    afterPhotoUrl = await uploadPhotoToStorage(afterPhotoBase64, appointmentId, 'after');
                }
                
                // Update appointment status - include assigned_groomer_id check for RLS
                const updateData = {
                    status: 'completed',
                    completed_at: new Date().toISOString(),
                    completed_by: state.currentUser.id
                };
                
                // Auto-set started_at if not already set
                if (!appointment.started_at) {
                    updateData.started_at = new Date(Date.now() - 60 * 60 * 1000).toISOString(); // 1 hour ago
                }
                
                if (groomerNotes) {
                    updateData.groomer_notes = groomerNotes;
                }
                
                // Add after photo URL if uploaded
                if (afterPhotoUrl) {
                    updateData.after_photo_url = afterPhotoUrl;
                }
                
                // Update with both id and assigned_groomer_id to satisfy RLS
                const { error } = await supabaseClient
                    .from('appointments')
                    .update(updateData)
                    .eq('id', appointmentId)
                    .eq('assigned_groomer_id', state.currentUser.id);
                
                if (error) {
                    console.error('Update error:', error);
                    hideLoading();
                    showToast('Failed to complete: ' + error.message, 'error');
                    return;
                }
                
                // IMMEDIATELY update local state to show completion
                // This ensures UI updates even if reload has issues
                const aptIndex = state.groomerAppointments.findIndex(a => a.id === appointmentId);
                if (aptIndex !== -1) {
                    state.groomerAppointments[aptIndex] = {
                        ...state.groomerAppointments[aptIndex],
                        status: 'completed',
                        completed_at: updateData.completed_at,
                        completed_by: updateData.completed_by,
                        groomer_notes: groomerNotes,
                        after_photo_url: afterPhotoUrl
                    };
                    console.log('Local state updated for appointment:', appointmentId);
                }
                
                // Award loyalty points to customer (non-blocking)
                if (appointment.customer_id) {
                    awardLoyaltyPointsToCustomer(appointment.customer_id, appointmentId);
                }
                
                // Also reload from database to ensure sync
                try {
                    await loadGroomerData();
                } catch (reloadErr) {
                    console.warn('Reload warning (non-critical):', reloadErr);
                }
                
                hideLoading();
                const photoMsg = afterPhotoUrl ? 'ðŸ“¸ Photo saved! ' : '';
                showToast(`${photoMsg}Appointment completed! Customer earned 50 loyalty points.`, 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Complete appointment error:', err);
                showToast('Failed to complete appointment', 'error');
            }
        }
        
        // Helper function to award loyalty points (non-blocking)
        async function awardLoyaltyPointsToCustomer(customerId, appointmentId) {
            try {
                // Direct update - just add points to customer profile
                const { data: customer } = await supabaseClient
                    .from('profiles')
                    .select('loyalty_points')
                    .eq('id', customerId)
                    .single();
                
                if (customer) {
                    const updatedPoints = (customer.loyalty_points || 0) + 50;
                    await supabaseClient
                        .from('profiles')
                        .update({ loyalty_points: updatedPoints })
                        .eq('id', customerId);
                    
                    console.log(`Awarded 50 loyalty points to customer. New total: ${updatedPoints}`);
                }
            } catch (pointsErr) {
                console.error('Failed to award loyalty points:', pointsErr);
                // Don't fail the whole operation just because points couldn't be awarded
            }
        }

        // =============================================
        // AUTHENTICATION FUNCTIONS
        // =============================================

        async function handleSignUp(email, password, fullName, phone) {
            showLoading();
            
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: { 
                        full_name: fullName,
                        phone: phone
                    }
                }
            });
            
            hideLoading();
            
            if (error) {
                showToast(error.message, 'error');
                return false;
            }
            
            // Check if email confirmation is required
            if (data.user && !data.session) {
                showToast('Check your email to confirm your account!', 'success');
                state.authTab = 'login';
                render();
            } else if (data.session) {
                // Auto-confirmed - NEW USER, show onboarding
                // IMPORTANT: Set onboarding flags FIRST before setting currentUser
                // This prevents a flash of dashboard during the transition
                state.showOnboarding = true;
                state.onboardingStep = 1;
                
                state.session = data.session;
                
                // Set up basic user info
                state.currentUser = {
                    id: data.user.id,
                    email: data.user.email,
                    name: fullName,
                    phone: phone,
                    role: 'customer',
                    loyaltyPoints: 0
                };
                
                // Load public data (services, products, etc)
                await loadPublicData();
                
                showToast(`Welcome, ${fullName}! Let's set up your account.`, 'success');
                render();
            }
            return true;
        }

        async function handleSignIn(email, password) {
            showLoading();
            
            // Reset onboarding state - login should NEVER show onboarding
            state.showOnboarding = false;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    hideLoading();
                    showToast(error.message, 'error');
                    return false;
                }
                
                console.log('Sign in successful, loading profile...');
                state.session = data.session;
                
                // Try to load user profile
                const profileLoaded = await loadUserProfile(data.user.id);
                
                // If profile didn't load, create a basic one from auth data
                if (!state.currentUser) {
                    console.log('Profile not found, using auth data');
                    state.currentUser = {
                        id: data.user.id,
                        email: data.user.email,
                        name: data.user.user_metadata?.full_name || email.split('@')[0],
                        role: 'customer',
                        loyaltyPoints: 0
                    };
                    
                    // Try to load customer data anyway
                    await loadCustomerData(data.user.id);
                }
                
                await loadPublicData();
                hideLoading();
                showToast(`Welcome back, ${state.currentUser?.name || 'there'}!`, 'success');
                render();
                return true;
            } catch (err) {
                console.error('Sign in exception:', err);
                hideLoading();
                showToast('Login failed: ' + err.message, 'error');
                return false;
            }
        }

        async function handleSignOut() {
            showLoading();
            await supabaseClient.auth.signOut();
            state.currentUser = null;
            state.session = null;
            state.pets = [];
            state.appointments = [];
            state.allAppointments = [];
            state.allCustomers = [];
            state.rideAlongInquiries = [];
            state.rewardRedemptions = [];
            state.groomers = [];
            state.groomerAppointments = [];
            state.showGroomerLogin = false;
            hideLoading();
            showToast('Signed out successfully', 'info');
            render();
        }

        // =============================================
        // PET MANAGEMENT
        // =============================================

        async function addPet(petData) {
            // Validation safeguard
            if (!petData.name || !petData.name.trim()) {
                showToast('Please enter your pet\'s name', 'error');
                return null;
            }
            const weight = parseFloat(petData.weight);
            if (weight && (weight < 1 || weight > 300)) {
                showToast('Please enter a valid weight (1-300 lbs)', 'error');
                return null;
            }
            
            showLoading();
            const { data, error } = await supabaseClient
                .from('pets')
                .insert({
                    owner_id: state.currentUser.id,
                    name: petData.name,
                    breed: petData.breed,
                    weight: weight || null,
                    gender: petData.gender,
                    age_years: petData.age,
                    color: petData.color,
                    grooming_notes: petData.notes,
                    photo_url: petData.photo,
                    is_active: true  // IMPORTANT: Must be true to show up
                })
                .select()
                .single();
            
            hideLoading();
            
            if (error) {
                showToast('Failed to add pet: ' + error.message, 'error');
                return null;
            }
            
            state.pets.push(data);
            showToast(`${petData.name} added successfully!`, 'success');
            render();
            return data;
        }

        async function updatePet(petId, petData) {
            showLoading();
            const { data, error } = await supabaseClient
                .from('pets')
                .update(petData)
                .eq('id', petId)
                .select()
                .single();
            
            hideLoading();
            
            if (error) {
                showToast('Failed to update pet', 'error');
                return null;
            }
            
            const index = state.pets.findIndex(p => p.id === petId);
            if (index !== -1) state.pets[index] = data;
            showToast('Pet updated!', 'success');
            render();
            return data;
        }

        // Safe pet deletion with appointment check
        async function deletePet(petId) {
            showLoading();
            
            // First check if pet can be deleted
            const { data: checkResult, error: checkError } = await supabaseClient
                .rpc('can_delete_pet', { pet_uuid: petId });
            
            hideLoading();
            
            if (checkError) {
                console.error('Error checking pet deletion:', checkError);
                // Fallback to simple soft delete if function doesn't exist
                await simpleSoftDeletePet(petId);
                return;
            }
            
            // If pet has active appointments, show blocking modal
            if (!checkResult.can_delete) {
                state.petDeletionBlocked = {
                    petId: petId,
                    petName: state.pets.find(p => p.id === petId)?.name || 'This pet',
                    appointments: checkResult.appointments || []
                };
                render();
                return;
            }
            
            // Safe to delete - perform soft delete
            await performPetDeletion(petId);
        }
        
        // Fallback simple soft delete (if DB function not available)
        async function simpleSoftDeletePet(petId) {
            showLoading();
            const { error } = await supabaseClient
                .from('pets')
                .update({ 
                    is_active: false,
                    deactivated_at: new Date().toISOString()
                })
                .eq('id', petId);
            
            hideLoading();
            
            if (error) {
                showToast('Failed to delete pet', 'error');
                return;
            }
            
            state.pets = state.pets.filter(p => p.id !== petId);
            showToast('Pet removed', 'success');
            render();
        }
        
        // Perform the actual pet deletion after checks pass
        async function performPetDeletion(petId) {
            showLoading();
            
            // Try the RPC first, fallback to direct update
            const { data, error } = await supabaseClient
                .rpc('soft_delete_pet', { 
                    pet_uuid: petId,
                    reason: 'User requested deletion'
                });
            
            if (error) {
                // Fallback to direct update
                console.log('soft_delete_pet RPC not available, using direct update');
                await simpleSoftDeletePet(petId);
                return;
            }
            
            hideLoading();
            
            if (!data?.success) {
                console.error('Deletion error:', data?.error);
                showToast(data?.error || 'Failed to delete pet', 'error');
                return;
            }
            
            // Update local state
            state.pets = state.pets.filter(p => p.id !== petId);
            state.petDeletionBlocked = null;
            showToast('Pet removed successfully', 'success');
            render();
        }
        
        // Close pet deletion blocked modal
        function closePetDeletionBlockedModal() {
            state.petDeletionBlocked = null;
            render();
        }
        
        // Render pet deletion blocked modal
        function renderPetDeletionBlockedModal() {
            if (!state.petDeletionBlocked) return '';
            
            const { petName, appointments } = state.petDeletionBlocked;
            
            return `
                <div class="fixed inset-0 z-[150] bg-black/50 flex items-center justify-center p-4" onclick="closePetDeletionBlockedModal()">
                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">block</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold dark:text-white">Cannot Delete Pet</h3>
                                <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${petName} has upcoming appointments</p>
                            </div>
                        </div>
                        
                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg p-3 mb-4">
                            <p class="text-sm text-amber-800 dark:text-amber-200 mb-2">
                                <strong>Please cancel these appointments first:</strong>
                            </p>
                            <ul class="space-y-2">
                                ${appointments.map(apt => `
                                    <li class="flex items-center justify-between text-sm">
                                        <span class="text-amber-700 dark:text-amber-300">
                                            ${new Date(apt.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${apt.time}
                                        </span>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${apt.status === 'pending' ? 'bg-amber-200 text-amber-800' : 'bg-blue-200 text-blue-800'}">
                                            ${apt.status}
                                        </span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closePetDeletionBlockedModal()" class="flex-1 h-11 rounded-lg border border-border-light dark:border-border-dark font-bold hover:bg-background-light dark:hover:bg-background-dark dark:text-white">
                                Got It
                            </button>
                            <button onclick="closePetDeletionBlockedModal(); setTab('appointments');" class="flex-1 h-11 rounded-lg bg-primary hover:bg-primary/90 text-white font-bold">
                                View Appointments
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // APPOINTMENT MANAGEMENT
        // =============================================

        async function createAppointment(appointmentData) {
            showLoading();
            
            // Get pet and service details for storing names directly
            const pet = state.pets.find(p => p.id === appointmentData.petId);
            const service = state.services?.find(s => s.id === appointmentData.serviceId);
            
            console.log('Creating appointment:', appointmentData);
            console.log('Pet found:', pet);
            console.log('Service found:', service);
            
            // Build appointment data - store names directly for reliability
            const appointmentRecord = {
                customer_id: state.currentUser.id,
                pet_id: appointmentData.petId,
                appointment_date: appointmentData.date,
                start_time: appointmentData.time,
                duration_minutes: appointmentData.duration || 120, // Default 2 hours
                service_address: appointmentData.address,
                service_city: appointmentData.city,
                service_state: 'CA',
                service_zip: appointmentData.zip,
                base_price: appointmentData.price,
                total_price: appointmentData.price,
                customer_notes: appointmentData.notes,
                status: 'confirmed' // Auto-confirm since slot was available
            };
            
            // Add coordinates if provided (for smart booking optimization)
            if (appointmentData.latitude && appointmentData.longitude) {
                appointmentRecord.latitude = appointmentData.latitude;
                appointmentRecord.longitude = appointmentData.longitude;
            }
            
            // Auto-assign groomer if provided from smart booking
            if (appointmentData.groomerId && appointmentData.groomerId.length > 10) {
                appointmentRecord.assigned_groomer_id = appointmentData.groomerId;
                console.log('Auto-assigning groomer:', appointmentData.groomerId);
            }
            
            // Only add service_id if it's a valid UUID (from actual database)
            // Don't add if it's from fallback data (simple string like '1', '2')
            if (service && appointmentData.serviceId && appointmentData.serviceId.length > 10) {
                appointmentRecord.service_id = appointmentData.serviceId;
            }
            
            const { data, error } = await supabaseClient
                .from('appointments')
                .insert(appointmentRecord)
                .select()
                .single();
            
            if (error) {
                console.error('Appointment creation error:', error);
                hideLoading();
                showToast('Failed to book appointment: ' + error.message, 'error');
                return null;
            }
            
            console.log('Appointment created:', data);
            
            // If no coordinates were provided, geocode asynchronously after creation
            if (!appointmentData.latitude && !appointmentData.longitude && data.id) {
                geocodeAndStoreAppointmentLocation(data.id, appointmentData.address, appointmentData.city, appointmentData.zip);
            }
            
            // Note: Loyalty points are awarded when appointment is COMPLETED, not at booking
            // This prevents gaming the system by booking and cancelling
            
            // Add to local state immediately with resolved names
            const newAppointment = {
                ...data,
                petName: pet?.name || 'Pet',
                petBreed: pet?.breed || '',
                serviceName: service?.name || appointmentData.serviceName || 'Grooming',
                customerName: state.currentUser.name || 'Customer'
            };
            state.appointments.unshift(newAppointment);
            
            // Also add to allAppointments if admin is viewing
            if (state.currentUser.role === 'admin') {
                state.allAppointments.unshift(newAppointment);
            }
            
            hideLoading();
            showToast('ðŸŽ‰ Appointment booked successfully! You\'ll earn 50 points when completed.', 'success');
            
            // Notify admins of new booking
            try {
                const dateStr = new Date(appointmentData.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                await notifyAllAdmins(
                    'New Booking! ðŸ“…',
                    `${state.currentUser.name} booked ${pet?.name || 'a pet'} for ${dateStr} at ${appointmentData.time}`,
                    'booking_created',
                    'appointment',
                    data.id
                );
            } catch (notifyErr) {
                console.log('Could not send admin notification:', notifyErr);
            }
            
            // Create customer confirmation notification
            try {
                await createNotification(
                    state.currentUser.id,
                    'Booking Confirmed! ðŸŽ‰',
                    `Your appointment for ${pet?.name || 'your pet'} on ${new Date(appointmentData.date).toLocaleDateString()} is pending confirmation.`,
                    'booking_created',
                    'appointment',
                    data.id
                );
            } catch (notifyErr) {
                console.log('Could not create customer notification:', notifyErr);
            }
            
            render();
            return data;
        }

        async function cancelAppointment(appointmentId, reason = 'No reason provided') {
            showLoading();
            
            // Direct database update (bypasses RPC functions that may not exist)
            const { error } = await supabaseClient
                .from('appointments')
                .update({ 
                    status: 'cancelled',
                    cancelled_at: new Date().toISOString(),
                    cancelled_by: state.currentUser.id,
                    cancellation_reason: reason
                })
                .eq('id', appointmentId);
            
            hideLoading();
            
            if (error) {
                showToast('Failed to cancel appointment: ' + error.message, 'error');
                return;
            }
            
            // Reload appointments based on role
            if (state.currentUser.role === 'admin') {
                await loadAdminData();
            } else if (state.currentUser.role === 'groomer') {
                await loadGroomerData(state.currentUser.id);
            } else {
                await loadCustomerData(state.currentUser.id);
            }
            
            showToast('Appointment cancelled', 'info');
            render();
        }

        // Customer-facing cancel with confirmation and reason
        function confirmCancelAppointment(appointmentId) {
            state.cancelAppointmentModal = {
                appointmentId: appointmentId,
                reason: ''
            };
            render();
        }
        
        // Render cancel appointment modal with reason dropdown
        function renderCancelAppointmentModal() {
            if (!state.cancelAppointmentModal) return '';
            
            const reasons = [
                'Schedule conflict',
                'Pet is sick',
                'Weather concerns',
                'Found alternative service',
                'Financial reasons',
                'Moving/relocating',
                'Other'
            ];
            
            return `
                <div class="fixed inset-0 z-[150] bg-black/50 flex items-center justify-center p-4" onclick="closeCancelAppointmentModal()">
                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">event_busy</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold dark:text-white">Cancel Appointment</h3>
                                <p class="text-sm text-text-sub-light dark:text-text-sub-dark">This action cannot be undone</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                Reason for cancellation
                            </label>
                            <select id="cancel-reason" class="w-full h-11 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white">
                                <option value="">Select a reason...</option>
                                ${reasons.map(r => `<option value="${r}">${r}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div id="cancel-other-reason" class="mb-4 hidden">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                Please specify
                            </label>
                            <input type="text" id="cancel-reason-other" placeholder="Enter your reason..." 
                                class="w-full h-11 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white">
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeCancelAppointmentModal()" class="flex-1 h-11 rounded-lg border border-border-light dark:border-border-dark font-bold hover:bg-background-light dark:hover:bg-background-dark dark:text-white">
                                Keep Appointment
                            </button>
                            <button onclick="submitCancelAppointment()" class="flex-1 h-11 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold">
                                Cancel Appointment
                            </button>
                        </div>
                    </div>
                </div>

            `;
        }
        
        function closeCancelAppointmentModal() {
            state.cancelAppointmentModal = null;
            render();
        }
        
        async function submitCancelAppointment() {
            const reasonSelect = document.getElementById('cancel-reason');
            const reasonOther = document.getElementById('cancel-reason-other');
            
            let reason = reasonSelect?.value || 'No reason provided';
            if (reason === 'Other' && reasonOther?.value) {
                reason = reasonOther.value;
            }
            
            if (!reason || reason === '') {
                showToast('Please select a reason for cancellation', 'warning');
                return;
            }
            
            const appointmentId = state.cancelAppointmentModal?.appointmentId;
            state.cancelAppointmentModal = null;
            
            await cancelAppointment(appointmentId, reason);
        }

        // =============================================
        // RIDE-ALONG INQUIRIES
        // =============================================
        async function inquireRideAlong(packageId, packageName, packagePrice) {
            if (!state.currentUser) {
                showToast('Please log in to inquire about ride-alongs', 'error');
                return;
            }
            
            showConfirm(
                'Inquire About Ride-Along',
                `Would you like to inquire about the "${packageName}" package ($${packagePrice})? We'll contact you to schedule.`,
                async () => {
                    showLoading();
                    
                    try {
                        const { data, error } = await supabaseClient
                            .from('ride_along_inquiries')
                            .insert({
                                customer_id: state.currentUser.id,
                                package_id: packageId,
                                status: 'pending',
                                notes: ''
                            })
                            .select()
                            .single();
                        
                        hideLoading();
                        
                        if (error) {
                            // If table doesn't exist, show friendly message
                            if (error.code === '42P01') {
                                showToast('Thank you for your interest! Please contact us directly to book.', 'info');
                            } else {
                                console.error('Inquiry error:', error);
                                showToast('Failed to submit inquiry: ' + error.message, 'error');
                            }
                            return;
                        }
                        
                        showToast('ðŸŽ‰ Inquiry submitted! We\'ll contact you soon to schedule.', 'success');
                    } catch (err) {
                        hideLoading();
                        console.error('Inquiry exception:', err);
                        showToast('Thank you for your interest! Please contact us directly.', 'info');
                    }
                }
            );
        }

        // =============================================
        // LOYALTY REWARDS REDEMPTION
        // =============================================
        async function redeemReward(rewardId, rewardName, pointsRequired) {
            if (!state.currentUser) {
                showToast('Please log in to redeem rewards', 'error');
                return;
            }
            
            const currentPoints = state.currentUser.loyaltyPoints || 0;
            
            if (currentPoints < pointsRequired) {
                showToast(`You need ${pointsRequired - currentPoints} more points to redeem this reward.`, 'error');
                return;
            }
            
            showConfirm(
                'Redeem Reward',
                `Redeem "${rewardName}" for ${pointsRequired} points? You currently have ${currentPoints} points.`,
                async () => {
                    showLoading();
                    
                    try {
                        // First, try to record the redemption
                        const { error: redemptionError } = await supabaseClient
                            .from('reward_redemptions')
                            .insert({
                                customer_id: state.currentUser.id,
                                reward_id: rewardId,
                                points_cost: pointsRequired,
                                status: 'pending'
                            });
                        
                        // If table doesn't exist, just deduct points anyway
                        if (redemptionError && redemptionError.code !== '42P01') {
                            console.error('Redemption record error:', redemptionError);
                        }
                        
                        // Deduct points from user's profile
                        const newPoints = currentPoints - pointsRequired;
                        const { error: updateError } = await supabaseClient
                            .from('profiles')
                            .update({ loyalty_points: newPoints })
                            .eq('id', state.currentUser.id);
                        
                        hideLoading();
                        
                        if (updateError) {
                            console.error('Points update error:', updateError);
                            showToast('Failed to redeem: ' + updateError.message, 'error');
                            return;
                        }
                        
                        // Update local state
                        state.currentUser.loyaltyPoints = newPoints;
                        
                        showToast(`ðŸŽ‰ "${rewardName}" redeemed! We'll apply this to your next visit.`, 'success');
                        render();
                    } catch (err) {
                        hideLoading();
                        console.error('Redemption exception:', err);
                        showToast('Error: ' + err.message, 'error');
                    }
                }
            );
        }

        // Admin: Update appointment status
        async function updateAppointmentStatus(appointmentId, status) {
            showLoading();
            
            const updateData = { status };
            if (status === 'confirmed') updateData.confirmed_at = new Date().toISOString();
            if (status === 'completed') updateData.completed_at = new Date().toISOString();
            if (status === 'cancelled') updateData.cancelled_at = new Date().toISOString();
            
            const { error } = await supabaseClient
                .from('appointments')
                .update(updateData)
                .eq('id', appointmentId);
            
            hideLoading();
            
            if (error) {
                showToast('Failed to update appointment', 'error');
                return;
            }
            
            // Award loyalty points when appointment is COMPLETED
            if (status === 'completed') {
                // Find the appointment to get customer_id
                const appointment = state.allAppointments.find(a => a.id === appointmentId);
                if (appointment && appointment.customer_id) {
                    try {
                        // Get current customer points
                        const { data: customer } = await supabaseClient
                            .from('profiles')
                            .select('loyalty_points')
                            .eq('id', appointment.customer_id)
                            .single();
                        
                        if (customer) {
                            const newPoints = (customer.loyalty_points || 0) + 50;
                            await supabaseClient
                                .from('profiles')
                                .update({ loyalty_points: newPoints })
                                .eq('id', appointment.customer_id);
                            
                            console.log(`Awarded 50 loyalty points to customer ${appointment.customer_id}. New total: ${newPoints}`);
                        }
                    } catch (pointsErr) {
                        console.error('Failed to award loyalty points:', pointsErr);
                        // Don't fail the whole operation for points error
                    }
                }
            }
            
            await loadAdminData();
            showToast(`Appointment ${status}!${status === 'completed' ? ' Customer earned 50 loyalty points!' : ''}`, 'success');
            render();
        }

        // Get available time slots for a date
        async function getAvailableSlots(date, serviceId) {
            const dayOfWeek = new Date(date + 'T12:00:00').getDay();
            const hours = state.businessHours.find(h => h.day_of_week === dayOfWeek);
            
            if (!hours || hours.is_closed) return [];
            
            // Check if this is today (Pacific time) - need to filter past slots
            const isToday = date === getTodayPacific();
            let minTimeStr = '00:00';
            
            if (isToday) {
                // Add 2-hour buffer from current Pacific time
                const nowPacific = getNowPacific();
                const minTime = new Date(nowPacific.getTime() + 2 * 60 * 60 * 1000);
                minTimeStr = `${String(minTime.getHours()).padStart(2, '0')}:${String(minTime.getMinutes()).padStart(2, '0')}`;
                console.log('Today in Pacific - min bookable time:', minTimeStr);
            }
            
            // Get existing appointments for that date
            const { data: existingAppts } = await supabaseClient
                .from('appointments')
                .select('start_time, end_time, duration_minutes')
                .eq('appointment_date', date)
                .in('status', ['pending', 'confirmed', 'in_progress']);
            
            // Get blocked times
            const { data: blocked } = await supabaseClient
                .from('blocked_times')
                .select('start_datetime, end_datetime')
                .gte('start_datetime', `${date}T00:00:00`)
                .lte('end_datetime', `${date}T23:59:59`);
            
            // Generate available slots
            const slots = [];
            let [openHour, openMin] = hours.open_time.split(':').map(Number);
            const [closeHour, closeMin] = hours.close_time.split(':').map(Number);
            
            while (openHour < closeHour || (openHour === closeHour && openMin < closeMin)) {
                const timeStr = `${String(openHour).padStart(2, '0')}:${String(openMin).padStart(2, '0')}`;
                
                // Skip past times for today
                if (isToday && timeStr <= minTimeStr) {
                    openMin += 30;
                    if (openMin >= 60) {
                        openMin = 0;
                        openHour++;
                    }
                    continue;
                }
                
                // Check if slot is busy
                const isBusy = (existingAppts || []).some(appt => {
                    const apptStart = appt.start_time.slice(0, 5);
                    return timeStr >= apptStart && timeStr < appt.end_time?.slice(0, 5);
                });
                
                const isBlocked = (blocked || []).some(b => {
                    const blockStart = new Date(b.start_datetime).toTimeString().slice(0, 5);
                    const blockEnd = new Date(b.end_datetime).toTimeString().slice(0, 5);
                    return timeStr >= blockStart && timeStr < blockEnd;
                });
                
                if (!isBusy && !isBlocked) {
                    slots.push(timeStr);
                }
                
                // Add 30 minutes
                openMin += 30;
                if (openMin >= 60) {
                    openMin = 0;
                    openHour++;
                }
            }
            
            return slots;
        }

        // =============================================
        // FALLBACK DATA (for demo when database is empty)
        // =============================================
        const fallbackData = {
            services: [
                { id: '1', name: 'Full Grooming', description: 'Complete grooming package', duration_minutes: 90, base_price: 85, price_small: 65, price_medium: 85, price_large: 105 },
                { id: '2', name: 'Bath & Brush', description: 'Thorough bath and brushing', duration_minutes: 60, base_price: 55, price_small: 45, price_medium: 55, price_large: 70 },
                { id: '3', name: 'Puppy First Groom', description: 'Gentle intro for puppies', duration_minutes: 45, base_price: 45 },
                { id: '4', name: 'Nail Trim', description: 'Quick nail trimming', duration_minutes: 15, base_price: 20, is_addon: true }
            ],
            products: [
                { id: '1', name: 'Soothing Oatmeal Shampoo', price: 14.99, category: 'grooming', image_url: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBMKgUmjvDBkj1cS2xNNGiY6RxULqo_q_qTbUWOJk7DBZYrF3zP8DpSUHcgGfbH8zpSf9NqqLhQrEloqgKWve4BVE9bWl41KHvdV7rKFUPMhcoJkX_WqH8dlN-ReLiSQhWqYdzZion6BRW4vFG2kbqH25uuBAQMPtnfBawmO8ueSzNPj7TG-b_GBe1DxAerdgmn3X-P5jOnFEP2_LtSjwIM_Ly6ov8dX0enxErJC81GkXDnpXkVa21RQPQ-lr6fNXwdtpJtOZg7FveL', description: 'Hypoallergenic formula', badge: 'popular' },
                { id: '2', name: 'Pro Slicker Brush', price: 22.50, category: 'grooming', image_url: 'https://lh3.googleusercontent.com/aida-public/AB6AXuAhRyB6hZU9Y9Vmd6rp_OesEand1Ucr8YLYYMVQH0nIzfB0qMa-4Rd_PyiEoJDtN24jE2Y_mM_3ACLp29R0qBTbpe5kipzat_nuE8wiDbTgj7tHuvtjhXx6l8KegMMQgzL_iN75VoHstS-7CbAFyuzNnkE-bzeTEfIyae0rcMI_C2XjFH9Ld84BBTT9zxx8jSfjZOj4MDihRtDSfanSxRNKIJ_hIumhhiaokmVM2RRauG8sUpm5-OpZx_dESHIlljuPRSyVe0NtlPHa', description: 'Remove tangles easily' }
            ],
            rewards: [
                { id: '1', name: 'Free Bath & Brush', points_required: 500, description: 'Complete bath service' },
                { id: '2', name: '$20 Off Full Groom', points_required: 300, description: 'Discount on grooming' },
                { id: '3', name: 'Free Nail Trim', points_required: 150, description: 'Nail trimming service' }
            ],
            rideAlongPackages: [
                { id: '1', name: 'Observer Package', price: 199, duration: '4 hours', description: 'Shadow a professional groomer for a half day.', features: ['4-hour shadowing session', 'Watch 2-3 complete grooms', 'Q&A with instructor', 'Digital handbook included'] },
                { id: '2', name: 'Hands-On Package', price: 399, duration: 'Full Day', description: 'Get hands-on experience under direct supervision.', features: ['8-hour full day session', 'Hands-on with 4-5 dogs', 'Certificate of completion', 'Lunch included'], is_popular: true },
                { id: '3', name: 'Mentorship Package', price: 999, duration: '3 Days', description: 'Comprehensive 3-day intensive training.', features: ['3 full days of training', 'Groom 12+ dogs hands-on', 'Business coaching session', '30-day follow-up support'] }
            ]
        };

        // Use fallback data if database is empty
        function getServices() { return state.services.length ? state.services : fallbackData.services; }
        function getProducts() { return state.products.length ? state.products : fallbackData.products; }
        function getRewards() { return state.rewards.length ? state.rewards : fallbackData.rewards; }
        function getRideAlongPackages() { return state.rideAlongPackages.length ? state.rideAlongPackages : fallbackData.rideAlongPackages; }

        // Legacy data object for backward compatibility with existing render functions
        const data = {
            get users() { return []; }, // No longer using mock users
            get products() { return getProducts(); },
            get rewards() { return getRewards(); },
            get appointments() { return state.allAppointments; },
            get rideAlongs() { return getRideAlongPackages().map(p => ({...p, features: typeof p.features === 'string' ? JSON.parse(p.features) : p.features, popular: p.is_popular })); }
        };

        function render() {
            try {
                const app = document.getElementById('app');
                if (!app) {
                    console.error('App element not found!');
                    return;
                }
                
                // Show password reset page (after clicking email link)
                if (state.showResetPassword) {
                    app.innerHTML = renderResetPasswordPage();
                    return;
                }
                
                // Show groomer login page
                if (state.showGroomerLogin) {
                    app.innerHTML = renderGroomerLogin() + renderForgotPasswordModal();
                } else if (!state.currentUser) {
                    app.innerHTML = renderAuthPage() + renderForgotPasswordModal();
                } else if (state.showOnboarding) {
                    app.innerHTML = renderOnboarding();
                } else if (state.currentUser.role === 'admin') {
                    app.innerHTML = renderAdminDashboard() + renderChangePasswordModal();
                } else if (state.currentUser.role === 'groomer') {
                    app.innerHTML = renderGroomerDashboard() + renderChangePasswordModal() + renderCompleteAppointmentModal() + renderBeforePhotoModal() + renderPetProfileModal();
                } else {
                    app.innerHTML = renderCustomerDashboard() + renderChangePasswordModal();
                }
                attachEventListeners();
            } catch (err) {
                console.error('Render error:', err);
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                        <div class="bg-white rounded-2xl p-8 max-w-lg w-full shadow-xl text-center">
                            <span class="material-symbols-outlined text-6xl text-red-500 mb-4">error</span>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Something went wrong</h2>
                            <p class="text-gray-600 mb-4">${err.message}</p>
                            <button onclick="location.reload()" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">
                                Reload Page
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // =============================================
        // ONBOARDING FLOW
        // =============================================
        function renderOnboarding() {
            const step = state.onboardingStep;
            const totalSteps = 3;
            
            return `
            <div class="min-h-screen bg-gradient-to-br from-primary/5 via-background-light to-sky-50 dark:from-background-dark dark:via-background-dark dark:to-slate-900 flex flex-col">
                <!-- Header -->
                <header class="p-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-xl overflow-hidden shadow-md"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div>
                        <span class="font-bold text-xl dark:text-white">Dogfathersplus</span>
                    </div>
                    <button onclick="skipOnboarding()" class="text-sm text-text-sub-light dark:text-text-sub-dark hover:text-primary">Skip for now</button>
                </header>

                <!-- Progress Bar -->
                <div class="px-6 py-4 max-w-2xl mx-auto w-full">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-text-sub-light dark:text-text-sub-dark">Step ${step} of ${totalSteps}</span>
                        <span class="text-sm font-medium text-primary">${Math.round((step/totalSteps)*100)}% Complete</span>
                    </div>
                    <div class="h-2 bg-border-light dark:bg-border-dark rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary to-sky-400 rounded-full transition-all duration-500" style="width: ${(step/totalSteps)*100}%"></div>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 flex items-center justify-center p-6">
                    <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
                        ${step === 1 ? renderOnboardingStep1() : ''}
                        ${step === 2 ? renderOnboardingStep2() : ''}
                        ${step === 3 ? renderOnboardingStep3() : ''}
                    </div>
                </div>
            </div>`;
        }

        function renderOnboardingStep1() {
            return `
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-4xl text-primary">waving_hand</span>
                    </div>
                    <h1 class="text-3xl font-bold mb-2 dark:text-white">Welcome to Dogfathersplus!</h1>
                    <p class="text-text-sub-light dark:text-text-sub-dark">Let's get you set up in just a few steps. First, we need your address for mobile grooming visits.</p>
                </div>

                <form id="onboarding-form-1" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Street Address *</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-text-sub-light">home</span>
                            <input type="text" id="ob-address" value="${state.onboardingData.address}" placeholder="123 Main Street" 
                                class="w-full h-12 pl-12 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 dark:text-white">City *</label>
                            <input type="text" id="ob-city" value="${state.onboardingData.city}" placeholder="Los Angeles" 
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 dark:text-white">ZIP Code *</label>
                            <input type="text" id="ob-zip" value="${state.onboardingData.zip}" placeholder="90001" 
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        </div>
                    </div>

                    <div class="bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-lg p-4 flex items-start gap-3">
                        <span class="material-symbols-outlined text-primary">info</span>
                        <p class="text-sm text-text-sub-light dark:text-text-sub-dark">We come to you! Our mobile grooming van will arrive at your address for all appointments.</p>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="w-full h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg flex items-center justify-center gap-2 touch-target transition-all">
                            Continue <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </form>
            </div>`;
        }

        function renderOnboardingStep2() {
            const popularBreeds = [
                'Labrador Retriever', 'Golden Retriever', 'German Shepherd', 'French Bulldog', 'Bulldog',
                'Poodle', 'Beagle', 'Rottweiler', 'Yorkshire Terrier', 'Boxer',
                'Dachshund', 'Shih Tzu', 'Siberian Husky', 'Great Dane', 'Doberman Pinscher',
                'Chihuahua', 'Maltese', 'Pomeranian', 'Cocker Spaniel', 'Bernese Mountain Dog',
                'Other'
            ];
            const currentYear = new Date().getFullYear();
            const years = Array.from({length: 25}, (_, i) => currentYear - i);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const showOtherBreed = state.onboardingData.petBreed === 'Other';

            return `
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-4xl text-primary">pets</span>
                    </div>
                    <h1 class="text-3xl font-bold mb-2 dark:text-white">Tell us about your pet!</h1>
                    <p class="text-text-sub-light dark:text-text-sub-dark">We'd love to meet your furry friend. This helps us prepare the perfect grooming experience.</p>
                </div>

                <form id="onboarding-form-2" class="space-y-4">
                    <!-- Pet Photo Upload -->
                    <div class="flex justify-center mb-4">
                        <div class="relative">
                            <div id="pet-photo-preview" class="w-28 h-28 rounded-full bg-background-light dark:bg-background-dark border-2 border-dashed border-border-light dark:border-border-dark flex items-center justify-center overflow-hidden cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('ob-pet-photo').click()">
                                ${state.onboardingData.petPhoto ? 
                                    `<img src="${state.onboardingData.petPhoto}" class="w-full h-full object-cover"/>` : 
                                    `<div class="text-center p-2">
                                        <span class="material-symbols-outlined text-3xl text-text-sub-light">add_a_photo</span>
                                        <p class="text-xs text-text-sub-light mt-1">Add Photo</p>
                                    </div>`
                                }
                            </div>
                            <input type="file" id="ob-pet-photo" accept="image/*" class="hidden" onchange="handlePetPhotoUpload(event)">
                            ${state.onboardingData.petPhoto ? `
                            <button type="button" onclick="removePetPhoto()" class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </button>` : ''}
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Pet's Name *</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-text-sub-light">badge</span>
                            <input type="text" id="ob-pet-name" value="${state.onboardingData.petName}" placeholder="Max" 
                                class="w-full h-12 pl-12 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Breed *</label>
                        <select id="ob-pet-breed" onchange="handleBreedChange(this.value)"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white appearance-none cursor-pointer" required>
                            <option value="">Select breed...</option>
                            ${popularBreeds.map(breed => `<option value="${breed}" ${state.onboardingData.petBreed === breed ? 'selected' : ''}>${breed}</option>`).join('')}
                        </select>
                    </div>

                    ${showOtherBreed ? `
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Specify Breed *</label>
                        <input type="text" id="ob-pet-breed-other" value="${state.onboardingData.petBreedOther}" placeholder="Enter your dog's breed" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                    </div>` : ''}

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 dark:text-white">Weight (lbs) *</label>
                            <input type="number" id="ob-pet-weight" value="${state.onboardingData.petWeight}" placeholder="50" min="1" max="300" 
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 dark:text-white">Gender</label>
                            <select id="ob-pet-gender"
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                                <option value="male" ${state.onboardingData.petGender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${state.onboardingData.petGender === 'female' ? 'selected' : ''}>Female</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Birthday (optional)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="ob-pet-birth-month"
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                                <option value="">Month</option>
                                ${months.map((month, i) => `<option value="${i + 1}" ${state.onboardingData.petBirthMonth == (i + 1) ? 'selected' : ''}>${month}</option>`).join('')}
                            </select>
                            <select id="ob-pet-birth-year"
                                class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                                <option value="">Year</option>
                                ${years.map(year => `<option value="${year}" ${state.onboardingData.petBirthYear == year ? 'selected' : ''}>${year}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Special Notes (optional)</label>
                        <textarea id="ob-pet-notes" placeholder="Any allergies, sensitivities, or special care instructions..." 
                            class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${state.onboardingData.petNotes}</textarea>
                    </div>

                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="prevOnboardingStep()" class="flex-1 h-12 border border-border-light dark:border-border-dark rounded-lg font-bold hover:bg-background-light dark:hover:bg-background-dark dark:text-white touch-target transition-all">
                            <span class="material-symbols-outlined align-middle">arrow_back</span> Back
                        </button>
                        <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg flex items-center justify-center gap-2 touch-target transition-all">
                            Continue <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>
                </form>
            </div>`;
        }

        // Save current onboarding form data to state (prevents data loss on re-render)
        function saveOnboardingFormData() {
            // Step 1 fields
            const address = document.getElementById('ob-address');
            const city = document.getElementById('ob-city');
            const zip = document.getElementById('ob-zip');
            if (address) state.onboardingData.address = address.value;
            if (city) state.onboardingData.city = city.value;
            if (zip) state.onboardingData.zip = zip.value;
            
            // Step 2 fields
            const petName = document.getElementById('ob-pet-name');
            const petBreed = document.getElementById('ob-pet-breed');
            const petBreedOther = document.getElementById('ob-pet-breed-other');
            const petWeight = document.getElementById('ob-pet-weight');
            const petGender = document.getElementById('ob-pet-gender');
            const petBirthMonth = document.getElementById('ob-pet-birth-month');
            const petBirthYear = document.getElementById('ob-pet-birth-year');
            const petNotes = document.getElementById('ob-pet-notes');
            
            if (petName) state.onboardingData.petName = petName.value;
            if (petBreed) state.onboardingData.petBreed = petBreed.value;
            if (petBreedOther) state.onboardingData.petBreedOther = petBreedOther.value;
            if (petWeight) state.onboardingData.petWeight = petWeight.value;
            if (petGender) state.onboardingData.petGender = petGender.value;
            if (petBirthMonth) state.onboardingData.petBirthMonth = petBirthMonth.value;
            if (petBirthYear) state.onboardingData.petBirthYear = petBirthYear.value;
            if (petNotes) state.onboardingData.petNotes = petNotes.value;
        }

        // Handle pet photo upload
        function handlePetPhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }
                // Save current form data before re-render
                saveOnboardingFormData();
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.onboardingData.petPhoto = e.target.result;
                    render();
                    showToast('Photo uploaded!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function removePetPhoto() {
            // Save current form data before re-render
            saveOnboardingFormData();
            state.onboardingData.petPhoto = '';
            render();
        }

        function handleBreedChange(value) {
            // Save current form data before re-render
            saveOnboardingFormData();
            state.onboardingData.petBreed = value;
            if (value !== 'Other') {
                state.onboardingData.petBreedOther = '';
            }
            render();
        }

        function renderOnboardingStep3() {
            const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const birthDisplay = state.onboardingData.petBirthMonth && state.onboardingData.petBirthYear 
                ? `${months[parseInt(state.onboardingData.petBirthMonth)]} ${state.onboardingData.petBirthYear}` 
                : null;
                
            return `
            <div class="p-8 text-center">
                <div class="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="material-symbols-outlined text-5xl text-green-600 dark:text-green-400">check_circle</span>
                </div>
                <h1 class="text-3xl font-bold mb-2 dark:text-white">You're All Set! ðŸŽ‰</h1>
                <p class="text-text-sub-light dark:text-text-sub-dark mb-6">Welcome to the Dogfathersplus family! Your account is ready and ${state.onboardingData.petName || 'your pet'} is registered.</p>

                <div class="bg-background-light dark:bg-background-dark rounded-xl p-6 mb-6 text-left">
                    <h3 class="font-bold mb-4 dark:text-white flex items-center gap-2"><span class="material-symbols-outlined text-primary">summarize</span>Your Information</h3>
                    
                    <!-- Pet Card -->
                    <div class="flex items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark rounded-xl mb-4 border border-border-light dark:border-border-dark">
                        <div class="w-20 h-20 rounded-full overflow-hidden bg-primary/10 flex items-center justify-center flex-shrink-0">
                            ${state.onboardingData.petPhoto 
                                ? `<img src="${state.onboardingData.petPhoto}" class="w-full h-full object-cover"/>` 
                                : `<span class="material-symbols-outlined text-3xl text-primary">pets</span>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-lg dark:text-white">${state.onboardingData.petName}</h4>
                            <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${state.onboardingData.petBreed}</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="px-2 py-0.5 bg-primary/10 text-primary text-xs rounded-full font-medium">${state.onboardingData.petWeight} lbs</span>
                                <span class="px-2 py-0.5 bg-primary/10 text-primary text-xs rounded-full font-medium capitalize">${state.onboardingData.petGender}</span>
                                ${birthDisplay ? `<span class="px-2 py-0.5 bg-primary/10 text-primary text-xs rounded-full font-medium">Born ${birthDisplay}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address -->
                    <div class="flex items-start gap-3 text-sm">
                        <span class="material-symbols-outlined text-primary">home</span>
                        <div>
                            <p class="font-medium dark:text-white">Grooming Address</p>
                            <p class="text-text-sub-light dark:text-text-sub-dark">${state.onboardingData.address}, ${state.onboardingData.city} ${state.onboardingData.zip}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-xl p-4 mb-6">
                    <p class="text-sm"><strong class="text-primary">ðŸŽ Welcome Gift:</strong> <span class="text-text-sub-light dark:text-text-sub-dark">You've earned <strong>50 bonus points</strong> for completing your profile!</span></p>
                </div>

                <button onclick="completeOnboarding()" class="w-full h-14 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg flex items-center justify-center gap-2 touch-target transition-all text-lg">
                    Go to Dashboard <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>`;
        }

        // Onboarding Functions
        function startOnboarding() {
            state.showOnboarding = true;
            state.onboardingStep = 1;
            render();
        }

        function skipOnboarding() {
            state.showOnboarding = false;
            showToast('You can complete your profile later in Settings', 'info');
            render();
        }

        function prevOnboardingStep() {
            if (state.onboardingStep > 1) {
                state.onboardingStep--;
                render();
            }
        }

        async function nextOnboardingStep() {
            if (state.onboardingStep === 1) {
                // Save address data
                state.onboardingData.address = document.getElementById('ob-address')?.value || '';
                state.onboardingData.city = document.getElementById('ob-city')?.value || '';
                state.onboardingData.zip = document.getElementById('ob-zip')?.value || '';
                
                // Update profile with address
                await supabaseClient
                    .from('profiles')
                    .update({
                        address: state.onboardingData.address,
                        city: state.onboardingData.city,
                        zip_code: state.onboardingData.zip
                    })
                    .eq('id', state.currentUser.id);
                
                state.currentUser.address = state.onboardingData.address;
                state.currentUser.city = state.onboardingData.city;
                state.currentUser.zip = state.onboardingData.zip;
                
                state.onboardingStep = 2;
                render();
            } else if (state.onboardingStep === 2) {
                // Save pet data
                state.onboardingData.petName = document.getElementById('ob-pet-name')?.value || '';
                state.onboardingData.petBreed = document.getElementById('ob-pet-breed')?.value || '';
                state.onboardingData.petBreedOther = document.getElementById('ob-pet-breed-other')?.value || '';
                state.onboardingData.petWeight = document.getElementById('ob-pet-weight')?.value || '';
                state.onboardingData.petGender = document.getElementById('ob-pet-gender')?.value || 'male';
                state.onboardingData.petBirthMonth = document.getElementById('ob-pet-birth-month')?.value || '';
                state.onboardingData.petBirthYear = document.getElementById('ob-pet-birth-year')?.value || '';
                state.onboardingData.petNotes = document.getElementById('ob-pet-notes')?.value || '';
                
                // VALIDATION - Check required fields and valid ranges
                if (!state.onboardingData.petName.trim()) {
                    showToast('Please enter your pet\'s name', 'error');
                    return;
                }
                if (!state.onboardingData.petBreed) {
                    showToast('Please select a breed', 'error');
                    return;
                }
                const weight = parseFloat(state.onboardingData.petWeight);
                if (!weight || weight < 1 || weight > 300) {
                    showToast('Please enter a valid weight (1-300 lbs)', 'error');
                    return;
                }
                
                // Determine final breed (use Other input if selected)
                const finalBreed = state.onboardingData.petBreed === 'Other' 
                    ? state.onboardingData.petBreedOther 
                    : state.onboardingData.petBreed;
                
                // Calculate age if birthday provided
                let ageYears = null;
                if (state.onboardingData.petBirthYear) {
                    const birthYear = parseInt(state.onboardingData.petBirthYear);
                    ageYears = new Date().getFullYear() - birthYear;
                }
                
                showLoading();
                
                // Create pet in database
                const petData = {
                    owner_id: state.currentUser.id,
                    name: state.onboardingData.petName,
                    breed: finalBreed,
                    weight: weight,
                    gender: state.onboardingData.petGender,
                    grooming_notes: state.onboardingData.petNotes,
                    is_active: true
                };
                
                // Add optional fields
                if (ageYears !== null) petData.age_years = ageYears;
                if (state.onboardingData.petBirthMonth) petData.birth_month = parseInt(state.onboardingData.petBirthMonth);
                if (state.onboardingData.petBirthYear) petData.birth_year = parseInt(state.onboardingData.petBirthYear);
                if (state.onboardingData.petPhoto) petData.photo_url = state.onboardingData.petPhoto;
                
                console.log('Creating pet:', petData);
                
                const { data: pet, error } = await supabaseClient
                    .from('pets')
                    .insert(petData)
                    .select()
                    .single();
                
                if (error) {
                    console.error('Failed to create pet:', error);
                    hideLoading();
                    showToast('Failed to add pet: ' + error.message, 'error');
                    return;
                }
                
                if (pet) {
                    console.log('Pet created successfully:', pet);
                    state.pets.push(pet);
                }
                
                // Add 50 bonus points
                await supabaseClient
                    .from('profiles')
                    .update({ loyalty_points: (state.currentUser.loyaltyPoints || 0) + 50 })
                    .eq('id', state.currentUser.id);
                
                state.currentUser.loyaltyPoints = (state.currentUser.loyaltyPoints || 0) + 50;
                
                // Store final breed for display
                state.onboardingData.petBreed = finalBreed;
                
                hideLoading();
                state.onboardingStep = 3;
                render();
            }
        }

        async function completeOnboarding() {
            state.showOnboarding = false;
            showToast('Welcome to Dogfathersplus! ðŸŽ‰', 'success');
            render();
        }

        // =============================================
        // GROOMER LOGIN PAGE
        // =============================================
        function renderGroomerLogin() {
            return `
            <div class="flex flex-1 w-full min-h-screen">
                <div class="hidden lg:flex lg:w-1/2 relative bg-emerald-600 items-center justify-center overflow-hidden">
                    <div class="absolute inset-0 z-0">
                        <img alt="Dog grooming professional" class="w-full h-full object-cover opacity-40" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBAgB_Ncu0Jwq7NoOkvrWM3LGmNdBpAvJUbF63k_Xj9ezgydcIjvE6ICw5DsWJPlgZ5OAkQu_V81UIU9qbm1qZ6jJvuGb7NSlCZ9l2elEVA1AdGbc2gqs-Qcflihvblt2dmv7_bhd6nC-BDxrA3AuKq663UGylWq-VkgYnjpJKcbP_6mU7YoSnvb5-bzJQReNiTzDYO5B_lEB1sPJQGHUr_CvYOx9sErYMiLLlVrM1DPw9IAGvTFteiACwuGtOkYAjnJShJTBJnZh45"/>
                        <div class="absolute inset-0 bg-gradient-to-t from-emerald-900/80 via-emerald-800/40 to-transparent"></div>
                    </div>
                    <div class="relative z-10 text-center text-white px-12">
                        <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-white/10 backdrop-blur-sm flex items-center justify-center">
                            <span class="material-symbols-outlined text-5xl">content_cut</span>
                        </div>
                        <h2 class="text-4xl font-black mb-4">Groomer Portal</h2>
                        <p class="text-xl text-white/80 max-w-md mx-auto">Access your assigned appointments and manage your daily schedule.</p>
                    </div>
                </div>
                <div class="flex flex-1 w-full lg:w-1/2 items-center justify-center px-6 py-12 bg-background-light dark:bg-background-dark">
                    <div class="w-full max-w-md">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-14 h-14 rounded-xl overflow-hidden shadow-lg">
                                <img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/>
                            </div>
                            <div>
                                <h1 class="text-2xl font-black dark:text-white">Dogfathers<span class="text-emerald-600">plus</span></h1>
                                <p class="text-sm text-emerald-600 font-semibold">Groomer Login</p>
                            </div>
                        </div>
                        
                        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl p-8 shadow-xl border border-border-light dark:border-border-dark">
                            <h2 class="text-2xl font-bold mb-2 dark:text-white">Welcome Back</h2>
                            <p class="text-text-sub-light dark:text-text-sub-dark mb-6">Sign in to view your assignments</p>
                            
                            <form id="groomer-login-form" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 dark:text-white">Email</label>
                                    <div class="relative">
                                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-sub-light">mail</span>
                                        <input id="groomer-email" type="email" required placeholder="groomer@dogfathersplus.com" 
                                            class="w-full h-12 pl-11 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white"/>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 dark:text-white">Password</label>
                                    <div class="relative">
                                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-sub-light">lock</span>
                                        <input id="groomer-password" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                                            class="w-full h-12 pl-11 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white"/>
                                    </div>
                                </div>
                                <button type="submit" class="w-full h-12 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                                    <span class="material-symbols-outlined">login</span>
                                    Sign In as Groomer
                                </button>
                                <div class="text-center mt-3">
                                    <a href="#" onclick="openForgotPassword(document.getElementById('groomer-email')?.value || ''); return false;" class="text-sm text-emerald-600 hover:text-emerald-700 hover:underline">Forgot password?</a>
                                </div>
                            </form>
                            
                            <div class="mt-6 pt-6 border-t border-border-light dark:border-border-dark text-center">
                                <button onclick="state.showGroomerLogin = false; render();" class="text-primary hover:underline text-sm font-medium">
                                    â† Back to Customer Login
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // =============================================
        // GROOMER DASHBOARD
        // =============================================
        function renderGroomerDashboard() {
            const user = state.currentUser;
            const appointments = state.groomerAppointments || [];
            const today = getTodayPacific(); // Use Pacific timezone
            const currentDate = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: TIMEZONE };
            const formattedDate = currentDate.toLocaleDateString('en-US', dateOptions);
            
            // Debug logging
            console.log('Groomer Dashboard - Today (Pacific):', today);
            console.log('Groomer Dashboard - Total appointments:', appointments.length);
            console.log('Groomer Dashboard - Appointments:', appointments.map(a => ({
                id: a.id?.substring(0, 8),
                date: a.appointment_date,
                status: a.status,
                pet: a.petName
            })));
            
            // Filter appointments
            const todayAppts = appointments.filter(a => a.appointment_date === today && a.status !== 'completed' && a.status !== 'cancelled');
            const upcomingAppts = appointments
                .filter(a => a.appointment_date > today && a.status !== 'completed' && a.status !== 'cancelled')
                .sort((a, b) => {
                    // Sort by date first, then by time
                    if (a.appointment_date !== b.appointment_date) {
                        return a.appointment_date.localeCompare(b.appointment_date);
                    }
                    return (a.start_time || '').localeCompare(b.start_time || '');
                });
            const completedAppts = appointments.filter(a => a.status === 'completed');
            const inProgressAppt = todayAppts.find(a => a.status === 'in_progress');
            
            console.log('Groomer Dashboard - Today:', todayAppts.length, 'Upcoming:', upcomingAppts.length);
            console.log('Groomer Dashboard - Completed total:', completedAppts.length);
            console.log('Groomer Dashboard - Upcoming dates:', upcomingAppts.map(a => a.appointment_date));
            
            // Calculate estimated earnings from COMPLETED appointments today
            const todayCompletedAppts = completedAppts.filter(a => a.appointment_date === today);
            const completedEarnings = todayCompletedAppts.reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.servicePrice) || 0), 0);
            
            // Also calculate pending earnings (for "estimated" display)
            const pendingEarnings = todayAppts.reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.servicePrice) || 0), 0);
            const todayEarnings = completedEarnings + pendingEarnings;
            
            // Calculate shift time (mock for now)
            const shiftStart = localStorage.getItem('groomer_shift_start');
            let shiftDuration = '';
            if (shiftStart) {
                const start = new Date(shiftStart);
                const now = new Date();
                const mins = Math.floor((now - start) / 60000);
                shiftDuration = `${Math.floor(mins/60)}h ${mins%60}m`;
            }
            
            // Groomer tabs
            const groomerTab = state.groomerTab || 'dashboard';
            const unreadMessages = state.unreadGroomerMessages || 0;
            
            return `
            <div class="flex h-screen overflow-hidden groomer-gradient-bg dark:bg-background-dark">
                <!-- Sidebar -->
                <aside class="w-56 flex-shrink-0 flex flex-col border-r border-slate-200/50 dark:border-slate-800/50 glass-card hidden lg:flex">
                    <div class="p-5">
                        <!-- Logo -->
                        <div class="flex items-center gap-3 mb-8">
                            <div class="bg-groomer-primary rounded-xl p-2 flex items-center justify-center text-white shadow-lg shadow-groomer-primary/30">
                                <span class="material-symbols-outlined text-xl">pets</span>
                            </div>
                            <div>
                                <h1 class="text-base font-extrabold leading-none tracking-tight text-slate-900 dark:text-white">Dogfathers</h1>
                                <p class="text-[9px] text-groomer-primary font-bold uppercase tracking-[0.15em]">Workflow Manager</p>
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <nav class="space-y-1">
                            <button onclick="setGroomerTab('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${groomerTab === 'dashboard' ? 'bg-groomer-primary text-white font-bold shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800 font-medium'} transition-all">
                                <span class="material-symbols-outlined text-xl">dashboard</span>
                                <span class="text-sm">Dashboard</span>
                            </button>
                            <button onclick="setGroomerTab('schedule')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${groomerTab === 'schedule' ? 'bg-groomer-primary text-white font-bold shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800 font-medium'} transition-all">
                                <span class="material-symbols-outlined text-xl">calendar_today</span>
                                <span class="text-sm">Schedule</span>
                            </button>
                            <button onclick="setGroomerTab('history')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${groomerTab === 'history' ? 'bg-groomer-primary text-white font-bold shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800 font-medium'} transition-all">
                                <span class="material-symbols-outlined text-xl">history</span>
                                <span class="text-sm">History</span>
                            </button>
                            <button onclick="setGroomerTab('messages')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${groomerTab === 'messages' ? 'bg-groomer-primary text-white font-bold shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800 font-medium'} transition-all relative">
                                <span class="material-symbols-outlined text-xl">chat_bubble</span>
                                <span class="text-sm">Messages</span>
                                ${unreadMessages > 0 ? `<span class="absolute right-3 w-5 h-5 bg-tech-magenta text-white text-xs font-bold rounded-full flex items-center justify-center">${unreadMessages}</span>` : ''}
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Bottom Section -->
                    <div class="mt-auto p-5">
                        <!-- Sign Out -->
                        <button onclick="handleSignOut()" class="w-full text-slate-500 dark:text-slate-400 py-2 rounded-lg font-medium flex items-center justify-center gap-2 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all text-sm">
                            <span class="material-symbols-outlined text-lg">logout</span>
                            Sign Out
                        </button>
                    </div>
                </aside>
                
                <!-- Main Content -->
                <main class="flex-1 flex flex-col overflow-hidden">
                    <!-- Mobile Header -->
                    <header class="h-14 lg:h-16 flex items-center justify-between px-4 lg:px-10 glass-card border-b border-slate-200/50 dark:border-slate-800/50 z-10">
                        <!-- Logo on Mobile / Search on Desktop -->
                        <div class="flex items-center gap-2 lg:hidden">
                            <div class="w-8 h-8 bg-groomer-primary rounded-lg flex items-center justify-center text-white">
                                <span class="material-symbols-outlined text-lg">pets</span>
                            </div>
                            <span class="font-bold text-slate-900 dark:text-white">Dogfathers</span>
                        </div>
                        <div class="relative hidden lg:block">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                            <input type="text" placeholder="Find a pet..." class="pl-10 pr-4 py-2 bg-white/50 dark:bg-slate-800/50 border border-slate-200/50 dark:border-slate-700/50 rounded-lg text-sm focus:ring-2 focus:ring-tech-purple/30 focus:border-tech-purple w-64 placeholder:text-slate-400"/>
                        </div>
                        
                        <div class="flex items-center gap-2 lg:gap-3">
                            <button onclick="toggleNotifications()" class="w-10 h-10 lg:w-auto lg:h-auto lg:p-2.5 flex items-center justify-center hover:bg-tech-purple/10 dark:hover:bg-slate-800 rounded-xl transition-colors relative touch-target" title="Notifications">
                                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span>
                                ${state.unreadNotifications > 0 ? `<span class="absolute top-0 right-0 lg:-top-1 lg:-right-1 w-5 h-5 bg-tech-magenta text-white text-xs font-bold rounded-full flex items-center justify-center">${state.unreadNotifications > 9 ? '9+' : state.unreadNotifications}</span>` : ''}
                            </button>
                            
                            <button onclick="openChangePassword()" class="hidden lg:flex p-2.5 hover:bg-groomer-primary/10 dark:hover:bg-slate-800 rounded-xl transition-colors" title="Settings">
                                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">settings</span>
                            </button>
                            
                            <!-- User Profile -->
                            <div class="flex items-center gap-2 lg:gap-3 pl-2 lg:pl-3 border-l border-slate-200/50 dark:border-slate-700/50">
                                <div class="text-right hidden lg:block">
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">${user.name || 'Groomer'}</p>
                                    <p class="text-[10px] text-slate-500 uppercase tracking-wider">Head Groomer</p>
                                </div>
                                <div class="w-9 h-9 lg:h-10 lg:w-10 rounded-full border-2 border-tech-purple/30 shadow-sm bg-gradient-to-br from-tech-purple to-tech-magenta flex items-center justify-center">
                                    <span class="text-white font-bold text-xs lg:text-sm">${(user.name || 'G').charAt(0).toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <!-- Content Area - Extra padding at bottom for mobile nav -->
                    <div class="flex-1 overflow-y-auto p-4 lg:p-10 space-y-6 pb-28 lg:pb-10 safe-bottom">
                        ${groomerTab === 'dashboard' ? renderGroomerDashboardContent(todayAppts, upcomingAppts, completedAppts, todayEarnings, inProgressAppt) : ''}
                        ${groomerTab === 'schedule' ? renderGroomerScheduleContent(todayAppts, upcomingAppts, completedAppts) : ''}
                        ${groomerTab === 'history' ? renderGroomerHistoryContent() : ''}
                        ${groomerTab === 'messages' ? renderGroomerMessagesContent() : ''}
                    </div>
                    
                    <!-- Mobile Bottom Navigation Bar -->
                    <nav class="lg:hidden fixed bottom-0 left-0 right-0 z-50 glass-card border-t border-slate-200/50 dark:border-slate-800/50 safe-bottom">
                        <div class="flex items-center justify-around h-16 px-2">
                            <button onclick="setGroomerTab('dashboard')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all touch-target ${groomerTab === 'dashboard' ? 'text-groomer-primary' : 'text-slate-400'}">
                                <span class="material-symbols-outlined text-2xl ${groomerTab === 'dashboard' ? 'fill-1' : ''}">dashboard</span>
                                <span class="text-[10px] font-bold mt-0.5">Home</span>
                            </button>
                            <button onclick="setGroomerTab('schedule')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all touch-target ${groomerTab === 'schedule' ? 'text-groomer-primary' : 'text-slate-400'}">
                                <span class="material-symbols-outlined text-2xl ${groomerTab === 'schedule' ? 'fill-1' : ''}">calendar_today</span>
                                <span class="text-[10px] font-bold mt-0.5">Schedule</span>
                            </button>
                            
                            <!-- Center FAB -->
                            <div class="relative -mt-8">
                                <button onclick="showQuickActions()" class="w-14 h-14 rounded-full bg-groomer-primary text-white flex items-center justify-center shadow-xl shadow-groomer-primary/40 active:scale-95 transition-transform">
                                    <span class="material-symbols-outlined text-2xl">add</span>
                                </button>
                            </div>
                            
                            <button onclick="setGroomerTab('messages')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all touch-target relative ${groomerTab === 'messages' ? 'text-groomer-primary' : 'text-slate-400'}">
                                <span class="material-symbols-outlined text-2xl ${groomerTab === 'messages' ? 'fill-1' : ''}">chat_bubble</span>
                                <span class="text-[10px] font-bold mt-0.5">Messages</span>
                                ${unreadMessages > 0 ? `<span class="absolute top-1 right-3 w-4 h-4 bg-tech-magenta text-white text-[8px] font-bold rounded-full flex items-center justify-center">${unreadMessages}</span>` : ''}
                            </button>
                            <button onclick="openMobileMenu()" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all touch-target text-slate-400">
                                <span class="material-symbols-outlined text-2xl">menu</span>
                                <span class="text-[10px] font-bold mt-0.5">More</span>
                            </button>
                        </div>
                    </nav>
                    
                    <!-- Desktop FAB -->
                    <div class="hidden lg:block fixed bottom-8 right-8 z-50">
                        <button onclick="showQuickActions()" class="w-14 h-14 rounded-full bg-groomer-primary text-white flex items-center justify-center shadow-2xl shadow-groomer-primary/40 hover:scale-110 transition-transform group">
                            <span class="material-symbols-outlined text-2xl">add</span>
                            <span class="absolute right-16 bg-slate-900 text-white px-3 py-1.5 rounded-lg text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">Quick Actions</span>
                        </button>
                    </div>
                </main>
            </div>
            
            <!-- Mobile Menu Modal -->
            ${state.showMobileMenu ? `
            <div class="fixed inset-0 z-[200] lg:hidden" onclick="closeMobileMenu()">
                <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                <div class="absolute bottom-0 left-0 right-0 glass-card rounded-t-3xl p-6 pb-10 safe-bottom animate-slide-up" onclick="event.stopPropagation()">
                    <div class="w-12 h-1 bg-slate-300 dark:bg-slate-600 rounded-full mx-auto mb-6"></div>
                    <div class="space-y-2">
                        <button onclick="setGroomerTab('history'); closeMobileMenu();" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors touch-target">
                            <span class="material-symbols-outlined text-slate-600 dark:text-slate-400">history</span>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Appointment History</span>
                        </button>
                        <button onclick="openChangePassword(); closeMobileMenu();" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors touch-target">
                            <span class="material-symbols-outlined text-slate-600 dark:text-slate-400">settings</span>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Settings</span>
                        </button>
                        <div class="border-t border-slate-200 dark:border-slate-700 my-2"></div>
                        <button onclick="handleSignOut()" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors touch-target">
                            <span class="material-symbols-outlined text-red-500">logout</span>
                            <span class="font-medium text-red-500">Sign Out</span>
                        </button>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- Quick Actions Modal -->
            ${state.showQuickActions ? `
            <div class="fixed inset-0 z-[200]" onclick="closeQuickActions()">
                <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                <div class="absolute bottom-20 lg:bottom-24 right-4 lg:right-8 glass-card rounded-2xl p-2 shadow-2xl animate-scale-up" onclick="event.stopPropagation()">
                    <div class="space-y-1">
                        <button onclick="alert('Call admin to add appointment'); closeQuickActions();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors touch-target">
                            <div class="w-10 h-10 rounded-full bg-groomer-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-groomer-primary">event</span>
                            </div>
                            <span class="font-medium text-slate-700 dark:text-slate-300 pr-4">New Appointment</span>
                        </button>
                        <button onclick="window.location.href='tel:+13235551234'; closeQuickActions();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors touch-target">
                            <div class="w-10 h-10 rounded-full bg-tech-purple/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-tech-purple">call</span>
                            </div>
                            <span class="font-medium text-slate-700 dark:text-slate-300 pr-4">Call Office</span>
                        </button>
                    </div>
                </div>
            </div>
            ` : ''}
            
            ${state.showNotifications ? renderNotificationsPanel() : ''}
            ${state.showAppointmentDetail && state.selectedAppointment ? renderAppointmentDetailModal(state.selectedAppointment) : ''}`;
        }
        
        // Groomer Dashboard Content
        function renderGroomerDashboardContent(todayAppts, upcomingAppts, completedAppts, todayEarnings, inProgressAppt) {
            // Get all in-progress appointments (could be multiple)
            const allInProgress = (state.groomerAppointments || []).filter(a => a.status === 'in_progress');
            const pendingToday = todayAppts.filter(a => a.status !== 'in_progress');
            const today = getTodayPacific();
            
            // Calculate today's completed - use completed_at date (when actually completed), not appointment_date
            const todayCompletedAppts = completedAppts.filter(a => {
                // Check completed_at timestamp for today's date
                if (a.completed_at) {
                    const completedDate = new Date(a.completed_at).toLocaleDateString('en-CA', { timeZone: TIMEZONE });
                    return completedDate === today;
                }
                // Fallback to appointment_date if no completed_at
                return a.appointment_date === today;
            });
            const todayCompletedCount = todayCompletedAppts.length;
            
            // Also get total all-time completed for reference
            const totalCompletedCount = completedAppts.length;
            
            // Calculate earnings
            const todayEarningsAmount = todayCompletedAppts.reduce((sum, a) => sum + (parseFloat(a.total_price) || 0), 0);
            const pendingEarningsAmount = [...allInProgress, ...pendingToday].reduce((sum, a) => sum + (parseFloat(a.total_price) || 0), 0);
            const dailyGoal = 500; // Default daily goal
            const earningsProgress = Math.min(Math.round((todayEarningsAmount / dailyGoal) * 100), 100);
            
            // Get next appointment - TODAY ONLY for "Next Up"
            const nextTodayAppt = pendingToday.length > 0 ? pendingToday[0] : null;
            
            // Get next future appointment (for preview)
            const nextFutureAppt = upcomingAppts.length > 0 ? upcomingAppts[0] : null;
            
            // Get groomer name from currentUser
            const groomerName = state.currentUser?.name?.split(' ')[0] || 'there';
            
            // Time-based greeting
            const hour = new Date().getHours();
            const timeGreeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            const greetingEmoji = hour < 12 ? 'â˜€ï¸' : hour < 17 ? 'ðŸŒ¤ï¸' : 'ðŸŒ™';
            
            // Format today's date nicely
            const todayDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric',
                timeZone: TIMEZONE
            });
            
            // Calculate time until next appointment
            let timeUntilNext = '';
            if (nextTodayAppt && nextTodayAppt.start_time) {
                const [hours, minutes] = nextTodayAppt.start_time.split(':');
                const aptTime = new Date();
                aptTime.setHours(parseInt(hours), parseInt(minutes), 0);
                const now = new Date();
                const diffMs = aptTime - now;
                if (diffMs > 0) {
                    const diffMins = Math.floor(diffMs / 60000);
                    if (diffMins < 60) {
                        timeUntilNext = `Starts in ${diffMins} min`;
                    } else {
                        const diffHours = Math.floor(diffMins / 60);
                        const remainMins = diffMins % 60;
                        timeUntilNext = `Starts in ${diffHours}h ${remainMins}m`;
                    }
                } else {
                    timeUntilNext = 'Starting soon';
                }
            }
            
            return `
                <!-- #1 HERO SECTION - Gradient Banner with Time-based Greeting -->
                <div class="relative overflow-hidden rounded-3xl mb-6 bg-gradient-to-br from-groomer-primary via-teal-500 to-emerald-400 p-6 lg:p-8 text-white shadow-xl shadow-groomer-primary/20">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <defs>
                                <pattern id="paw-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <circle cx="5" cy="5" r="2" fill="currentColor"/>
                                    <circle cx="10" cy="3" r="1.5" fill="currentColor"/>
                                    <circle cx="14" cy="6" r="1.5" fill="currentColor"/>
                                    <circle cx="8" cy="10" r="1.5" fill="currentColor"/>
                                </pattern>
                            </defs>
                            <rect width="100" height="100" fill="url(#paw-pattern)"/>
                        </svg>
                    </div>
                    
                    <div class="relative z-10">
                        <!-- Top Row: Date & Weather placeholder -->
                        <div class="flex items-center justify-between mb-4 text-white/80 text-sm">
                            <span class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">calendar_today</span>
                                ${todayDate}
                            </span>
                            <span class="flex items-center gap-1 bg-white/20 px-3 py-1 rounded-full text-xs font-medium">
                                ${greetingEmoji} ${timeGreeting.split(' ')[1]}
                            </span>
                        </div>
                        
                        <!-- Main Greeting -->
                        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold leading-tight mb-2">
                            ${timeGreeting}, ${groomerName}! 
                        </h1>
                        <p class="text-white/80 text-sm sm:text-base">
                            ${allInProgress.length > 0 
                                ? `You have ${allInProgress.length} pet${allInProgress.length > 1 ? 's' : ''} in progress right now! ðŸ•` 
                                : pendingToday.length > 0 
                                    ? `${pendingToday.length} appointment${pendingToday.length > 1 ? 's' : ''} lined up for today. Let's make them beautiful! âœ¨`
                                    : todayCompletedCount > 0
                                        ? `Amazing work! You've completed ${todayCompletedCount} groom${todayCompletedCount > 1 ? 's' : ''} today! ðŸŽ‰`
                                        : `Ready to start your day? Check your schedule! ðŸ“…`
                            }
                        </p>
                    </div>
                </div>
                
                <!-- #2 STAT CARDS - Enhanced with Gradients & Visual Interest -->
                <div class="flex gap-4 overflow-x-auto pb-4 -mx-6 px-6 lg:mx-0 lg:px-0 lg:grid lg:grid-cols-3 lg:overflow-visible scrollbar-hide snap-x snap-mandatory">
                    
                    <!-- In Progress Card - Purple Gradient -->
                    <div onclick="document.getElementById('inprogress-section')?.scrollIntoView({behavior: 'smooth'})" class="relative overflow-hidden rounded-2xl min-w-[160px] sm:min-w-[200px] lg:min-w-0 flex-shrink-0 snap-start cursor-pointer active:scale-95 transition-all hover:shadow-lg group ${allInProgress.length > 0 ? 'bg-gradient-to-br from-purple-500 to-indigo-600 text-white shadow-lg shadow-purple-500/30' : 'glass-card'}">
                        ${allInProgress.length > 0 ? `
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        ` : ''}
                        <div class="relative p-4 sm:p-5">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl ${allInProgress.length > 0 ? 'bg-white/20' : 'bg-purple-100 dark:bg-purple-900/30'} flex items-center justify-center">
                                    <span class="material-symbols-outlined ${allInProgress.length > 0 ? 'text-white' : 'text-purple-600'} text-xl sm:text-2xl">content_cut</span>
                                </div>
                                ${allInProgress.length > 0 ? `
                                    <span class="flex items-center gap-1 px-2 py-0.5 bg-white/20 text-[9px] sm:text-[10px] font-bold uppercase rounded-full">
                                        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                                        Live
                                    </span>
                                ` : `
                                    <span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-600 text-[9px] sm:text-[10px] font-bold uppercase rounded-full">Ready</span>
                                `}
                            </div>
                            <p class="${allInProgress.length > 0 ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'} text-xs sm:text-sm font-medium">In Progress</p>
                            <div class="flex items-end justify-between">
                                <p class="text-3xl sm:text-4xl font-extrabold ${allInProgress.length > 0 ? '' : 'text-slate-900 dark:text-white'}">${allInProgress.length}</p>
                                ${allInProgress.length > 0 && allInProgress[0] ? `
                                    <p class="text-xs ${allInProgress.length > 0 ? 'text-white/70' : 'text-slate-400'} truncate max-w-[80px]">${allInProgress[0].petName}</p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Next Appointment Card - Amber/Orange Gradient when active -->
                    <div onclick="${nextTodayAppt ? `openAppointmentDetail('${nextTodayAppt.id}')` : ''}" class="relative overflow-hidden rounded-2xl min-w-[180px] sm:min-w-[220px] lg:min-w-0 flex-shrink-0 snap-start ${nextTodayAppt ? 'cursor-pointer active:scale-95 bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-lg shadow-amber-500/30' : 'glass-card'} transition-all hover:shadow-lg">
                        ${nextTodayAppt ? `
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        ` : ''}
                        <div class="relative p-4 sm:p-5">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl ${nextTodayAppt ? 'bg-white/20' : 'bg-amber-100 dark:bg-amber-900/30'} flex items-center justify-center">
                                    <span class="material-symbols-outlined ${nextTodayAppt ? 'text-white' : 'text-amber-600 dark:text-amber-400'} text-xl sm:text-2xl">schedule</span>
                                </div>
                                <span class="px-2 py-0.5 ${nextTodayAppt ? 'bg-white/20' : 'bg-amber-100 dark:bg-amber-900/30 text-amber-600'} text-[9px] sm:text-[10px] font-bold uppercase rounded-full">
                                    ${nextTodayAppt ? timeUntilNext || 'Today' : 'Today'}
                                </span>
                            </div>
                            <p class="${nextTodayAppt ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'} text-xs sm:text-sm font-medium">Next Up</p>
                            ${nextTodayAppt ? `
                                <p class="text-2xl sm:text-3xl font-extrabold">${formatTime(nextTodayAppt.start_time)}</p>
                                <p class="text-xs text-white/80 font-medium mt-1 truncate">${nextTodayAppt.petName} â€¢ ${nextTodayAppt.serviceName || 'Groom'}</p>
                            ` : `
                                <p class="text-lg font-bold text-groomer-primary">All done! ðŸŽ‰</p>
                                ${nextFutureAppt ? `
                                    <p class="text-xs text-slate-400 mt-1">Next: ${formatDate(nextFutureAppt.appointment_date)}</p>
                                ` : `
                                    <p class="text-xs text-slate-400 mt-1">No upcoming scheduled</p>
                                `}
                            `}
                        </div>
                    </div>
                    
                    <!-- Completed Card - Green Gradient when has completions -->
                    <div onclick="document.getElementById('completed-section')?.scrollIntoView({behavior: 'smooth'})" class="relative overflow-hidden rounded-2xl min-w-[160px] sm:min-w-[200px] lg:min-w-0 flex-shrink-0 snap-start cursor-pointer active:scale-95 transition-all hover:shadow-lg ${todayCompletedCount > 0 ? 'bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-lg shadow-emerald-500/30' : 'glass-card'}">
                        ${todayCompletedCount > 0 ? `
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        ` : ''}
                        <div class="relative p-4 sm:p-5">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl ${todayCompletedCount > 0 ? 'bg-white/20' : 'bg-emerald-100 dark:bg-emerald-900/30'} flex items-center justify-center">
                                    <span class="material-symbols-outlined ${todayCompletedCount > 0 ? 'text-white' : 'text-emerald-600'} text-xl sm:text-2xl">verified</span>
                                </div>
                                <span class="px-2 py-0.5 ${todayCompletedCount > 0 ? 'bg-white/20' : 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600'} text-[9px] sm:text-[10px] font-bold uppercase rounded-full">
                                    ${todayCompletedCount > 0 ? `$${todayEarningsAmount.toFixed(0)}` : 'Today'}
                                </span>
                            </div>
                            <p class="${todayCompletedCount > 0 ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'} text-xs sm:text-sm font-medium">Completed</p>
                            <div class="flex items-end justify-between">
                                <p class="text-3xl sm:text-4xl font-extrabold ${todayCompletedCount > 0 ? '' : 'text-slate-900 dark:text-white'}">${todayCompletedCount}</p>
                                ${todayCompletedCount > 0 ? `
                                    <p class="text-xs text-white/70">grooms today</p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Tab Switcher for Columns -->
                <div class="flex gap-2 overflow-x-auto pb-2 -mx-6 px-6 lg:hidden scrollbar-hide">
                    <button onclick="state.mobileTab = 'inprogress'; render();" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all touch-target ${state.mobileTab === 'inprogress' || !state.mobileTab ? 'bg-tech-purple text-white' : 'bg-white/50 text-slate-600 border border-slate-200'}">
                        ðŸ”µ In Progress (${allInProgress.length})
                    </button>
                    <button onclick="state.mobileTab = 'upcoming'; render();" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all touch-target ${state.mobileTab === 'upcoming' ? 'bg-amber-500 text-white' : 'bg-white/50 text-slate-600 border border-slate-200'}">
                        ðŸŸ¡ Upcoming (${pendingToday.length})
                    </button>
                    <button onclick="state.mobileTab = 'completed'; render();" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all touch-target ${state.mobileTab === 'completed' ? 'bg-groomer-primary text-white' : 'bg-white/50 text-slate-600 border border-slate-200'}">
                        âœ… Completed (${todayCompletedCount})
                    </button>
                </div>
                
                <!-- Mobile: Single Column View -->
                <div class="lg:hidden space-y-4 mt-4">
                    ${(!state.mobileTab || state.mobileTab === 'inprogress') ? `
                        <!-- In Progress Section Mobile -->
                        <div id="inprogress-section" class="space-y-3">
                            ${allInProgress.length > 0 ? allInProgress.map(apt => {
                                const elapsed = apt.started_at ? Math.floor((new Date() - new Date(apt.started_at)) / 60000) : 0;
                                const estimatedDuration = apt.duration_minutes || 60;
                                const progress = Math.min(Math.round((elapsed / estimatedDuration) * 100), 100);
                                const stage = elapsed < 15 ? 'Prep' : elapsed < estimatedDuration * 0.7 ? 'In Bath' : 'Finishing';
                                
                                return `
                                <div class="glass-card rounded-2xl p-4 active:scale-[0.98] transition-transform">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-14 h-14 rounded-2xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400 text-2xl">pets</span>`}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white text-lg hover:text-groomer-primary transition-colors flex items-center gap-1">
                                                    ${apt.petName}
                                                    <span class="material-symbols-outlined text-sm text-slate-400">info</span>
                                                </button>
                                                <span class="text-tech-purple font-bold">${formatTime(apt.start_time)}</span>
                                            </div>
                                            <p class="text-sm text-slate-500">${apt.serviceName || 'Grooming'}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="mb-3">
                                        <div class="flex items-center justify-between text-xs mb-1.5">
                                            <span class="text-tech-purple font-bold">${stage}</span>
                                            <span class="text-slate-400">${progress}%</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-tech-purple to-tech-magenta rounded-full transition-all" style="width: ${progress}%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex gap-2">
                                        <button onclick="openAppointmentDetail('${apt.id}')" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-xl touch-target transition-colors active:bg-slate-200">
                                            Details
                                        </button>
                                        <button onclick="openCompleteAppointmentModal('${apt.id}')" class="flex-1 py-3 bg-groomer-primary text-white font-bold rounded-xl touch-target transition-colors active:bg-groomer-primary/90">
                                            Complete âœ“
                                        </button>
                                    </div>
                                </div>
                                `;
                            }).join('') : `
                                <div class="glass-card rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-full flex items-center justify-center">
                                        <span class="text-5xl">ðŸ•</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-1">Ready to Groom!</h4>
                                    <p class="text-sm text-slate-500 mb-3">No pets on the table yet</p>
                                    ${pendingToday.length > 0 ? `
                                        <p class="text-xs text-purple-600 font-medium bg-purple-50 dark:bg-purple-900/20 rounded-lg py-2 px-3">
                                            ðŸ‘‰ Tap "Check In" on upcoming to start
                                        </p>
                                    ` : `
                                        <p class="text-xs text-slate-400">
                                            Your schedule is clear - enjoy the break! â˜•
                                        </p>
                                    `}
                                </div>
                            `}
                        </div>
                    ` : ''}
                    
                    ${state.mobileTab === 'upcoming' ? `
                        <!-- Upcoming Section Mobile -->
                        <div class="space-y-3">
                            <!-- Today's Upcoming -->
                            ${pendingToday.length > 0 ? `
                                <p class="text-xs font-bold text-amber-600 uppercase tracking-wider px-1">Today</p>
                                ${pendingToday.map(apt => `
                                <div class="glass-card rounded-2xl p-4 active:scale-[0.98] transition-transform">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-14 h-14 rounded-2xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400 text-2xl">pets</span>`}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white text-lg hover:text-groomer-primary transition-colors flex items-center gap-1">
                                                    ${apt.petName}
                                                    <span class="material-symbols-outlined text-sm text-slate-400">info</span>
                                                </button>
                                                <span class="text-amber-600 font-bold">${formatTime(apt.start_time)}</span>
                                            </div>
                                            <p class="text-sm text-slate-500">${apt.serviceName || 'Grooming'} â€¢ ${apt.customerName}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex gap-2">
                                        <button onclick="openAppointmentDetail('${apt.id}')" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-xl touch-target transition-colors active:bg-slate-200">
                                            Details
                                        </button>
                                        <button onclick="startGroomingAppointment('${apt.id}')" class="flex-1 py-3 bg-groomer-primary text-white font-bold rounded-xl touch-target transition-colors active:bg-groomer-primary/90 flex items-center justify-center gap-2">
                                            <span class="material-symbols-outlined text-lg">play_arrow</span>
                                            Check In
                                        </button>
                                    </div>
                                </div>
                                `).join('')}
                            ` : ''}
                            
                            <!-- Future Appointments -->
                            ${upcomingAppts.length > 0 ? `
                                <p class="text-xs font-bold text-blue-600 uppercase tracking-wider px-1 ${pendingToday.length > 0 ? 'mt-4' : ''}">Coming Up</p>
                                ${upcomingAppts.slice(0, 5).map(apt => `
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-2xl p-4 active:scale-[0.98] transition-transform cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-14 h-14 rounded-2xl bg-blue-50 dark:bg-blue-900/20 overflow-hidden flex items-center justify-center flex-shrink-0">
                                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-blue-400 text-2xl">pets</span>`}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white text-lg hover:text-groomer-primary transition-colors">
                                                    ${apt.petName}
                                                </button>
                                                <span class="text-blue-600 font-bold text-sm">${formatDate(apt.appointment_date)}</span>
                                            </div>
                                            <p class="text-sm text-slate-500">${apt.serviceName || 'Grooming'} â€¢ ${formatTime(apt.start_time)}</p>
                                        </div>
                                        <span class="material-symbols-outlined text-slate-300">chevron_right</span>
                                    </div>
                                </div>
                                `).join('')}
                                ${upcomingAppts.length > 5 ? `
                                    <button onclick="setGroomerTab('schedule')" class="w-full py-3 glass-card rounded-xl text-sm text-slate-600 dark:text-slate-400 font-bold hover:bg-white/80 transition-colors">
                                        View All ${upcomingAppts.length} Scheduled â†’
                                    </button>
                                ` : ''}
                            ` : ''}
                            
                            ${pendingToday.length === 0 && upcomingAppts.length === 0 ? `
                                <div class="glass-card rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 rounded-full flex items-center justify-center">
                                        <span class="text-5xl">ðŸ“…</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-1">Schedule Clear!</h4>
                                    <p class="text-sm text-slate-500 mb-3">No appointments on the books</p>
                                    <p class="text-xs text-slate-400">
                                        Time to relax or check your History ðŸ“‹
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${state.mobileTab === 'completed' ? `
                        <!-- Completed Section Mobile -->
                        <div id="completed-section" class="space-y-3">
                            <!-- Show today's completed first, then recent if today is empty -->
                            ${todayCompletedAppts.length > 0 ? `
                                <p class="text-xs font-bold text-groomer-primary uppercase tracking-wider px-1">Completed Today (${todayCompletedCount})</p>
                            ` : totalCompletedCount > 0 ? `
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider px-1">Recent Completed (${totalCompletedCount} total)</p>
                            ` : ''}
                            
                            ${(todayCompletedAppts.length > 0 ? todayCompletedAppts : completedAppts.slice(0, 10)).map(apt => `
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-2xl p-4 active:scale-[0.98] transition-transform opacity-90">
                                    <div class="flex items-center gap-3">
                                        <div class="w-14 h-14 rounded-2xl bg-groomer-primary/10 overflow-hidden flex items-center justify-center flex-shrink-0 relative">
                                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-groomer-primary text-2xl">pets</span>`}
                                            <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-groomer-primary rounded-full flex items-center justify-center border-2 border-white">
                                                <span class="material-symbols-outlined text-white text-sm">check</span>
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white text-lg hover:text-groomer-primary transition-colors flex items-center gap-1">
                                                    ${apt.petName}
                                                    <span class="material-symbols-outlined text-sm text-slate-400">info</span>
                                                </button>
                                                <span class="text-slate-400 text-sm">${apt.completed_at ? new Date(apt.completed_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : formatTime(apt.start_time)}</span>
                                            </div>
                                            <p class="text-sm text-slate-500">${apt.serviceName || 'Grooming'}</p>
                                            <p class="text-xs text-groomer-primary font-medium mt-1">âœ“ Completed${apt.completed_at ? ' â€¢ ' + new Date(apt.completed_at).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : ''}</p>
                                        </div>
                                        <span class="material-symbols-outlined text-slate-300">chevron_right</span>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${totalCompletedCount === 0 ? `
                                <div class="glass-card rounded-2xl p-8 text-center">
                                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">task_alt</span>
                                    <p class="text-slate-500 font-medium">No completed appointments yet</p>
                                    <p class="text-sm text-slate-400 mt-1">Complete your first groom to see it here</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Desktop: Three Column Kanban Layout -->
                <div class="hidden lg:grid lg:grid-cols-3 gap-6 mt-6">
                    
                    <!-- #5 IN PROGRESS COLUMN - Enhanced Header with colored border -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-purple-500/10 to-transparent border-l-4 border-purple-500">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-lg">content_cut</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-slate-900 dark:text-white">In Progress</h3>
                                    <p class="text-[10px] text-slate-500">Currently grooming</p>
                                </div>
                            </div>
                            ${allInProgress.length > 0 ? `
                                <span class="flex items-center gap-1.5 px-2.5 py-1 bg-purple-500 text-white text-xs font-bold rounded-full">
                                    <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                                    ${allInProgress.length} LIVE
                                </span>
                            ` : `
                                <span class="px-2.5 py-1 bg-slate-100 dark:bg-slate-800 text-slate-400 text-xs font-bold rounded-full">0</span>
                            `}
                        </div>
                        
                        <div class="space-y-3">
                            ${allInProgress.length > 0 ? allInProgress.map(apt => {
                                const elapsed = apt.started_at ? Math.floor((new Date() - new Date(apt.started_at)) / 60000) : 0;
                                const estimatedDuration = apt.duration_minutes || 60;
                                const progress = Math.min(Math.round((elapsed / estimatedDuration) * 100), 100);
                                const stage = elapsed < 15 ? 'Prep & Setup' : elapsed < estimatedDuration * 0.5 ? 'Bath & Wash' : elapsed < estimatedDuration * 0.8 ? 'Grooming' : 'Finishing Up';
                                const stageIcon = elapsed < 15 ? 'check_circle' : elapsed < estimatedDuration * 0.5 ? 'water_drop' : elapsed < estimatedDuration * 0.8 ? 'content_cut' : 'auto_awesome';
                                
                                return `
                                <!-- #6 RICHER IN-PROGRESS CARD -->
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-2xl overflow-hidden cursor-pointer hover:shadow-xl transition-all border-l-4 border-purple-500 group">
                                    <!-- Card Header with gradient -->
                                    <div class="bg-gradient-to-r from-purple-500/5 to-transparent p-4">
                                        <div class="flex items-center gap-3">
                                            <div class="relative">
                                                <div class="w-14 h-14 rounded-2xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center ring-2 ring-purple-500/30">
                                                    ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400 text-2xl">pets</span>`}
                                                </div>
                                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center">
                                                    <span class="material-symbols-outlined text-white text-xs">${stageIcon}</span>
                                                </div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white hover:text-purple-600 transition-colors text-left text-lg">${apt.petName}</button>
                                                    <span class="text-xs font-bold text-purple-600 bg-purple-100 dark:bg-purple-900/30 px-2 py-0.5 rounded-full">${elapsed} min</span>
                                                </div>
                                                <p class="text-xs text-slate-500">${apt.petBreed || 'Dog'} â€¢ ${apt.petWeight ? apt.petWeight + ' lbs' : ''}</p>
                                                <p class="text-xs text-slate-400 truncate">${apt.serviceName || 'Full Grooming'} â€¢ $${apt.total_price || '0'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Section -->
                                    <div class="px-4 pb-4">
                                        <div class="flex items-center justify-between text-xs mb-2">
                                            <span class="flex items-center gap-1 text-purple-600 font-bold">
                                                <span class="material-symbols-outlined text-sm">${stageIcon}</span>
                                                ${stage}
                                            </span>
                                            <span class="text-slate-400">${progress}% complete</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                                        </div>
                                        
                                        <button onclick="event.stopPropagation(); openCompleteAppointmentModal('${apt.id}')" class="mt-4 w-full py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white text-sm font-bold rounded-xl transition-all shadow-lg shadow-purple-500/25 flex items-center justify-center gap-2">
                                            <span class="material-symbols-outlined text-lg">check_circle</span>
                                            Mark Complete
                                        </button>
                                    </div>
                                </div>
                                `;
                            }).join('') : `
                                <!-- #4 BETTER EMPTY STATE - In Progress -->
                                <div class="glass-card rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-full flex items-center justify-center">
                                        <span class="text-5xl">ðŸ•</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-1">Ready to Groom!</h4>
                                    <p class="text-sm text-slate-500 mb-4">No pets on the table yet</p>
                                    ${pendingToday.length > 0 ? `
                                        <p class="text-xs text-purple-600 font-medium">
                                            ðŸ‘‰ Check in your next appointment to start
                                        </p>
                                    ` : `
                                        <p class="text-xs text-slate-400">
                                            Your schedule is clear - enjoy the break! â˜•
                                        </p>
                                    `}
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- #5 UPCOMING COLUMN - Enhanced Header -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-amber-500/10 to-transparent border-l-4 border-amber-500">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-lg">schedule</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-slate-900 dark:text-white">Upcoming</h3>
                                    <p class="text-[10px] text-slate-500">Scheduled appointments</p>
                                </div>
                            </div>
                            <span class="px-2.5 py-1 ${pendingToday.length > 0 ? 'bg-amber-500 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'} text-xs font-bold rounded-full">
                                ${pendingToday.length > 0 ? pendingToday.length + ' TODAY' : upcomingAppts.length > 0 ? upcomingAppts.length : '0'}
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Today's Appointments -->
                            ${pendingToday.length > 0 ? `
                                <p class="text-[10px] font-bold text-amber-600 uppercase tracking-wider flex items-center gap-1">
                                    <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
                                    Today's Queue
                                </p>
                                ${pendingToday.slice(0, 3).map((apt, idx) => {
                                    // Calculate time until appointment
                                    let countdown = '';
                                    if (apt.start_time) {
                                        const [h, m] = apt.start_time.split(':');
                                        const aptTime = new Date();
                                        aptTime.setHours(parseInt(h), parseInt(m), 0);
                                        const diffMs = aptTime - new Date();
                                        if (diffMs > 0) {
                                            const mins = Math.floor(diffMs / 60000);
                                            countdown = mins < 60 ? mins + ' min' : Math.floor(mins/60) + 'h ' + (mins%60) + 'm';
                                        }
                                    }
                                    return `
                                <!-- #6 RICHER UPCOMING CARD -->
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-2xl overflow-hidden cursor-pointer hover:shadow-xl transition-all border-l-4 border-amber-500 group">
                                    <div class="p-4">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="w-12 h-12 rounded-xl bg-amber-50 dark:bg-amber-900/20 overflow-hidden flex items-center justify-center">
                                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-amber-500 text-xl">pets</span>`}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white hover:text-amber-600 transition-colors text-left">${apt.petName}</button>
                                                    <span class="text-sm font-bold text-amber-600">${formatTime(apt.start_time)}</span>
                                                </div>
                                                <p class="text-xs text-slate-500">${apt.serviceName || 'Grooming'} â€¢ $${apt.total_price || '0'}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Address Preview -->
                                        <div class="flex items-center gap-2 text-xs text-slate-500 mb-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg p-2">
                                            <span class="material-symbols-outlined text-sm text-slate-400">location_on</span>
                                            <span class="truncate">${apt.customerAddress || 'Address not provided'}</span>
                                        </div>
                                        
                                        <!-- Countdown & Actions -->
                                        <div class="flex items-center justify-between">
                                            ${countdown ? `
                                                <span class="text-xs font-medium text-amber-600 bg-amber-100 dark:bg-amber-900/30 px-2 py-1 rounded-full flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-sm">timer</span>
                                                    ${countdown}
                                                </span>
                                            ` : `
                                                <span class="text-xs font-medium text-green-600 bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full">
                                                    Ready now
                                                </span>
                                            `}
                                            <button onclick="event.stopPropagation(); startGroomingAppointment('${apt.id}')" class="px-4 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-1">
                                                <span class="material-symbols-outlined text-sm">play_arrow</span>
                                                Check In
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                `;}).join('')}
                            ` : ''}
                            
                            <!-- Future Appointments -->
                            ${upcomingAppts.length > 0 ? `
                                <p class="text-[10px] font-bold text-blue-500 uppercase tracking-wider flex items-center gap-1 ${pendingToday.length > 0 ? 'mt-3' : ''}">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                    Coming Up
                                </p>
                                ${upcomingAppts.slice(0, pendingToday.length > 0 ? 2 : 4).map(apt => `
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-xl p-3 cursor-pointer hover:shadow-lg transition-all border-l-4 border-blue-400 group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="w-10 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 overflow-hidden flex items-center justify-center">
                                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-blue-400 text-lg">pets</span>`}
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-900 dark:text-white text-sm group-hover:text-blue-600 transition-colors">${apt.petName}</p>
                                                <p class="text-[10px] text-slate-500">${apt.serviceName || 'Grooming'} â€¢ $${apt.total_price || '0'}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs font-bold text-blue-600">${formatDate(apt.appointment_date)}</p>
                                            <p class="text-[10px] text-slate-400">${formatTime(apt.start_time)}</p>
                                        </div>
                                    </div>
                                </div>
                                `).join('')}
                            ` : ''}
                            
                            ${pendingToday.length === 0 && upcomingAppts.length === 0 ? `
                                <!-- #4 BETTER EMPTY STATE - Upcoming -->
                                <div class="glass-card rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 rounded-full flex items-center justify-center">
                                        <span class="text-5xl">ðŸ“…</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-1">Schedule Clear!</h4>
                                    <p class="text-sm text-slate-500 mb-4">No appointments on the books</p>
                                    <p class="text-xs text-slate-400">
                                        Time to relax or check the History tab ðŸ“‹
                                    </p>
                                </div>
                            ` : ''}
                            
                            ${(pendingToday.length > 3 || upcomingAppts.length > 4) ? `
                                <button onclick="setGroomerTab('schedule')" class="w-full py-2.5 glass-card rounded-xl text-sm text-amber-600 font-bold hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-colors flex items-center justify-center gap-1">
                                    View Full Schedule
                                    <span class="material-symbols-outlined text-lg">arrow_forward</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- #5 COMPLETED COLUMN - Enhanced Header -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-emerald-500/10 to-transparent border-l-4 border-emerald-500">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-lg">verified</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-slate-900 dark:text-white">Completed</h3>
                                    <p class="text-[10px] text-slate-500">Finished grooms</p>
                                </div>
                            </div>
                            <span class="px-2.5 py-1 ${todayCompletedCount > 0 ? 'bg-emerald-500 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'} text-xs font-bold rounded-full">
                                ${todayCompletedCount > 0 ? '$' + todayEarningsAmount.toFixed(0) : totalCompletedCount}
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            ${todayCompletedAppts.length > 0 ? `
                                <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider flex items-center gap-1">
                                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                                    Today's Grooms (${todayCompletedCount})
                                </p>
                            ` : totalCompletedCount > 0 ? `
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                    <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                                    Recent
                                </p>
                            ` : ''}
                            
                            ${(todayCompletedAppts.length > 0 ? todayCompletedAppts.slice(0, 5) : completedAppts.slice(0, 5)).map(apt => {
                                return `
                                <!-- #6 RICHER COMPLETED CARD -->
                                <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-2xl overflow-hidden cursor-pointer hover:shadow-lg transition-all border-l-4 border-emerald-500 group">
                                    <div class="p-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="relative">
                                                    <div class="w-12 h-12 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 overflow-hidden flex items-center justify-center">
                                                        ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-emerald-500 text-xl">pets</span>`}
                                                    </div>
                                                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg">
                                                        <span class="material-symbols-outlined text-white text-xs">check</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress}).replace(/"/g, '&quot;')})" class="font-bold text-slate-900 dark:text-white hover:text-emerald-600 transition-colors text-left">${apt.petName}</button>
                                                    <p class="text-xs text-slate-500">${apt.serviceName || 'Grooming'}</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-bold text-emerald-600">$${apt.total_price || '0'}</p>
                                                <p class="text-[10px] text-slate-400">${apt.completed_at ? new Date(apt.completed_at).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : ''}</p>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
                                            <span class="text-xs font-medium text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full flex items-center gap-1">
                                                <span class="material-symbols-outlined text-xs">check_circle</span>
                                                Complete
                                            </span>
                                            <span class="text-xs text-slate-400">${apt.completed_at ? new Date(apt.completed_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : formatDate(apt.appointment_date)}</span>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            
                            ${totalCompletedCount === 0 ? `
                                <!-- #4 BETTER EMPTY STATE - Completed -->
                                <div class="glass-card rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-full flex items-center justify-center">
                                        <span class="text-5xl">ðŸ†</span>
                                    </div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-1">Your Trophy Case</h4>
                                    <p class="text-sm text-slate-500 mb-4">Completed grooms will appear here</p>
                                    <p class="text-xs text-slate-400">
                                        Start grooming to build your record! ðŸ’ª
                                    </p>
                                </div>
                            ` : ''}
                            
                            ${totalCompletedCount > 5 ? `
                                <button onclick="setGroomerTab('history')" class="w-full py-2.5 glass-card rounded-xl text-sm text-emerald-600 font-bold hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors flex items-center justify-center gap-1">
                                    View All ${totalCompletedCount} Completed
                                    <span class="material-symbols-outlined text-lg">arrow_forward</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // New Groomer Appointment Card (prettier version)
        function renderGroomerAppointmentCardNew(apt, isUpcoming = false, isCompleted = false, isCurrentStop = false) {
            const statusColors = {
                pending: 'bg-amber-100 text-amber-700 border-amber-200',
                confirmed: 'bg-blue-100 text-blue-700 border-blue-200',
                in_progress: 'bg-purple-100 text-purple-700 border-purple-200',
                completed: 'bg-green-100 text-green-700 border-green-200',
                cancelled: 'bg-red-100 text-red-700 border-red-200'
            };
            
            const fullAddress = apt.service_address || apt.customerAddress || '';
            const city = apt.service_city || apt.customerCity || '';
            const displayAddress = fullAddress ? (fullAddress + (city ? ', ' + city : '')) : 'Address not provided';
            const mapsUrl = fullAddress ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(displayAddress)}` : '';
            const phoneClean = (apt.customerPhone || '').replace(/[^0-9+]/g, '');
            
            // Combine notes: pet grooming notes + customer appointment notes
            const petNotes = apt.petNotes || apt.pet?.grooming_notes || '';
            const customerNotes = apt.customer_notes || apt.notes || '';
            const hasNotes = petNotes || customerNotes;
            
            // Calculate elapsed time if in progress
            let elapsedTime = '';
            if (apt.status === 'in_progress' && apt.started_at) {
                const started = new Date(apt.started_at);
                const now = new Date();
                const mins = Math.floor((now - started) / 60000);
                elapsedTime = mins < 60 ? `${mins}m` : `${Math.floor(mins/60)}h ${mins%60}m`;
            }
            
            if (apt.status === 'in_progress') {
                // Current in-progress appointment - special highlighted card
                return `
                <div class="glass-card border-l-4 border-l-tech-purple rounded-2xl p-5 soft-lift">
                    <!-- Header: Pet info + Time -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="h-14 w-14 rounded-2xl bg-tech-purple/10 overflow-hidden ring-4 ring-tech-purple/20 flex items-center justify-center flex-shrink-0">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-2xl text-tech-purple">pets</span>`}
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h4 class="text-lg font-extrabold text-slate-900 dark:text-white leading-tight">${apt.petName}</h4>
                                    <span class="px-2 py-0.5 bg-tech-purple text-white text-[10px] font-black uppercase rounded flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                                        In Progress
                                    </span>
                                </div>
                                <p class="text-sm text-slate-500 font-semibold">${apt.petBreed || 'Pet'} â€¢ ${apt.serviceName}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-lg font-extrabold text-tech-purple leading-tight">${formatTime(apt.start_time)}</p>
                            <p class="text-xs text-tech-magenta font-bold uppercase tracking-tighter">${elapsedTime} elapsed</p>
                        </div>
                    </div>
                    
                    <!-- Notes Section (Pet + Customer) -->
                    ${hasNotes ? `
                    <div class="mb-3 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl">
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-amber-600 text-lg flex-shrink-0">warning</span>
                            <div class="text-sm">
                                ${petNotes ? `<p class="text-amber-800 dark:text-amber-200"><span class="font-bold">Pet:</span> ${petNotes}</p>` : ''}
                                ${customerNotes ? `<p class="text-amber-700 dark:text-amber-300 ${petNotes ? 'mt-1' : ''}"><span class="font-bold">Note:</span> ${customerNotes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Address with Navigate -->
                    <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 bg-white/50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-200/50 dark:border-slate-800 mb-3">
                        <span class="material-symbols-outlined text-tech-purple flex-shrink-0">location_on</span>
                        <span class="font-medium flex-1 truncate">${displayAddress}</span>
                        ${mapsUrl ? `<a href="${mapsUrl}" target="_blank" class="flex-shrink-0 px-3 py-1.5 bg-groomer-primary text-white text-xs font-bold uppercase rounded-lg hover:opacity-90 transition-colors touch-target">Navigate</a>` : ''}
                    </div>
                    
                    <!-- Customer Contact -->
                    <div class="flex items-center gap-2 text-sm mb-4">
                        <span class="material-symbols-outlined text-slate-400 text-lg">person</span>
                        <span class="font-medium dark:text-white flex-1 truncate">${apt.customerName}</span>
                        ${phoneClean ? `
                            <a href="tel:${phoneClean}" class="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors touch-target" title="Call">
                                <span class="material-symbols-outlined text-lg">call</span>
                            </a>
                            <a href="sms:${phoneClean}" class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors touch-target" title="Text">
                                <span class="material-symbols-outlined text-lg">sms</span>
                            </a>
                        ` : ''}
                    </div>
                    
                    <!-- Complete Button -->
                    <button onclick="openCompleteAppointmentModal('${apt.id}')" class="w-full py-3.5 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg shadow-emerald-500/30 touch-target">
                        <span class="material-symbols-outlined">check_circle</span>
                        Complete Appointment
                    </button>
                </div>`;
            }
            
            // Regular appointment card (confirmed, pending, or completed)
            return `
            <div class="glass-card ${isCurrentStop ? 'border-l-4 border-l-groomer-primary' : ''} rounded-2xl p-5 soft-lift ${isCompleted ? 'opacity-60' : ''}">
                <!-- Header: Pet info + Time -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="h-12 w-12 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0 ${isCurrentStop ? 'ring-2 ring-groomer-primary/30' : ''}">
                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-xl text-slate-400">pets</span>`}
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-base font-bold text-slate-900 dark:text-white truncate">${apt.petName}</h4>
                            <p class="text-sm text-slate-500 font-medium truncate">${apt.petBreed || 'Pet'} â€¢ ${apt.serviceName}</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-base font-bold text-slate-700 dark:text-slate-300">${formatTime(apt.start_time)}</p>
                        ${isCurrentStop ? `<span class="inline-block px-2 py-0.5 bg-groomer-primary/10 text-groomer-primary text-[10px] font-bold uppercase rounded">Up Next</span>` : ''}
                        ${isUpcoming ? `<p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${formatDate(apt.appointment_date)}</p>` : ''}
                        ${!isCurrentStop && !isUpcoming ? `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase ${statusColors[apt.status] || 'bg-slate-100 text-slate-600'}">${apt.status}</span>` : ''}
                    </div>
                </div>
                
                ${!isCompleted ? `
                <!-- Notes Section (shown prominently if present) -->
                ${hasNotes ? `
                <div class="mb-3 p-2.5 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg">
                    <div class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-amber-600 text-base flex-shrink-0">warning</span>
                        <div class="text-xs">
                            ${petNotes ? `<p class="text-amber-800 dark:text-amber-200"><span class="font-bold">Pet:</span> ${petNotes}</p>` : ''}
                            ${customerNotes ? `<p class="text-amber-700 dark:text-amber-300 ${petNotes ? 'mt-0.5' : ''}"><span class="font-bold">Note:</span> ${customerNotes}</p>` : ''}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Address Row -->
                <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-3">
                    <span class="material-symbols-outlined text-base text-slate-400 flex-shrink-0">location_on</span>
                    <span class="flex-1 truncate">${displayAddress}</span>
                </div>
                
                <!-- Customer + Quick Actions Row -->
                <div class="flex items-center justify-between gap-2 pt-3 border-t border-slate-200/50 dark:border-slate-800">
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="material-symbols-outlined text-slate-400 text-base">person</span>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate">${apt.customerName}</span>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        ${mapsUrl ? `
                        <a href="${mapsUrl}" target="_blank" class="p-2 bg-white/50 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg hover:bg-groomer-primary/10 hover:text-groomer-primary dark:hover:bg-groomer-primary/20 dark:hover:text-groomer-primary transition-colors touch-target" title="Navigate">
                            <span class="material-symbols-outlined text-lg">directions</span>
                        </a>
                        ` : ''}
                        ${phoneClean ? `
                        <a href="tel:${phoneClean}" class="p-2 bg-white/50 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg hover:bg-groomer-primary/10 hover:text-groomer-primary dark:hover:bg-groomer-primary/20 dark:hover:text-groomer-primary transition-colors touch-target" title="Call">
                            <span class="material-symbols-outlined text-lg">call</span>
                        </a>
                        <a href="sms:${phoneClean}" class="p-2 bg-white/50 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg hover:bg-tech-purple/10 hover:text-tech-purple dark:hover:bg-tech-purple/20 dark:hover:text-tech-purple transition-colors touch-target" title="Text">
                            <span class="material-symbols-outlined text-lg">sms</span>
                        </a>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                ${(apt.status === 'confirmed' || apt.status === 'pending') ? `
                <div class="mt-3 flex gap-2">
                    <button onclick="openAppointmentDetail('${apt.id}')" class="flex-1 py-2.5 bg-white/50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold rounded-xl flex items-center justify-center gap-2 transition-colors touch-target border border-slate-200/50 dark:border-slate-700">
                        <span class="material-symbols-outlined text-lg">visibility</span>
                        Details
                    </button>
                    <button onclick="startGroomingAppointment('${apt.id}')" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-colors shadow-md touch-target">
                        <span class="material-symbols-outlined text-lg">play_arrow</span>
                        Start
                    </button>
                </div>
                ` : ''}
                ` : ''}
                
                ${apt.status === 'completed' && apt.groomer_notes ? `
                    <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-800">
                        <p class="text-xs text-slate-500 font-medium mb-1">Groomer Notes:</p>
                        <p class="text-sm text-slate-600 dark:text-slate-400">${apt.groomer_notes}</p>
                    </div>
                ` : ''}
            </div>`; 
        }
        
        // Groomer Schedule Content (full schedule view)
        function renderGroomerScheduleContent(todayAppts, upcomingAppts, completedAppts) {
            // Initialize calendar start date if not set
            if (!state.calendarStartDate) {
                state.calendarStartDate = getWeekStart(getTodayPacific());
            }
            
            const today = getTodayPacific();
            const viewMode = state.scheduleViewMode || 'monthly';
            
            // Get ALL in-progress appointments (across all days)
            const allInProgress = (state.groomerAppointments || []).filter(a => a.status === 'in_progress');
            
            return `
            <div class="space-y-6">
                <!-- COMPACT IN PROGRESS BANNER -->
                ${allInProgress.length > 0 ? `
                <div class="glass-card rounded-xl p-3 border-l-4 border-l-tech-purple">
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-tech-purple animate-pulse"></div>
                            <span class="text-xs font-bold text-tech-purple uppercase tracking-wide">In Progress (${allInProgress.length})</span>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            ${allInProgress.map(apt => `
                            <div class="flex items-center gap-2 bg-white dark:bg-slate-800 rounded-lg pl-1 pr-2 py-1 border border-tech-purple/20">
                                <div class="w-7 h-7 rounded-lg bg-tech-purple/10 overflow-hidden flex items-center justify-center flex-shrink-0">
                                    ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-tech-purple text-sm">pets</span>`}
                                </div>
                                <span class="text-sm font-semibold text-slate-900 dark:text-white">${apt.petName}</span>
                                <button onclick="openCompleteAppointmentModal('${apt.id}')" class="px-2 py-0.5 bg-groomer-primary hover:bg-groomer-primary/90 text-white text-xs font-bold rounded transition-colors">
                                    Done
                                </button>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- View Toggle Header -->
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">My Schedule</h2>
                    <div class="flex items-center gap-1 p-1 glass-card rounded-xl">
                        <button onclick="setScheduleViewMode('today')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${viewMode === 'today' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'}">
                            Today
                        </button>
                        <button onclick="setScheduleViewMode('weekly')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${viewMode === 'weekly' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'}">
                            Weekly
                        </button>
                        <button onclick="setScheduleViewMode('monthly')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${viewMode === 'monthly' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300'}">
                            Monthly
                        </button>
                    </div>
                </div>
                
                <!-- View Content -->
                ${viewMode === 'today' ? renderTodayView(todayAppts, today) : ''}
                ${viewMode === 'weekly' ? renderWeeklyView(today) : ''}
                ${viewMode === 'monthly' ? renderMonthlyView(today) : ''}
            </div>
            
            <!-- Appointment Detail Modal -->
            ${state.showAppointmentDetail && state.selectedAppointment ? renderAppointmentDetailModal(state.selectedAppointment) : ''}
            `;
        }
        
        // =============================================
        // HISTORY TAB - All Appointments View
        // =============================================
        function renderGroomerHistoryContent() {
            const allAppts = state.groomerAppointments || [];
            const filter = state.historyFilter || 'all';
            const search = (state.historySearch || '').toLowerCase();
            const dateRange = state.historyDateRange || 'all';
            
            // Calculate date range
            const today = new Date();
            let startDate = null;
            if (dateRange === 'week') {
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 7);
            } else if (dateRange === 'month') {
                startDate = new Date(today);
                startDate.setMonth(startDate.getMonth() - 1);
            }
            
            // Filter appointments
            let filteredAppts = allAppts.filter(apt => {
                // Status filter
                if (filter === 'completed' && apt.status !== 'completed') return false;
                if (filter === 'cancelled' && apt.status !== 'cancelled') return false;
                if (filter === 'upcoming' && !['pending', 'confirmed'].includes(apt.status)) return false;
                
                // Date range filter
                if (startDate) {
                    const aptDate = new Date(apt.appointment_date);
                    if (aptDate < startDate) return false;
                }
                
                // Search filter
                if (search) {
                    const searchable = [
                        apt.petName,
                        apt.customerName,
                        apt.serviceName,
                        apt.customerAddress
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchable.includes(search)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filteredAppts.sort((a, b) => {
                const dateCompare = (b.appointment_date || '').localeCompare(a.appointment_date || '');
                if (dateCompare !== 0) return dateCompare;
                return (b.start_time || '').localeCompare(a.start_time || '');
            });
            
            // Stats
            const stats = {
                total: allAppts.length,
                completed: allAppts.filter(a => a.status === 'completed').length,
                cancelled: allAppts.filter(a => a.status === 'cancelled').length,
                upcoming: allAppts.filter(a => ['pending', 'confirmed'].includes(a.status)).length,
                revenue: allAppts.filter(a => a.status === 'completed').reduce((sum, a) => sum + (parseFloat(a.total_price) || 0), 0)
            };
            
            return `
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Appointment History</h2>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-slate-900 dark:text-white">${stats.total}</p>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Total</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-groomer-primary">${stats.completed}</p>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Completed</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-amber-500">${stats.upcoming}</p>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Upcoming</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-emerald-500">$${stats.revenue.toFixed(0)}</p>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Revenue</p>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="glass-card rounded-xl p-4">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- Search -->
                        <div class="flex-1">
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                                <input type="text" placeholder="Search by pet, customer, service..." 
                                    value="${state.historySearch || ''}"
                                    onkeyup="updateHistorySearch(this.value)"
                                    class="w-full h-12 pl-10 pr-4 rounded-xl bg-slate-100 dark:bg-slate-800 border-0 focus:ring-2 focus:ring-groomer-primary text-sm"/>
                            </div>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="flex gap-1 p-1 bg-slate-100 dark:bg-slate-800 rounded-xl">
                            <button onclick="setHistoryFilter('all')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${filter === 'all' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                All
                            </button>
                            <button onclick="setHistoryFilter('completed')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${filter === 'completed' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                Completed
                            </button>
                            <button onclick="setHistoryFilter('upcoming')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${filter === 'upcoming' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                Upcoming
                            </button>
                            <button onclick="setHistoryFilter('cancelled')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${filter === 'cancelled' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                Cancelled
                            </button>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="flex gap-1 p-1 bg-slate-100 dark:bg-slate-800 rounded-xl">
                            <button onclick="setHistoryDateRange('all')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${dateRange === 'all' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                All Time
                            </button>
                            <button onclick="setHistoryDateRange('month')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${dateRange === 'month' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                Month
                            </button>
                            <button onclick="setHistoryDateRange('week')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${dateRange === 'week' ? 'bg-white dark:bg-slate-700 text-groomer-primary shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                Week
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Count -->
                <p class="text-sm text-slate-500">
                    Showing ${filteredAppts.length} appointment${filteredAppts.length !== 1 ? 's' : ''}
                    ${search ? ` matching "${search}"` : ''}
                </p>
                
                <!-- Appointments List -->
                <div class="space-y-3">
                    ${filteredAppts.length > 0 ? filteredAppts.map(apt => renderHistoryAppointmentCard(apt)).join('') : `
                        <div class="glass-card rounded-xl p-8 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">search_off</span>
                            <p class="text-slate-500 font-medium">No appointments found</p>
                            <p class="text-sm text-slate-400 mt-1">Try adjusting your filters</p>
                        </div>
                    `}
                </div>
            </div>
            
            ${state.showAppointmentDetail && state.selectedAppointment ? renderAppointmentDetailModal(state.selectedAppointment) : ''}
            `;
        }
        
        // History appointment card
        function renderHistoryAppointmentCard(apt) {
            const statusConfig = {
                pending: { bg: 'bg-amber-100 dark:bg-amber-900/30', text: 'text-amber-700 dark:text-amber-300', border: 'border-l-amber-500', icon: 'schedule' },
                confirmed: { bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', border: 'border-l-blue-500', icon: 'event_available' },
                in_progress: { bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-700 dark:text-purple-300', border: 'border-l-purple-500', icon: 'content_cut' },
                completed: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300', border: 'border-l-green-500', icon: 'check_circle' },
                cancelled: { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-300', border: 'border-l-red-500', icon: 'cancel' }
            };
            const config = statusConfig[apt.status] || statusConfig.pending;
            
            const petProfileData = JSON.stringify({
                name: apt.petName, breed: apt.petBreed, weight: apt.petWeight,
                photo_url: apt.petPhoto, grooming_notes: apt.petNotes,
                owner_name: apt.customerName, owner_phone: apt.customerPhone,
                owner_address: apt.customerAddress
            }).replace(/"/g, '&quot;');
            
            return `
            <div onclick="openAppointmentDetail('${apt.id}')" class="glass-card rounded-xl overflow-hidden border-l-4 ${config.border} cursor-pointer hover:shadow-lg transition-all">
                <div class="p-4">
                    <div class="flex items-center gap-4">
                        <!-- Pet Photo -->
                        <div class="w-14 h-14 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-2xl text-slate-400">pets</span>`}
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${petProfileData})" class="font-bold text-slate-900 dark:text-white hover:text-groomer-primary transition-colors truncate">
                                    ${apt.petName}
                                </button>
                                <span class="px-2 py-0.5 ${config.bg} ${config.text} text-xs font-bold rounded-full flex items-center gap-1 flex-shrink-0">
                                    <span class="material-symbols-outlined text-xs">${config.icon}</span>
                                    ${apt.status}
                                </span>
                            </div>
                            <p class="text-sm text-slate-500 truncate">${apt.serviceName || 'Grooming'} â€¢ ${apt.customerName}</p>
                            <p class="text-xs text-slate-400 mt-1">${apt.customerAddress || 'No address'}</p>
                        </div>
                        
                        <!-- Date & Price -->
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-slate-700 dark:text-slate-300">${formatDate(apt.appointment_date)}</p>
                            <p class="text-sm text-slate-500">${formatTime(apt.start_time)}</p>
                            <p class="text-sm font-bold text-groomer-primary mt-1">$${apt.total_price || '0'}</p>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }
        
        // History filter functions
        function setHistoryFilter(filter) {
            state.historyFilter = filter;
            render();
        }
        
        function setHistoryDateRange(range) {
            state.historyDateRange = range;
            render();
        }
        
        function updateHistorySearch(value) {
            state.historySearch = value;
            // Debounce render
            clearTimeout(window.historySearchTimeout);
            window.historySearchTimeout = setTimeout(() => render(), 300);
        }
        
        // Set schedule view mode
        function setScheduleViewMode(mode) {
            state.scheduleViewMode = mode;
            render();
        }
        
        // TODAY VIEW - Full list of today's appointments
        function renderTodayView(todayAppts, today) {
            const allTodayAppts = (state.groomerAppointments || [])
                .filter(a => a.appointment_date === today)
                .sort((a, b) => (a.start_time || '').localeCompare(b.start_time || ''));
            
            const pendingAppts = allTodayAppts.filter(a => a.status === 'pending' || a.status === 'confirmed');
            const inProgressAppts = allTodayAppts.filter(a => a.status === 'in_progress');
            const completedAppts = allTodayAppts.filter(a => a.status === 'completed');
            
            const dateObj = new Date(today + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            return `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${formattedDate}</h3>
                        <p class="text-sm text-slate-500">${allTodayAppts.length} appointment${allTodayAppts.length !== 1 ? 's' : ''} scheduled</p>
                    </div>
                </div>
                
                ${allTodayAppts.length === 0 ? `
                    <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl p-12 text-center">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600 mb-4">event_available</span>
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-300 mb-2">No Appointments Today</h3>
                        <p class="text-slate-500 dark:text-slate-400">Enjoy your day off!</p>
                    </div>
                ` : `
                    <!-- In Progress - Compact Header -->
                    ${inProgressAppts.length > 0 ? `
                        <div class="space-y-3">
                            <h4 class="text-sm font-bold text-tech-purple uppercase tracking-wider flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-tech-purple animate-pulse"></span>
                                In Progress (${inProgressAppts.length})
                            </h4>
                            <div class="space-y-3">
                                ${inProgressAppts.map(apt => renderScheduleAppointmentCard(apt)).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Upcoming Today -->
                    ${pendingAppts.length > 0 ? `
                        <div class="space-y-3">
                            <h4 class="text-sm font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">
                                Upcoming (${pendingAppts.length})
                            </h4>
                            <div class="space-y-3">
                                ${pendingAppts.map(apt => renderScheduleAppointmentCard(apt)).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Completed Today -->
                    ${completedAppts.length > 0 ? `
                        <div class="space-y-3">
                            <h4 class="text-sm font-bold text-groomer-primary uppercase tracking-wider flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">check_circle</span>
                                Completed (${completedAppts.length})
                            </h4>
                            <div class="space-y-3 opacity-60">
                                ${completedAppts.map(apt => renderScheduleAppointmentCard(apt, true)).join('')}
                            </div>
                        </div>
                    ` : ''}
                `}
            </div>
            `;
        }
        
        // WEEKLY VIEW - Calendar week grid
        function renderWeeklyView(today) {
            const weekDates = getWeekDates(state.calendarStartDate);
            const appointmentCounts = getAppointmentCountsByDate();
            const weekLabel = getWeekRangeLabel(state.calendarStartDate);
            
            // Get appointments for selected day
            const selectedDayAppts = state.selectedCalendarDate 
                ? getAppointmentsForDate(state.selectedCalendarDate)
                : [];
            
            return `
            <div class="flex h-[calc(100vh-280px)] gap-6">
                <!-- Calendar Section -->
                <div class="flex-1 flex flex-col">
                    <!-- Calendar Header -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${weekLabel}</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="goToPreviousWeek()" class="p-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_left</span>
                            </button>
                            <button onclick="goToCalendarToday()" class="px-3 py-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                Today
                            </button>
                            <button onclick="goToNextWeek()" class="p-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_right</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
                                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">${day}</div>
                            `).join('')}
                        </div>
                        
                        <!-- Calendar Days -->
                        <div class="grid grid-cols-7 flex-1">
                            ${weekDates.map(dateStr => {
                                const dateObj = new Date(dateStr + 'T12:00:00');
                                const dayNum = dateObj.getDate();
                                const count = appointmentCounts[dateStr] || 0;
                                const isSelected = state.selectedCalendarDate === dateStr;
                                const isTodayDate = dateStr === today;
                                const isPast = dateStr < today;
                                
                                const dayAppts = getAppointmentsForDate(dateStr);
                                const hasInProgress = dayAppts.some(a => a.status === 'in_progress');
                                const hasConfirmed = dayAppts.some(a => a.status === 'confirmed' || a.status === 'pending');
                                
                                return `
                                <button onclick="selectCalendarDate('${dateStr}')" 
                                    class="p-4 border-r border-b border-slate-100 dark:border-slate-700 last:border-r-0 flex flex-col items-center justify-start gap-2 transition-all hover:bg-slate-50 dark:hover:bg-slate-800 ${isSelected ? 'bg-emerald-50 dark:bg-emerald-900/20 ring-2 ring-emerald-500 ring-inset' : ''} ${isTodayDate ? 'bg-emerald-50/50 dark:bg-emerald-900/10' : ''} ${isPast && !isTodayDate ? 'opacity-50' : ''}">
                                    <span class="text-2xl font-bold ${isTodayDate ? 'text-emerald-600 dark:text-emerald-400' : isSelected ? 'text-emerald-700 dark:text-emerald-300' : 'text-slate-700 dark:text-slate-300'}">${dayNum}</span>
                                    ${count > 0 ? `
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="flex items-center gap-1">
                                                ${hasInProgress ? `<span class="w-2.5 h-2.5 rounded-full bg-purple-500 animate-pulse"></span>` : ''}
                                                ${hasConfirmed ? `<span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span>` : ''}
                                            </div>
                                            <span class="text-xs font-semibold ${isTodayDate || isSelected ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-500 dark:text-slate-400'}">${count} appt${count !== 1 ? 's' : ''}</span>
                                        </div>
                                    ` : `<span class="text-xs text-slate-400 dark:text-slate-500">-</span>`}
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Day Detail Panel -->
                ${state.selectedCalendarDate ? renderDayDetailPanel(state.selectedCalendarDate, selectedDayAppts) : `
                    <div class="w-[380px] bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 flex items-center justify-center">
                        <div class="text-center p-8">
                            <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-3">calendar_today</span>
                            <p class="text-slate-500 dark:text-slate-400">Select a day to view appointments</p>
                        </div>
                    </div>
                `}
            </div>
            `;
        }
        
        // MONTHLY VIEW - Full month calendar
        function renderMonthlyView(today) {
            // Get current month start
            const currentDate = state.calendarStartDate ? new Date(state.calendarStartDate + 'T12:00:00') : new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            const startDay = (monthStart.getDay() + 6) % 7; // Monday = 0
            const daysInMonth = monthEnd.getDate();
            
            const monthLabel = monthStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const appointmentCounts = getAppointmentCountsByDate();
            
            // Generate calendar days
            const calendarDays = [];
            // Add empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                calendarDays.push(null);
            }
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                calendarDays.push(dateStr);
            }
            
            // Get appointments for selected day
            const selectedDayAppts = state.selectedCalendarDate 
                ? getAppointmentsForDate(state.selectedCalendarDate)
                : [];
            
            return `
            <div class="flex h-[calc(100vh-280px)] gap-6">
                <!-- Calendar Section -->
                <div class="flex-1 flex flex-col">
                    <!-- Calendar Header -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${monthLabel}</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="goToPreviousMonth()" class="p-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_left</span>
                            </button>
                            <button onclick="goToCalendarToday()" class="px-3 py-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                Today
                            </button>
                            <button onclick="goToNextMonth()" class="p-2 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_right</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
                                <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">${day}</div>
                            `).join('')}
                        </div>
                        
                        <!-- Calendar Days -->
                        <div class="grid grid-cols-7 flex-1 auto-rows-fr">
                            ${calendarDays.map(dateStr => {
                                if (!dateStr) {
                                    return `<div class="border-r border-b border-slate-100 dark:border-slate-700 last:border-r-0 bg-slate-50/50 dark:bg-slate-800/30"></div>`;
                                }
                                
                                const dayNum = parseInt(dateStr.split('-')[2]);
                                const count = appointmentCounts[dateStr] || 0;
                                const isSelected = state.selectedCalendarDate === dateStr;
                                const isTodayDate = dateStr === today;
                                const isPast = dateStr < today;
                                
                                const dayAppts = getAppointmentsForDate(dateStr);
                                const hasInProgress = dayAppts.some(a => a.status === 'in_progress');
                                const hasConfirmed = dayAppts.some(a => a.status === 'confirmed' || a.status === 'pending');
                                
                                return `
                                <button onclick="selectCalendarDate('${dateStr}')" 
                                    class="p-2 border-r border-b border-slate-100 dark:border-slate-700 last:border-r-0 flex flex-col items-center justify-center gap-1 transition-all hover:bg-slate-50 dark:hover:bg-slate-800 ${isSelected ? 'bg-emerald-50 dark:bg-emerald-900/20 ring-2 ring-emerald-500 ring-inset' : ''} ${isTodayDate ? 'bg-emerald-50/50 dark:bg-emerald-900/10' : ''} ${isPast && !isTodayDate ? 'opacity-40' : ''}">
                                    <span class="text-sm font-bold ${isTodayDate ? 'text-emerald-600 dark:text-emerald-400' : isSelected ? 'text-emerald-700 dark:text-emerald-300' : 'text-slate-700 dark:text-slate-300'}">${dayNum}</span>
                                    ${count > 0 ? `
                                        <div class="flex items-center gap-0.5">
                                            ${hasInProgress ? `<span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>` : ''}
                                            ${hasConfirmed ? `<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>` : ''}
                                            <span class="text-[10px] font-bold text-slate-500">${count}</span>
                                        </div>
                                    ` : ''}
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Day Detail Panel -->
                ${state.selectedCalendarDate ? renderDayDetailPanel(state.selectedCalendarDate, selectedDayAppts) : `
                    <div class="w-[380px] bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 flex items-center justify-center">
                        <div class="text-center p-8">
                            <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-3">calendar_today</span>
                            <p class="text-slate-500 dark:text-slate-400">Select a day to view appointments</p>
                        </div>
                    </div>
                `}
            </div>
            `;
        }
        
        // Schedule Appointment Card (for Today view)
        function renderScheduleAppointmentCard(apt, isCompleted = false) {
            const statusColors = {
                pending: 'border-l-amber-500',
                confirmed: 'border-l-blue-500',
                in_progress: 'border-l-purple-500',
                completed: 'border-l-emerald-500',
                cancelled: 'border-l-red-500'
            };
            
            const fullAddress = apt.service_address || apt.customerAddress || '';
            const city = apt.service_city || apt.customerCity || '';
            const displayAddress = fullAddress ? (fullAddress + (city ? ', ' + city : '')) : 'Address not provided';
            const mapsUrl = fullAddress ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(displayAddress)}` : '';
            const phoneClean = (apt.customerPhone || '').replace(/[^0-9+]/g, '');
            
            // Combine notes
            const petNotes = apt.petNotes || apt.pet?.grooming_notes || '';
            const customerNotes = apt.customer_notes || apt.notes || '';
            const hasNotes = petNotes || customerNotes;
            
            // JSON for pet profile (escaped for onclick)
            const petProfileData = JSON.stringify({
                name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, 
                photo_url: apt.petPhoto, grooming_notes: apt.petNotes, 
                owner_name: apt.customerName, owner_phone: apt.customerPhone, 
                owner_address: apt.customerAddress
            }).replace(/"/g, '&quot;');
            
            return `
            <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden border-l-4 ${statusColors[apt.status] || 'border-l-slate-300'} ${isCompleted ? 'opacity-60' : ''}">
                <!-- Main clickable area -->
                <div onclick="openAppointmentDetail('${apt.id}')" class="p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                            ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-xl text-slate-400">pets</span>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); openPetProfile('${apt.pet_id}', ${petProfileData})" class="font-bold text-slate-900 dark:text-white truncate hover:text-groomer-primary transition-colors text-left">${apt.petName}</button>
                                ${apt.status === 'in_progress' ? `<span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-xs font-bold rounded-full flex-shrink-0">In Progress</span>` : ''}
                            </div>
                            <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${apt.serviceName} â€¢ ${apt.customerName}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-lg font-bold text-slate-700 dark:text-slate-300">${formatTime(apt.start_time)}</p>
                            <p class="text-xs text-slate-500">$${apt.total_price || apt.servicePrice || '0'}</p>
                        </div>
                    </div>
                    
                    <!-- Notes Warning (shown prominently if present) -->
                    ${hasNotes ? `
                    <div class="mt-3 p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg">
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-amber-600 text-base flex-shrink-0">warning</span>
                            <div class="text-xs">
                                ${petNotes ? `<p class="text-amber-800 dark:text-amber-200"><span class="font-bold">Pet:</span> ${petNotes}</p>` : ''}
                                ${customerNotes ? `<p class="text-amber-700 dark:text-amber-300 ${petNotes ? 'mt-0.5' : ''}"><span class="font-bold">Note:</span> ${customerNotes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Address -->
                    <p class="text-xs text-slate-400 dark:text-slate-500 truncate mt-2 flex items-center gap-1">
                        <span class="material-symbols-outlined text-xs">location_on</span>
                        ${displayAddress}
                    </p>
                </div>
                
                ${!isCompleted ? `
                <!-- Quick Action Bar -->
                <div class="flex items-center justify-between px-4 py-2 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-1">
                        ${mapsUrl ? `
                        <a href="${mapsUrl}" target="_blank" onclick="event.stopPropagation()" class="p-2 text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-lg transition-colors touch-target" title="Navigate">
                            <span class="material-symbols-outlined text-lg">directions</span>
                        </a>
                        ` : ''}
                        ${phoneClean ? `
                        <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="p-2 text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-lg transition-colors touch-target" title="Call">
                            <span class="material-symbols-outlined text-lg">call</span>
                        </a>
                        <a href="sms:${phoneClean}" onclick="event.stopPropagation()" class="p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition-colors touch-target" title="Text">
                            <span class="material-symbols-outlined text-lg">sms</span>
                        </a>
                        ` : ''}
                    </div>
                    ${(apt.status === 'confirmed' || apt.status === 'pending') ? `
                    <button onclick="event.stopPropagation(); startGroomingAppointment('${apt.id}')" class="px-4 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold rounded-lg transition-colors touch-target flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">play_arrow</span>
                        Start
                    </button>
                    ` : apt.status === 'in_progress' ? `
                    <button onclick="event.stopPropagation(); openCompleteAppointmentModal('${apt.id}')" class="px-4 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold rounded-lg transition-colors touch-target flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Complete
                    </button>
                    ` : ''}
                </div>
                ` : ''}
            </div>
            `;
        }
        
        // Navigation functions for monthly view
        function goToPreviousMonth() {
            const current = state.calendarStartDate ? new Date(state.calendarStartDate + 'T12:00:00') : new Date();
            current.setMonth(current.getMonth() - 1);
            current.setDate(1);
            state.calendarStartDate = current.toISOString().split('T')[0];
            state.selectedCalendarDate = null;
            render();
        }
        
        function goToNextMonth() {
            const current = state.calendarStartDate ? new Date(state.calendarStartDate + 'T12:00:00') : new Date();
            current.setMonth(current.getMonth() + 1);
            current.setDate(1);
            state.calendarStartDate = current.toISOString().split('T')[0];
            state.selectedCalendarDate = null;
            render();
        }
        
        // Day Detail Panel (right sidebar)
        function renderDayDetailPanel(dateStr, appointments) {
            const dateObj = new Date(dateStr + 'T12:00:00');
            const isToday = dateStr === getTodayPacific();
            const isPast = dateStr < getTodayPacific();
            const dayLabel = isToday ? 'Today' : dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            return `
            <div class="w-[380px] bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden">
                <!-- Panel Header -->
                <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${dayLabel}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${appointments.length} Appointment${appointments.length !== 1 ? 's' : ''}</p>
                    </div>
                    <button onclick="closeDayPanel()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors lg:hidden">
                        <span class="material-symbols-outlined text-slate-500">close</span>
                    </button>
                </div>
                
                <!-- Appointments List -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    ${appointments.length > 0 ? appointments.map(apt => {
                        const statusColors = {
                            pending: 'border-amber-300 bg-amber-50 dark:bg-amber-900/20',
                            confirmed: 'border-emerald-300 bg-emerald-50 dark:bg-emerald-900/20',
                            in_progress: 'border-purple-400 bg-purple-50 dark:bg-purple-900/20 ring-2 ring-purple-400',
                            completed: 'border-slate-200 bg-slate-50 dark:bg-slate-800/50 opacity-60',
                            cancelled: 'border-red-200 bg-red-50 dark:bg-red-900/20 opacity-50'
                        };
                        const statusBadges = {
                            pending: 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300',
                            confirmed: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300',
                            in_progress: 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300',
                            completed: 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300',
                            cancelled: 'bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300'
                        };
                        
                        return `
                        <button onclick="openAppointmentDetail('${apt.id}')" class="w-full p-4 rounded-xl border-2 ${statusColors[apt.status] || 'border-slate-200 bg-white'} text-left transition-all hover:shadow-md">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-11 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden">
                                        ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400">pets</span>`}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-900 dark:text-white">${apt.petName || 'Pet'}</h4>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${apt.serviceName || 'Grooming'}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-[10px] font-bold uppercase rounded-lg ${statusBadges[apt.status] || 'bg-slate-100 text-slate-600'}">
                                    ${apt.status === 'in_progress' ? 'In Progress' : apt.status}
                                </span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="font-bold text-emerald-600 dark:text-emerald-400">${formatTime(apt.start_time)}</span>
                                <span class="text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">person</span>
                                    ${apt.customerName || 'Customer'}
                                </span>
                            </div>
                        </button>`;
                    }).join('') : `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-3">event_available</span>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">No appointments</p>
                            <p class="text-sm text-slate-400 dark:text-slate-500">You're free this day!</p>
                        </div>
                    `}
                </div>
            </div>`;
        }
        
        // Full Appointment Detail Modal
        function renderAppointmentDetailModal(apt) {
            const statusColors = {
                pending: 'bg-amber-500',
                confirmed: 'bg-emerald-500',
                in_progress: 'bg-purple-500',
                completed: 'bg-slate-500',
                cancelled: 'bg-red-500'
            };
            
            const fullAddress = apt.service_address || apt.customerAddress || 'Address not provided';
            const city = apt.service_city || apt.customerCity || '';
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress + (city ? ', ' + city : ''))}`;
            
            // Calculate elapsed time if in progress
            let elapsedTime = '';
            if (apt.status === 'in_progress' && apt.started_at) {
                const started = new Date(apt.started_at);
                const now = new Date();
                const mins = Math.floor((now - started) / 60000);
                elapsedTime = mins < 60 ? `${mins} min` : `${Math.floor(mins/60)}h ${mins%60}m`;
            }
            
            const isPastAppointment = apt.appointment_date < getTodayPacific();
            const canTakeAction = !isPastAppointment && apt.status !== 'completed' && apt.status !== 'cancelled';
            
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeAppointmentDetail()">
                <div class="bg-white dark:bg-surface-dark rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                    
                    <!-- Header -->
                    <div class="relative p-6 pb-4">
                        <button onclick="closeAppointmentDetail()" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                            <span class="material-symbols-outlined text-slate-500">close</span>
                        </button>
                        
                        <div class="flex items-center gap-2 mb-4">
                            <span class="w-3 h-3 rounded-full ${statusColors[apt.status] || 'bg-slate-400'} ${apt.status === 'in_progress' ? 'animate-pulse' : ''}"></span>
                            <span class="text-sm font-bold uppercase tracking-wider ${apt.status === 'in_progress' ? 'text-purple-600 dark:text-purple-400' : 'text-slate-500 dark:text-slate-400'}">
                                ${apt.status === 'in_progress' ? 'In Progress' : apt.status}
                            </span>
                            ${elapsedTime ? `<span class="text-sm text-purple-500 dark:text-purple-400 ml-2">â€¢ ${elapsedTime}</span>` : ''}
                        </div>
                        
                        <!-- Pet Info -->
                        <div class="flex items-center gap-4">
                            <div class="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden ring-4 ring-slate-100 dark:ring-slate-700">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-4xl text-slate-400">pets</span>`}
                            </div>
                            <div class="flex-1">
                                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">${apt.petName || 'Pet'}</h2>
                                <p class="text-slate-500 dark:text-slate-400">${apt.petBreed || 'Pet'} ${apt.petWeight ? 'â€¢ ' + apt.petWeight + ' lbs' : ''}</p>
                                <button onclick="openPetProfile('${apt.pet_id}', ${JSON.stringify({name: apt.petName, breed: apt.petBreed, weight: apt.petWeight, photo_url: apt.petPhoto, grooming_notes: apt.petNotes, owner_name: apt.customerName, owner_phone: apt.customerPhone, owner_address: apt.customerAddress, owner_city: apt.customerCity}).replace(/"/g, '&quot;')})" class="mt-2 text-sm text-groomer-primary hover:text-groomer-primary/80 font-bold flex items-center gap-1 transition-colors">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                    View Pet Profile
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Details Section -->
                    <div class="px-6 pb-4 space-y-4">
                        
                        <!-- Service & Time -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-emerald-500">content_cut</span>
                                    <div>
                                        <p class="font-bold text-slate-900 dark:text-white">${apt.serviceName || 'Grooming'}</p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">$${apt.total_price || apt.servicePrice || '0'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-emerald-600 dark:text-emerald-400">${formatTime(apt.start_time)}</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">${formatDate(apt.appointment_date)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Info -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined text-blue-500">person</span>
                                <div class="flex-1">
                                    <p class="font-bold text-slate-900 dark:text-white">${apt.customerName || 'Customer'}</p>
                                </div>
                                ${apt.customerPhone ? `
                                    <a href="tel:${apt.customerPhone}" class="flex items-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl transition-colors">
                                        <span class="material-symbols-outlined text-lg">call</span>
                                    </a>
                                    <a href="sms:${apt.customerPhone}" class="flex items-center gap-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition-colors">
                                        <span class="material-symbols-outlined text-lg">sms</span>
                                    </a>
                                ` : ''}
                            </div>
                            
                            <!-- Quick Text Templates -->
                            ${apt.customerPhone ? `
                                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Quick Text</p>
                                    <div class="flex flex-wrap gap-2">
                                        <a href="sms:${apt.customerPhone}?body=${encodeURIComponent("On my way! Should arrive in about 10 minutes.")}" class="px-3 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            ðŸš— On my way
                                        </a>
                                        <a href="sms:${apt.customerPhone}?body=${encodeURIComponent("I've arrived! Ready when you are.")}" class="px-3 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            ðŸ  Arrived
                                        </a>
                                        <a href="sms:${apt.customerPhone}?body=${encodeURIComponent("Running about 10 minutes late, sorry for the delay!")}" class="px-3 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            â° Running late
                                        </a>
                                        <a href="sms:${apt.customerPhone}?body=${encodeURIComponent("Grooming complete! Your fur baby looks amazing. ðŸ•âœ¨")}" class="px-3 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            âœ… Done
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Address -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-rose-500 mt-0.5">location_on</span>
                                <div class="flex-1">
                                    <p class="font-bold text-slate-900 dark:text-white">${fullAddress}</p>
                                    ${city ? `<p class="text-sm text-slate-500 dark:text-slate-400">${city}</p>` : ''}
                                </div>
                                <a href="${mapsUrl}" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white font-bold rounded-xl transition-colors">
                                    <span class="material-symbols-outlined text-lg">directions</span>
                                    Navigate
                                </a>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        ${apt.customer_notes ? `
                            <div class="bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-4 border border-amber-200 dark:border-amber-700">
                                <div class="flex items-start gap-3">
                                    <span class="material-symbols-outlined text-amber-500">note</span>
                                    <div>
                                        <p class="text-sm font-bold text-amber-700 dark:text-amber-300 mb-1">Customer Notes</p>
                                        <p class="text-sm text-amber-800 dark:text-amber-200">${apt.customer_notes}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${apt.groomer_notes ? `
                            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-2xl p-4 border border-blue-200 dark:border-blue-700">
                                <div class="flex items-start gap-3">
                                    <span class="material-symbols-outlined text-blue-500">edit_note</span>
                                    <div>
                                        <p class="text-sm font-bold text-blue-700 dark:text-blue-300 mb-1">Your Notes</p>
                                        <p class="text-sm text-blue-800 dark:text-blue-200">${apt.groomer_notes}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    ${canTakeAction ? `
                        <div class="p-6 pt-2 space-y-3">
                            ${apt.status === 'confirmed' || apt.status === 'pending' ? `
                                <button onclick="startGroomingAppointment('${apt.id}')" class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-2xl flex items-center justify-center gap-3 transition-all shadow-lg shadow-blue-500/20 text-lg">
                                    <span class="material-symbols-outlined text-2xl">play_circle</span>
                                    Start Grooming
                                </button>
                            ` : apt.status === 'in_progress' ? `
                                <div class="space-y-3">
                                    <textarea id="modal-groomer-notes-${apt.id}" placeholder="Add notes about the groom (optional)..." class="w-full h-24 px-4 py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 border-0 focus:ring-2 focus:ring-emerald-500 text-sm resize-none dark:text-white"></textarea>
                                    <button onclick="groomerCompleteAppointmentFromModal('${apt.id}')" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-2xl flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-500/20 text-lg">
                                        <span class="material-symbols-outlined text-2xl">check_circle</span>
                                        Complete & Award Points
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="p-6 pt-2">
                            <div class="py-4 text-center text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 rounded-2xl">
                                ${apt.status === 'completed' ? 'âœ… This appointment has been completed' : apt.status === 'cancelled' ? 'âŒ This appointment was cancelled' : 'ðŸ“… Past appointment'}
                            </div>
                        </div>
                    `}
                </div>
            </div>`;
        }
        
        // Open completion modal
        function openCompleteAppointmentModal(appointmentId) {
            const apt = state.groomerAppointments.find(a => a.id === appointmentId);
            if (!apt) {
                showToast('Appointment not found', 'error');
                return;
            }
            state.showCompleteAppointmentModal = true;
            state.completingAppointmentId = appointmentId;
            state.completingAppointmentData = apt;
            state.capturedAfterPhoto = null; // Reset after photo when opening
            render();
        }
        
        // Close completion modal
        function closeCompleteAppointmentModal() {
            state.showCompleteAppointmentModal = false;
            state.completingAppointmentId = null;
            state.completingAppointmentData = null;
            state.capturedAfterPhoto = null; // Clear captured after photo
            render();
        }
        
        // Submit completion from modal
        async function submitAppointmentCompletion() {
            const appointmentId = state.completingAppointmentId;
            if (!appointmentId) return;
            
            const completedCheckbox = document.getElementById('completion-confirmed');
            const notesEl = document.getElementById('completion-notes');
            
            if (!completedCheckbox?.checked) {
                showToast('Please confirm the grooming was completed', 'error');
                return;
            }
            
            const notes = notesEl?.value?.trim() || null;
            const afterPhotoBase64 = state.capturedAfterPhoto; // Capture before clearing state
            
            // Close modal FIRST and clear all modal state
            state.showCompleteAppointmentModal = false;
            state.completingAppointmentId = null;
            state.completingAppointmentData = null;
            state.capturedAfterPhoto = null;
            
            // Render to close the modal visually
            render();
            
            // Then complete the appointment (this will render again when done)
            await groomerCompleteAppointment(appointmentId, notes, afterPhotoBase64);
        }
        
        // Render Before Photo Modal (shown when starting appointment)
        function renderBeforePhotoModal() {
            if (!state.showBeforePhotoModal || !state.beforePhotoAppointmentData) return '';
            
            const apt = state.beforePhotoAppointmentData;
            const hasPhoto = state.capturedBeforePhoto;
            
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closeBeforePhotoModal()">
                <div class="bg-white dark:bg-surface-dark rounded-3xl w-full max-w-md shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">ðŸ“¸ Before Photo</h2>
                            <button onclick="closeBeforePhotoModal()" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center overflow-hidden">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-2xl">pets</span>`}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">${apt.petName || 'Pet'}</h3>
                                <p class="text-white/80 text-sm">${apt.serviceName || 'Grooming'} â€¢ ${apt.customerName || 'Customer'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Photo Capture Area -->
                    <div class="p-6 space-y-4">
                        <p class="text-sm text-slate-600 dark:text-slate-400 text-center">
                            Take a "before" photo to document the pet's condition before grooming. This is optional but recommended.
                        </p>
                        
                        <!-- Photo Preview / Capture Button -->
                        <div class="relative">
                            ${hasPhoto ? `
                                <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-slate-100 dark:bg-slate-800">
                                    <img src="${state.capturedBeforePhoto}" class="w-full h-full object-cover" alt="Before photo"/>
                                    <button onclick="state.capturedBeforePhoto = null; render();" class="absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <p class="text-center text-sm text-emerald-600 dark:text-emerald-400 mt-2 font-medium">
                                    âœ“ Photo captured! Ready to start.
                                </p>
                            ` : `
                                <button onclick="capturePhoto('before')" class="w-full aspect-[4/3] rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 flex flex-col items-center justify-center gap-3 hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all cursor-pointer touch-target">
                                    <div class="w-16 h-16 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-3xl text-blue-500">photo_camera</span>
                                    </div>
                                    <div class="text-center">
                                        <p class="font-bold text-slate-700 dark:text-slate-300">Tap to Take Photo</p>
                                        <p class="text-xs text-slate-500">Use your camera</p>
                                    </div>
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="p-6 pt-0 flex gap-3">
                        <button onclick="skipBeforePhotoAndStart()" class="flex-1 py-3 px-4 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            Skip Photo
                        </button>
                        <button onclick="startWithBeforePhoto()" class="flex-1 py-3 px-4 rounded-xl ${hasPhoto ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-blue-500 hover:bg-blue-600'} text-white font-bold transition-colors flex items-center justify-center gap-2 shadow-lg ${hasPhoto ? 'shadow-emerald-500/30' : 'shadow-blue-500/30'}">
                            <span class="material-symbols-outlined">${hasPhoto ? 'check_circle' : 'play_arrow'}</span>
                            ${hasPhoto ? 'Start with Photo' : 'Start Now'}
                        </button>
                    </div>
                </div>
            </div>`;
        }
        
        // Render completion modal
        function renderCompleteAppointmentModal() {
            if (!state.showCompleteAppointmentModal || !state.completingAppointmentData) return '';
            
            const apt = state.completingAppointmentData;
            const hasAfterPhoto = state.capturedAfterPhoto;
            
            // Calculate elapsed time
            let elapsedTime = '';
            if (apt.started_at) {
                const started = new Date(apt.started_at);
                const now = new Date();
                const mins = Math.floor((now - started) / 60000);
                elapsedTime = mins < 60 ? `${mins} minutes` : `${Math.floor(mins/60)}h ${mins%60}m`;
            }
            
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closeCompleteAppointmentModal()">
                <div class="bg-white dark:bg-surface-dark rounded-3xl w-full max-w-md shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Complete Appointment</h2>
                            <button onclick="closeCompleteAppointmentModal()" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center overflow-hidden">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-2xl">pets</span>`}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">${apt.petName || 'Pet'}</h3>
                                <p class="text-white/80 text-sm">${apt.serviceName || 'Grooming'} â€¢ ${apt.customerName || 'Customer'}</p>
                            </div>
                        </div>
                        ${elapsedTime ? `<p class="mt-3 text-sm text-white/80"><span class="material-symbols-outlined text-sm align-middle mr-1">timer</span>Session duration: ${elapsedTime}</p>` : ''}
                    </div>
                    
                    <!-- Form -->
                    <div class="p-6 space-y-5">
                        <!-- After Photo Section -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                                <span class="material-symbols-outlined text-sm align-middle mr-1">photo_camera</span>
                                After Photo (Recommended)
                            </label>
                            ${hasAfterPhoto ? `
                                <div class="relative aspect-[4/3] rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800">
                                    <img src="${state.capturedAfterPhoto}" class="w-full h-full object-cover" alt="After photo"/>
                                    <button onclick="state.capturedAfterPhoto = null; render();" class="absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <p class="text-center text-sm text-emerald-600 dark:text-emerald-400 mt-2 font-medium">
                                    âœ“ After photo captured!
                                </p>
                            ` : `
                                <button onclick="capturePhoto('after')" class="w-full aspect-[3/2] rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 flex flex-col items-center justify-center gap-2 hover:border-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-all cursor-pointer touch-target">
                                    <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-2xl text-emerald-500">photo_camera</span>
                                    </div>
                                    <p class="font-medium text-slate-600 dark:text-slate-400 text-sm">Tap to capture after photo</p>
                                </button>
                            `}
                        </div>
                        
                        <!-- Confirmation Checkbox -->
                        <label class="flex items-start gap-4 p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800 cursor-pointer">
                            <input type="checkbox" id="completion-confirmed" class="mt-0.5 h-5 w-5 rounded border-emerald-300 text-emerald-500 focus:ring-emerald-500"/>
                            <div>
                                <p class="font-bold text-slate-900 dark:text-white">Grooming Completed</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">I confirm this grooming session has been completed successfully</p>
                            </div>
                        </label>
                        
                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                                <span class="material-symbols-outlined text-sm align-middle mr-1">notes</span>
                                Session Notes (Optional)
                            </label>
                            <textarea 
                                id="completion-notes" 
                                rows="3" 
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-none"
                                placeholder="Any observations about this grooming session..."
                            ></textarea>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="p-6 pt-0 flex gap-3">
                        <button onclick="closeCompleteAppointmentModal()" class="flex-1 py-3 px-4 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            Cancel
                        </button>
                        <button onclick="submitAppointmentCompletion()" class="flex-1 py-3 px-4 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/30">
                            <span class="material-symbols-outlined">check_circle</span>
                            Mark Complete
                        </button>
                    </div>
                </div>
            </div>`; 
        }

        // Complete appointment from modal (gets notes from modal textarea)
        async function groomerCompleteAppointmentFromModal(appointmentId) {
            openCompleteAppointmentModal(appointmentId);
        }
        
        // Groomer Messages Content
        function renderGroomerMessagesContent() {
            const messages = state.groomerMessages || [];
            const conversations = state.messageConversations || [];
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">
                    <!-- Conversations List -->
                    <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-800">
                            <h3 class="font-bold dark:text-white">Conversations</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <!-- Admin Conversation (always shown) -->
                            <button onclick="openConversation('admin')" class="w-full p-4 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-800 ${state.activeConversation === 'admin' ? 'bg-emerald-50 dark:bg-emerald-900/20' : ''}">
                                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-blue-600">admin_panel_settings</span>
                                </div>
                                <div class="flex-1 text-left">
                                    <p class="font-bold dark:text-white">Admin / Office</p>
                                    <p class="text-sm text-slate-500 truncate">${getLastMessage('admin') || 'Start a conversation'}</p>
                                </div>
                                ${getUnreadCount('admin') > 0 ? `<span class="w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${getUnreadCount('admin')}</span>` : ''}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Message Thread -->
                    <div class="lg:col-span-2 bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden">
                        ${state.activeConversation ? `
                            <!-- Header -->
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-blue-600">admin_panel_settings</span>
                                </div>
                                <div>
                                    <p class="font-bold dark:text-white">Admin / Office</p>
                                    <p class="text-xs text-slate-500">Usually responds within minutes</p>
                                </div>
                            </div>
                            
                            <!-- Messages -->
                            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                                ${renderMessageThread('admin')}
                            </div>
                            
                            <!-- Input -->
                            <div class="p-4 border-t border-slate-100 dark:border-slate-800">
                                <form onsubmit="sendGroomerMessage(event)" class="flex gap-3">
                                    <input type="text" id="message-input" placeholder="Type a message to admin..." class="flex-1 h-12 px-4 rounded-xl bg-slate-100 dark:bg-slate-800 border-0 focus:ring-2 focus:ring-emerald-500" autocomplete="off"/>
                                    <button type="submit" class="h-12 px-6 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition-colors flex items-center gap-2">
                                        <span class="material-symbols-outlined">send</span>
                                    </button>
                                </form>
                            </div>
                        ` : `
                            <div class="flex-1 flex items-center justify-center">
                                <div class="text-center">
                                    <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">forum</span>
                                    <p class="text-slate-500">Select a conversation to start messaging</p>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Helper functions for messages
        function getLastMessage(conversationId) {
            const messages = state.groomerMessages || [];
            const convMessages = messages.filter(m => m.conversation_id === conversationId || (conversationId === 'admin' && m.is_admin));
            if (convMessages.length === 0) return '';
            const last = convMessages[convMessages.length - 1];
            return last.message?.substring(0, 40) + (last.message?.length > 40 ? '...' : '');
        }
        
        function getUnreadCount(conversationId) {
            const messages = state.groomerMessages || [];
            return messages.filter(m => (m.conversation_id === conversationId || (conversationId === 'admin' && m.is_admin)) && !m.is_read && m.sender_id !== state.currentUser?.id).length;
        }
        
        function renderMessageThread(conversationId) {
            const messages = state.groomerMessages || [];
            const convMessages = messages.filter(m => m.conversation_id === conversationId || (conversationId === 'admin' && (m.is_admin || m.to_admin)));
            
            if (convMessages.length === 0) {
                return `
                    <div class="h-full flex items-center justify-center">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">chat</span>
                            <p class="text-slate-500">No messages yet. Say hello!</p>
                        </div>
                    </div>
                `;
            }
            
            return convMessages.map(m => {
                const isMe = m.sender_id === state.currentUser?.id;
                const time = new Date(m.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                return `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[70%] ${isMe ? 'bg-emerald-500 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white'} rounded-2xl px-4 py-3">
                            <p class="text-sm">${m.message}</p>
                            <p class="text-[10px] ${isMe ? 'text-emerald-200' : 'text-slate-400'} mt-1">${time}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Groomer tab and shift functions
        function setGroomerTab(tab) {
            state.groomerTab = tab;
            state.mobileTab = null; // Reset mobile tab when changing main tabs
            if (tab === 'messages') {
                state.activeConversation = 'admin';
                loadGroomerMessages();
            }
            render();
        }
        
        // Mobile menu functions
        function openMobileMenu() {
            state.showMobileMenu = true;
            render();
        }
        
        function closeMobileMenu() {
            state.showMobileMenu = false;
            render();
        }
        
        // Quick actions menu
        function showQuickActions() {
            state.showQuickActions = true;
            render();
        }
        
        function closeQuickActions() {
            state.showQuickActions = false;
            render();
        }
        
        // =============================================
        // PET PROFILE QUICK VIEW
        // =============================================
        async function openPetProfile(petId, petData = null) {
            showLoading();
            
            try {
                let pet = petData;
                
                // If we don't have full pet data, fetch it
                if (!pet || !pet.id) {
                    // Try to find pet from groomer appointments
                    const aptWithPet = state.groomerAppointments?.find(a => a.pet_id === petId);
                    if (aptWithPet) {
                        pet = {
                            id: petId,
                            name: aptWithPet.petName,
                            breed: aptWithPet.petBreed,
                            weight: aptWithPet.petWeight,
                            photo_url: aptWithPet.petPhoto,
                            grooming_notes: aptWithPet.petNotes,
                            owner_name: aptWithPet.customerName,
                            owner_phone: aptWithPet.customerPhone,
                            owner_email: aptWithPet.customerEmail,
                            owner_address: aptWithPet.customerAddress,
                            owner_city: aptWithPet.customerCity
                        };
                    }
                }
                
                // Get appointment history for this pet
                const petAppointments = (state.groomerAppointments || [])
                    .filter(a => a.pet_id === petId || a.petName === pet?.name)
                    .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
                
                state.selectedPetProfile = pet;
                state.petAppointmentHistory = petAppointments;
                state.showPetProfile = true;
                
                hideLoading();
                render();
            } catch (err) {
                hideLoading();
                console.error('Error loading pet profile:', err);
                showToast('Failed to load pet profile', 'error');
            }
        }
        
        function closePetProfile() {
            state.showPetProfile = false;
            state.selectedPetProfile = null;
            state.petAppointmentHistory = [];
            render();
        }
        
        function renderPetProfileModal() {
            if (!state.showPetProfile || !state.selectedPetProfile) return '';
            
            const pet = state.selectedPetProfile;
            const history = state.petAppointmentHistory || [];
            const completedGrooms = history.filter(a => a.status === 'completed');
            const lastGroom = completedGrooms[0];
            
            // Get photos from history
            const photoHistory = completedGrooms
                .filter(a => a.before_photo_url || a.after_photo_url)
                .slice(0, 6);
            
            return `
            <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closePetProfile()">
                <div class="bg-white dark:bg-surface-dark rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                    
                    <!-- Header with Pet Photo -->
                    <div class="relative bg-gradient-to-br from-groomer-primary to-groomer-primary/80 p-6 text-white">
                        <button onclick="closePetProfile()" class="absolute top-4 right-4 p-2 hover:bg-white/20 rounded-xl transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                        
                        <div class="flex items-center gap-4">
                            <div class="w-24 h-24 rounded-2xl bg-white/20 flex items-center justify-center overflow-hidden ring-4 ring-white/30">
                                ${pet.photo_url || pet.petPhoto ? `<img src="${pet.photo_url || pet.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-5xl">pets</span>`}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">${pet.name || pet.petName || 'Pet'}</h2>
                                <p class="text-white/80">${pet.breed || pet.petBreed || 'Unknown breed'}</p>
                                ${pet.weight || pet.petWeight ? `<p class="text-white/80 text-sm">${pet.weight || pet.petWeight} lbs</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="flex gap-4 mt-4">
                            <div class="flex-1 bg-white/20 rounded-xl p-3 text-center">
                                <p class="text-2xl font-bold">${completedGrooms.length}</p>
                                <p class="text-xs text-white/70">Total Grooms</p>
                            </div>
                            <div class="flex-1 bg-white/20 rounded-xl p-3 text-center">
                                <p class="text-2xl font-bold">${lastGroom ? Math.floor((new Date() - new Date(lastGroom.completed_at || lastGroom.appointment_date)) / (1000 * 60 * 60 * 24)) : '-'}</p>
                                <p class="text-xs text-white/70">Days Since Last</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 space-y-5">
                        
                        <!-- Owner Info -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Owner</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">${pet.owner_name || pet.customerName || 'Unknown'}</p>
                                    <p class="text-sm text-slate-500">${pet.owner_address || pet.customerAddress || ''}</p>
                                </div>
                                <div class="flex gap-2">
                                    ${pet.owner_phone || pet.customerPhone ? `
                                        <a href="tel:${pet.owner_phone || pet.customerPhone}" class="w-10 h-10 bg-blue-500 text-white rounded-xl flex items-center justify-center">
                                            <span class="material-symbols-outlined text-lg">call</span>
                                        </a>
                                        <a href="sms:${pet.owner_phone || pet.customerPhone}" class="w-10 h-10 bg-green-500 text-white rounded-xl flex items-center justify-center">
                                            <span class="material-symbols-outlined text-lg">sms</span>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Quick Text Templates in Pet Profile -->
                            ${pet.owner_phone || pet.customerPhone ? `
                                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                    <p class="text-xs font-bold text-slate-400 mb-2">Quick Text</p>
                                    <div class="flex flex-wrap gap-2">
                                        <a href="sms:${pet.owner_phone || pet.customerPhone}?body=${encodeURIComponent("On my way! Should arrive in about 10 minutes.")}" class="px-2.5 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            ðŸš— On my way
                                        </a>
                                        <a href="sms:${pet.owner_phone || pet.customerPhone}?body=${encodeURIComponent("I've arrived! Ready when you are.")}" class="px-2.5 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            ðŸ  Arrived
                                        </a>
                                        <a href="sms:${pet.owner_phone || pet.customerPhone}?body=${encodeURIComponent("Grooming complete! " + (pet.name || pet.petName || "Your fur baby") + " looks amazing. ðŸ•âœ¨")}" class="px-2.5 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:border-green-400 hover:text-green-600 transition-colors">
                                            âœ… Done
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Grooming Notes & Preferences -->
                        <div class="bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-4 border border-amber-200 dark:border-amber-800">
                            <h3 class="text-xs font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">note</span>
                                Grooming Notes
                            </h3>
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                ${pet.grooming_notes || pet.petNotes || 'No special notes recorded for this pet.'}
                            </p>
                        </div>
                        
                        <!-- Photo Gallery -->
                        ${photoHistory.length > 0 ? `
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Photo History</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${photoHistory.map(apt => `
                                    ${apt.before_photo_url ? `
                                        <div class="aspect-square rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 relative">
                                            <img src="${apt.before_photo_url}" class="w-full h-full object-cover"/>
                                            <span class="absolute bottom-1 left-1 px-1.5 py-0.5 bg-black/60 text-white text-[10px] rounded">Before</span>
                                        </div>
                                    ` : ''}
                                    ${apt.after_photo_url ? `
                                        <div class="aspect-square rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 relative">
                                            <img src="${apt.after_photo_url}" class="w-full h-full object-cover"/>
                                            <span class="absolute bottom-1 left-1 px-1.5 py-0.5 bg-black/60 text-white text-[10px] rounded">After</span>
                                        </div>
                                    ` : ''}
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Appointment History -->
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Recent Appointments</h3>
                            <div class="space-y-2">
                                ${history.slice(0, 5).map(apt => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                        <div>
                                            <p class="font-medium text-slate-900 dark:text-white text-sm">${apt.serviceName || 'Grooming'}</p>
                                            <p class="text-xs text-slate-500">${formatDate(apt.appointment_date)}</p>
                                        </div>
                                        <span class="px-2 py-1 text-xs font-bold rounded-full ${
                                            apt.status === 'completed' ? 'bg-green-100 text-green-700' :
                                            apt.status === 'in_progress' ? 'bg-purple-100 text-purple-700' :
                                            apt.status === 'confirmed' ? 'bg-blue-100 text-blue-700' :
                                            'bg-slate-100 text-slate-600'
                                        }">${apt.status}</span>
                                    </div>
                                `).join('')}
                                ${history.length === 0 ? `
                                    <p class="text-sm text-slate-500 text-center py-4">No appointment history yet</p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        // =============================================
        // QUICK TEXT TEMPLATES
        // =============================================
        const quickTemplates = [
            { icon: 'ðŸš—', text: "On my way! Should arrive in about 10 minutes.", category: 'arrival' },
            { icon: 'â°', text: "Running about 10 minutes late, sorry for the delay!", category: 'delay' },
            { icon: 'ðŸ ', text: "I've arrived! Ready when you are.", category: 'arrival' },
            { icon: 'âœ‚ï¸', text: "Starting the grooming session now!", category: 'progress' },
            { icon: 'ðŸ›', text: "Bath time! Your pup is doing great.", category: 'progress' },
            { icon: 'âœ…', text: "Grooming complete! Your fur baby looks amazing.", category: 'complete' },
            { icon: 'ðŸ“¸', text: "Just sent you some photos of the finished groom!", category: 'complete' },
            { icon: 'â“', text: "Quick question about today's appointment...", category: 'question' },
            { icon: 'ðŸ“…', text: "Just a reminder about your upcoming appointment!", category: 'reminder' },
            { icon: 'ðŸ™', text: "Thank you for choosing Dogfathers Plus!", category: 'thanks' }
        ];
        
        function toggleQuickTemplates() {
            state.showQuickTemplates = !state.showQuickTemplates;
            render();
        }
        
        function selectQuickTemplate(template) {
            const input = document.getElementById('message-input');
            if (input) {
                input.value = template.text;
                input.focus();
            }
            state.showQuickTemplates = false;
            render();
        }
        
        function sendQuickTemplate(template) {
            // Send template directly
            const event = { preventDefault: () => {} };
            const input = document.getElementById('message-input');
            if (input) {
                input.value = template.text;
            }
            sendGroomerMessage(event);
            state.showQuickTemplates = false;
        }
        
        function startGroomerShift() {
            localStorage.setItem('groomer_shift_start', new Date().toISOString());
            showToast('Shift started! Have a great day! ðŸš', 'success');
            render();
        }
        
        function endGroomerShift() {
            const start = localStorage.getItem('groomer_shift_start');
            if (start) {
                const duration = Math.floor((new Date() - new Date(start)) / 60000);
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                showToast(`Shift ended! Total time: ${hours}h ${mins}m. Great work! ðŸŽ‰`, 'success');
            }
            localStorage.removeItem('groomer_shift_start');
            render();
        }
        
        function openConversation(conversationId) {
            state.activeConversation = conversationId;
            render();
            // Scroll to bottom of messages
            setTimeout(() => {
                const container = document.getElementById('messages-container');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function loadGroomerMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .or(`sender_id.eq.${state.currentUser.id},recipient_id.eq.${state.currentUser.id}`)
                    .order('created_at', { ascending: true });
                
                if (!error && data) {
                    state.groomerMessages = data;
                    render();
                }
            } catch (err) {
                console.log('Messages table may not exist yet');
                state.groomerMessages = [];
            }
        }
        
        async function sendGroomerMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const message = input?.value?.trim();
            if (!message) return;
            
            try {
                // Try to insert into messages table
                const { error } = await supabaseClient
                    .from('messages')
                    .insert({
                        sender_id: state.currentUser.id,
                        message: message,
                        to_admin: true,
                        is_read: false
                    });
                
                if (error) {
                    // If table doesn't exist, just show locally
                    console.log('Messages table may not exist');
                }
                
                // Add to local state for immediate feedback
                state.groomerMessages = state.groomerMessages || [];
                state.groomerMessages.push({
                    id: Date.now(),
                    sender_id: state.currentUser.id,
                    message: message,
                    to_admin: true,
                    created_at: new Date().toISOString()
                });
                
                input.value = '';
                render();
                
                // Scroll to bottom
                setTimeout(() => {
                    const container = document.getElementById('messages-container');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);
            } catch (err) {
                console.error('Error sending message:', err);
                showToast('Failed to send message', 'error');
            }
        }

        // Render individual appointment card for groomer (kept for schedule view compatibility)
        function renderGroomerAppointmentCard(apt, isUpcoming = false, isCompleted = false) {
            const statusColors = {
                pending: 'bg-amber-100 text-amber-700',
                confirmed: 'bg-blue-100 text-blue-700',
                in_progress: 'bg-purple-100 text-purple-700',
                completed: 'bg-green-100 text-green-700',
                cancelled: 'bg-red-100 text-red-700'
            };
            
            const fullAddress = apt.service_address || apt.customerAddress || 'Address not provided';
            const city = apt.service_city || apt.customerCity || '';
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress + (city ? ', ' + city : ''))}`;
            
            // Calculate elapsed time if in progress
            let elapsedTime = '';
            if (apt.status === 'in_progress' && apt.started_at) {
                const started = new Date(apt.started_at);
                const now = new Date();
                const mins = Math.floor((now - started) / 60000);
                elapsedTime = mins < 60 ? `${mins}m` : `${Math.floor(mins/60)}h ${mins%60}m`;
            }
            
            return `
            <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm overflow-hidden ${apt.status === 'in_progress' ? 'ring-2 ring-purple-500' : ''}">
                <div class="p-5">
                    <!-- Header: Time & Status -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-14 h-14 rounded-xl ${apt.status === 'in_progress' ? 'bg-purple-100 dark:bg-purple-900/30' : 'bg-emerald-100 dark:bg-emerald-900/30'} flex items-center justify-center">
                                <span class="material-symbols-outlined text-2xl ${apt.status === 'in_progress' ? 'text-purple-600' : 'text-emerald-600'}">${apt.status === 'in_progress' ? 'timer' : 'schedule'}</span>
                            </div>
                            <div>
                                <p class="text-lg font-bold dark:text-white">${formatTime(apt.start_time)}</p>
                                <p class="text-sm text-slate-500">${isUpcoming ? formatDate(apt.appointment_date) : 'Today'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${apt.status === 'in_progress' && elapsedTime ? `
                                <span class="px-2 py-1 text-xs font-bold rounded-full bg-purple-500 text-white animate-pulse">
                                    ${elapsedTime} elapsed
                                </span>
                            ` : ''}
                            <span class="px-3 py-1 text-xs font-bold rounded-full uppercase ${statusColors[apt.status] || 'bg-gray-100 text-gray-600'}">
                                ${apt.status === 'in_progress' ? 'In Progress' : apt.status}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Customer & Pet Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Customer -->
                        <div class="bg-slate-50 dark:bg-background-dark rounded-lg p-4">
                            <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">Customer</h4>
                            <p class="font-bold dark:text-white">${apt.customerName}</p>
                            ${apt.customerPhone ? `
                                <a href="tel:${apt.customerPhone}" class="flex items-center gap-1 text-sm text-emerald-600 hover:underline mt-1">
                                    <span class="material-symbols-outlined text-sm">call</span>${apt.customerPhone}
                                </a>
                            ` : ''}
                        </div>
                        
                        <!-- Pet -->
                        <div class="bg-slate-50 dark:bg-background-dark rounded-lg p-4">
                            <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">Pet</h4>
                            <div class="flex items-center gap-3">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" alt="${apt.petName}" class="w-12 h-12 rounded-lg object-cover"/>` : ''}
                                <div>
                                    <p class="font-bold dark:text-white">${apt.petName}</p>
                                    <p class="text-sm text-slate-500">${apt.petBreed || 'Unknown breed'}${apt.petWeight ? ' â€¢ ' + apt.petWeight + ' lbs' : ''}</p>
                                </div>
                            </div>
                            ${apt.petNotes ? `<p class="text-sm text-slate-600 dark:text-slate-400 mt-2 italic">"${apt.petNotes}"</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- Service & Address -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-slate-400">content_cut</span>
                            <div>
                                <p class="font-semibold dark:text-white">${apt.serviceName}</p>
                                <p class="text-sm text-slate-500">${apt.serviceDuration || 60} min â€¢ $${apt.total_price || apt.servicePrice || '0'}</p>
                            </div>
                        </div>
                        <a href="${mapsUrl}" target="_blank" class="flex items-center gap-3 text-emerald-600 hover:text-emerald-700">
                            <span class="material-symbols-outlined">directions</span>
                            <div>
                                <p class="font-semibold">${fullAddress}</p>
                                <p class="text-sm text-slate-500">${city}</p>
                            </div>
                        </a>
                    </div>
                    
                    ${apt.customer_notes ? `
                        <div class="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-3 mb-4">
                            <p class="text-sm text-amber-800 dark:text-amber-200">
                                <span class="font-semibold">Customer Notes:</span> ${apt.customer_notes}
                            </p>
                        </div>
                    ` : ''}
                    
                    ${apt.groomer_notes ? `
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                <span class="font-semibold">Your Notes:</span> ${apt.groomer_notes}
                            </p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Action Buttons -->
                ${!isCompleted && apt.status !== 'completed' && apt.status !== 'cancelled' ? `
                    <div class="px-5 py-4 bg-slate-50 dark:bg-background-dark border-t border-slate-200 dark:border-border-dark">
                        ${apt.status === 'confirmed' ? `
                            <!-- Start Button for confirmed appointments -->
                            <button onclick="startGroomingAppointment('${apt.id}')" 
                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                                <span class="material-symbols-outlined">play_circle</span>
                                Start Appointment
                            </button>
                        ` : apt.status === 'in_progress' ? `
                            <!-- Complete Button for in-progress appointments -->
                            <div class="space-y-3">
                                <textarea id="groomer-notes-${apt.id}" placeholder="Add notes (optional): e.g., found tick, recommend shorter cut next time..." 
                                    class="w-full h-20 px-4 py-3 rounded-lg bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark text-sm resize-none"></textarea>
                                <button onclick="openCompleteAppointmentModal('${apt.id}')" 
                                    class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Complete & Award Points
                                </button>
                            </div>
                        ` : `
                            <!-- Mark Complete for pending (edge case - should go through start first) -->
                            <button onclick="startGroomingAppointment('${apt.id}')" 
                                class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                                <span class="material-symbols-outlined">check_circle</span>
                                Mark as Completed
                            </button>
                        `}
                    </div>
                ` : ''}
                
                ${isCompleted && apt.actual_duration_minutes ? `
                    <div class="px-5 py-3 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-700">
                        <p class="text-sm text-green-700 dark:text-green-300 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">timer</span>
                            Duration: ${Math.floor(apt.actual_duration_minutes)} minutes
                        </p>
                    </div>
                ` : ''}
            </div>`;
        }

        // =============================================
        // GROOMER MANAGEMENT FUNCTIONS (Admin)
        // =============================================
        
        // Render individual groomer card for admin panel
        function renderGroomerCard(g) {
            const initials = (g.full_name || 'G').split(' ').map(n => n.charAt(0)).join('').toUpperCase().slice(0, 2);
            const specialtyLabels = (g.specialties || []).map(s => {
                const spec = GROOMER_SPECIALTIES.find(sp => sp.id === s);
                return spec ? spec.label : s;
            });
            
            return `
            <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all ${g.is_active === false ? 'opacity-60' : ''}">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-emerald-500/25">
                            ${initials}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white truncate">${g.full_name || 'Groomer'}</h3>
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold ${g.is_active !== false ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400'}">
                                    <span class="w-1.5 h-1.5 rounded-full ${g.is_active !== false ? 'bg-emerald-500' : 'bg-slate-400'}"></span>
                                    ${g.is_active !== false ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="flex flex-col gap-1 text-sm text-slate-500 dark:text-slate-400">
                                <a href="mailto:${g.email}" class="hover:text-primary flex items-center gap-1.5">
                                    <span class="material-symbols-outlined text-sm">email</span>${g.email}
                                </a>
                                ${g.phone ? `
                                <a href="tel:${g.phone}" class="hover:text-primary flex items-center gap-1.5">
                                    <span class="material-symbols-outlined text-sm">phone</span>${g.phone}
                                </a>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hired Date -->
                    ${g.hired_date ? `
                    <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-4">
                        <span class="material-symbols-outlined text-sm">calendar_month</span>
                        Hired: ${new Date(g.hired_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </div>` : ''}
                    
                    <!-- Specialties -->
                    ${specialtyLabels.length > 0 ? `
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${specialtyLabels.map(s => `
                            <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-xs font-medium text-slate-600 dark:text-slate-300">
                                ${s}
                            </span>
                        `).join('')}
                    </div>` : ''}
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-3 p-4 bg-slate-50 dark:bg-background-dark rounded-xl mb-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">${g.appointmentsThisMonth || 0}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Appointments</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">$${(g.revenueThisMonth || 0).toFixed(0)}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Revenue</p>
                        </div>
                    </div>
                    
                    <!-- Admin Notes (if any) -->
                    ${g.admin_notes ? `
                    <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg mb-4">
                        <p class="text-xs text-amber-800 dark:text-amber-200">
                            <span class="font-semibold">Notes:</span> ${g.admin_notes}
                        </p>
                    </div>` : ''}
                </div>
                
                <!-- Actions -->
                <div class="px-6 py-4 bg-slate-50 dark:bg-background-dark border-t border-slate-100 dark:border-border-dark flex gap-2">
                    <button onclick="openEditGroomerModal('${g.id}')" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-lg text-sm font-medium text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">
                        <span class="material-symbols-outlined text-lg">edit</span>Edit
                    </button>
                    <button onclick="openGroomerScheduleModal('${g.id}')" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-lg text-sm font-medium text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">
                        <span class="material-symbols-outlined text-lg">calendar_today</span>Schedule
                    </button>
                    <button onclick="toggleGroomerActive('${g.id}', ${g.is_active !== false})" class="flex items-center justify-center px-3 py-2.5 bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-lg text-sm font-medium ${g.is_active !== false ? 'text-red-600 hover:border-red-300 hover:bg-red-50 dark:hover:bg-red-900/20' : 'text-emerald-600 hover:border-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/20'} transition-all" title="${g.is_active !== false ? 'Deactivate' : 'Reactivate'}">
                        <span class="material-symbols-outlined text-lg">${g.is_active !== false ? 'person_off' : 'person_add'}</span>
                    </button>
                </div>
            </div>`;
        }
        
        // Render Add Groomer Modal
        function renderAddGroomerModal() {
            if (!state.showAddGroomerModal) return '';
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeAddGroomerModal()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark flex justify-between items-center sticky top-0 bg-white dark:bg-surface-dark z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400">person_add</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Add New Groomer</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Create login credentials for your groomer</p>
                            </div>
                        </div>
                        <button onclick="closeAddGroomerModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-slate-400">close</span>
                        </button>
                    </div>
                    
                    <form id="add-groomer-form" class="p-6 space-y-5">
                        <!-- Full Name -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
                            <input type="text" id="groomer-name" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                placeholder="Rosa Martinez">
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email * <span class="font-normal text-slate-400">(used for login)</span></label>
                            <input type="email" id="groomer-email-input" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                placeholder="rosa@dogfathersplus.com">
                        </div>
                        
                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Password * <span class="font-normal text-slate-400">(share with groomer)</span></label>
                            <div class="relative">
                                <input type="password" id="groomer-password-input" required minlength="6"
                                    class="w-full px-4 py-3 pr-12 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <button type="button" onclick="toggleGroomerPasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600">
                                    <span class="material-symbols-outlined" id="groomer-password-toggle">visibility</span>
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-amber-600 dark:text-amber-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">warning</span>
                                Write this down! You won't be able to see it again.
                            </p>
                        </div>
                        
                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
                            <input type="tel" id="groomer-phone-input"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                placeholder="(555) 123-4567">
                        </div>
                        
                        <!-- Hired Date -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Hired Date</label>
                            <input type="date" id="groomer-hired-date"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <!-- Specialties -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Specialties</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${GROOMER_SPECIALTIES.map(s => `
                                    <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-border-dark hover:border-emerald-300 hover:bg-emerald-50/50 dark:hover:bg-emerald-900/20 cursor-pointer transition-all">
                                        <input type="checkbox" name="groomer-specialty" value="${s.id}" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                                        <span class="text-sm text-slate-700 dark:text-slate-300">${s.icon} ${s.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Admin Notes -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Admin Notes <span class="font-normal text-slate-400">(internal only)</span></label>
                            <textarea id="groomer-admin-notes" rows="2"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all resize-none"
                                placeholder="Available Mon-Fri, prefers morning shifts..."></textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="w-full py-3.5 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-600/25">
                            <span class="material-symbols-outlined">person_add</span>
                            Add Groomer
                        </button>
                    </form>
                </div>
            </div>`;
        }
        
        // =============================================
        // ADMIN ADD APPOINTMENT MODAL
        // =============================================
        
        function openAdminAddAppointment() {
            state.showAdminAddAppointment = true;
            state.adminAppointmentStep = 1;
            state.adminCustomerSearch = '';
            state.adminCustomerSearchResults = [];
            state.adminSelectedCustomer = null;
            state.adminSelectedPet = null;
            state.adminNewCustomer = null;
            state.adminNewPet = null;
            render();
        }
        
        function closeAdminAddAppointment() {
            state.showAdminAddAppointment = false;
            state.adminAppointmentStep = 1;
            state.adminCustomerSearch = '';
            state.adminCustomerSearchResults = [];
            state.adminSelectedCustomer = null;
            state.adminSelectedPet = null;
            state.adminNewCustomer = null;
            state.adminNewPet = null;
            render();
        }
        
        // Search customers by phone or name
        async function searchCustomersForAppointment(query) {
            state.adminCustomerSearch = query;
            
            if (!query || query.length < 2) {
                state.adminCustomerSearchResults = [];
                render();
                return;
            }
            
            try {
                // Search by phone or name
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name, email, phone, address, city, zip_code')
                    .or(`phone.ilike.%${query}%,full_name.ilike.%${query}%`)
                    .neq('role', 'admin')
                    .neq('role', 'groomer')
                    .limit(10);
                
                if (error) {
                    console.error('Customer search error:', error);
                    state.adminCustomerSearchResults = [];
                } else {
                    state.adminCustomerSearchResults = data || [];
                }
                render();
            } catch (err) {
                console.error('Search failed:', err);
                state.adminCustomerSearchResults = [];
                render();
            }
        }
        
        // Select an existing customer
        async function selectCustomerForAppointment(customerId) {
            const customer = state.adminCustomerSearchResults.find(c => c.id === customerId);
            if (!customer) return;
            
            state.adminSelectedCustomer = customer;
            state.adminNewCustomer = null;
            state.adminCustomerSearchResults = [];
            
            // Load this customer's pets
            try {
                const { data: pets } = await supabaseClient
                    .from('pets')
                    .select('*')
                    .eq('owner_id', customerId)
                    .eq('is_active', true);
                
                state.adminSelectedCustomer.pets = pets || [];
            } catch (err) {
                console.error('Failed to load pets:', err);
                state.adminSelectedCustomer.pets = [];
            }
            
            state.adminAppointmentStep = 2;
            render();
        }
        
        // Start creating a new customer inline
        function startNewCustomerForAppointment() {
            state.adminNewCustomer = {
                full_name: '',
                phone: '',
                email: '',
                address: '',
                city: '',
                zip_code: ''
            };
            state.adminSelectedCustomer = null;
            state.adminCustomerSearchResults = [];
            render();
        }
        
        // Save the new customer and move to pet step
        async function saveNewCustomerAndContinue() {
            const nameEl = document.getElementById('new-customer-name');
            const phoneEl = document.getElementById('new-customer-phone');
            const emailEl = document.getElementById('new-customer-email');
            const addressEl = document.getElementById('new-customer-address');
            const cityEl = document.getElementById('new-customer-city');
            const zipEl = document.getElementById('new-customer-zip');
            
            const name = nameEl?.value?.trim();
            const phone = phoneEl?.value?.trim();
            const email = emailEl?.value?.trim() || null;
            const address = addressEl?.value?.trim();
            const city = cityEl?.value?.trim();
            const zip = zipEl?.value?.trim();
            
            // Validation
            if (!name) {
                showToast('Customer name is required', 'error');
                return;
            }
            if (!phone) {
                showToast('Phone number is required', 'error');
                return;
            }
            if (!address || !city) {
                showToast('Address and city are required for scheduling', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Check if phone already exists
                const { data: existing } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name')
                    .eq('phone', phone)
                    .maybeSingle();
                
                if (existing) {
                    hideLoading();
                    showToast(`Phone number already exists for ${existing.full_name}. Please select them from search.`, 'error');
                    return;
                }
                
                // Generate a UUID for admin-created customer (no auth account)
                const newId = crypto.randomUUID();
                
                // Create the customer profile (without auth - admin created)
                const { data: newCustomer, error } = await supabaseClient
                    .from('profiles')
                    .insert({
                        id: newId,
                        full_name: name,
                        phone: phone,
                        email: email,
                        address: address,
                        city: city,
                        zip_code: zip,
                        role: 'customer',
                        created_by_admin: true,
                        loyalty_points: 0
                    })
                    .select()
                    .single();
                
                if (error) {
                    hideLoading();
                    console.error('Failed to create customer:', error);
                    showToast('Failed to create customer: ' + error.message, 'error');
                    return;
                }
                
                state.adminSelectedCustomer = {
                    ...newCustomer,
                    pets: []
                };
                state.adminNewCustomer = null;
                state.adminAppointmentStep = 2;
                
                hideLoading();
                showToast('Customer created successfully!', 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Error creating customer:', err);
                showToast('Failed to create customer', 'error');
            }
        }
        
        // Select an existing pet
        function selectPetForAppointment(petId) {
            const pet = state.adminSelectedCustomer?.pets?.find(p => p.id === petId);
            if (!pet) return;
            
            state.adminSelectedPet = pet;
            state.adminNewPet = null;
            state.adminAppointmentStep = 3;
            render();
        }
        
        // Start creating a new pet inline
        function startNewPetForAppointment() {
            state.adminNewPet = {
                name: '',
                breed: '',
                weight: '',
                grooming_notes: ''
            };
            state.adminSelectedPet = null;
            render();
        }
        
        // Save new pet and continue to appointment
        async function saveNewPetAndContinue() {
            const nameEl = document.getElementById('new-pet-name');
            const breedEl = document.getElementById('new-pet-breed');
            const weightEl = document.getElementById('new-pet-weight');
            const notesEl = document.getElementById('new-pet-notes');
            
            const name = nameEl?.value?.trim();
            const breed = breedEl?.value?.trim();
            const weight = weightEl?.value?.trim();
            const notes = notesEl?.value?.trim();
            
            if (!name) {
                showToast('Pet name is required', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const { data: newPet, error } = await supabaseClient
                    .from('pets')
                    .insert({
                        owner_id: state.adminSelectedCustomer.id,
                        name: name,
                        breed: breed || null,
                        weight: weight ? parseFloat(weight) : null,
                        grooming_notes: notes || null,
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (error) {
                    hideLoading();
                    showToast('Failed to create pet: ' + error.message, 'error');
                    return;
                }
                
                state.adminSelectedPet = newPet;
                state.adminNewPet = null;
                state.adminAppointmentStep = 3;
                
                hideLoading();
                showToast('Pet added successfully!', 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Error creating pet:', err);
                showToast('Failed to create pet', 'error');
            }
        }
        
        // Go back a step
        function adminAppointmentBack() {
            if (state.adminAppointmentStep > 1) {
                state.adminAppointmentStep--;
                if (state.adminAppointmentStep === 1) {
                    state.adminSelectedPet = null;
                    state.adminNewPet = null;
                }
                render();
            }
        }
        
        // Create the appointment
        async function createAdminAppointment(event) {
            event.preventDefault();
            
            const dateEl = document.getElementById('admin-appt-date');
            const timeEl = document.getElementById('admin-appt-time');
            const serviceEl = document.getElementById('admin-appt-service');
            const groomerEl = document.getElementById('admin-appt-groomer');
            const priceEl = document.getElementById('admin-appt-price');
            const notesEl = document.getElementById('admin-appt-notes');
            
            const date = dateEl?.value;
            const time = timeEl?.value;
            const serviceId = serviceEl?.value;
            const groomerId = groomerEl?.value;
            const price = priceEl?.value;
            const notes = notesEl?.value?.trim();
            
            if (!date || !time || !groomerId) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const customer = state.adminSelectedCustomer;
                const pet = state.adminSelectedPet;
                const service = state.services.find(s => s.id === serviceId);
                
                // Geocode the address
                let latitude = null, longitude = null;
                if (customer.address && customer.city) {
                    const coords = await geocodeAddress(customer.address, customer.city, 'CA', customer.zip_code);
                    if (coords) {
                        latitude = coords.latitude;
                        longitude = coords.longitude;
                    }
                }
                
                const appointmentData = {
                    customer_id: customer.id,
                    pet_id: pet.id,
                    appointment_date: date,
                    start_time: time,
                    duration_minutes: service?.duration_minutes || 120,
                    service_id: serviceId && serviceId.length > 10 ? serviceId : null,
                    service_address: customer.address,
                    service_city: customer.city,
                    service_state: 'CA',
                    service_zip: customer.zip_code,
                    latitude: latitude,
                    longitude: longitude,
                    base_price: parseFloat(price) || service?.base_price || 0,
                    total_price: parseFloat(price) || service?.base_price || 0,
                    assigned_groomer_id: groomerId,
                    customer_notes: notes,
                    status: 'confirmed'
                };
                
                const { data, error } = await supabaseClient
                    .from('appointments')
                    .insert(appointmentData)
                    .select()
                    .single();
                
                if (error) {
                    hideLoading();
                    showToast('Failed to create appointment: ' + error.message, 'error');
                    return;
                }
                
                // Reload admin data
                await loadAdminData();
                
                hideLoading();
                showToast('Appointment created successfully!', 'success');
                closeAdminAddAppointment();
                
            } catch (err) {
                hideLoading();
                console.error('Error creating appointment:', err);
                showToast('Failed to create appointment', 'error');
            }
        }
        
        // Render the admin add appointment modal
        function renderAdminAddAppointmentModal() {
            if (!state.showAdminAddAppointment) return '';
            
            const step = state.adminAppointmentStep;
            const customer = state.adminSelectedCustomer;
            const pet = state.adminSelectedPet;
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeAdminAddAppointment()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark flex justify-between items-center sticky top-0 bg-white dark:bg-surface-dark z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary">calendar_add_on</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">New Appointment</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Step ${step} of 3: ${step === 1 ? 'Customer' : step === 2 ? 'Pet' : 'Appointment Details'}</p>
                            </div>
                        </div>
                        <button onclick="closeAdminAddAppointment()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-slate-400">close</span>
                        </button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="px-6 pt-4">
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 rounded-full ${step >= 1 ? 'bg-primary' : 'bg-slate-200'}"></div>
                            <div class="flex-1 h-2 rounded-full ${step >= 2 ? 'bg-primary' : 'bg-slate-200'}"></div>
                            <div class="flex-1 h-2 rounded-full ${step >= 3 ? 'bg-primary' : 'bg-slate-200'}"></div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                        ${step === 1 ? renderAdminAppointmentStep1() : ''}
                        ${step === 2 ? renderAdminAppointmentStep2() : ''}
                        ${step === 3 ? renderAdminAppointmentStep3() : ''}
                    </div>
                </div>
            </div>`;
        }
        
        // Step 1: Select or Create Customer
        function renderAdminAppointmentStep1() {
            const searchResults = state.adminCustomerSearchResults || [];
            const newCustomer = state.adminNewCustomer;
            
            // If creating new customer
            if (newCustomer !== null) {
                return `
                <div class="space-y-5">
                    <div class="flex items-center gap-2 text-primary mb-4">
                        <span class="material-symbols-outlined">person_add</span>
                        <span class="font-bold">New Customer</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
                            <input type="text" id="new-customer-name" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="John Smith">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Phone * <span class="font-normal text-slate-400">(primary identifier)</span></label>
                            <input type="tel" id="new-customer-phone" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="(818) 555-1234">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email <span class="font-normal text-slate-400">(optional)</span></label>
                            <input type="email" id="new-customer-email"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="john@email.com">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Street Address *</label>
                            <input type="text" id="new-customer-address" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="123 Main Street">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">City *</label>
                            <input type="text" id="new-customer-city" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="Los Angeles">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">ZIP Code</label>
                            <input type="text" id="new-customer-zip"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="91401">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button onclick="state.adminNewCustomer = null; render();" class="flex-1 py-3 border border-slate-200 dark:border-border-dark text-slate-700 dark:text-slate-300 font-semibold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            Back to Search
                        </button>
                        <button onclick="saveNewCustomerAndContinue()" class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">arrow_forward</span>
                            Continue to Pet
                        </button>
                    </div>
                </div>`;
            }
            
            // Search mode
            return `
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Search Customer by Phone or Name</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">search</span>
                        <input type="text" id="customer-search-input"
                            class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                            placeholder="Enter phone number or name..."
                            value="${state.adminCustomerSearch || ''}"
                            oninput="searchCustomersForAppointment(this.value)">
                    </div>
                </div>
                
                ${searchResults.length > 0 ? `
                    <div class="space-y-2">
                        <p class="text-sm text-slate-500">Found ${searchResults.length} customer(s):</p>
                        ${searchResults.map(c => `
                            <button onclick="selectCustomerForAppointment('${c.id}')" class="w-full p-4 rounded-xl border border-slate-200 dark:border-border-dark hover:border-primary hover:bg-primary/5 text-left transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary">person</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-slate-900 dark:text-white">${c.full_name}</p>
                                        <p class="text-sm text-slate-500">${c.phone || 'No phone'} ${c.email ? 'â€¢ ' + c.email : ''}</p>
                                        ${c.address ? `<p class="text-xs text-slate-400">${c.address}, ${c.city || ''}</p>` : ''}
                                    </div>
                                    <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                ` : state.adminCustomerSearch && state.adminCustomerSearch.length >= 2 ? `
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">person_off</span>
                        <p class="text-slate-500">No customers found matching "${state.adminCustomerSearch}"</p>
                    </div>
                ` : ''}
                
                <div class="pt-4 border-t border-slate-100 dark:border-border-dark">
                    <button onclick="startNewCustomerForAppointment()" class="w-full py-3 border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400 font-semibold rounded-xl hover:border-primary hover:text-primary transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">person_add</span>
                        Create New Customer
                    </button>
                </div>
            </div>`;
        }
        
        // Step 2: Select or Create Pet
        function renderAdminAppointmentStep2() {
            const customer = state.adminSelectedCustomer;
            const pets = customer?.pets || [];
            const newPet = state.adminNewPet;
            
            // If creating new pet
            if (newPet !== null) {
                return `
                <div class="space-y-5">
                    <div class="flex items-center gap-2 text-primary mb-4">
                        <span class="material-symbols-outlined">pets</span>
                        <span class="font-bold">New Pet for ${customer.full_name}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Pet Name *</label>
                            <input type="text" id="new-pet-name" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="Buddy">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Breed</label>
                            <input type="text" id="new-pet-breed"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="Golden Retriever">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Weight (lbs)</label>
                            <input type="number" id="new-pet-weight"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="65">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Grooming Notes</label>
                            <input type="text" id="new-pet-notes"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="Sensitive ears, likes treats">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button onclick="state.adminNewPet = null; render();" class="flex-1 py-3 border border-slate-200 dark:border-border-dark text-slate-700 dark:text-slate-300 font-semibold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            Back
                        </button>
                        <button onclick="saveNewPetAndContinue()" class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">arrow_forward</span>
                            Continue
                        </button>
                    </div>
                </div>`;
            }
            
            return `
            <div class="space-y-5">
                <!-- Selected Customer Summary -->
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">person</span>
                        </div>
                        <div>
                            <p class="font-bold text-slate-900 dark:text-white">${customer.full_name}</p>
                            <p class="text-sm text-slate-500">${customer.phone || ''} ${customer.address ? 'â€¢ ' + customer.address + ', ' + customer.city : ''}</p>
                        </div>
                        <button onclick="adminAppointmentBack()" class="ml-auto text-sm text-primary hover:underline">Change</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Select Pet</label>
                    
                    ${pets.length > 0 ? `
                        <div class="space-y-2">
                            ${pets.map(p => `
                                <button onclick="selectPetForAppointment('${p.id}')" class="w-full p-4 rounded-xl border border-slate-200 dark:border-border-dark hover:border-primary hover:bg-primary/5 text-left transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center overflow-hidden">
                                            ${p.photo_url ? `<img src="${p.photo_url}" class="w-full h-full object-cover">` : `<span class="material-symbols-outlined text-amber-600">pets</span>`}
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-bold text-slate-900 dark:text-white">${p.name}</p>
                                            <p class="text-sm text-slate-500">${p.breed || 'Dog'} ${p.weight ? 'â€¢ ' + p.weight + ' lbs' : ''}</p>
                                        </div>
                                        <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-6">
                            <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">pets</span>
                            <p class="text-slate-500">No pets found for this customer</p>
                        </div>
                    `}
                </div>
                
                <div class="pt-4 border-t border-slate-100 dark:border-border-dark">
                    <button onclick="startNewPetForAppointment()" class="w-full py-3 border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-400 font-semibold rounded-xl hover:border-primary hover:text-primary transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">add</span>
                        Add New Pet
                    </button>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button onclick="adminAppointmentBack()" class="flex-1 py-3 border border-slate-200 dark:border-border-dark text-slate-700 dark:text-slate-300 font-semibold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                        <span class="material-symbols-outlined text-sm mr-1">arrow_back</span>
                        Back
                    </button>
                </div>
            </div>`;
        }
        
        // Step 3: Appointment Details
        function renderAdminAppointmentStep3() {
            const customer = state.adminSelectedCustomer;
            const pet = state.adminSelectedPet;
            // Only show ACTIVE services in booking dropdown
            const services = (state.services || []).filter(s => s.is_active !== false);
            const groomers = state.groomers?.filter(g => g.is_active !== false) || [];
            const today = getTodayPacific();
            
            // Time slots (2-hour increments)
            const timeSlots = ['07:00', '09:00', '11:00', '13:00', '15:00', '17:00'];
            
            return `
            <div class="space-y-5">
                <!-- Customer & Pet Summary -->
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-sm">person</span>
                            <span class="font-semibold text-slate-900 dark:text-white">${customer.full_name}</span>
                        </div>
                        <span class="text-slate-300">|</span>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-amber-500 text-sm">pets</span>
                            <span class="font-semibold text-slate-900 dark:text-white">${pet.name}</span>
                            ${pet.breed ? `<span class="text-slate-500 text-sm">(${pet.breed})</span>` : ''}
                        </div>
                        <button onclick="adminAppointmentBack()" class="ml-auto text-sm text-primary hover:underline">Change</button>
                    </div>
                </div>
                
                <form onsubmit="createAdminAppointment(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Date *</label>
                            <input type="date" id="admin-appt-date" required min="${today}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                        </div>
                        
                        <!-- Time -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Time *</label>
                            <select id="admin-appt-time" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                <option value="">Select time</option>
                                ${timeSlots.map(t => `<option value="${t}">${formatTime(t)}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Service -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Service</label>
                            <select id="admin-appt-service" onchange="updateAdminApptPrice()"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                <option value="">Select service</option>
                                ${services.filter(s => !s.is_addon).map(s => `<option value="${s.id}" data-price="${s.base_price}">${s.name} - $${s.base_price}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Groomer -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Groomer *</label>
                            <select id="admin-appt-groomer" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                <option value="">Select groomer</option>
                                ${groomers.map(g => `<option value="${g.id}">${g.full_name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Price -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Price ($)</label>
                            <input type="number" id="admin-appt-price" step="0.01" min="0"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="0.00">
                        </div>
                        
                        <!-- Notes -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Notes</label>
                            <textarea id="admin-appt-notes" rows="2"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all resize-none"
                                placeholder="Any special instructions..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="adminAppointmentBack()" class="flex-1 py-3 border border-slate-200 dark:border-border-dark text-slate-700 dark:text-slate-300 font-semibold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            <span class="material-symbols-outlined text-sm mr-1">arrow_back</span>
                            Back
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">check</span>
                            Create Appointment
                        </button>
                    </div>
                </form>
            </div>`;
        }
        
        // Update price when service is selected
        function updateAdminApptPrice() {
            const serviceEl = document.getElementById('admin-appt-service');
            const priceEl = document.getElementById('admin-appt-price');
            
            if (serviceEl && priceEl) {
                const selectedOption = serviceEl.options[serviceEl.selectedIndex];
                const price = selectedOption?.dataset?.price;
                if (price) {
                    priceEl.value = price;
                }
            }
        }
        
        // Render Edit Groomer Modal
        function renderEditGroomerModal() {
            if (!state.showEditGroomerModal || !state.editingGroomer) return '';
            
            const g = state.editingGroomer;
            const currentSpecialties = g.specialties || [];
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeEditGroomerModal()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark flex justify-between items-center sticky top-0 bg-white dark:bg-surface-dark z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">edit</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Edit Groomer</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${g.full_name}</p>
                            </div>
                        </div>
                        <button onclick="closeEditGroomerModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-slate-400">close</span>
                        </button>
                    </div>
                    
                    <form id="edit-groomer-form" class="p-6 space-y-5">
                        <input type="hidden" id="edit-groomer-id" value="${g.id}">
                        
                        <!-- Full Name -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
                            <input type="text" id="edit-groomer-name" required value="${g.full_name || ''}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all">
                        </div>
                        
                        <!-- Email (read-only) -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email <span class="font-normal text-slate-400">(cannot be changed)</span></label>
                            <input type="email" value="${g.email || ''}" disabled
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 cursor-not-allowed">
                        </div>
                        
                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
                            <input type="tel" id="edit-groomer-phone" value="${g.phone || ''}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all"
                                placeholder="(555) 123-4567">
                        </div>
                        
                        <!-- Hired Date -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Hired Date</label>
                            <input type="date" id="edit-groomer-hired-date" value="${g.hired_date || ''}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all">
                        </div>
                        
                        <!-- Specialties -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Specialties</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${GROOMER_SPECIALTIES.map(s => `
                                    <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-border-dark hover:border-blue-300 hover:bg-blue-50/50 dark:hover:bg-blue-900/20 cursor-pointer transition-all">
                                        <input type="checkbox" name="edit-groomer-specialty" value="${s.id}" ${currentSpecialties.includes(s.id) ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm text-slate-700 dark:text-slate-300">${s.icon} ${s.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Admin Notes -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Admin Notes</label>
                            <textarea id="edit-groomer-admin-notes" rows="2"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all resize-none"
                                placeholder="Internal notes...">${g.admin_notes || ''}</textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-600/25">
                            <span class="material-symbols-outlined">save</span>
                            Save Changes
                        </button>
                    </form>
                </div>
            </div>`;
        }
        
        // Render Groomer Schedule Modal
        function renderGroomerScheduleModal() {
            if (!state.showGroomerScheduleModal || !state.viewingGroomerSchedule) return '';
            
            const g = state.viewingGroomerSchedule;
            
            // Initialize month/year if not set
            if (state.adminScheduleMonth === null || state.adminScheduleYear === null) {
                const now = new Date();
                state.adminScheduleMonth = now.getMonth();
                state.adminScheduleYear = now.getFullYear();
            }
            
            const currentMonth = state.adminScheduleMonth;
            const currentYear = state.adminScheduleYear;
            
            // Debug: Log all appointments and their groomer IDs
            console.log('All appointments for schedule:', state.allAppointments.map(a => ({
                id: a.id,
                date: a.appointment_date,
                assigned_groomer_id: a.assigned_groomer_id,
                groomerMatch: a.assigned_groomer_id === g.id
            })));
            
            const groomerAppts = state.allAppointments.filter(a => a.assigned_groomer_id === g.id);
            console.log(`Filtered appointments for ${g.full_name}:`, groomerAppts);
            
            // Get calendar data for the selected month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const todayDate = new Date();
            const today = todayDate.getDate();
            const todayMonth = todayDate.getMonth();
            const todayYear = todayDate.getFullYear();
            
            // Count appointments per day
            const apptsByDay = {};
            const apptsByDateStr = {};
            groomerAppts.forEach(a => {
                if (a.appointment_date) {
                    let dateStr = a.appointment_date;
                    if (dateStr.length === 11 && dateStr.startsWith('20') && dateStr[4] === '0') {
                        dateStr = dateStr.substring(1);
                    }
                    // Parse date parts manually to avoid timezone issues
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2]);
                        
                        if (month === currentMonth && year === currentYear) {
                            apptsByDay[day] = (apptsByDay[day] || 0) + 1;
                            if (!apptsByDateStr[dateStr]) apptsByDateStr[dateStr] = [];
                            apptsByDateStr[dateStr].push(a);
                        }
                    }
                }
            });
            
            // Get selected day's appointments
            const selectedDateAppts = state.adminScheduleSelectedDate 
                ? groomerAppts.filter(a => {
                    let dateStr = a.appointment_date;
                    if (dateStr && dateStr.length === 11) dateStr = dateStr.substring(1);
                    return dateStr === state.adminScheduleSelectedDate;
                }).sort((a, b) => (a.start_time || '').localeCompare(b.start_time || ''))
                : [];
            
            // Calculate month stats
            const monthAppts = groomerAppts.filter(a => {
                if (!a.appointment_date) return false;
                let dateStr = a.appointment_date;
                if (dateStr.length === 11) dateStr = dateStr.substring(1);
                // Parse date parts manually to avoid timezone issues
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    return month === currentMonth && year === currentYear;
                }
                return false;
            });
            const completedMonth = monthAppts.filter(a => a.status === 'completed').length;
            const revenueMonth = monthAppts.filter(a => a.status === 'completed' || a.status === 'confirmed')
                .reduce((sum, a) => sum + (parseFloat(a.total_price) || 0), 0);
            
            // Generate calendar grid
            let calendarDays = '';
            for (let i = 0; i < startPadding; i++) {
                calendarDays += '<div class="aspect-square min-h-[44px]"></div>';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const count = apptsByDay[day] || 0;
                const isToday = day === today && currentMonth === todayMonth && currentYear === todayYear;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isSelected = state.adminScheduleSelectedDate === dateStr;
                
                calendarDays += `
                    <button onclick="selectAdminScheduleDate('${dateStr}')" class="aspect-square min-h-[44px] flex flex-col items-center justify-center rounded-xl transition-all hover:bg-emerald-50 dark:hover:bg-emerald-900/20 active:scale-95 ${isSelected ? 'ring-2 ring-emerald-500 bg-emerald-50 dark:bg-emerald-900/30' : ''} ${isToday ? 'bg-emerald-600 text-white hover:bg-emerald-700' : count > 0 ? 'bg-emerald-100 dark:bg-emerald-900/30' : ''}">
                        <span class="text-sm font-bold ${isToday ? 'text-white' : ''}">${day}</span>
                        ${count > 0 ? `<span class="text-[10px] ${isToday ? 'text-emerald-200' : 'text-emerald-600 dark:text-emerald-400'}">(${count})</span>` : ''}
                    </button>
                `;
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeGroomerScheduleModal()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-bold">
                                ${(g.full_name || 'G').split(' ').map(n => n.charAt(0)).join('').toUpperCase().slice(0, 2)}
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">${g.full_name}'s Schedule</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${monthAppts.length} appointments this month</p>
                            </div>
                        </div>
                        <button onclick="closeGroomerScheduleModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-slate-400">close</span>
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="flex gap-6">
                            <!-- Calendar Section -->
                            <div class="flex-1">
                                <!-- Month Navigation -->
                                <div class="flex items-center justify-between mb-4">
                                    <button onclick="adminSchedulePrevMonth()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                        <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">chevron_left</span>
                                    </button>
                                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">${monthNames[currentMonth]} ${currentYear}</h3>
                                    <button onclick="adminScheduleNextMonth()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                        <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">chevron_right</span>
                                    </button>
                                </div>
                                
                                <!-- Calendar Grid -->
                                <div class="bg-slate-50 dark:bg-background-dark rounded-xl p-4">
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <div class="text-center text-xs font-bold text-slate-400">Sun</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Mon</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Tue</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Wed</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Thu</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Fri</div>
                                        <div class="text-center text-xs font-bold text-slate-400">Sat</div>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1">
                                        ${calendarDays}
                                    </div>
                                </div>
                                
                                <!-- Month Summary -->
                                <div class="grid grid-cols-3 gap-4 p-4 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-xl mt-4">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-slate-900 dark:text-white">${monthAppts.length}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Total Appts</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${completedMonth}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Completed</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">$${revenueMonth.toFixed(0)}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Revenue</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Day Detail Panel -->
                            <div class="w-80 bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4">
                                ${state.adminScheduleSelectedDate ? `
                                    <div class="mb-4">
                                        <h4 class="font-bold text-slate-900 dark:text-white">${new Date(state.adminScheduleSelectedDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</h4>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">${selectedDateAppts.length} appointment${selectedDateAppts.length !== 1 ? 's' : ''}</p>
                                    </div>
                                    
                                    ${selectedDateAppts.length > 0 ? `
                                        <div class="space-y-2 max-h-80 overflow-y-auto">
                                            ${selectedDateAppts.map(a => `
                                                <div class="p-3 bg-white dark:bg-surface-dark rounded-lg border border-slate-200 dark:border-slate-700">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="font-bold text-emerald-600 dark:text-emerald-400">${formatTime(a.start_time)}</span>
                                                        <span class="px-2 py-0.5 rounded-full text-xs font-bold ${
                                                            a.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' :
                                                            a.status === 'confirmed' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300' :
                                                            a.status === 'in_progress' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300' :
                                                            a.status === 'pending' ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300' :
                                                            'bg-slate-100 text-slate-600'
                                                        }">${a.status === 'in_progress' ? 'In Progress' : a.status}</span>
                                                    </div>
                                                    <p class="font-medium text-slate-900 dark:text-white">${a.petName || 'Pet'}</p>
                                                    <p class="text-sm text-slate-500 dark:text-slate-400">${a.serviceName || 'Grooming'}</p>
                                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${a.customerName || 'Customer'}</p>
                                                    ${a.service_address || a.customerAddress ? `
                                                        <p class="text-xs text-slate-400 dark:text-slate-500">${a.service_address || a.customerAddress}, ${a.service_city || a.customerCity || ''}</p>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-8 text-slate-400 dark:text-slate-500">
                                            <span class="material-symbols-outlined text-3xl mb-2">event_available</span>
                                            <p class="text-sm">No appointments</p>
                                        </div>
                                    `}
                                ` : `
                                    <div class="text-center py-12 text-slate-400 dark:text-slate-500">
                                        <span class="material-symbols-outlined text-4xl mb-2">calendar_today</span>
                                        <p class="text-sm">Click a day to see appointments</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        // Admin schedule navigation functions
        function adminSchedulePrevMonth() {
            if (state.adminScheduleMonth === 0) {
                state.adminScheduleMonth = 11;
                state.adminScheduleYear--;
            } else {
                state.adminScheduleMonth--;
            }
            state.adminScheduleSelectedDate = null;
            render();
        }
        
        function adminScheduleNextMonth() {
            if (state.adminScheduleMonth === 11) {
                state.adminScheduleMonth = 0;
                state.adminScheduleYear++;
            } else {
                state.adminScheduleMonth++;
            }
            state.adminScheduleSelectedDate = null;
            render();
        }
        
        function selectAdminScheduleDate(dateStr) {
            state.adminScheduleSelectedDate = dateStr;
            render();
        }
        
        // Modal control functions
        function openAddGroomerModal() {
            state.showAddGroomerModal = true;
            render();
            // Attach form listener after render
            setTimeout(() => {
                const form = document.getElementById('add-groomer-form');
                if (form) {
                    form.addEventListener('submit', handleAddGroomer);
                }
            }, 100);
        }
        
        function closeAddGroomerModal() {
            state.showAddGroomerModal = false;
            render();
        }
        
        function openEditGroomerModal(groomerId) {
            const groomer = state.groomers.find(g => g.id === groomerId);
            if (groomer) {
                state.editingGroomer = groomer;
                state.showEditGroomerModal = true;
                render();
                // Attach form listener after render
                setTimeout(() => {
                    const form = document.getElementById('edit-groomer-form');
                    if (form) {
                        form.addEventListener('submit', handleEditGroomer);
                    }
                }, 100);
            }
        }
        
        function closeEditGroomerModal() {
            state.showEditGroomerModal = false;
            state.editingGroomer = null;
            render();
        }
        
        async function openGroomerScheduleModal(groomerId) {
            showLoading();
            
            // Reload data to get fresh appointments
            await loadAdminData();
            
            const groomer = state.groomers.find(g => g.id === groomerId);
            if (groomer) {
                state.viewingGroomerSchedule = groomer;
                state.showGroomerScheduleModal = true;
                
                // Debug: Log what appointments belong to this groomer
                const groomerAppts = state.allAppointments.filter(a => a.assigned_groomer_id === groomerId);
                console.log(`Groomer ${groomer.full_name} (${groomerId}) has ${groomerAppts.length} appointments:`, groomerAppts);
            }
            
            hideLoading();
            render();
        }
        
        function closeGroomerScheduleModal() {
            state.showGroomerScheduleModal = false;
            state.viewingGroomerSchedule = null;
            state.adminScheduleMonth = null;
            state.adminScheduleYear = null;
            state.adminScheduleSelectedDate = null;
            render();
        }
        
        function toggleGroomerPasswordVisibility() {
            const input = document.getElementById('groomer-password-input');
            const toggle = document.getElementById('groomer-password-toggle');
            if (input && toggle) {
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.textContent = 'visibility_off';
                } else {
                    input.type = 'password';
                    toggle.textContent = 'visibility';
                }
            }
        }
        
        // Add Groomer Handler
        async function handleAddGroomer(e) {
            e.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('groomer-name').value.trim();
                const email = document.getElementById('groomer-email-input').value.trim();
                const password = document.getElementById('groomer-password-input').value;
                const phone = document.getElementById('groomer-phone-input').value.trim();
                const hiredDate = document.getElementById('groomer-hired-date').value;
                const adminNotes = document.getElementById('groomer-admin-notes').value.trim();
                
                // Get selected specialties
                const specialtyCheckboxes = document.querySelectorAll('input[name="groomer-specialty"]:checked');
                const specialties = Array.from(specialtyCheckboxes).map(cb => cb.value);
                
                // First, check if user already exists in profiles
                const { data: existingProfile } = await supabaseClient
                    .from('profiles')
                    .select('id, email, role, full_name')
                    .eq('email', email)
                    .single();
                
                if (existingProfile) {
                    // User already exists - offer to convert them to groomer
                    if (existingProfile.role === 'groomer') {
                        hideLoading();
                        showToast('This email is already registered as a groomer.', 'error');
                        return;
                    }
                    
                    // Ask admin if they want to convert this user
                    hideLoading();
                    const confirmConvert = confirm(
                        `"${existingProfile.full_name || email}" already has an account as a ${existingProfile.role}.\n\n` +
                        `Do you want to convert them to a groomer?\n\n` +
                        `Note: They will keep their existing password.`
                    );
                    
                    if (!confirmConvert) {
                        return;
                    }
                    
                    showLoading();
                    
                    // Convert existing user to groomer
                    const { error: updateError } = await supabaseClient
                        .from('profiles')
                        .update({
                            full_name: name || existingProfile.full_name,
                            phone: phone || null,
                            role: 'groomer',
                            specialties: specialties,
                            is_active: true,
                            hired_date: hiredDate || null,
                            admin_notes: adminNotes || null
                        })
                        .eq('id', existingProfile.id);
                    
                    if (updateError) {
                        hideLoading();
                        showToast('Failed to convert user to groomer: ' + updateError.message, 'error');
                        return;
                    }
                    
                    await loadAdminData();
                    hideLoading();
                    closeAddGroomerModal();
                    showToast(`"${name || existingProfile.full_name}" converted to groomer! They use their existing password.`, 'success');
                    return;
                }
                
                // User doesn't exist - create new account
                // Store admin session data
                const adminSessionData = state.session;
                
                // Create new user account for groomer
                const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (signUpError) {
                    // Check if it's a "user already registered" error (might be in auth but not profiles)
                    if (signUpError.message.includes('already registered') || signUpError.message.includes('already exists')) {
                        hideLoading();
                        showToast('This email is already registered. Try using "Forgot Password" to recover the account, or use a different email.', 'error');
                        return;
                    }
                    hideLoading();
                    showToast('Failed to create groomer account: ' + signUpError.message, 'error');
                    return;
                }
                
                const newUserId = signUpData.user?.id;
                if (!newUserId) {
                    hideLoading();
                    showToast('Failed to create groomer account', 'error');
                    return;
                }
                
                // Restore admin session immediately
                if (adminSessionData && adminSessionData.access_token) {
                    try {
                        await supabaseClient.auth.setSession({
                            access_token: adminSessionData.access_token,
                            refresh_token: adminSessionData.refresh_token
                        });
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        state.session = session;
                    } catch (sessionError) {
                        console.error('Session restore error:', sessionError);
                        hideLoading();
                        showToast('Session expired. Please login again and retry.', 'error');
                        logout();
                        return;
                    }
                }
                
                // Update the profile with groomer details
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .update({
                        full_name: name,
                        phone: phone || null,
                        role: 'groomer',
                        specialties: specialties,
                        is_active: true,
                        hired_date: hiredDate || null,
                        admin_notes: adminNotes || null
                    })
                    .eq('id', newUserId);
                
                if (profileError) {
                    console.error('Profile update error:', profileError);
                    hideLoading();
                    showToast('Groomer created but profile update failed: ' + profileError.message, 'error');
                    return;
                }
                
                // Reload admin data
                await loadAdminData();
                
                hideLoading();
                closeAddGroomerModal();
                showToast(`Groomer "${name}" added successfully! They can login with: ${email}`, 'success');
                
            } catch (err) {
                hideLoading();
                console.error('Add groomer error:', err);
                showToast('Failed to add groomer: ' + err.message, 'error');
            }
        }
        
        // Edit Groomer Handler
        async function handleEditGroomer(e) {
            e.preventDefault();
            showLoading();
            
            try {
                const groomerId = document.getElementById('edit-groomer-id').value;
                const name = document.getElementById('edit-groomer-name').value.trim();
                const phone = document.getElementById('edit-groomer-phone').value.trim();
                const hiredDate = document.getElementById('edit-groomer-hired-date').value;
                const adminNotes = document.getElementById('edit-groomer-admin-notes').value.trim();
                
                // Get selected specialties
                const specialtyCheckboxes = document.querySelectorAll('input[name="edit-groomer-specialty"]:checked');
                const specialties = Array.from(specialtyCheckboxes).map(cb => cb.value);
                
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        full_name: name,
                        phone: phone || null,
                        specialties: specialties,
                        hired_date: hiredDate || null,
                        admin_notes: adminNotes || null
                    })
                    .eq('id', groomerId);
                
                if (error) {
                    hideLoading();
                    showToast('Failed to update groomer: ' + error.message, 'error');
                    return;
                }
                
                await loadAdminData();
                hideLoading();
                closeEditGroomerModal();
                showToast('Groomer updated successfully!', 'success');
                
            } catch (err) {
                hideLoading();
                console.error('Edit groomer error:', err);
                showToast('Failed to update groomer: ' + err.message, 'error');
            }
        }
        
        // Toggle Groomer Active Status
        async function toggleGroomerActive(groomerId, currentlyActive) {
            const action = currentlyActive ? 'deactivate' : 'reactivate';
            const groomer = state.groomers.find(g => g.id === groomerId);
            
            if (!confirm(`Are you sure you want to ${action} ${groomer?.full_name || 'this groomer'}?`)) {
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ is_active: !currentlyActive })
                    .eq('id', groomerId);
                
                if (error) {
                    hideLoading();
                    showToast(`Failed to ${action} groomer: ` + error.message, 'error');
                    return;
                }
                
                await loadAdminData();
                hideLoading();
                showToast(`Groomer ${action}d successfully!`, 'success');
                
            } catch (err) {
                hideLoading();
                console.error('Toggle groomer active error:', err);
                showToast(`Failed to ${action} groomer`, 'error');
            }
        }

        function renderAuthPage() {
            return `
            <div class="flex flex-1 w-full min-h-screen">
                <div class="hidden lg:flex lg:w-1/2 relative bg-primary/10 items-center justify-center overflow-hidden">
                    <div class="absolute inset-0 z-0">
                        <img alt="Dog grooming" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBAgB_Ncu0Jwq7NoOkvrWM3LGmNdBpAvJUbF63k_Xj9ezgydcIjvE6ICw5DsWJPlgZ5OAkQu_V81UIU9qbm1qZ6jJvuGb7NSlCZ9l2elEVA1AdGbc2gqs-Qcflihvblt2dmv7_bhd6nC-BDxrA3AuKq663UGylWq-VkgYnjpJKcbP_6mU7YoSnvb5-bzJQReNiTzDYO5B_lEB1sPJQGHUr_CvYOx9sErYMiLLlVrM1DPw9IAGvTFteiACwuGtOkYAjnJShJTBJnZh45"/>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                    </div>
                    <div class="relative z-10 p-12 text-white max-w-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="size-12 rounded-xl shadow-lg overflow-hidden"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div>
                            <h2 class="text-3xl font-bold text-white">Dogfathersplus</h2>
                        </div>
                        <h1 class="text-5xl font-bold leading-tight mb-6">Professional grooming at your doorstep.</h1>
                        <p class="text-lg opacity-90 mb-8">Join thousands of happy pet owners who save time with our mobile grooming service.</p>
                        <div class="flex items-center gap-2 text-yellow-400">
                            <span class="material-symbols-outlined fill-1">star</span><span class="material-symbols-outlined fill-1">star</span><span class="material-symbols-outlined fill-1">star</span><span class="material-symbols-outlined fill-1">star</span><span class="material-symbols-outlined fill-1">star</span>
                            <span class="text-white text-sm ml-2">Trusted by 5,000+ owners</span>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-1/2 flex flex-col bg-surface-light dark:bg-surface-dark overflow-y-auto">
                    <div class="lg:hidden p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg overflow-hidden"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div>
                            <span class="font-bold text-xl dark:text-white">Dogfathersplus</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openAdminLogin()" class="px-3 py-1.5 text-xs font-medium border border-border-light dark:border-border-dark rounded-lg hover:bg-background-light dark:hover:bg-background-dark text-text-sub-light dark:text-text-sub-dark flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">admin_panel_settings</span>
                                Admin
                            </button>
                            <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-background-light dark:hover:bg-background-dark touch-target">
                                <span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col justify-center px-6 py-10 sm:px-12 lg:px-24 max-w-3xl mx-auto w-full">
                        <div class="hidden lg:flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <button onclick="openAdminLogin()" class="px-3 py-1.5 text-xs font-medium border border-border-light dark:border-border-dark rounded-lg hover:bg-background-light dark:hover:bg-background-dark text-text-sub-light dark:text-text-sub-dark flex items-center gap-1.5 transition-colors">
                                    <span class="material-symbols-outlined text-sm">admin_panel_settings</span>
                                    Admin Login
                                </button>
                                <button onclick="state.showGroomerLogin = true; render();" class="px-3 py-1.5 text-xs font-medium border border-emerald-200 dark:border-emerald-800 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center gap-1.5 transition-colors">
                                    <span class="material-symbols-outlined text-sm">content_cut</span>
                                    Groomer Login
                                </button>
                            </div>
                            <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-background-light dark:hover:bg-background-dark touch-target flex items-center gap-2 text-sm text-text-sub-light dark:text-text-sub-dark">
                                <span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>
                                ${state.darkMode ? 'Light Mode' : 'Dark Mode'}
                            </button>
                        </div>
                        <div class="mb-8 text-center">
                            <h2 class="text-3xl font-bold mb-2 dark:text-white">${state.authTab === 'login' ? 'Welcome Back' : 'Join the Pack'}</h2>
                            <p class="text-text-sub-light dark:text-text-sub-dark">${state.authTab === 'login' ? 'Sign in to manage appointments.' : 'Create an account to get started.'}</p>
                        </div>
                        <div class="mb-8 flex border-b border-border-light dark:border-border-dark">
                            <button onclick="setAuthTab('login')" class="flex-1 pb-4 pt-2 text-sm font-bold touch-target ${state.authTab === 'login' ? 'text-primary border-b-[3px] border-primary' : 'text-text-sub-light dark:text-text-sub-dark border-b-[3px] border-transparent'}">Log In</button>
                            <button onclick="setAuthTab('signup')" class="flex-1 pb-4 pt-2 text-sm font-bold touch-target ${state.authTab === 'signup' ? 'text-primary border-b-[3px] border-primary' : 'text-text-sub-light dark:text-text-sub-dark border-b-[3px] border-transparent'}">Create Account</button>
                        </div>
                        <div id="auth-error" class="hidden mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">error</span>
                            <span id="auth-error-text"></span>
                        </div>
                        <form id="auth-form" class="flex flex-col gap-5">
                            ${state.authTab === 'signup' ? `
                            <label class="flex flex-col gap-2"><span class="text-sm font-semibold dark:text-white">Full Name</span>
                                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-sub-light dark:text-text-sub-dark material-symbols-outlined text-xl">person</span>
                                <input id="auth-name" class="w-full h-12 pl-11 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" placeholder="John Smith" type="text" required/></div>
                            </label>
                            <label class="flex flex-col gap-2"><span class="text-sm font-semibold dark:text-white">Phone Number</span>
                                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-sub-light dark:text-text-sub-dark material-symbols-outlined text-xl">phone</span>
                                <input id="auth-phone" class="w-full h-12 pl-11 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" placeholder="(555) 123-4567" type="tel"/></div>
                            </label>
                            ` : ''}
                            <label class="flex flex-col gap-2"><span class="text-sm font-semibold dark:text-white">Email</span>
                                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-sub-light dark:text-text-sub-dark material-symbols-outlined text-xl">mail</span>
                                <input id="auth-email" class="w-full h-12 pl-11 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" placeholder="jane@example.com" type="email" required/></div>
                            </label>
                            <label class="flex flex-col gap-2"><span class="text-sm font-semibold dark:text-white">Password</span>
                                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-sub-light dark:text-text-sub-dark material-symbols-outlined text-xl">lock</span>
                                <input id="auth-password" class="w-full h-12 pl-11 pr-12 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" placeholder="${state.authTab === 'signup' ? 'Create a password (min 6 chars)' : 'Enter password'}" type="${state.showPassword ? 'text' : 'password'}" required minlength="${state.authTab === 'signup' ? '6' : '1'}"/>
                                <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 -translate-y-1/2 text-text-sub-light dark:text-text-sub-dark hover:text-primary p-1">
                                    <span class="material-symbols-outlined text-xl">${state.showPassword ? 'visibility_off' : 'visibility'}</span>
                                </button></div>
                            </label>
                            ${state.authTab === 'login' ? `
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="remember-me" ${state.rememberMe ? 'checked' : ''} onchange="toggleRememberMe()" class="w-4 h-4 rounded border-border-light text-primary focus:ring-primary"/>
                                    <span class="text-sm text-text-sub-light dark:text-text-sub-dark">Remember me</span>
                                </label>
                                <a href="#" onclick="openForgotPassword(document.getElementById('auth-email')?.value || ''); return false;" class="text-sm text-primary hover:underline">Forgot password?</a>
                            </div>` : ''}
                            <button type="submit" class="mt-4 w-full h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg shadow-lg shadow-primary/20 flex items-center justify-center gap-2 touch-target transition-all active:scale-[0.98]">
                                <span id="auth-btn-text">${state.authTab === 'login' ? 'Sign In' : 'Create Account'}</span>
                                <span class="material-symbols-outlined">arrow_forward</span>
                            </button>
                        </form>
                        <div class="mt-6 p-4 bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-lg text-sm text-center text-text-sub-light dark:text-text-sub-dark">
                            <strong class="text-text-main-light dark:text-white">Create an account or sign in to book appointments!</strong>
                        </div>
                        
                        <!-- Mobile Staff Login Options -->
                        <div class="mt-6 pt-6 border-t border-border-light dark:border-border-dark lg:hidden">
                            <p class="text-xs text-center text-text-sub-light dark:text-text-sub-dark mb-3">Staff Access</p>
                            <div class="flex gap-2">
                                <button onclick="openAdminLogin()" class="flex-1 px-3 py-2 text-xs font-medium border border-border-light dark:border-border-dark rounded-lg hover:bg-background-light dark:hover:bg-background-dark text-text-sub-light dark:text-text-sub-dark flex items-center justify-center gap-1.5 transition-colors">
                                    <span class="material-symbols-outlined text-sm">admin_panel_settings</span>
                                    Admin
                                </button>
                                <button onclick="state.showGroomerLogin = true; render();" class="flex-1 px-3 py-2 text-xs font-medium border border-emerald-200 dark:border-emerald-800 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center gap-1.5 transition-colors">
                                    <span class="material-symbols-outlined text-sm">content_cut</span>
                                    Groomer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ${state.showAdminLogin ? renderAdminLoginModal() : ''}`;
        }

        // Admin Login Modal
        function renderAdminLoginModal() {
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeAdminLogin()">
                <div class="bg-surface-light dark:bg-surface-dark rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-amber-600 dark:text-amber-400">admin_panel_settings</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold dark:text-white">Admin Login</h2>
                                <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Authorized personnel only</p>
                            </div>
                        </div>
                        <button onclick="closeAdminLogin()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <form id="admin-login-form" class="p-6 space-y-5">
                        <div id="admin-auth-error" class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">error</span>
                            <span id="admin-auth-error-text"></span>
                        </div>
                        <label class="block">
                            <span class="text-sm font-semibold mb-2 block dark:text-white">Admin Email</span>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-text-sub-light">mail</span>
                                <input id="admin-email" type="email" required placeholder="admin@dogfathersplus.com" 
                                    class="w-full h-12 pl-12 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-amber-500 outline-none dark:text-white">
                            </div>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold mb-2 block dark:text-white">Password</span>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-text-sub-light">lock</span>
                                <input id="admin-password" type="password" required placeholder="Enter admin password" 
                                    class="w-full h-12 pl-12 pr-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-amber-500 outline-none dark:text-white">
                            </div>
                        </label>
                        <button type="submit" class="w-full h-12 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 touch-target transition-all shadow-lg shadow-amber-500/20">
                            <span class="material-symbols-outlined">login</span>
                            Sign In as Admin
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="openForgotPassword(document.getElementById('admin-email')?.value || ''); return false;" class="text-sm text-amber-600 hover:text-amber-700 hover:underline">Forgot password?</a>
                        </div>
                    </form>
                    <div class="px-6 pb-6">
                        <div class="p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg flex items-start gap-2">
                            <span class="material-symbols-outlined text-amber-600 dark:text-amber-400 text-lg mt-0.5">info</span>
                            <p class="text-xs text-amber-800 dark:text-amber-300">This area is for Dogfathersplus staff only. Unauthorized access attempts are logged.</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function openAdminLogin() {
            state.showAdminLogin = true;
            render();
        }

        function closeAdminLogin() {
            state.showAdminLogin = false;
            render();
        }

        async function handleAdminLogin(email, password) {
            showLoading();
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                hideLoading();
                const errorDiv = document.getElementById('admin-auth-error');
                const errorText = document.getElementById('admin-auth-error-text');
                errorText.textContent = error.message;
                errorDiv.classList.remove('hidden');
                return false;
            }
            
            // Load profile to check if admin
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', data.user.id)
                .single();
            
            if (!profile || profile.role !== 'admin') {
                // Not an admin - sign out and show error
                await supabaseClient.auth.signOut();
                hideLoading();
                const errorDiv = document.getElementById('admin-auth-error');
                const errorText = document.getElementById('admin-auth-error-text');
                errorText.textContent = 'Access denied. This account is not authorized for admin access.';
                errorDiv.classList.remove('hidden');
                return false;
            }
            
            // Success - load admin data
            state.session = data.session;
            state.currentUser = {
                id: profile.id,
                email: profile.email,
                name: profile.full_name,
                phone: profile.phone,
                role: profile.role,
                loyaltyPoints: profile.loyalty_points || 0,
                avatar: profile.avatar_url
            };
            
            await loadAdminData();
            await loadPublicData();
            
            state.showAdminLogin = false;
            hideLoading();
            showToast(`Welcome back, ${profile.full_name || 'Admin'}!`, 'success');
            render();
            return true;
        }

        // =============================================
        // PASSWORD RESET SYSTEM
        // =============================================
        
        // Open Forgot Password Modal
        function openForgotPassword(prefilledEmail = '') {
            state.showForgotPassword = true;
            state.forgotPasswordEmail = prefilledEmail;
            state.showAdminLogin = false;
            state.showGroomerLogin = false;
            render();
        }
        
        // Close Forgot Password Modal
        function closeForgotPassword() {
            state.showForgotPassword = false;
            state.forgotPasswordEmail = '';
            render();
        }
        
        // Handle Forgot Password Request
        async function handleForgotPassword(e) {
            e.preventDefault();
            showLoading();
            
            const email = document.getElementById('forgot-email').value.trim();
            
            if (!email) {
                hideLoading();
                showToast('Please enter your email address', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + window.location.pathname
                });
                
                if (error) {
                    hideLoading();
                    showToast('Error: ' + error.message, 'error');
                    return;
                }
                
                hideLoading();
                closeForgotPassword();
                showToast('Password reset email sent! Check your inbox.', 'success');
                
            } catch (err) {
                hideLoading();
                console.error('Forgot password error:', err);
                showToast('Failed to send reset email', 'error');
            }
        }
        
        // Check for password recovery token in URL (called on app init)
        function checkForPasswordRecovery() {
            const hash = window.location.hash;
            
            // Supabase sends recovery links with hash like: #access_token=...&type=recovery
            if (hash && hash.includes('type=recovery')) {
                console.log('Password recovery detected');
                state.showResetPassword = true;
                render();
                return true;
            }
            
            // Also check for error in URL (e.g., expired link)
            if (hash && hash.includes('error=')) {
                const params = new URLSearchParams(hash.substring(1));
                const errorDesc = params.get('error_description');
                if (errorDesc) {
                    showToast(decodeURIComponent(errorDesc.replace(/\+/g, ' ')), 'error');
                }
                // Clear the hash
                history.replaceState(null, '', window.location.pathname);
            }
            
            return false;
        }
        
        // Handle Setting New Password (after clicking email link)
        async function handleResetPassword(e) {
            e.preventDefault();
            showLoading();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword.length < 6) {
                hideLoading();
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                hideLoading();
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    hideLoading();
                    showToast('Error: ' + error.message, 'error');
                    return;
                }
                
                // Clear the hash from URL
                history.replaceState(null, '', window.location.pathname);
                
                // Sign out and redirect to login
                await supabaseClient.auth.signOut();
                
                state.showResetPassword = false;
                state.currentUser = null;
                state.session = null;
                
                hideLoading();
                showToast('Password updated successfully! Please log in with your new password.', 'success');
                render();
                
            } catch (err) {
                hideLoading();
                console.error('Reset password error:', err);
                showToast('Failed to reset password', 'error');
            }
        }
        
        // Open Change Password Modal (for logged-in users)
        function openChangePassword() {
            state.showChangePassword = true;
            render();
        }
        
        // Close Change Password Modal
        function closeChangePassword() {
            state.showChangePassword = false;
            render();
        }
        
        // Handle Change Password (for logged-in users)
        async function handleChangePassword(e) {
            e.preventDefault();
            showLoading();
            
            const newPassword = document.getElementById('change-new-password').value;
            const confirmPassword = document.getElementById('change-confirm-password').value;
            
            if (newPassword.length < 6) {
                hideLoading();
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                hideLoading();
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    hideLoading();
                    showToast('Error: ' + error.message, 'error');
                    return;
                }
                
                hideLoading();
                closeChangePassword();
                showToast('Password changed successfully!', 'success');
                
            } catch (err) {
                hideLoading();
                console.error('Change password error:', err);
                showToast('Failed to change password', 'error');
            }
        }
        
        // Render Forgot Password Modal
        function renderForgotPasswordModal() {
            if (!state.showForgotPassword) return '';
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeForgotPassword()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary">lock_reset</span>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Forgot Password</h2>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">We'll send you a reset link</p>
                                </div>
                            </div>
                            <button onclick="closeForgotPassword()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-slate-400">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <form onsubmit="handleForgotPassword(event)" class="p-6 space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
                            <input type="email" id="forgot-email" required value="${state.forgotPasswordEmail || ''}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="you@example.com">
                        </div>
                        
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Enter the email address associated with your account and we'll send you a link to reset your password.
                        </p>
                        
                        <button type="submit" class="w-full py-3.5 bg-primary hover:bg-sky-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-primary/25">
                            <span class="material-symbols-outlined">send</span>
                            Send Reset Link
                        </button>
                        
                        <button type="button" onclick="closeForgotPassword()" class="w-full py-3 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 font-medium transition-colors">
                            Back to Login
                        </button>
                    </form>
                </div>
            </div>`;
        }
        
        // Render Reset Password Page (after clicking email link)
        function renderResetPasswordPage() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-background-dark dark:to-surface-dark flex items-center justify-center p-4">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-md shadow-2xl border border-slate-200 dark:border-border-dark">
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark text-center">
                        <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-primary text-3xl">lock_reset</span>
                        </div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Set New Password</h1>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Enter your new password below</p>
                    </div>
                    
                    <form onsubmit="handleResetPassword(event)" class="p-6 space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">New Password</label>
                            <input type="password" id="new-password" required minlength="6"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" required minlength="6"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            Password must be at least 6 characters long.
                        </p>
                        
                        <button type="submit" class="w-full py-3.5 bg-primary hover:bg-sky-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-primary/25">
                            <span class="material-symbols-outlined">check</span>
                            Update Password
                        </button>
                    </form>
                </div>
            </div>`;
        }
        
        // Render Change Password Modal (for logged-in users)
        function renderChangePasswordModal() {
            if (!state.showChangePassword) return '';
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeChangePassword()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-slate-200 dark:border-border-dark">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center">
                                    <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400">password</span>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Change Password</h2>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Update your account password</p>
                                </div>
                            </div>
                            <button onclick="closeChangePassword()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-slate-400">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <form onsubmit="handleChangePassword(event)" class="p-6 space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">New Password</label>
                            <input type="password" id="change-new-password" required minlength="6"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Confirm New Password</label>
                            <input type="password" id="change-confirm-password" required minlength="6"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-background-dark text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 outline-none transition-all"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            Password must be at least 6 characters long.
                        </p>
                        
                        <button type="submit" class="w-full py-3.5 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-600/25">
                            <span class="material-symbols-outlined">check</span>
                            Update Password
                        </button>
                    </form>
                </div>
            </div>`;
        }

        // =============================================
        // EDIT MODALS
        // =============================================
        
        const popularBreeds = [
            'Labrador Retriever', 'Golden Retriever', 'German Shepherd', 'French Bulldog', 'Bulldog',
            'Poodle', 'Beagle', 'Rottweiler', 'Yorkshire Terrier', 'Boxer',
            'Dachshund', 'Shih Tzu', 'Siberian Husky', 'Great Dane', 'Doberman Pinscher',
            'Chihuahua', 'Maltese', 'Pomeranian', 'Cocker Spaniel', 'Bernese Mountain Dog',
            'Other'
        ];

        function openEditModal(type, dataOrIndex = {}) {
            let data = {};
            
            // If it's an index number, look up from editItems
            if (typeof dataOrIndex === 'number') {
                const key = `${type}_${dataOrIndex}`;
                data = state.editItems[key] || {};
            } else if (typeof dataOrIndex === 'object') {
                // It's already an object (empty {} or with data)
                data = dataOrIndex;
            }
            
            state.editModal = { type, data: { ...data } };
            render();
        }

        function closeEditModal() {
            state.editModal = null;
            render();
        }

        // =============================================
        // GROOMING SERVICE MANAGEMENT
        // =============================================
        
        function openGroomingServiceModal(serviceId = null) {
            if (serviceId) {
                const service = state.services?.find(s => s.id === serviceId);
                if (service) {
                    state.groomingServiceModal = { 
                        isEdit: true,
                        id: service.id,
                        name: service.name || '',
                        description: service.description || '',
                        base_price: service.base_price || 0,
                        duration_minutes: service.duration_minutes || 60,
                        is_active: service.is_active !== false,
                        sort_order: service.sort_order || 0
                    };
                }
            } else {
                state.groomingServiceModal = {
                    isEdit: false,
                    id: null,
                    name: '',
                    description: '',
                    base_price: 85,
                    duration_minutes: 60,
                    is_active: true,
                    sort_order: (state.services?.length || 0) + 1
                };
            }
            render();
        }
        
        function closeGroomingServiceModal() {
            state.groomingServiceModal = null;
            render();
        }
        
        async function saveGroomingService() {
            const modal = state.groomingServiceModal;
            if (!modal) return;
            
            if (!modal.name.trim()) {
                showToast('Please enter a service name', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const serviceData = {
                    name: modal.name.trim(),
                    description: modal.description.trim(),
                    base_price: parseFloat(modal.base_price) || 0,
                    duration_minutes: parseInt(modal.duration_minutes) || 60,
                    is_active: modal.is_active,
                    sort_order: parseInt(modal.sort_order) || 0
                };
                
                if (modal.isEdit && modal.id) {
                    // Update existing service
                    const { error } = await supabaseClient
                        .from('services')
                        .update(serviceData)
                        .eq('id', modal.id);
                    
                    if (error) throw error;
                    showToast('Service updated successfully', 'success');
                } else {
                    // Create new service
                    const { error } = await supabaseClient
                        .from('services')
                        .insert([serviceData]);
                    
                    if (error) throw error;
                    showToast('Service created successfully', 'success');
                }
                
                // Reload services
                await loadPublicData();
                closeGroomingServiceModal();
            } catch (err) {
                console.error('Error saving service:', err);
                showToast('Failed to save service: ' + err.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function toggleGroomingServiceStatus(serviceId, currentlyActive) {
            try {
                const { error } = await supabaseClient
                    .from('services')
                    .update({ is_active: !currentlyActive })
                    .eq('id', serviceId);
                
                if (error) throw error;
                
                showToast(`Service ${currentlyActive ? 'deactivated' : 'activated'}`, 'success');
                await loadPublicData();
                render();
            } catch (err) {
                console.error('Error toggling service status:', err);
                showToast('Failed to update service status', 'error');
            }
        }
        
        function confirmDeleteGroomingService(serviceId, serviceName) {
            state.confirmDialog = {
                title: 'Delete Service',
                message: `Are you sure you want to delete "${serviceName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                confirmClass: 'bg-red-500 hover:bg-red-600',
                onConfirm: () => deleteGroomingService(serviceId)
            };
            render();
        }
        
        async function deleteGroomingService(serviceId) {
            showLoading();
            
            try {
                const { error } = await supabaseClient
                    .from('services')
                    .delete()
                    .eq('id', serviceId);
                
                if (error) throw error;
                
                showToast('Service deleted successfully', 'success');
                state.confirmDialog = null;
                await loadPublicData();
                render();
            } catch (err) {
                console.error('Error deleting service:', err);
                showToast('Failed to delete service: ' + err.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function renderGroomingServiceModal() {
            const modal = state.groomingServiceModal;
            if (!modal) return '';
            
            return `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="closeGroomingServiceModal()">
                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary">content_cut</span>
                                    </div>
                                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">${modal.isEdit ? 'Edit Service' : 'Add New Service'}</h2>
                                </div>
                                <button onclick="closeGroomingServiceModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-slate-400">close</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <!-- Service Name -->
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Service Name *</label>
                                <input type="text" value="${modal.name}" onchange="state.groomingServiceModal.name = this.value" 
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="e.g., Full Grooming, Bath & Brush, Nail Trim">
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Description</label>
                                <textarea onchange="state.groomingServiceModal.description = this.value" rows="3"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                    placeholder="Describe what's included in this service...">${modal.description}</textarea>
                            </div>
                            
                            <!-- Price & Duration Row -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Base Price ($)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                        <input type="number" value="${modal.base_price}" onchange="state.groomingServiceModal.base_price = this.value" min="0" step="0.01"
                                            class="w-full pl-8 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Duration (min)</label>
                                    <select onchange="state.groomingServiceModal.duration_minutes = this.value"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="15" ${modal.duration_minutes == 15 ? 'selected' : ''}>15 min</option>
                                        <option value="30" ${modal.duration_minutes == 30 ? 'selected' : ''}>30 min</option>
                                        <option value="45" ${modal.duration_minutes == 45 ? 'selected' : ''}>45 min</option>
                                        <option value="60" ${modal.duration_minutes == 60 ? 'selected' : ''}>60 min</option>
                                        <option value="75" ${modal.duration_minutes == 75 ? 'selected' : ''}>75 min</option>
                                        <option value="90" ${modal.duration_minutes == 90 ? 'selected' : ''}>90 min</option>
                                        <option value="120" ${modal.duration_minutes == 120 ? 'selected' : ''}>120 min</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Sort Order -->
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Sort Order</label>
                                <input type="number" value="${modal.sort_order}" onchange="state.groomingServiceModal.sort_order = this.value" min="0"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="0">
                                <p class="text-xs text-slate-400 mt-1">Lower numbers appear first in the booking dropdown</p>
                            </div>
                            
                            <!-- Active Toggle -->
                            <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Active Service</p>
                                    <p class="text-sm text-slate-500">Inactive services won't appear in booking options</p>
                                </div>
                                <button onclick="state.groomingServiceModal.is_active = !state.groomingServiceModal.is_active; render();" 
                                    class="w-14 h-8 rounded-full transition-colors relative ${modal.is_active ? 'bg-green-500' : 'bg-slate-300 dark:bg-slate-600'}">
                                    <span class="absolute top-1 ${modal.is_active ? 'right-1' : 'left-1'} w-6 h-6 bg-white rounded-full shadow transition-all"></span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                            <button onclick="closeGroomingServiceModal()" class="px-6 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 font-bold transition-colors">
                                Cancel
                            </button>
                            <button onclick="saveGroomingService()" class="px-6 py-3 rounded-xl bg-primary hover:bg-sky-600 text-white font-bold transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">${modal.isEdit ? 'check' : 'add'}</span>
                                ${modal.isEdit ? 'Save Changes' : 'Create Service'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper to store item for editing
        function storeEditItem(type, index, item) {
            state.editItems[`${type}_${index}`] = item;
        }

        function renderEditModal() {
            if (!state.editModal) return '';
            const { type, data } = state.editModal;
            
            let title = '';
            let content = '';
            
            switch(type) {
                case 'pet':
                    title = data.id ? 'Edit Pet' : 'Add New Pet';
                    content = renderPetEditForm(data);
                    break;
                case 'profile':
                    title = 'Edit Profile';
                    content = renderProfileEditForm(data);
                    break;
                case 'reward':
                    title = data.id ? 'Edit Reward' : 'Add New Reward';
                    content = renderRewardEditForm(data);
                    break;
                case 'product':
                    title = data.id ? 'Edit Product' : 'Add New Product';
                    content = renderProductEditForm(data);
                    break;
                case 'appointment':
                    title = 'Appointment Details';
                    content = renderAppointmentEditForm(data);
                    break;
                case 'ridealong':
                    title = data.id ? 'Edit Package' : 'Add New Package';
                    content = renderRideAlongEditForm(data);
                    break;
                case 'course':
                    title = 'Edit Course Settings';
                    content = renderCourseEditForm(data);
                    break;
                default:
                    return '';
            }
            
            return `
            <div class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onclick="closeEditModal()">
                <div class="bg-surface-light dark:bg-surface-dark rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                        <h2 class="text-xl font-bold dark:text-white">${title}</h2>
                        <button onclick="closeEditModal()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                        ${content}
                    </div>
                </div>
            </div>`;
        }

        // Confirmation Dialog
        function renderConfirmDialog() {
            const dialog = state.confirmDialog;
            if (!dialog) return '';
            
            return `
            <div class="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4" onclick="closeConfirmDialog()">
                <div class="bg-surface-light dark:bg-surface-dark rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400">warning</span>
                            </div>
                            <h3 class="text-xl font-bold dark:text-white">${dialog.title || 'Confirm Action'}</h3>
                        </div>
                        <p class="text-text-sub-light dark:text-text-sub-dark mb-6">${dialog.message || 'Are you sure you want to proceed?'}</p>
                        <div class="flex gap-3">
                            <button onclick="closeConfirmDialog()" class="flex-1 px-4 py-3 text-sm font-bold text-text-main-light dark:text-white bg-background-light dark:bg-background-dark hover:bg-border-light dark:hover:bg-border-dark rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button onclick="confirmDialogAction()" class="flex-1 px-4 py-3 text-sm font-bold text-white ${dialog.confirmClass || 'bg-red-600 hover:bg-red-700'} rounded-lg transition-colors">
                                ${dialog.confirmText || 'Confirm'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function closeConfirmDialog() {
            if (state.confirmDialog?.onCancel) {
                state.confirmDialog.onCancel();
            } else {
                state.confirmDialog = null;
                render();
            }
        }

        function confirmDialogAction() {
            if (state.confirmDialog?.onConfirm) {
                state.confirmDialog.onConfirm();
            } else {
                state.confirmDialog = null;
                render();
            }
        }

        // Ride-Along Package Edit Form
        function renderRideAlongEditForm(pkg) {
            const features = pkg.features || [];
            return `
            <form id="edit-ridealong-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Package Name *</label>
                    <input type="text" id="edit-ridealong-name" value="${pkg.name || ''}" placeholder="Starter Package" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Price ($) *</label>
                        <input type="number" id="edit-ridealong-price" value="${pkg.price || ''}" placeholder="299" min="0" max="99999" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Duration</label>
                        <input type="text" id="edit-ridealong-duration" value="${pkg.duration || ''}" placeholder="1 Day" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Description</label>
                    <textarea id="edit-ridealong-description" placeholder="Describe this package..." 
                        class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${pkg.description || ''}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Features (one per line)</label>
                    <textarea id="edit-ridealong-features" placeholder="Shadow a professional groomer&#10;Learn basic techniques&#10;Certificate included" 
                        class="w-full h-28 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${Array.isArray(features) ? features.join('\n') : ''}</textarea>
                </div>

                <div class="flex items-center gap-3">
                    <input type="checkbox" id="edit-ridealong-popular" ${pkg.is_popular || pkg.popular ? 'checked' : ''} class="w-5 h-5 rounded border-border-light text-primary focus:ring-primary">
                    <label for="edit-ridealong-popular" class="text-sm font-medium dark:text-white">Mark as "Most Popular"</label>
                </div>

                <div class="flex gap-3 pt-4">
                    ${pkg.id ? `<button type="button" onclick="confirmDeleteRideAlong('${pkg.id}', '${pkg.name}')" class="px-4 h-12 border border-red-300 text-red-600 rounded-lg font-bold hover:bg-red-50 transition-colors">Delete</button>` : ''}
                    <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        ${pkg.id ? 'Save Changes' : 'Add Package'}
                    </button>
                </div>
            </form>`;
        }

        // Course Edit Form  
        function renderCourseEditForm(course) {
            return `
            <form id="edit-course-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Course Title *</label>
                    <input type="text" id="edit-course-title" value="${course.title || 'Dogfathersplus Academy'}" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Instructor</label>
                    <input type="text" id="edit-course-instructor" value="${course.instructor || 'Rosa & Gerardo'}" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Tagline</label>
                    <input type="text" id="edit-course-tagline" value="${course.tagline || 'Master Dog Grooming at Home'}" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <!-- Thumbnail Upload -->
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Course Thumbnail</label>
                    <div class="border-2 border-dashed border-border-light dark:border-border-dark rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('edit-course-thumbnail').click()">
                        <div id="course-thumbnail-preview">
                            ${course.thumbnail_url ? 
                                `<img src="${course.thumbnail_url}" class="max-h-32 mx-auto rounded-lg mb-2"/>` :
                                `<span class="material-symbols-outlined text-4xl text-text-sub-light mb-2">cloud_upload</span>`
                            }
                        </div>
                        <p class="text-sm text-text-sub-light dark:text-text-sub-dark">Click to upload thumbnail</p>
                        <input type="file" id="edit-course-thumbnail" accept="image/*" class="hidden" onchange="handleCourseThumbnailUpload(event)">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Price ($)</label>
                        <input type="number" step="0.01" id="edit-course-price" value="${course.price || 49}" min="0" max="99999" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Billing</label>
                        <select id="edit-course-billing"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                            <option value="monthly" ${course.billing === 'monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="yearly" ${course.billing === 'yearly' ? 'selected' : ''}>Yearly</option>
                            <option value="onetime" ${course.billing === 'onetime' ? 'selected' : ''}>One-time</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Skool Community Link</label>
                    <input type="url" id="edit-course-link" value="${course.skool_url || 'https://www.skool.com/dogfathersplus'}" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        Save Course Settings
                    </button>
                </div>
            </form>`;
        }

        // Ride-Along Save Handler
        async function saveEditRideAlong(e) {
            e.preventDefault();
            const pkg = state.editModal.data;
            
            const name = document.getElementById('edit-ridealong-name')?.value?.trim();
            const priceVal = document.getElementById('edit-ridealong-price')?.value;
            const duration = document.getElementById('edit-ridealong-duration')?.value?.trim() || '';
            const description = document.getElementById('edit-ridealong-description')?.value?.trim() || '';
            const featuresText = document.getElementById('edit-ridealong-features')?.value || '';
            const isPopular = document.getElementById('edit-ridealong-popular')?.checked || false;
            
            if (!name) {
                showToast('Package name is required', 'error');
                return;
            }
            
            const price = parseFloat(priceVal);
            if (isNaN(price) || price < 0) {
                showToast('Please enter a valid price', 'error');
                return;
            }
            
            const featuresArray = featuresText.split('\n').filter(f => f.trim());
            
            const pkgData = {
                name: name,
                price: price,
                duration: duration,
                description: description,
                features: JSON.stringify(featuresArray),
                is_popular: isPopular
            };
            
            console.log('Saving ride-along:', pkgData, 'ID:', pkg.id);
            showLoading();
            
            try {
                if (pkg.id) {
                    const { data, error } = await supabaseClient
                        .from('ride_along_packages')
                        .update(pkgData)
                        .eq('id', pkg.id)
                        .select();
                    
                    if (error) {
                        console.error('Package update error:', error);
                        hideLoading();
                        showToast('Failed to update: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    showToast('Package updated!', 'success');
                } else {
                    pkgData.is_active = true;
                    pkgData.sort_order = 0;
                    
                    const { data, error } = await supabaseClient
                        .from('ride_along_packages')
                        .insert(pkgData)
                        .select();
                    
                    if (error) {
                        console.error('Package insert error:', error);
                        hideLoading();
                        showToast('Failed to add: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    showToast('Package added!', 'success');
                }
                
                await loadPublicData();
                hideLoading();
                closeEditModal();
            } catch (err) {
                console.error('Exception:', err);
                hideLoading();
                showToast('Error: ' + err.message, 'error');
            }
        }

        // Course Thumbnail Upload (Modal)
        function handleCourseThumbnailUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.editModal.data.thumbnail_url = e.target.result;
                    const preview = document.getElementById('course-thumbnail-preview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="max-h-32 mx-auto rounded-lg mb-2"/>`;
                    }
                    showToast('Thumbnail uploaded!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Course Thumbnail Upload (Inline Education Tab)
        function handleInlineCourseThumbnail(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store in localStorage
                    const courseSettings = JSON.parse(localStorage.getItem('courseSettings') || '{}');
                    courseSettings.thumbnail_url = e.target.result;
                    localStorage.setItem('courseSettings', JSON.stringify(courseSettings));
                    
                    // Update preview
                    const preview = document.getElementById('course-thumbnail-inline-preview');
                    if (preview) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" class="max-h-40 mx-auto rounded-lg shadow-lg mb-3"/>
                            <p class="text-green-600 font-bold text-sm"><span class="material-symbols-outlined text-sm align-middle">check_circle</span> Thumbnail uploaded!</p>
                            <p class="text-slate-500 text-xs mt-1">Click to change</p>
                        `;
                    }
                    showToast('Course thumbnail uploaded!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Course Save Handler (stores in localStorage for now as course is single entity)
        async function saveEditCourse(e) {
            e.preventDefault();
            
            const courseData = {
                title: document.getElementById('edit-course-title').value,
                instructor: document.getElementById('edit-course-instructor').value,
                tagline: document.getElementById('edit-course-tagline').value,
                price: parseFloat(document.getElementById('edit-course-price').value),
                billing: document.getElementById('edit-course-billing').value,
                skool_url: document.getElementById('edit-course-link').value,
                thumbnail_url: state.editModal.data.thumbnail_url || ''
            };
            
            // Save to localStorage (or could create a settings table in Supabase)
            localStorage.setItem('courseSettings', JSON.stringify(courseData));
            
            showToast('Course settings saved!', 'success');
            closeEditModal();
        }

        // Delete Ride-Along
        function confirmDeleteRideAlong(id, name) {
            showConfirm('Delete Package', `Are you sure you want to delete "${name}"?`, async () => {
                showLoading();
                try {
                    const { error } = await supabaseClient.from('ride_along_packages').update({ is_active: false }).eq('id', id);
                    if (error) {
                        console.error('Delete package error:', error);
                        hideLoading();
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    await loadPublicData();
                    hideLoading();
                    showToast('Package deleted', 'success');
                    closeEditModal();
                } catch (err) {
                    console.error('Exception:', err);
                    hideLoading();
                    showToast('Error: ' + err.message, 'error');
                }
            });
        }

        // Inline Course Save (from education tab form)
        function saveCourseInline() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                showToast('Course changes saved!', 'success');
            }, 500);
        }

        function renderPetEditForm(pet) {
            const currentYear = new Date().getFullYear();
            const years = Array.from({length: 25}, (_, i) => currentYear - i);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const isOtherBreed = pet.breed && !popularBreeds.slice(0, -1).includes(pet.breed);
            
            return `
            <form id="edit-pet-form" class="space-y-4">
                <!-- Photo -->
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div id="edit-pet-photo-preview" class="w-24 h-24 rounded-full bg-background-light dark:bg-background-dark border-2 border-dashed border-border-light dark:border-border-dark flex items-center justify-center overflow-hidden cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('edit-pet-photo').click()">
                            ${pet.photo_url ? 
                                `<img src="${pet.photo_url}" class="w-full h-full object-cover"/>` : 
                                `<span class="material-symbols-outlined text-3xl text-text-sub-light">add_a_photo</span>`
                            }
                        </div>
                        <input type="file" id="edit-pet-photo" accept="image/*" class="hidden" onchange="handleEditPetPhoto(event)">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Pet Name *</label>
                    <input type="text" id="edit-pet-name" value="${pet.name || ''}" placeholder="Max" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Breed *</label>
                    <select id="edit-pet-breed" onchange="handleEditBreedChange(this.value)"
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                        <option value="">Select breed...</option>
                        ${popularBreeds.map(breed => `<option value="${breed}" ${pet.breed === breed || (isOtherBreed && breed === 'Other') ? 'selected' : ''}>${breed}</option>`).join('')}
                    </select>
                </div>

                <div id="edit-breed-other-container" class="${isOtherBreed ? '' : 'hidden'}">
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Specify Breed *</label>
                    <input type="text" id="edit-pet-breed-other" value="${isOtherBreed ? pet.breed : ''}" placeholder="Enter breed" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Weight (lbs) *</label>
                        <input type="number" id="edit-pet-weight" value="${pet.weight || ''}" placeholder="50" min="1" max="300" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Gender</label>
                        <select id="edit-pet-gender"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                            <option value="male" ${pet.gender === 'male' ? 'selected' : ''}>Male</option>
                            <option value="female" ${pet.gender === 'female' ? 'selected' : ''}>Female</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Birthday (optional)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="edit-pet-birth-month"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                            <option value="">Month</option>
                            ${months.map((month, i) => `<option value="${i + 1}" ${pet.birth_month == (i + 1) ? 'selected' : ''}>${month}</option>`).join('')}
                        </select>
                        <select id="edit-pet-birth-year"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                            <option value="">Year</option>
                            ${years.map(year => `<option value="${year}" ${pet.birth_year == year ? 'selected' : ''}>${year}</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Special Notes</label>
                    <textarea id="edit-pet-notes" placeholder="Allergies, sensitivities, special care..." 
                        class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${pet.grooming_notes || ''}</textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    ${pet.id ? `<button type="button" onclick="confirmDeletePet('${pet.id}', '${pet.name}')" class="px-4 h-12 border border-red-300 text-red-600 rounded-lg font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Delete</button>` : ''}
                    <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        ${pet.id ? 'Save Changes' : 'Add Pet'}
                    </button>
                </div>
            </form>`;
        }

        function renderProfileEditForm(profile) {
            return `
            <form id="edit-profile-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Full Name *</label>
                    <input type="text" id="edit-profile-name" value="${profile.name || ''}" placeholder="John Smith" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Phone Number</label>
                    <input type="tel" id="edit-profile-phone" value="${profile.phone || ''}" placeholder="(555) 123-4567" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Street Address</label>
                    <input type="text" id="edit-profile-address" value="${profile.address || ''}" placeholder="123 Main St" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">City</label>
                        <input type="text" id="edit-profile-city" value="${profile.city || ''}" placeholder="Los Angeles" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">ZIP Code</label>
                        <input type="text" id="edit-profile-zip" value="${profile.zip || ''}" placeholder="90001" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>`;
        }

        function renderRewardEditForm(reward) {
            return `
            <form id="edit-reward-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Reward Name *</label>
                    <input type="text" id="edit-reward-name" value="${reward.name || ''}" placeholder="Free Bath & Brush" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Description</label>
                    <textarea id="edit-reward-description" placeholder="Describe this reward..." 
                        class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${reward.description || ''}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Points Required *</label>
                    <input type="number" id="edit-reward-points" value="${reward.points_required || reward.points || ''}" placeholder="500" min="1" max="99999" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div class="flex gap-3 pt-4">
                    ${reward.id ? `<button type="button" onclick="confirmDeleteReward('${reward.id}', '${reward.name}')" class="px-4 h-12 border border-red-300 text-red-600 rounded-lg font-bold hover:bg-red-50 transition-colors">Delete</button>` : ''}
                    <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        ${reward.id ? 'Save Changes' : 'Add Reward'}
                    </button>
                </div>
            </form>`;
        }

        function renderProductEditForm(product) {
            return `
            <form id="edit-product-form" class="space-y-4">
                <!-- Product Image Upload -->
                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Product Image</label>
                    <div class="border-2 border-dashed border-border-light dark:border-border-dark rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors" onclick="document.getElementById('edit-product-image-file').click()">
                        <div id="product-image-preview">
                            ${product.image_url ? 
                                `<img src="${product.image_url}" class="max-h-32 mx-auto rounded-lg mb-2" alt="Product"/>` :
                                `<span class="material-symbols-outlined text-4xl text-text-sub-light dark:text-text-sub-dark block mb-2">add_photo_alternate</span>`
                            }
                        </div>
                        <p class="text-sm text-text-sub-light dark:text-text-sub-dark">Click to upload image</p>
                        <p class="text-xs text-text-sub-light dark:text-text-sub-dark mt-1">PNG, JPG up to 5MB</p>
                        <input type="file" id="edit-product-image-file" accept="image/*" class="hidden" onchange="handleProductImageUpload(event)">
                        <input type="hidden" id="edit-product-image" value="${product.image_url || ''}">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Product Name *</label>
                    <input type="text" id="edit-product-name" value="${product.name || ''}" placeholder="Oatmeal Shampoo" 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Description</label>
                    <textarea id="edit-product-description" placeholder="Product description..." 
                        class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${product.description || ''}</textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Price *</label>
                        <input type="number" step="0.01" id="edit-product-price" value="${product.price || ''}" placeholder="14.99" min="0" max="99999" 
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 dark:text-white">Category</label>
                        <select id="edit-product-category"
                            class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                            <option value="grooming" ${product.category === 'grooming' ? 'selected' : ''}>Grooming</option>
                            <option value="treats" ${product.category === 'treats' ? 'selected' : ''}>Treats</option>
                            <option value="toys" ${product.category === 'toys' ? 'selected' : ''}>Toys</option>
                            <option value="health" ${product.category === 'health' ? 'selected' : ''}>Health</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Affiliate Link</label>
                    <input type="url" id="edit-product-link" value="${product.affiliate_url || ''}" placeholder="https://amazon.com/..." 
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                </div>

                <div class="flex gap-3 pt-4">
                    ${product.id ? `<button type="button" onclick="confirmDeleteProduct('${product.id}', '${(product.name || '').replace(/'/g, "\\'")}')" class="px-4 h-12 border border-red-300 text-red-600 rounded-lg font-bold hover:bg-red-50 transition-colors">Delete</button>` : ''}
                    <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        ${product.id ? 'Save Changes' : 'Add Product'}
                    </button>
                </div>
            </form>`;
        }

        // Product Image Upload Handler
        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store in hidden field and state
                    document.getElementById('edit-product-image').value = e.target.result;
                    if (state.editModal) {
                        state.editModal.data.image_url = e.target.result;
                    }
                    // Update preview
                    const preview = document.getElementById('product-image-preview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="max-h-32 mx-auto rounded-lg mb-2" alt="Product"/>`;
                    }
                    showToast('Image uploaded!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function renderAppointmentEditForm(apt) {
            const statuses = ['pending', 'confirmed', 'in_progress', 'completed', 'cancelled', 'no_show'];
            return `
            <form id="edit-appointment-form" class="space-y-4">
                <div class="p-4 bg-background-light dark:bg-background-dark rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">pets</span>
                        </div>
                        <div>
                            <p class="font-bold dark:text-white">${apt.petName || apt.pet?.name || 'Pet'}</p>
                            <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${apt.customerName || apt.customer?.full_name || 'Customer'}</p>
                        </div>
                    </div>
                    <div class="text-sm text-text-sub-light dark:text-text-sub-dark space-y-1">
                        <p><strong>Service:</strong> ${apt.serviceName || apt.service?.name || 'Grooming'}</p>
                        <p><strong>Date:</strong> ${formatDate(apt.appointment_date || apt.date)}</p>
                        <p><strong>Time:</strong> ${formatTime(apt.start_time || apt.time)}</p>
                        ${apt.service_address ? `<p><strong>Address:</strong> ${apt.service_address}, ${apt.service_city || ''}</p>` : ''}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Status</label>
                    <select id="edit-appointment-status"
                        class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white">
                        ${statuses.map(s => `<option value="${s}" ${apt.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1).replace('_', ' ')}</option>`).join('')}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 dark:text-white">Admin Notes</label>
                    <textarea id="edit-appointment-notes" placeholder="Internal notes..." 
                        class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none">${apt.admin_notes || ''}</textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 h-12 border border-border-light dark:border-border-dark rounded-lg font-bold hover:bg-background-light dark:hover:bg-background-dark dark:text-white transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 h-12 bg-primary hover:bg-sky-600 text-white font-bold rounded-lg transition-colors">
                        Update
                    </button>
                </div>
            </form>`;
        }

        // Edit handlers
        function handleEditBreedChange(value) {
            const container = document.getElementById('edit-breed-other-container');
            if (container) {
                container.classList.toggle('hidden', value !== 'Other');
            }
        }

        function handleEditPetPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image must be less than 5MB', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.editModal.data.photo_url = e.target.result;
                    const preview = document.getElementById('edit-pet-photo-preview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover"/>`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveEditPet(e) {
            e.preventDefault();
            const pet = state.editModal.data;
            
            // Get form values
            const name = document.getElementById('edit-pet-name').value.trim();
            let breed = document.getElementById('edit-pet-breed').value;
            if (breed === 'Other') {
                breed = document.getElementById('edit-pet-breed-other').value;
            }
            const weightValue = document.getElementById('edit-pet-weight').value;
            
            // VALIDATION
            if (!name) {
                showToast('Please enter your pet\'s name', 'error');
                return;
            }
            if (!breed) {
                showToast('Please select a breed', 'error');
                return;
            }
            const weight = parseFloat(weightValue);
            if (!weight || weight < 1 || weight > 300) {
                showToast('Please enter a valid weight (1-300 lbs)', 'error');
                return;
            }
            
            // Get birthday values
            const birthMonth = document.getElementById('edit-pet-birth-month')?.value;
            const birthYear = document.getElementById('edit-pet-birth-year')?.value;
            
            // Calculate age from birth year if provided
            let ageYears = null;
            if (birthYear) {
                ageYears = new Date().getFullYear() - parseInt(birthYear);
            }
            
            const petData = {
                name: name,
                breed: breed,
                weight: weight,
                gender: document.getElementById('edit-pet-gender').value,
                grooming_notes: document.getElementById('edit-pet-notes').value,
                photo_url: state.editModal.data.photo_url || pet.photo_url
            };
            
            // Add optional fields
            if (ageYears !== null) petData.age_years = ageYears;
            if (birthMonth) petData.birth_month = parseInt(birthMonth);
            if (birthYear) petData.birth_year = parseInt(birthYear);
            
            showLoading();
            
            if (pet.id) {
                // Update existing pet
                const { error } = await supabaseClient
                    .from('pets')
                    .update(petData)
                    .eq('id', pet.id);
                
                if (error) {
                    hideLoading();
                    showToast('Failed to update pet', 'error');
                    return;
                }
                
                // Update local state
                const index = state.pets.findIndex(p => p.id === pet.id);
                if (index !== -1) {
                    state.pets[index] = { ...state.pets[index], ...petData };
                }
                showToast('Pet updated!', 'success');
            } else {
                // Create new pet
                petData.owner_id = state.currentUser.id;
                petData.is_active = true;  // IMPORTANT: Must be true to show up
                const { data, error } = await supabaseClient
                    .from('pets')
                    .insert(petData)
                    .select()
                    .single();
                
                if (error) {
                    hideLoading();
                    showToast('Failed to add pet: ' + error.message, 'error');
                    return;
                }
                
                state.pets.push(data);
                showToast('Pet added!', 'success');
            }
            
            hideLoading();
            closeEditModal();
        }

        async function saveEditProfile(e) {
            e.preventDefault();
            
            const profileData = {
                full_name: document.getElementById('edit-profile-name').value,
                phone: document.getElementById('edit-profile-phone').value,
                address: document.getElementById('edit-profile-address').value,
                city: document.getElementById('edit-profile-city').value,
                zip_code: document.getElementById('edit-profile-zip').value
            };
            
            showLoading();
            
            const { error } = await supabaseClient
                .from('profiles')
                .update(profileData)
                .eq('id', state.currentUser.id);
            
            if (error) {
                hideLoading();
                showToast('Failed to update profile', 'error');
                return;
            }
            
            // Update local state
            state.currentUser.name = profileData.full_name;
            state.currentUser.phone = profileData.phone;
            state.currentUser.address = profileData.address;
            state.currentUser.city = profileData.city;
            state.currentUser.zip = profileData.zip_code;
            
            hideLoading();
            showToast('Profile updated!', 'success');
            closeEditModal();
        }

        async function saveEditReward(e) {
            e.preventDefault();
            const reward = state.editModal.data;
            
            const name = document.getElementById('edit-reward-name')?.value?.trim();
            const description = document.getElementById('edit-reward-description')?.value?.trim() || '';
            const pointsVal = document.getElementById('edit-reward-points')?.value;
            
            if (!name) {
                showToast('Reward name is required', 'error');
                return;
            }
            
            const points = parseInt(pointsVal);
            if (isNaN(points) || points < 0) {
                showToast('Please enter valid points', 'error');
                return;
            }
            
            const rewardData = {
                name: name,
                description: description,
                points_required: points
            };
            
            console.log('Saving reward:', rewardData, 'ID:', reward.id);
            showLoading();
            
            try {
                if (reward.id) {
                    const { data, error } = await supabaseClient
                        .from('rewards')
                        .update(rewardData)
                        .eq('id', reward.id)
                        .select();
                    
                    if (error) {
                        console.error('Reward update error:', error);
                        hideLoading();
                        showToast('Failed to update: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    showToast('Reward updated!', 'success');
                } else {
                    rewardData.is_active = true;
                    const { data, error } = await supabaseClient
                        .from('rewards')
                        .insert(rewardData)
                        .select();
                    
                    if (error) {
                        console.error('Reward insert error:', error);
                        hideLoading();
                        showToast('Failed to add: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    showToast('Reward added!', 'success');
                }
                
                await loadPublicData();
                hideLoading();
                closeEditModal();
            } catch (err) {
                console.error('Exception:', err);
                hideLoading();
                showToast('Error: ' + err.message, 'error');
            }
        }

        async function saveEditProduct(e) {
            e.preventDefault();
            const product = state.editModal.data;
            
            // Get form values
            const name = document.getElementById('edit-product-name')?.value?.trim();
            const description = document.getElementById('edit-product-description')?.value?.trim() || '';
            const priceVal = document.getElementById('edit-product-price')?.value;
            const category = document.getElementById('edit-product-category')?.value || 'grooming';
            const affiliateUrl = document.getElementById('edit-product-link')?.value?.trim() || '';
            const imageUrl = document.getElementById('edit-product-image')?.value?.trim() || '';
            
            // Validate required fields
            if (!name) {
                showToast('Product name is required', 'error');
                return;
            }
            
            const price = parseFloat(priceVal);
            if (isNaN(price) || price < 0) {
                showToast('Please enter a valid price', 'error');
                return;
            }
            
            const productData = {
                name: name,
                description: description,
                price: price,
                category: category,
                affiliate_url: affiliateUrl,
                image_url: imageUrl
            };
            
            console.log('Saving product:', productData, 'ID:', product.id);
            
            showLoading();
            
            try {
                if (product.id) {
                    const { data, error } = await supabaseClient
                        .from('products')
                        .update(productData)
                        .eq('id', product.id)
                        .select();
                    
                    if (error) {
                        console.error('Update error:', error);
                        hideLoading();
                        showToast('Failed to update: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    console.log('Update result:', data);
                    showToast('Product updated!', 'success');
                } else {
                    productData.is_active = true;
                    productData.sort_order = 0;
                    
                    const { data, error } = await supabaseClient
                        .from('products')
                        .insert(productData)
                        .select();
                    
                    if (error) {
                        console.error('Insert error:', error);
                        hideLoading();
                        showToast('Failed to add: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    console.log('Insert result:', data);
                    showToast('Product added!', 'success');
                }
                
                await loadPublicData();
                hideLoading();
                closeEditModal();
            } catch (err) {
                console.error('Exception:', err);
                hideLoading();
                showToast('Error: ' + err.message, 'error');
            }
        }

        async function saveEditAppointment(e) {
            e.preventDefault();
            const apt = state.editModal.data;
            
            const status = document.getElementById('edit-appointment-status').value;
            const notes = document.getElementById('edit-appointment-notes').value;
            
            showLoading();
            
            const updateData = { status, admin_notes: notes };
            if (status === 'confirmed') updateData.confirmed_at = new Date().toISOString();
            if (status === 'completed') updateData.completed_at = new Date().toISOString();
            if (status === 'cancelled') updateData.cancelled_at = new Date().toISOString();
            
            const { error } = await supabaseClient
                .from('appointments')
                .update(updateData)
                .eq('id', apt.id);
            
            if (error) {
                hideLoading();
                showToast('Failed to update appointment', 'error');
                return;
            }
            
            // Reload data
            if (state.currentUser.role === 'admin') {
                await loadAdminData();
            } else {
                await loadCustomerData(state.currentUser.id);
            }
            
            hideLoading();
            showToast('Appointment updated!', 'success');
            closeEditModal();
        }

        // Delete confirmations
        function confirmDeletePet(id, name) {
            showConfirm('Delete Pet', `Are you sure you want to remove ${name}?`, async () => {
                showLoading();
                try {
                    const { error } = await supabaseClient.from('pets').update({ is_active: false }).eq('id', id);
                    if (error) {
                        console.error('Delete pet error:', error);
                        hideLoading();
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    state.pets = state.pets.filter(p => p.id !== id);
                    hideLoading();
                    showToast(`${name} removed`, 'success');
                    closeEditModal();
                } catch (err) {
                    console.error('Exception:', err);
                    hideLoading();
                    showToast('Error: ' + err.message, 'error');
                }
            });
        }

        function confirmDeleteReward(id, name) {
            showConfirm('Delete Reward', `Are you sure you want to delete "${name}"?`, async () => {
                showLoading();
                try {
                    const { error } = await supabaseClient.from('rewards').update({ is_active: false }).eq('id', id);
                    if (error) {
                        console.error('Delete reward error:', error);
                        hideLoading();
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    await loadPublicData();
                    hideLoading();
                    showToast('Reward deleted', 'success');
                    closeEditModal();
                } catch (err) {
                    console.error('Exception:', err);
                    hideLoading();
                    showToast('Error: ' + err.message, 'error');
                }
            });
        }

        function confirmDeleteProduct(id, name) {
            showConfirm('Delete Product', `Are you sure you want to delete "${name}"?`, async () => {
                showLoading();
                try {
                    const { error } = await supabaseClient.from('products').update({ is_active: false }).eq('id', id);
                    if (error) {
                        console.error('Delete product error:', error);
                        hideLoading();
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        return;
                    }
                    await loadPublicData();
                    hideLoading();
                    showToast('Product deleted', 'success');
                    closeEditModal();
                } catch (err) {
                    console.error('Exception:', err);
                    hideLoading();
                    showToast('Error: ' + err.message, 'error');
                }
            });
        }

        // =============================================
        // ADMIN DASHBOARD HELPER FUNCTIONS
        // =============================================
        
        // Export dashboard data as CSV
        function exportDashboardData() {
            const appointments = data.appointments;
            if (appointments.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = ['Date', 'Time', 'Pet', 'Customer', 'Service', 'Groomer', 'Status', 'Price'];
            const rows = appointments.map(a => [
                a.appointment_date || '',
                a.start_time || '',
                a.petName || '',
                a.customerName || '',
                a.serviceName || '',
                a.groomerName || 'Unassigned',
                a.status || '',
                a.total_price || a.base_price || ''
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `appointments_${getTodayPacific()}.csv`;
            link.click();
            showToast('Export downloaded', 'success');
        }
        
        // View appointment details modal
        function viewAppointmentDetails(appointmentId) {
            const appointment = data.appointments.find(a => a.id === appointmentId);
            if (!appointment) {
                showToast('Appointment not found', 'error');
                return;
            }
            state.selectedAppointment = appointment;
            state.showAppointmentDetail = true;
            render();
        }
        
        // Open edit appointment modal
        function openEditAppointmentModal(appointmentId) {
            const appointment = data.appointments.find(a => a.id === appointmentId);
            if (!appointment) {
                showToast('Appointment not found', 'error');
                return;
            }
            // For now, show a toast - can be enhanced with full edit modal later
            showToast('Edit appointment feature coming soon. Use status dropdown to update.', 'info');
        }
        
        // Confirm delete appointment
        function confirmDeleteAppointment(appointmentId) {
            const appointment = data.appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            showConfirm('Delete Appointment', `Are you sure you want to delete the appointment for ${appointment.petName || 'this pet'}?`, async () => {
                showLoading();
                try {
                    const { error } = await supabaseClient
                        .from('appointments')
                        .update({ status: 'cancelled' })
                        .eq('id', appointmentId);
                    
                    if (error) throw error;
                    await loadAdminData();
                    hideLoading();
                    showToast('Appointment cancelled', 'success');
                } catch (err) {
                    hideLoading();
                    showToast('Error: ' + err.message, 'error');
                }
            });
        }
        
        // Appointment pagination
        function prevAppointmentPage() {
            if ((state.appointmentPage || 1) > 1) {
                state.appointmentPage = (state.appointmentPage || 1) - 1;
                render();
            }
        }
        
        function nextAppointmentPage() {
            const totalPages = Math.ceil(data.appointments.length / 10);
            if ((state.appointmentPage || 1) < totalPages) {
                state.appointmentPage = (state.appointmentPage || 1) + 1;
                render();
            }
        }
        
        // Mini calendar functions
        function getMiniCalendarMonthLabel() {
            const date = state.miniCalendarDate ? new Date(state.miniCalendarDate + 'T12:00:00') : new Date();
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        
        function generateMiniCalendarDays() {
            const today = getTodayPacific();
            const baseDate = state.miniCalendarDate ? new Date(state.miniCalendarDate + 'T12:00:00') : new Date();
            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            const daysInMonth = lastDay.getDate();
            
            const days = [];
            
            // Add empty cells for days before first of month
            for (let i = 0; i < startDayOfWeek; i++) {
                days.push({ empty: true });
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                days.push({
                    day: day,
                    dateStr: dateStr,
                    isToday: dateStr === today,
                    isSelected: dateStr === state.selectedMiniCalendarDate
                });
            }
            
            return days;
        }
        
        function miniCalendarPrevMonth() {
            const current = state.miniCalendarDate ? new Date(state.miniCalendarDate + 'T12:00:00') : new Date();
            current.setMonth(current.getMonth() - 1);
            state.miniCalendarDate = current.toISOString().split('T')[0];
            render();
        }
        
        function miniCalendarNextMonth() {
            const current = state.miniCalendarDate ? new Date(state.miniCalendarDate + 'T12:00:00') : new Date();
            current.setMonth(current.getMonth() + 1);
            state.miniCalendarDate = current.toISOString().split('T')[0];
            render();
        }
        
        function goToMiniCalendarToday() {
            state.miniCalendarDate = getTodayPacific();
            state.selectedMiniCalendarDate = getTodayPacific();
            render();
        }
        
        function selectMiniCalendarDate(dateStr) {
            state.selectedMiniCalendarDate = dateStr;
            // Could filter appointments by this date if needed
            render();
        }
        
        // Save education settings
        function saveEducationSettings() {
            showToast('Education settings saved', 'success');
        }
        
        // =============================================
        // DEBOUNCED APPOINTMENT SEARCH
        // =============================================
        
        let appointmentSearchTimeout = null;
        function handleAppointmentSearch(value) {
            state.appointmentSearchQuery = value;
            
            // Clear previous timeout
            if (appointmentSearchTimeout) {
                clearTimeout(appointmentSearchTimeout);
            }
            
            // Debounce: wait 300ms after user stops typing before re-rendering
            appointmentSearchTimeout = setTimeout(() => {
                state.appointmentPage = 1; // Reset to first page on search
                render();
                // Restore focus to search input after render
                setTimeout(() => {
                    const input = document.getElementById('appointmentSearchInput');
                    if (input) {
                        input.focus();
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                }, 10);
            }, 300);
        }
        
        // =============================================
        // CUSTOMER TAB FUNCTIONS
        // =============================================
        
        let customerSearchTimeout = null;
        function handleCustomerSearch(value) {
            state.customerSearchQuery = value;
            
            if (customerSearchTimeout) {
                clearTimeout(customerSearchTimeout);
            }
            
            customerSearchTimeout = setTimeout(() => {
                state.customerPage = 1;
                render();
                setTimeout(() => {
                    const input = document.getElementById('customerSearchInput');
                    if (input) {
                        input.focus();
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                }, 10);
            }, 300);
        }
        
        function exportCustomerData() {
            const customers = state.allCustomers.filter(c => c.role === 'customer');
            if (customers.length === 0) {
                showToast('No customers to export', 'warning');
                return;
            }
            
            const headers = ['Name', 'Email', 'Phone', 'Address', 'Loyalty Points', 'Total Visits', 'Total Spent', 'Last Visit'];
            const rows = customers.map(c => {
                const customerAppts = data.appointments.filter(a => a.customer_id === c.id);
                const lastAppt = customerAppts.sort((a, b) => (b.appointment_date || '').localeCompare(a.appointment_date || ''))[0];
                const totalSpent = customerAppts.filter(a => a.status === 'completed').reduce((sum, a) => sum + (parseFloat(a.total_price) || 0), 0);
                return [
                    c.full_name || '',
                    c.email || '',
                    c.phone || '',
                    c.address || '',
                    c.loyalty_points || 0,
                    customerAppts.length,
                    totalSpent.toFixed(2),
                    lastAppt?.appointment_date || 'Never'
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `customers_${getTodayPacific()}.csv`;
            link.click();
            showToast('Customer data exported', 'success');
        }
        
        function openCustomerDetailModal(customerId) {
            const customer = state.allCustomers.find(c => c.id === customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            state.customerDetailModal = customer;
            render();
        }
        
        function closeCustomerDetailModal() {
            state.customerDetailModal = null;
            render();
        }
        
        function renderCustomerDetailModal() {
            const customer = state.customerDetailModal;
            if (!customer) return '';
            
            const customerPets = (state.pets || []).filter(p => p.owner_id === customer.id);
            const customerAppts = (data.appointments || []).filter(a => a.customer_id === customer.id).sort((a, b) => (b.appointment_date || '').localeCompare(a.appointment_date || ''));
            const completedAppts = customerAppts.filter(a => a.status === 'completed');
            const totalSpent = completedAppts.reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.base_price) || 0), 0);
            const initials = (customer.full_name || 'C').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const loyaltyTier = (customer.loyalty_points || 0) >= 200 ? 'Gold' : (customer.loyalty_points || 0) >= 100 ? 'Silver' : 'Bronze';
            const tierColors = { Gold: 'from-amber-400 to-amber-600', Silver: 'from-slate-400 to-slate-600', Bronze: 'from-orange-400 to-orange-600' };
            
            return `
            <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeCustomerDetailModal()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                    <!-- Header with gradient -->
                    <div class="relative bg-gradient-to-r ${tierColors[loyaltyTier]} p-6 text-white">
                        <button onclick="closeCustomerDetailModal()" class="absolute top-4 right-4 p-2 hover:bg-white/20 rounded-xl transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                        <div class="flex items-center gap-4">
                            <div class="w-20 h-20 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center text-3xl font-bold">
                                ${initials}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">${customer.full_name || 'Unknown'}</h2>
                                <p class="text-white/80">${loyaltyTier} Member â€¢ ${customer.loyalty_points || 0} points</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-6 space-y-6">
                        <!-- Contact Info -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">phone</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Phone</span>
                                </div>
                                <p class="text-sm font-medium text-slate-900 dark:text-white">${customer.phone || 'Not provided'}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">mail</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Email</span>
                                </div>
                                <p class="text-sm font-medium text-slate-900 dark:text-white truncate">${customer.email || 'Not provided'}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl sm:col-span-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">location_on</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Address</span>
                                </div>
                                <p class="text-sm font-medium text-slate-900 dark:text-white">${customer.address || 'Not provided'}</p>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="text-center p-4 bg-admin-primary/5 rounded-xl border border-admin-primary/20">
                                <p class="text-2xl font-bold text-admin-primary">${customer.loyalty_points || 0}</p>
                                <p class="text-xs text-slate-500 font-medium">Points</p>
                            </div>
                            <div class="text-center p-4 bg-admin-accent/5 rounded-xl border border-admin-accent/20">
                                <p class="text-2xl font-bold text-admin-accent">${customerAppts.length}</p>
                                <p class="text-xs text-slate-500 font-medium">Total Visits</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-xl border border-green-200">
                                <p class="text-2xl font-bold text-green-600">$${totalSpent.toFixed(0)}</p>
                                <p class="text-xs text-slate-500 font-medium">Total Spent</p>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <p class="text-2xl font-bold text-purple-600">${customerPets.length}</p>
                                <p class="text-xs text-slate-500 font-medium">Pets</p>
                            </div>
                        </div>
                        
                        <!-- Pets Section -->
                        <div>
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-admin-primary">pets</span>Pets
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${customerPets.length > 0 ? customerPets.map(pet => `
                                    <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                        <div class="w-12 h-12 rounded-xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">
                                            ${pet.photo_url ? `<img src="${pet.photo_url}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400">pets</span>`}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-bold text-slate-900 dark:text-white">${pet.name}</p>
                                            <p class="text-xs text-slate-500">${pet.breed || 'Unknown breed'} â€¢ ${pet.weight ? pet.weight + ' lbs' : 'Weight N/A'}</p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-sm text-slate-400 col-span-2">No pets registered</p>'}
                            </div>
                        </div>
                        
                        <!-- Recent Appointments -->
                        <div>
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-admin-primary">history</span>Recent Appointments
                            </h3>
                            <div class="space-y-2 max-h-[200px] overflow-y-auto">
                                ${customerAppts.length > 0 ? customerAppts.slice(0, 5).map(apt => `
                                    <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                        <div class="text-center min-w-[60px]">
                                            <p class="text-xs font-bold text-slate-400">${apt.appointment_date ? new Date(apt.appointment_date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}</p>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-slate-900 dark:text-white">${apt.petName || 'Pet'} - ${apt.serviceName || 'Grooming'}</p>
                                            <p class="text-xs text-slate-500">${apt.groomerName || 'Unassigned'}</p>
                                        </div>
                                        <span class="px-2 py-1 text-xs font-bold rounded-full ${apt.status === 'completed' ? 'bg-green-100 text-green-700' : apt.status === 'confirmed' ? 'bg-teal-100 text-teal-700' : apt.status === 'cancelled' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'}">${apt.status}</span>
                                        <p class="text-sm font-bold text-slate-700 dark:text-slate-300">$${(apt.total_price || apt.base_price || 0).toFixed(0)}</p>
                                    </div>
                                `).join('') : '<p class="text-sm text-slate-400">No appointments yet</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="px-6 py-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                        <button onclick="closeCustomerDetailModal()" class="px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-800 transition-colors">
                            Close
                        </button>
                        <button onclick="closeCustomerDetailModal(); openAdminAddAppointment();" class="px-5 py-2.5 bg-admin-accent hover:bg-teal-600 text-white font-bold text-sm rounded-xl transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">calendar_add_on</span>Book Appointment
                        </button>
                    </div>
                </div>
            </div>`;
        }
        
        // =============================================
        // QUICK VIEW APPOINTMENT MODAL
        // =============================================
        
        function openQuickViewAppointment(appointmentId) {
            const appointment = data.appointments.find(a => a.id === appointmentId);
            if (!appointment) {
                showToast('Appointment not found', 'error');
                return;
            }
            state.quickViewAppointment = appointment;
            render();
        }
        
        function closeQuickViewAppointment() {
            state.quickViewAppointment = null;
            render();
        }
        
        function renderQuickViewAppointmentModal() {
            const apt = state.quickViewAppointment;
            if (!apt) return '';
            
            const statusColors = {
                pending: 'bg-amber-100 text-amber-700 border-amber-200',
                confirmed: 'bg-teal-100 text-teal-700 border-teal-200',
                in_progress: 'bg-purple-100 text-purple-700 border-purple-200',
                completed: 'bg-green-100 text-green-700 border-green-200',
                cancelled: 'bg-red-100 text-red-700 border-red-200',
                no_show: 'bg-slate-100 text-slate-700 border-slate-200'
            };
            
            return `
            <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeQuickViewAppointment()">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-gradient-to-r from-admin-primary/5 to-transparent">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-admin-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-admin-primary">visibility</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 dark:text-white">Quick View</h3>
                                <p class="text-xs text-slate-500">Appointment Details</p>
                            </div>
                        </div>
                        <button onclick="closeQuickViewAppointment()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                            <span class="material-symbols-outlined text-slate-400">close</span>
                        </button>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 space-y-5">
                        <!-- Pet & Customer Info -->
                        <div class="flex items-start gap-4">
                            <div class="w-16 h-16 rounded-2xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex items-center justify-center flex-shrink-0">
                                ${apt.petPhoto ? `<img src="${apt.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-3xl text-slate-400">pets</span>`}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-xl font-bold text-slate-900 dark:text-white">${apt.petName || 'Unknown Pet'}</h4>
                                <p class="text-sm text-slate-500">${apt.petBreed || 'Unknown Breed'}</p>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-slate-400">person</span>
                                    <span class="text-sm text-slate-700 dark:text-slate-300">${apt.customerName || 'Unknown Customer'}</span>
                                </div>
                            </div>
                            <span class="px-3 py-1.5 rounded-full text-xs font-bold border ${statusColors[apt.status] || statusColors.pending}">${apt.status === 'in_progress' ? 'In Progress' : apt.status?.charAt(0).toUpperCase() + apt.status?.slice(1) || 'Pending'}</span>
                        </div>
                        
                        <!-- Details Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">calendar_today</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Date</span>
                                </div>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">${apt.appointment_date ? new Date(apt.appointment_date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'Not set'}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">schedule</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Time</span>
                                </div>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">${formatTime(apt.start_time)}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">content_cut</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Service</span>
                                </div>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">${apt.serviceName || 'Full Grooming'}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-sm text-admin-primary">payments</span>
                                    <span class="text-xs font-bold text-slate-500 uppercase">Price</span>
                                </div>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">$${(apt.total_price || apt.base_price || 0).toFixed(2)}</p>
                            </div>
                        </div>
                        
                        <!-- Groomer -->
                        <div class="p-4 bg-admin-accent/5 border border-admin-accent/20 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-admin-accent/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-admin-accent">badge</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-slate-500 uppercase">Assigned Groomer</p>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">${apt.groomerName || 'Not Assigned'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Address -->
                        ${apt.address ? `
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="material-symbols-outlined text-sm text-admin-primary">location_on</span>
                                <span class="text-xs font-bold text-slate-500 uppercase">Address</span>
                            </div>
                            <p class="text-sm text-slate-700 dark:text-slate-300">${apt.address}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Notes -->
                        ${apt.notes ? `
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="material-symbols-outlined text-sm text-amber-600">note</span>
                                <span class="text-xs font-bold text-amber-700 uppercase">Notes</span>
                            </div>
                            <p class="text-sm text-amber-800 dark:text-amber-200">${apt.notes}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Grooming Photos (Before/After) -->
                        ${(apt.before_photo_url || apt.after_photo_url) ? `
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-admin-primary">photo_camera</span>
                                <span class="text-xs font-bold text-slate-500 uppercase">Grooming Photos</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                ${apt.before_photo_url ? `
                                <div class="relative">
                                    <img src="${apt.before_photo_url}" class="w-full aspect-[4/3] object-cover rounded-xl border border-slate-200 dark:border-slate-700" alt="Before"/>
                                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs font-bold rounded">Before</span>
                                </div>
                                ` : `
                                <div class="w-full aspect-[4/3] bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center border border-slate-200 dark:border-slate-700">
                                    <span class="text-xs text-slate-400">No before photo</span>
                                </div>
                                `}
                                ${apt.after_photo_url ? `
                                <div class="relative">
                                    <img src="${apt.after_photo_url}" class="w-full aspect-[4/3] object-cover rounded-xl border border-slate-200 dark:border-slate-700" alt="After"/>
                                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-emerald-500/80 text-white text-xs font-bold rounded">After</span>
                                </div>
                                ` : `
                                <div class="w-full aspect-[4/3] bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center border border-slate-200 dark:border-slate-700">
                                    <span class="text-xs text-slate-400">No after photo</span>
                                </div>
                                `}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div class="px-6 py-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between">
                        <button onclick="closeQuickViewAppointment()" class="px-4 py-2 text-sm font-bold text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors">
                            Close
                        </button>
                        <div class="flex items-center gap-2">
                            <select onchange="updateAppointmentStatus('${apt.id}', this.value); closeQuickViewAppointment();" class="px-3 py-2 text-sm font-bold rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-300 cursor-pointer">
                                <option value="" disabled selected>Change Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button onclick="closeQuickViewAppointment(); setTab('appointments');" class="px-4 py-2 bg-admin-accent hover:bg-teal-600 text-white font-bold text-sm rounded-lg transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">open_in_new</span>Full View
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        // =============================================
        // ADMIN DASHBOARD WEEK/MONTH VIEW HELPERS
        // =============================================
        
        function getAdminDashboardWeekLabel() {
            const start = state.adminDashboardWeekStart ? new Date(state.adminDashboardWeekStart + 'T12:00:00') : new Date();
            const startOfWeek = new Date(start);
            startOfWeek.setDate(start.getDate() - start.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const startMonth = startOfWeek.toLocaleDateString('en-US', { month: 'short' });
            const endMonth = endOfWeek.toLocaleDateString('en-US', { month: 'short' });
            const startDay = startOfWeek.getDate();
            const endDay = endOfWeek.getDate();
            
            if (startMonth === endMonth) {
                return `${startMonth} ${startDay} - ${endDay}, ${startOfWeek.getFullYear()}`;
            }
            return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${endOfWeek.getFullYear()}`;
        }
        
        function getAdminDashboardWeekDays() {
            const start = state.adminDashboardWeekStart ? new Date(state.adminDashboardWeekStart + 'T12:00:00') : new Date();
            const startOfWeek = new Date(start);
            startOfWeek.setDate(start.getDate() - start.getDay());
            const today = getTodayPacific();
            const days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const count = data.appointments.filter(a => a.appointment_date === dateStr && a.status !== 'cancelled').length;
                days.push({
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' }),
                    dayNum: date.getDate(),
                    dateStr: dateStr,
                    isToday: dateStr === today,
                    count: count
                });
            }
            return days;
        }
        
        function getAdminDashboardWeekAppointments() {
            const start = state.adminDashboardWeekStart ? new Date(state.adminDashboardWeekStart + 'T12:00:00') : new Date();
            const startOfWeek = new Date(start);
            startOfWeek.setDate(start.getDate() - start.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const startStr = startOfWeek.toISOString().split('T')[0];
            const endStr = endOfWeek.toISOString().split('T')[0];
            
            return data.appointments
                .filter(a => a.appointment_date >= startStr && a.appointment_date <= endStr && a.status !== 'cancelled')
                .sort((a, b) => {
                    if (a.appointment_date !== b.appointment_date) {
                        return a.appointment_date.localeCompare(b.appointment_date);
                    }
                    return (a.start_time || '').localeCompare(b.start_time || '');
                });
        }
        
        function adminDashboardPrevWeek() {
            const current = state.adminDashboardWeekStart ? new Date(state.adminDashboardWeekStart + 'T12:00:00') : new Date();
            current.setDate(current.getDate() - 7);
            state.adminDashboardWeekStart = current.toISOString().split('T')[0];
            render();
        }
        
        function adminDashboardNextWeek() {
            const current = state.adminDashboardWeekStart ? new Date(state.adminDashboardWeekStart + 'T12:00:00') : new Date();
            current.setDate(current.getDate() + 7);
            state.adminDashboardWeekStart = current.toISOString().split('T')[0];
            render();
        }
        
        function getAdminDashboardMonthLabel() {
            const date = state.adminDashboardMonth ? new Date(state.adminDashboardMonth + '-01T12:00:00') : new Date();
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        
        function getAdminDashboardMonthDays() {
            const now = new Date();
            const baseDate = state.adminDashboardMonth ? new Date(state.adminDashboardMonth + '-01T12:00:00') : now;
            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            const today = getTodayPacific();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const days = [];
            
            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                days.push({ empty: true });
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const count = data.appointments.filter(a => a.appointment_date === dateStr && a.status !== 'cancelled').length;
                days.push({
                    day: day,
                    dateStr: dateStr,
                    isToday: dateStr === today,
                    count: count
                });
            }
            
            return days;
        }
        
        function adminDashboardPrevMonth() {
            const scrollContainer = document.querySelector('.overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const current = state.adminDashboardMonth ? new Date(state.adminDashboardMonth + '-01T12:00:00') : new Date();
            current.setMonth(current.getMonth() - 1);
            state.adminDashboardMonth = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
            render();
            
            requestAnimationFrame(() => {
                const newScrollContainer = document.querySelector('.overflow-y-auto');
                if (newScrollContainer) newScrollContainer.scrollTop = scrollTop;
            });
        }
        
        function adminDashboardNextMonth() {
            const scrollContainer = document.querySelector('.overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const current = state.adminDashboardMonth ? new Date(state.adminDashboardMonth + '-01T12:00:00') : new Date();
            current.setMonth(current.getMonth() + 1);
            state.adminDashboardMonth = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
            render();
            
            requestAnimationFrame(() => {
                const newScrollContainer = document.querySelector('.overflow-y-auto');
                if (newScrollContainer) newScrollContainer.scrollTop = scrollTop;
            });
        }

        function resetDashboardMonth() {
            const scrollContainer = document.querySelector('.overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            state.adminDashboardMonth = null;
            render();
            
            requestAnimationFrame(() => {
                const newScrollContainer = document.querySelector('.overflow-y-auto');
                if (newScrollContainer) newScrollContainer.scrollTop = scrollTop;
            });
        }

        function renderCustomerDashboard() {
            const user = state.currentUser;
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'home' },
                { id: 'pets', label: 'My Pets', icon: 'pets' },
                { id: 'appointments', label: 'Appointments', icon: 'calendar_month' },
                { id: 'rewards', label: 'Rewards', icon: 'loyalty' },
                { id: 'store', label: 'Store', icon: 'storefront' },
                { id: 'ridealongs', label: 'Ride-Alongs', icon: 'directions_car' },
                { id: 'education', label: 'Academy', icon: 'school' }
            ];
            const isFullWidth = ['store', 'ridealongs', 'education'].includes(state.currentTab);

            // PWA Install Banner (only shown when install is available)
            const installBanner = state.showInstallPrompt && !state.isPWA ? `
            <div class="fixed bottom-20 lg:bottom-4 left-4 right-4 lg:left-auto lg:right-4 lg:w-80 z-50 bg-gradient-to-r from-primary to-sky-600 text-white p-4 rounded-2xl shadow-2xl shadow-primary/30 flex items-center gap-3 safe-bottom">
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
                    <span class="material-symbols-outlined text-2xl">install_mobile</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm">Install Dogfathers Plus</p>
                    <p class="text-xs text-white/80">Add to home screen for the best experience</p>
                </div>
                <button onclick="installPWA()" class="px-3 py-2 bg-white text-primary font-bold text-xs rounded-lg hover:bg-white/90 transition-colors flex-shrink-0">Install</button>
                <button onclick="state.showInstallPrompt = false; render();" class="p-1 hover:bg-white/20 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-lg">close</span>
                </button>
            </div>` : '';

            return `
            ${installBanner}
            <header class="lg:hidden fixed top-0 left-0 right-0 z-50 bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark px-4 py-3 flex items-center justify-between safe-top">
                <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-lg overflow-hidden"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div><span class="font-bold text-lg dark:text-white">Dogfathersplus</span></div>
                <div class="flex items-center gap-1">
                    <button onclick="toggleNotifications()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg touch-target relative" title="Notifications">
                        <span class="material-symbols-outlined">notifications</span>
                        ${state.unreadNotifications > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${state.unreadNotifications > 9 ? '9+' : state.unreadNotifications}</span>` : ''}
                    </button>
                    <button onclick="refreshData()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg touch-target" title="Refresh"><span class="material-symbols-outlined">refresh</span></button>
                    <button onclick="toggleDarkMode()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg touch-target"><span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span></button>
                    <button onclick="toggleMobileMenu()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg touch-target"><span class="material-symbols-outlined">${state.showMobileMenu ? 'close' : 'menu'}</span></button>
                </div>
            </header>
            ${state.showMobileMenu ? `
            <div class="lg:hidden fixed inset-0 z-40 bg-black/50" onclick="toggleMobileMenu()">
                <div class="absolute left-0 top-0 bottom-0 w-72 bg-surface-light dark:bg-surface-dark shadow-xl" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl overflow-hidden"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div>
                        <div><p class="font-bold dark:text-white">${user.name}</p><p class="text-sm text-text-sub-light dark:text-text-sub-dark">${user.loyaltyPoints} pts</p></div>
                    </div>
                    <nav class="p-4">${navItems.map(i => `<button onclick="setTab('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 touch-target ${state.currentTab === i.id ? 'bg-primary text-white' : 'hover:bg-background-light dark:hover:bg-background-dark dark:text-white'}"><span class="material-symbols-outlined">${i.icon}</span>${i.label}</button>`).join('')}</nav>
                    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-border-light dark:border-border-dark safe-bottom">
                        <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark dark:text-white mb-1 touch-target"><span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>${state.darkMode ? 'Light Mode' : 'Dark Mode'}</button>
                        <button onclick="openChangePassword()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark dark:text-white mb-1 touch-target"><span class="material-symbols-outlined">password</span>Change Password</button>
                        <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 touch-target"><span class="material-symbols-outlined">logout</span>Sign Out</button>
                    </div>
                </div>
            </div>` : ''}
            <div class="flex min-h-screen">
                <aside class="hidden lg:flex lg:flex-col w-72 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark fixed left-0 top-0 bottom-0 z-40">
                    <div class="p-6 border-b border-border-light dark:border-border-dark">
                        <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-xl overflow-hidden shadow-md"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div><span class="font-bold text-xl dark:text-white">Dogfathersplus</span></div>
                        <div class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl cursor-pointer hover:bg-border-light dark:hover:bg-border-dark transition-colors" onclick="openEditModal('profile', state.currentUser)">
                            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">${user.name?.charAt(0) || 'U'}</div>
                            <div class="flex-1"><p class="font-semibold dark:text-white">${user.name}</p><p class="text-sm text-text-sub-light dark:text-text-sub-dark">${user.loyaltyPoints} pts</p></div>
                            <span class="material-symbols-outlined text-text-sub-light text-sm">edit</span>
                        </div>
                    </div>
                    <nav class="flex-1 p-4 overflow-y-auto">${navItems.map(i => `<button onclick="setTab('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 touch-target ${state.currentTab === i.id ? 'bg-primary text-white' : 'hover:bg-background-light dark:hover:bg-background-dark dark:text-white'}"><span class="material-symbols-outlined">${i.icon}</span>${i.label}</button>`).join('')}</nav>
                    <div class="p-4 border-t border-border-light dark:border-border-dark">
                        <button onclick="refreshData()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark dark:text-white mb-1 touch-target"><span class="material-symbols-outlined">refresh</span>Refresh Data</button>
                        <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark dark:text-white mb-1 touch-target"><span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>${state.darkMode ? 'Light Mode' : 'Dark Mode'}</button>
                        <button onclick="openChangePassword()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark dark:text-white mb-1 touch-target"><span class="material-symbols-outlined">password</span>Change Password</button>
                        <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 touch-target"><span class="material-symbols-outlined">logout</span>Sign Out</button>
                    </div>
                </aside>
                <main class="flex-1 lg:ml-72 pt-16 lg:pt-0 pb-8 bg-background-light dark:bg-background-dark min-h-screen safe-bottom"><div class="${isFullWidth ? '' : 'p-6 lg:p-8 max-w-6xl mx-auto'}">${renderCustomerContent()}</div></main>
            </div>
            ${state.showBookingModal ? renderBookingModal() : ''}
            ${state.editModal ? renderEditModal() : ''}
            ${state.confirmDialog ? renderConfirmDialog() : ''}
            ${state.petDeletionBlocked ? renderPetDeletionBlockedModal() : ''}
            ${state.cancelAppointmentModal ? renderCancelAppointmentModal() : ''}
            ${state.showNotifications ? renderNotificationsPanel() : ''}`;
        }

        function renderCustomerContent() {
            const user = state.currentUser;
            const pets = state.pets || [];
            const appointments = state.appointments || [];
            
            // Categorize appointments
            const upcomingAppointments = appointments.filter(a => a.status === 'pending' || a.status === 'confirmed');
            const inProgressAppointments = appointments.filter(a => a.status === 'in_progress');
            const completedAppointments = appointments.filter(a => a.status === 'completed');
            const nextAppt = upcomingAppointments[0];
            const activeAppt = inProgressAppointments[0];
            
            // Time-based greeting
            const hour = new Date().getHours();
            const timeGreeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            const greetingEmoji = hour < 12 ? 'â˜€ï¸' : hour < 17 ? 'ðŸŒ¤ï¸' : 'ðŸŒ™';
            
            // Calculate countdown for next appointment
            let countdownText = '';
            let countdownDays = 0;
            if (nextAppt && nextAppt.appointment_date) {
                const apptDate = new Date(nextAppt.appointment_date + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = apptDate - today;
                countdownDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (countdownDays === 0) countdownText = 'Today!';
                else if (countdownDays === 1) countdownText = 'Tomorrow';
                else if (countdownDays > 0) countdownText = `In ${countdownDays} days`;
                else countdownText = '';
            }
            
            // Calculate "last groomed" for each pet
            const getPetLastGroom = (petId) => {
                const petGrooms = completedAppointments.filter(a => a.pet_id === petId);
                if (petGrooms.length === 0) return null;
                // Sort by date descending
                petGrooms.sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
                const lastGroom = petGrooms[0];
                const lastDate = new Date(lastGroom.appointment_date || lastGroom.completed_at);
                const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                return { date: lastDate, daysSince, weeksSince: Math.floor(daysSince / 7) };
            };
            
            // Business phone number (you can make this configurable)
            const businessPhone = '(323) 304-7618';
            const businessPhoneClean = businessPhone.replace(/\D/g, '');

            if (state.currentTab === 'dashboard') {
                return `
                <!-- #1 HERO SECTION - Prominent Book Now + Phone + Countdown -->
                <div class="relative overflow-hidden rounded-3xl mb-6 bg-gradient-to-br from-primary via-sky-500 to-cyan-400 p-6 lg:p-8 text-white shadow-xl shadow-primary/20">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <defs>
                                <pattern id="paw-customer" x="0" y="0" width="25" height="25" patternUnits="userSpaceOnUse">
                                    <circle cx="6" cy="6" r="2.5" fill="currentColor"/>
                                    <circle cx="12" cy="4" r="2" fill="currentColor"/>
                                    <circle cx="17" cy="7" r="2" fill="currentColor"/>
                                    <circle cx="10" cy="12" r="2" fill="currentColor"/>
                                </pattern>
                            </defs>
                            <rect width="100" height="100" fill="url(#paw-customer)"/>
                        </svg>
                    </div>
                    
                    <div class="relative z-10">
                        <!-- Top Row: Greeting & Phone -->
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${greetingEmoji}</span>
                                <h1 class="text-2xl sm:text-3xl font-extrabold">${timeGreeting}, ${user.name?.split(' ')[0] || 'there'}!</h1>
                            </div>
                            <a href="tel:${businessPhoneClean}" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full transition-colors text-sm font-bold">
                                <span class="material-symbols-outlined text-lg">call</span>
                                ${businessPhone}
                            </a>
                        </div>
                        
                        <!-- Appointment Status -->
                        ${activeAppt ? `
                            <!-- PET IN PROGRESS -->
                            <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 mb-4">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 rounded-xl bg-white/30 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-2xl animate-pulse">content_cut</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-lg">${activeAppt.petName || 'Your pet'} is being groomed! ðŸ•</p>
                                        <p class="text-white/80 text-sm">${activeAppt.serviceName || 'Grooming'}</p>
                                    </div>
                                </div>
                                ${activeAppt.started_at ? `
                                    <div class="mb-2">
                                        <div class="flex justify-between text-xs mb-1">
                                            <span>In Progress</span>
                                            <span>${Math.floor((new Date() - new Date(activeAppt.started_at)) / 60000)} min elapsed</span>
                                        </div>
                                        <div class="h-2 bg-white/30 rounded-full overflow-hidden">
                                            <div class="h-full bg-white rounded-full animate-pulse" style="width: ${Math.min(Math.round(((new Date() - new Date(activeAppt.started_at)) / 60000) / (activeAppt.duration_minutes || 60) * 100), 95)}%"></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : nextAppt ? `
                            <!-- NEXT APPOINTMENT COUNTDOWN -->
                            <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 mb-4">
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-white/30 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-2xl">event</span>
                                        </div>
                                        <div>
                                            <p class="text-white/80 text-sm">Next appointment ${countdownText ? `â€¢ ${countdownText}` : ''}</p>
                                            <p class="font-bold text-lg">${nextAppt.petName || 'Pet'} â€¢ ${nextAppt.serviceName || 'Grooming'}</p>
                                            <p class="text-white/80 text-sm">${formatDate(nextAppt.appointment_date)} at ${formatTime(nextAppt.start_time)}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="confirmCancelAppointment('${nextAppt.id}')" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-bold transition-colors">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <!-- NO APPOINTMENTS -->
                            <p class="text-white/80 mb-4">You don't have any upcoming appointments. Book one today!</p>
                        `}
                        
                        <!-- Primary CTA Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="openBookingModal()" class="flex-1 bg-white text-primary font-bold px-6 py-4 rounded-xl hover:bg-white/90 flex items-center justify-center gap-2 shadow-lg shadow-black/10 transition-all hover:scale-[1.02]">
                                <span class="material-symbols-outlined text-2xl">calendar_add_on</span>
                                <span class="text-lg">Book Appointment</span>
                            </button>
                            ${nextAppt ? `
                                <button onclick="setTab('appointments')" class="px-6 py-4 bg-white/20 hover:bg-white/30 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                                    <span class="material-symbols-outlined">visibility</span>
                                    View Details
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- #6 CONDENSED STAT CARDS (4 cards including loyalty) -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-primary">pets</span>
                        </div>
                        <div>
                            <p class="text-2xl font-bold dark:text-white">${pets.length}</p>
                            <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Pets</p>
                        </div>
                    </div>
                    <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-green-600 dark:text-green-400">check_circle</span>
                        </div>
                        <div>
                            <p class="text-2xl font-bold dark:text-white">${completedAppointments.length}</p>
                            <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Grooms</p>
                        </div>
                    </div>
                    <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-amber-600 dark:text-amber-400">calendar_month</span>
                        </div>
                        <div>
                            <p class="text-2xl font-bold dark:text-white">${upcomingAppointments.length}</p>
                            <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Upcoming</p>
                        </div>
                    </div>
                    <button onclick="setTab('rewards')" class="bg-gradient-to-br from-primary to-sky-600 text-white rounded-xl p-4 flex items-center gap-3 hover:shadow-lg transition-all text-left">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined">loyalty</span>
                        </div>
                        <div>
                            <p class="text-2xl font-bold">${user.loyaltyPoints || 0}</p>
                            <p class="text-xs text-white/80">Points</p>
                        </div>
                    </button>
                </div>

                <!-- #7 MY PETS with "Last Groomed" Reminders -->
                <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2 dark:text-white">
                            <span class="material-symbols-outlined text-primary">pets</span>My Pets
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="openEditModal('pet', {})" class="text-primary text-sm font-medium hover:underline flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">add</span>Add Pet
                            </button>
                        </div>
                    </div>
                    
                    ${pets.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${pets.map(pet => {
                                const lastGroom = getPetLastGroom(pet.id);
                                const needsGroom = lastGroom && lastGroom.weeksSince >= 6;
                                const hasUpcoming = upcomingAppointments.some(a => a.pet_id === pet.id);
                                
                                return `
                                <div class="bg-background-light dark:bg-background-dark rounded-xl p-4 ${needsGroom && !hasUpcoming ? 'ring-2 ring-amber-400 ring-offset-2 dark:ring-offset-slate-900' : ''}">
                                    <div class="flex items-start gap-4">
                                        <div class="w-16 h-16 rounded-2xl bg-cover bg-center border-2 border-primary/20 shadow-md flex-shrink-0" style="background-image: url('${pet.photo_url || 'https://via.placeholder.com/150'}')"></div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between">
                                                <div>
                                                    <p class="font-bold text-lg dark:text-white">${pet.name}</p>
                                                    <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${pet.breed || 'Unknown breed'} â€¢ ${pet.weight || '?'} lbs</p>
                                                </div>
                                            </div>
                                            
                                            <!-- Last Groomed Status -->
                                            <div class="mt-2">
                                                ${hasUpcoming ? `
                                                    <span class="inline-flex items-center gap-1 text-xs font-medium text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full">
                                                        <span class="material-symbols-outlined text-xs">event</span>
                                                        Appointment scheduled
                                                    </span>
                                                ` : lastGroom ? `
                                                    <span class="inline-flex items-center gap-1 text-xs font-medium ${needsGroom ? 'text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30' : 'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800'} px-2 py-1 rounded-full">
                                                        <span class="material-symbols-outlined text-xs">${needsGroom ? 'warning' : 'schedule'}</span>
                                                        ${needsGroom ? `Due for grooming (${lastGroom.weeksSince} weeks)` : `Groomed ${lastGroom.weeksSince} weeks ago`}
                                                    </span>
                                                ` : `
                                                    <span class="inline-flex items-center gap-1 text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full">
                                                        <span class="material-symbols-outlined text-xs">info</span>
                                                        No groom history
                                                    </span>
                                                `}
                                            </div>
                                            
                                            <!-- Quick Book Button for this pet -->
                                            ${!hasUpcoming ? `
                                                <button onclick="openBookingModalForPet('${pet.id}')" class="mt-3 w-full py-2 bg-primary/10 hover:bg-primary/20 text-primary text-sm font-bold rounded-lg flex items-center justify-center gap-1 transition-colors">
                                                    <span class="material-symbols-outlined text-sm">calendar_add_on</span>
                                                    Book ${pet.name}'s Groom
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-primary/10 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-3xl text-primary">pets</span>
                            </div>
                            <p class="text-text-sub-light dark:text-text-sub-dark mb-4">No pets added yet</p>
                            <button onclick="openEditModal('pet', {})" class="bg-primary text-white font-bold px-4 py-2 rounded-lg flex items-center gap-2 mx-auto">
                                <span class="material-symbols-outlined">add</span>Add Your First Pet
                            </button>
                        </div>
                    `}
                </div>
                
                <!-- Quick Links Section -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button onclick="setTab('ridealongs')" class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 hover:shadow-lg transition-all text-left group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">directions_car</span>
                            </div>
                            <div>
                                <p class="font-bold dark:text-white group-hover:text-primary transition-colors">Ride-Alongs</p>
                                <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Learn grooming skills</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="setTab('education')" class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 hover:shadow-lg transition-all text-left group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-cyan-100 dark:bg-cyan-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-cyan-600 dark:text-cyan-400">school</span>
                            </div>
                            <div>
                                <p class="font-bold dark:text-white group-hover:text-primary transition-colors">Academy</p>
                                <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Online courses</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="setTab('store')" class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-4 hover:shadow-lg transition-all text-left group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-rose-100 dark:bg-rose-900/30 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-rose-600 dark:text-rose-400">storefront</span>
                            </div>
                            <div>
                                <p class="font-bold dark:text-white group-hover:text-primary transition-colors">Store</p>
                                <p class="text-xs text-text-sub-light dark:text-text-sub-dark">Recommended products</p>
                            </div>
                        </div>
                    </button>
                </div>
                `;
            }

            if (state.currentTab === 'pets') {
                // Store pets for editing
                pets.forEach((pet, i) => { state.editItems['pet_' + i] = {...pet}; });
                return `<div class="flex justify-between items-start mb-8"><div><h1 class="text-3xl font-bold mb-2 dark:text-white">My Pets</h1><p class="text-text-sub-light dark:text-text-sub-dark">Manage your furry family</p></div><button onclick="openEditModal('pet', {})" class="bg-primary text-white font-bold px-4 py-2 rounded-lg flex items-center gap-2"><span class="material-symbols-outlined">add</span>Add Pet</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${pets.length > 0 ? pets.map((pet, i) => `<div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-6"><div class="flex gap-4"><div class="relative group">
                    <div class="w-32 h-32 rounded-2xl bg-cover bg-center border-2 border-primary/20 shadow-lg" style="background-image: url('${pet.photo_url || 'https://via.placeholder.com/150'}')"></div>
                </div><div class="flex-1"><div class="flex justify-between"><div><h3 class="text-xl font-bold dark:text-white">${pet.name}</h3><p class="text-text-sub-light dark:text-text-sub-dark">${pet.breed || 'Unknown breed'}</p></div><button onclick="openEditModal('pet', ${i})" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg text-text-sub-light hover:text-primary"><span class="material-symbols-outlined">edit</span></button></div><span class="inline-block mt-2 px-3 py-1 bg-background-light dark:bg-background-dark rounded-full text-sm dark:text-white">${pet.weight || '?'} lbs</span></div></div>${pet.grooming_notes ? `<div class="mt-4 p-3 bg-background-light dark:bg-background-dark rounded-lg text-sm text-text-sub-light dark:text-text-sub-dark"><strong>Notes:</strong> ${pet.grooming_notes}</div>` : ''}</div>`).join('') : '<div class="col-span-2 text-center py-12 bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark"><span class="material-symbols-outlined text-6xl text-text-sub-light mb-4">pets</span><p class="text-text-sub-light dark:text-text-sub-dark">No pets added yet</p><button onclick="openEditModal(\'pet\', {})" class="mt-4 bg-primary text-white font-bold px-4 py-2 rounded-lg">Add Your First Pet</button></div>'}</div>`;
            }

            if (state.currentTab === 'appointments') {
                // Separate appointments by status
                const upcomingAppts = appointments.filter(a => a.status === 'pending' || a.status === 'confirmed');
                const pastAppts = appointments.filter(a => a.status === 'completed' || a.status === 'cancelled' || a.status === 'no_show');
                
                return `<div class="flex justify-between items-start mb-8"><div><h1 class="text-3xl font-bold mb-2 dark:text-white">Appointments</h1><p class="text-text-sub-light dark:text-text-sub-dark">View and manage sessions</p></div><button onclick="openBookingModal()" class="bg-primary text-white font-bold px-4 py-2 rounded-lg flex items-center gap-2"><span class="material-symbols-outlined">add</span>Book New</button></div>
                
                ${upcomingAppts.length > 0 ? `<h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><span class="material-symbols-outlined text-primary">upcoming</span>Upcoming (${upcomingAppts.length})</h3>` : ''}
                <div class="space-y-4 mb-8">${upcomingAppts.length > 0 ? upcomingAppts.map(apt => `
                    <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-5">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined text-primary">pets</span></div>
                                <div>
                                    <p class="font-bold dark:text-white">${apt.petName || 'Pet'}</p>
                                    <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${apt.serviceName || apt.service || 'Grooming'}${apt.total_price ? ' â€¢ $' + apt.total_price : ''}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-sm text-text-sub-light dark:text-text-sub-dark text-right">
                                    <div class="flex items-center gap-1 mb-1"><span class="material-symbols-outlined text-base">calendar_month</span>${formatDate(apt.appointment_date || apt.date)}</div>
                                    <div class="flex items-center gap-1"><span class="material-symbols-outlined text-base">schedule</span>${formatTime(apt.start_time || apt.time)}</div>
                                </div>
                                <span class="px-3 py-1 text-xs font-bold rounded-full uppercase ${apt.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${apt.status}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4 pt-4 border-t border-border-light dark:border-border-dark">
                            <button onclick="confirmCancelAppointment('${apt.id}')" class="flex-1 px-4 py-2 text-sm font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg flex items-center justify-center gap-1 transition-colors">
                                <span class="material-symbols-outlined text-base">cancel</span>Cancel Appointment
                            </button>
                        </div>
                    </div>`).join('') : '<div class="text-center py-12 bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark"><span class="material-symbols-outlined text-6xl text-text-sub-light mb-4">calendar_month</span><p class="text-text-sub-light dark:text-text-sub-dark">No upcoming appointments</p><button onclick="openBookingModal()" class="mt-4 bg-primary text-white font-bold px-4 py-2 rounded-lg">Book Your First Appointment</button></div>'}</div>
                
                ${pastAppts.length > 0 ? `
                <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><span class="material-symbols-outlined text-slate-400">history</span>Past Appointments (${pastAppts.length})</h3>
                <div class="space-y-4">${pastAppts.map(apt => `
                    <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-5 opacity-90 hover:opacity-100 transition-opacity">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined text-slate-400">pets</span></div>
                                <div>
                                    <p class="font-bold dark:text-white">${apt.petName || 'Pet'}</p>
                                    <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${apt.serviceName || apt.service || 'Grooming'}${apt.total_price ? ' â€¢ $' + apt.total_price : ''}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-sm text-text-sub-light dark:text-text-sub-dark text-right">
                                    <div class="flex items-center gap-1 mb-1"><span class="material-symbols-outlined text-base">calendar_month</span>${formatDate(apt.appointment_date || apt.date)}</div>
                                </div>
                                <span class="px-3 py-1 text-xs font-bold rounded-full uppercase ${apt.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : apt.status === 'cancelled' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'}">${apt.status}</span>
                            </div>
                        </div>
                        ${(apt.before_photo_url || apt.after_photo_url) ? `
                        <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark">
                            <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-3 flex items-center gap-1"><span class="material-symbols-outlined text-sm">photo_camera</span>Grooming Photos</p>
                            <div class="grid grid-cols-2 gap-3">
                                ${apt.before_photo_url ? `
                                <div class="relative">
                                    <img src="${apt.before_photo_url}" class="w-full aspect-[4/3] object-cover rounded-xl" alt="Before grooming"/>
                                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs font-bold rounded">Before</span>
                                </div>
                                ` : ''}
                                ${apt.after_photo_url ? `
                                <div class="relative">
                                    <img src="${apt.after_photo_url}" class="w-full aspect-[4/3] object-cover rounded-xl" alt="After grooming"/>
                                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-emerald-500 text-white text-xs font-bold rounded">After âœ¨</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        ${apt.groomer_notes ? `<div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark"><p class="text-sm text-text-sub-light dark:text-text-sub-dark"><span class="font-semibold">Groomer Notes:</span> ${apt.groomer_notes}</p></div>` : ''}
                        
                        <!-- Quick Rebook Button (Recommendation #8) -->
                        ${apt.status === 'completed' ? `
                        <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark">
                            <button onclick="rebookAppointment('${apt.id}')" class="w-full py-2.5 bg-primary/10 hover:bg-primary/20 text-primary font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                                <span class="material-symbols-outlined text-lg">replay</span>
                                Book Again
                            </button>
                        </div>
                        ` : ''}
                    </div>`).join('')}</div>` : ''}`;
            }

            if (state.currentTab === 'rewards') {
                const rewards = getRewards();
                const loyaltyPoints = user.loyaltyPoints || 0;
                return `<div class="mb-8"><h1 class="text-3xl font-bold mb-2 dark:text-white">Loyalty Rewards</h1><p class="text-text-sub-light dark:text-text-sub-dark">Earn points with every groom</p></div>
                <div class="bg-gradient-to-br from-primary to-primary/80 rounded-xl p-6 text-white mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div><p class="text-sm opacity-80 uppercase mb-1">Your Points</p><p class="text-5xl font-bold">${loyaltyPoints}</p></div><div class="text-sm opacity-90"><p>50 points per groom</p><p>500 pts = Free Bath</p></div></div>
                <h3 class="text-xl font-bold mb-4 dark:text-white">Available Rewards</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${rewards.map(r => {
                    const pts = r.points_required || r.points || 0;
                    const canRedeem = loyaltyPoints >= pts;
                    return `<div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl p-5"><div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center mb-4"><span class="material-symbols-outlined text-primary">redeem</span></div><h4 class="font-bold mb-1 dark:text-white">${r.name}</h4><p class="text-sm text-text-sub-light dark:text-text-sub-dark mb-4">${r.description || ''}</p><div class="flex justify-between items-center"><span class="font-bold text-primary">${pts} pts</span><button onclick="redeemReward('${r.id}', '${(r.name || '').replace(/'/g, "\\'")}', ${pts})" class="px-3 py-1.5 text-sm font-bold rounded-lg ${canRedeem ? 'bg-primary text-white hover:bg-sky-600' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${!canRedeem ? 'disabled' : ''}>Redeem</button></div></div>`;
                }).join('')}</div>`;
            }

            if (state.currentTab === 'store') {
                const categories = ['all', 'grooming', 'treats', 'toys', 'health'];
                const filteredProducts = state.storeCategory === 'all' ? data.products : data.products.filter(p => p.category === state.storeCategory);
                return `
                <div class="p-4 md:p-8 max-w-[1200px] mx-auto">
                    <div class="flex min-h-[280px] flex-col gap-4 bg-cover bg-center bg-no-repeat rounded-2xl items-start justify-end px-6 pb-8 shadow-md relative overflow-hidden mb-6" style="background-image: linear-gradient(rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 100%), url('https://lh3.googleusercontent.com/aida-public/AB6AXuA-l9fQMzQ46NScwNxTOmvji96VyFtz0DEvfpIZPoEI2n98qWiqORYpMz7mP_SVLo7HdvDLy8EJTaPankBpfjSozf9kya8F5CF_NPLPoOIRnWnInstxdoCboZDO_Jh-HX8KlgRqD-iK-4O4hhgEOQCOpjBMqmREQEtYekCqzViyHxE6z6Puj8og0W3QwDAaug3ho0OLzxE_vW35ZF38i4Fc9u2Yk5igndj6fupyo-gv5B9oOXhPOqrpa8qscpgF9auQBUCmE-vGwUYy');">
                        <div class="absolute top-4 left-4 z-10"><img src="${LOGO_ACADEMY}" alt="Dogfathersplus Academy" class="h-16 w-auto drop-shadow-lg"/></div>
                        <div class="flex flex-col gap-2 text-left z-10 max-w-2xl"><h1 class="text-white text-3xl font-black leading-tight">Curated Grooming Essentials</h1><p class="text-white/90 text-sm">Handpicked by the Dogfathers Team.</p></div>
                        <button class="flex items-center gap-2 rounded-lg h-11 px-5 bg-primary hover:bg-sky-400 text-white text-sm font-bold shadow-lg z-10 mt-2">Explore Deals <span class="material-symbols-outlined text-sm">arrow_forward</span></button>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between gap-4 py-3 sticky top-16 lg:top-0 z-30 bg-background-light/95 backdrop-blur-sm mb-6">
                        <div class="flex w-full md:w-80 items-center rounded-lg bg-white border border-border-light px-3 h-11 shadow-sm"><span class="material-symbols-outlined text-text-sub-light">search</span><input class="w-full bg-transparent border-none focus:ring-0 text-sm px-2 placeholder:text-text-sub-light" placeholder="Search products..."/></div>
                        <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide">${categories.map(cat => `<button onclick="setStoreCategory('${cat}')" class="flex h-10 shrink-0 items-center justify-center rounded-full px-5 text-sm font-medium transition-all ${state.storeCategory === cat ? 'bg-primary text-white' : 'bg-white border border-border-light'}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`).join('')}</div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-8">
                        ${filteredProducts.map(p => `<div class="flex flex-col rounded-xl bg-white border border-border-light overflow-hidden hover:shadow-lg transition-all group"><div class="relative w-full aspect-[4/3] bg-gray-100 overflow-hidden">${p.badge ? `<div class="absolute top-3 left-3 z-10"><span class="${p.badge === 'groomer' ? 'bg-amber-100 text-amber-800' : p.badge === 'sale' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} text-xs font-bold px-2 py-1 rounded">${p.badge === 'groomer' ? "Groomer's Choice" : p.badge === 'sale' ? 'Sale 20% Off' : 'New'}</span></div>` : ''}<div class="w-full h-full bg-cover bg-center group-hover:scale-105 transition-transform duration-500" style="background-image: url('${p.image}');"></div></div><div class="flex flex-col flex-1 p-4 gap-3"><div class="flex-1"><h3 class="font-bold group-hover:text-primary transition-colors">${p.name}</h3><p class="text-sm text-text-sub-light">${p.description}</p></div><div class="flex items-center justify-between pt-2 border-t border-border-light">${p.originalPrice ? `<div class="flex flex-col"><span class="text-xs line-through text-text-sub-light">$${p.originalPrice.toFixed(2)}</span><span class="text-lg font-bold text-red-600">$${p.price.toFixed(2)}</span></div>` : `<span class="text-lg font-bold">$${p.price.toFixed(2)}</span>`}<a href="${p.link}" class="flex items-center gap-1 bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold">Buy <span class="material-symbols-outlined text-base">open_in_new</span></a></div></div></div>`).join('')}
                    </div>
                    <footer class="text-center py-6 border-t border-border-light"><p class="text-xs text-text-sub-light"><strong>Affiliate Disclosure:</strong> We may earn a commission at no extra cost to you.</p></footer>
                </div>`;
            }

            if (state.currentTab === 'ridealongs') {
                return `
                <div class="min-h-screen">
                    <section class="px-4 md:px-10 py-10 max-w-[960px] mx-auto">
                        <div class="flex flex-col gap-6 lg:flex-row lg:gap-10 items-center">
                            <div class="w-full lg:w-1/2 aspect-video bg-cover bg-center rounded-xl shadow-lg relative overflow-hidden" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCEoD1IZ_9OcIUbyU-lBHFtgnYLJ7VIoAdkkgFir2Jl5HBHKwCgHsNIVed366p0Wj2YOfADguhRocugY0iYtljzef8zHCjbg_y4hYONRTQqiUkzIJtwzGZ4CViGl_qLCXzU6jQbedXer7II9ey9tZVmtc1GoWQUUc_qgQSXrVZwSV8PTa5gRP7MmAc3qek43ZGfQ5vjGUDEhNKBBPYePrVevGB74UjHhZHTH5HK73uOCZghNocaNAvpdSgZLQhFSvDDg44uCW43W5RE');">
                                <div class="absolute top-4 left-4"><img src="${LOGO_ACADEMY}" alt="Dogfathersplus Academy" class="h-14 w-auto drop-shadow-lg"/></div>
                            </div>
                            <div class="flex flex-col gap-6 lg:w-1/2">
                                <div><h1 class="text-4xl md:text-5xl font-black leading-tight">Ride-Along Experiences</h1><p class="text-text-sub-light mt-2">Learn hands-on from professional groomers. Shadow, practice, and master the art of mobile dog grooming.</p></div>
                                <button class="w-fit px-6 h-12 bg-primary hover:bg-sky-500 text-white font-bold rounded-lg flex items-center gap-2"><span class="material-symbols-outlined">school</span>Start Learning</button>
                            </div>
                        </div>
                    </section>
                    <section class="px-4 md:px-10 py-10 bg-white">
                        <div class="max-w-[960px] mx-auto">
                            <div class="text-center mb-8"><h2 class="text-3xl font-bold mb-2">Choose Your Learning Path</h2><p class="text-text-sub-light">From observer to expert - we have a package for every skill level.</p></div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                ${data.rideAlongs.map((pkg, i) => `
                                <div class="relative flex flex-col gap-5 rounded-xl ${pkg.popular ? 'border-2 border-primary bg-white shadow-xl md:-translate-y-2 z-10' : 'border border-border-light bg-background-light'} p-6 transition-all">
                                    ${pkg.popular ? '<div class="absolute top-0 right-0 left-0 -mt-3 flex justify-center"><span class="bg-primary text-white text-xs font-bold px-3 py-1 rounded-full uppercase">Most Popular</span></div>' : ''}
                                    <div class="${pkg.popular ? 'mt-2' : ''}">
                                        <h3 class="text-lg font-bold">${pkg.name}</h3>
                                        <p class="text-sm text-text-sub-light mt-1">${pkg.duration || ''}</p>
                                        <p class="flex items-baseline gap-1 mt-2"><span class="text-4xl font-black">$${pkg.price}</span></p>
                                    </div>
                                    <p class="text-sm text-text-sub-light">${pkg.description || ''}</p>
                                    <button onclick="inquireRideAlong('${pkg.id}', '${(pkg.name || '').replace(/'/g, "\\'")}', ${pkg.price})" class="w-full h-10 px-4 ${pkg.popular ? 'bg-primary text-white shadow-md' : 'bg-slate-200 text-text-main-light hover:bg-slate-300'} font-bold rounded-lg transition-colors">Book Now</button>
                                    <div class="flex flex-col gap-2 pt-4 border-t border-border-light">${(pkg.features || []).map(f => `<div class="flex gap-3 items-start text-sm"><span class="material-symbols-outlined text-primary text-lg mt-0.5">check_circle</span><span>${f}</span></div>`).join('')}</div>
                                </div>`).join('')}
                            </div>
                        </div>
                    </section>
                    <section class="px-4 md:px-10 py-12 max-w-[960px] mx-auto">
                        <div class="flex flex-col gap-8">
                            <div><h2 class="text-3xl font-bold">Why Learn With Us?</h2><p class="text-text-sub-light mt-2">Get real-world experience that courses can't teach.</p></div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                <div class="flex flex-col gap-4 rounded-xl border border-border-light bg-white p-6 shadow-sm"><div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary"><span class="material-symbols-outlined text-2xl">person</span></div><div><h3 class="text-lg font-bold">1-on-1 Mentorship</h3><p class="text-text-sub-light text-sm">Learn directly from experienced pros.</p></div></div>
                                <div class="flex flex-col gap-4 rounded-xl border border-border-light bg-white p-6 shadow-sm"><div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary"><span class="material-symbols-outlined text-2xl">pets</span></div><div><h3 class="text-lg font-bold">Real Dogs, Real Skills</h3><p class="text-text-sub-light text-sm">Practice on actual clients' pets.</p></div></div>
                                <div class="flex flex-col gap-4 rounded-xl border border-border-light bg-white p-6 shadow-sm"><div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary"><span class="material-symbols-outlined text-2xl">workspace_premium</span></div><div><h3 class="text-lg font-bold">Certificate Included</h3><p class="text-text-sub-light text-sm">Proof of your hands-on training.</p></div></div>
                            </div>
                        </div>
                    </section>
                    <footer class="border-t border-border-light py-8 text-center"><p class="text-text-sub-light/70 text-sm">Â© 2024 Dogfathersplus. All rights reserved.</p></footer>
                </div>`;
            }

            if (state.currentTab === 'education') {
                return `
                <div class="min-h-screen max-w-[1200px] mx-auto px-4 md:px-10 py-6 md:py-10 flex flex-col gap-12">
                    <section class="flex flex-col-reverse lg:flex-row gap-8 items-center">
                        <div class="flex flex-col gap-6 flex-1 text-center lg:text-left items-center lg:items-start">
                            <div class="space-y-4">
                                <img src="${LOGO_ACADEMY}" alt="Dogfathersplus Academy" class="h-20 w-auto mx-auto lg:mx-0"/>
                                <h1 class="text-4xl md:text-5xl font-black leading-tight">Master Dog Grooming <span class="text-primary">at Home</span></h1>
                                <p class="text-text-sub-light max-w-xl">Join our exclusive Skool community to learn professional techniques and safety tips.</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <a href="https://www.skool.com/dogfathersplus" target="_blank" class="flex items-center justify-center gap-2 h-12 px-8 rounded-lg bg-primary text-white font-bold shadow-lg">Join Skool Course <span class="material-symbols-outlined text-sm">arrow_outward</span></a>
                                <button class="h-12 px-6 rounded-lg border border-border-light bg-white font-bold">Watch Preview</button>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-text-sub-light"><span class="font-medium">Joined by 500+ pet owners</span></div>
                        </div>
                        <div class="w-full lg:w-1/2">
                            <div class="relative aspect-video max-h-[400px] w-full rounded-2xl overflow-hidden shadow-2xl">
                                <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuC7UBx2cL4iT0nvTzBW8ZGt9p0gUezChZOdjKFTuKT0D3VzISQ3sbnEVvOv1Qde40FTjCEAmwRCRzTTUNC1mTR_n-cFb9mCgO6PSOXw3YUEOlpIZ8ipr6jkLpBN575EWZUsxjn6l38psNI3-2Ryuo_qiuW2i-LrURKgO6lCtvlwmBKM7mIXz8UGOGxTgK7p_NlvAs0ja8Fe5gNc4R-sWN0sS1sRHyE46v8BO3Ep5W8Kec-i3PZIt1Bis3-ag6NjdP7e8vciSPGvzuXK');"></div>
                                <div class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur-md p-4 rounded-xl shadow-lg flex items-center gap-4"><div class="bg-primary/20 p-3 rounded-full text-primary"><span class="material-symbols-outlined">play_circle</span></div><div><p class="text-sm font-bold">Module 1: Getting Started</p><p class="text-xs text-text-sub-light">12 mins - Introduction to Tools</p></div></div>
                            </div>
                        </div>
                    </section>
                    <section class="flex flex-col gap-8">
                        <div class="border-b border-border-light pb-6"><h2 class="text-2xl md:text-3xl font-bold mb-2">What You'll Learn</h2><p class="text-text-sub-light">Comprehensive modules from basic hygiene to advanced styling.</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${[{icon:'content_cut',title:'Professional Techniques',desc:'Safe scissoring and clipping methods.'},{icon:'shower',title:'Bathing & Drying',desc:'Best practices for all coat types.'},{icon:'health_and_safety',title:'Health Checks',desc:'Spot early signs of issues.'},{icon:'construction',title:'Tools of the Trade',desc:'Complete equipment guide.'},{icon:'groups',title:'Community Access',desc:'Q&A with expert groomers.'},{icon:'verified',title:'Certification',desc:'Earn your Home Groomer certificate.'}].map(item => `<div class="group flex flex-col gap-4 p-6 rounded-xl border border-border-light bg-white hover:shadow-lg transition-all"><div class="size-12 rounded-lg bg-blue-50 text-primary flex items-center justify-center"><span class="material-symbols-outlined text-2xl">${item.icon}</span></div><div><h3 class="text-lg font-bold mb-2">${item.title}</h3><p class="text-text-sub-light text-sm">${item.desc}</p></div></div>`).join('')}
                        </div>
                    </section>
                    <section class="rounded-3xl bg-primary/10 border border-primary/20 p-8 md:p-16 text-center">
                        <div class="max-w-3xl mx-auto flex flex-col items-center gap-6">
                            <h2 class="text-3xl md:text-4xl font-black">Ready to become a home grooming pro?</h2>
                            <p class="text-text-sub-light">Get unlimited access to all materials and weekly live Q&A.</p>
                            <div class="flex flex-col items-center gap-2 my-4"><span class="text-4xl font-black text-primary">$49<span class="text-xl font-medium text-text-sub-light">/month</span></span><span class="text-sm font-medium px-3 py-1 bg-green-100 text-green-700 rounded-full">Free for Premium Members</span></div>
                            <a href="https://www.skool.com/dogfathersplus" target="_blank" class="min-w-[200px] h-14 px-8 rounded-lg bg-primary text-white text-lg font-bold shadow-xl flex items-center justify-center gap-2">Start Learning <span class="material-symbols-outlined">arrow_forward</span></a>
                            <p class="text-xs text-text-sub-light">30-day money-back guarantee.</p>
                        </div>
                    </section>
                    <footer class="border-t border-border-light py-8 text-center"><p class="text-sm text-text-sub-light">Â© 2024 Dogfathersplus</p></footer>
                </div>`;
            }
            return '';
        }

        function renderBookingModal() {
            const user = state.currentUser;
            const pets = state.pets || [];
            // Use actual DB services - only show ACTIVE services to customers
            const services = (state.services || []).filter(s => s.is_active !== false);
            const hasRealServices = services.length > 0;
            
            // Get preselect values (from pet card or rebook)
            const preselect = state.bookingPreselect || {};
            
            // Get today's date for min validation (prevent past bookings)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Pre-fill address from user profile
            const userAddress = user?.address || '';
            const userCity = user?.city || '';
            const userZip = user?.zip || '';
            const fullAddress = userAddress + (userCity ? ', ' + userCity : '');
            
            // Get smart booking data
            const smartData = state.smartBookingData;
            const selectedDate = state.selectedBookingDate;
            
            // Get first service description for initial display
            const firstService = services.length > 0 ? services.filter(s => !s.is_addon)[0] : null;
            const initialDescription = firstService?.description || 'Complete grooming service tailored to your pet\'s needs.';
            
            return `<div class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" onclick="closeBookingModal()">
                <div class="bg-surface-light dark:bg-surface-dark rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold dark:text-white">Book Appointment</h2>
                            <p class="text-sm text-text-sub-light dark:text-text-sub-dark">Schedule your pet's next grooming session</p>
                        </div>
                        <button onclick="closeBookingModal()" class="p-2 hover:bg-background-light dark:hover:bg-background-dark rounded-lg">
                            <span class="material-symbols-outlined dark:text-white">close</span>
                        </button>
                    </div>
                    <form id="booking-form" class="p-6 space-y-5">
                        ${!hasRealServices ? '<div class="p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg text-amber-800 dark:text-amber-200 text-sm mb-2"><span class="font-semibold">Note:</span> Services not loaded from database. Please contact admin to set up services.</div>' : ''}
                        
                        <!-- Pet & Service Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-sm font-semibold mb-2 block dark:text-white">Select Pet</span>
                                <select id="booking-pet" class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white">
                                    ${pets.length > 0 ? pets.map(p => `<option value="${p.id}" ${preselect.petId === p.id ? 'selected' : ''}>${p.name} (${p.breed || 'Unknown'})</option>`).join('') : '<option value="">No pets - please add a pet first</option>'}
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-sm font-semibold mb-2 block dark:text-white">Service</span>
                                <select id="booking-service-select" onchange="showServiceDescription(this)" class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white">
                                    ${hasRealServices ? services.filter(s => !s.is_addon).map(s => `<option value="${s.id}" data-name="${s.name}" data-price="${s.base_price}" data-duration="${s.duration_minutes || 60}" data-description="${(s.description || '').replace(/"/g, '&quot;')}" ${preselect.serviceId === s.id ? 'selected' : ''}>${s.name} - $${s.base_price}</option>`).join('') : '<option value="default" data-name="Full Groom" data-price="85" data-duration="90" data-description="Complete grooming including bath, brush, haircut, nail trim, and ear cleaning.">Full Groom - $85</option><option value="default" data-name="Bath & Brush" data-price="45" data-duration="45" data-description="Thorough bath with premium shampoo and complete brush out.">Bath & Brush - $45</option>'}
                                </select>
                            </label>
                        </div>
                        
                        <!-- Service Description Box (Recommendation #3) -->
                        <div id="service-description-box" class="p-3 bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-lg">
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-primary text-lg mt-0.5">info</span>
                                <div>
                                    <p class="text-sm font-semibold text-primary dark:text-sky-400">What's included:</p>
                                    <p class="text-sm text-text-sub-light dark:text-text-sub-dark" id="service-desc-text">${initialDescription}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Address Section -->
                        <div class="space-y-3">
                            <label class="block">
                                <span class="text-sm font-semibold mb-2 block dark:text-white">Service Address</span>
                                <input type="text" id="booking-address" value="${fullAddress}" placeholder="Street address, City (e.g., 123 Main St, Los Angeles)" class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white" required oninput="debounceAddressChange(this.value)">
                                <div id="address-status" class="mt-1 text-xs text-slate-500 dark:text-slate-400 hidden">
                                    <span class="flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">location_on</span>
                                        <span id="address-status-text">Checking address...</span>
                                    </span>
                                </div>
                            </label>
                            <input type="hidden" id="booking-city" value="${userCity}">
                            <input type="hidden" id="booking-zip" value="${userZip}">
                        </div>
                        
                        <!-- Smart Date Picker - Auto-loads, shows loading state -->
                        <div id="smart-date-picker">
                            ${smartData ? renderSmartDatePicker(smartData, selectedDate) : `
                                <div class="p-6 bg-background-light dark:bg-background-dark rounded-xl text-center">
                                    <div class="inline-flex items-center gap-2 text-text-sub-light dark:text-text-sub-dark">
                                        <svg class="animate-spin h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Finding best available dates...</span>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <!-- Time Selection (shown after date is selected) -->
                        <div id="time-selection-wrapper" class="${selectedDate ? '' : 'hidden'}">
                            <label class="block">
                                <span class="text-sm font-semibold mb-2 block dark:text-white">Time</span>
                                <select id="booking-time" class="w-full h-12 px-4 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white" required>
                                    <option value="">Select a time</option>
                                </select>
                                <p id="booking-time-hint" class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden"></p>
                            </label>
                        </div>
                        
                        <!-- Hidden date input for form submission -->
                        <input type="hidden" id="booking-date" value="${selectedDate || ''}">
                        
                        <!-- Notes -->
                        <label class="block">
                            <span class="text-sm font-semibold mb-2 block dark:text-white">Notes (optional)</span>
                            <textarea id="booking-notes" placeholder="Any special requests or notes..." class="w-full h-20 px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white resize-none"></textarea>
                        </label>
                        
                        <button type="submit" id="booking-submit-btn" class="w-full h-12 bg-primary hover:bg-primary/90 text-white font-bold rounded-lg flex items-center justify-center gap-2 touch-target transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Confirm Booking
                            <span class="material-symbols-outlined">check</span>
                        </button>
                    </form>
                </div>
            </div>`;
        }
        
        // Render smart date picker with time slots
        function renderSmartDatePicker(smartData, selectedSlot) {
            if (!smartData) return '';
            
            // Support both old and new format
            const { bestAvailable, moreAvailable, recommended, goodOptions, available, noCoordinates, error } = smartData;
            
            // Use new format if available, otherwise fall back to old
            const best = bestAvailable || recommended || [];
            const more = moreAvailable || [...(goodOptions || []), ...(available || [])];
            
            if (noCoordinates) {
                return `
                    <div class="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-amber-600">location_off</span>
                            <div class="flex-1">
                                <p class="font-semibold text-amber-800 dark:text-amber-200">Location not found</p>
                                <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">We couldn't find your address. Please check the spelling and include the city.</p>
                                <p class="text-sm text-amber-600 dark:text-amber-400 mt-2">Or contact us and we'll help you book:</p>
                                <div class="flex gap-3 mt-3">
                                    <a href="tel:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-lg transition-colors">
                                        <span class="material-symbols-outlined text-lg">call</span>
                                        Call
                                    </a>
                                    <a href="sms:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                        <span class="material-symbols-outlined text-lg">chat</span>
                                        Text
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (error) {
                return `
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
                        <p class="text-red-800 dark:text-red-200 font-medium">Error loading available times.</p>
                        <p class="text-sm text-red-700 dark:text-red-300 mt-1">You can use the date picker below, or contact us for help.</p>
                        <input type="date" id="booking-date-fallback" min="${new Date().toISOString().split('T')[0]}" onchange="handleFallbackDateChange()" class="mt-3 w-full h-12 px-4 rounded-lg bg-white dark:bg-background-dark border border-border-light dark:border-border-dark dark:text-white">
                        <div class="flex gap-3 mt-3">
                            <a href="tel:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-lg">call</span>
                                Call Us
                            </a>
                            <a href="sms:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-lg">chat</span>
                                Text Us
                            </a>
                        </div>
                    </div>
                `;
            }
            
            // Render slot card (date + time)
            const renderSlotCard = (slot, isSelected) => {
                // Null check - skip invalid slots
                if (!slot || !slot.date) {
                    console.warn('Invalid slot:', slot);
                    return '';
                }
                
                // Handle both old format (date only) and new format (date + time)
                const hasTime = slot.time || slot.displayTime;
                const slotKey = hasTime ? `${slot.date}_${slot.time}` : slot.date;
                const selectedKey = typeof selectedSlot === 'object' ? `${selectedSlot?.date}_${selectedSlot?.time}` : selectedSlot;
                const isSlotSelected = slotKey === selectedKey || slot.date === selectedSlot;
                
                // Format display
                const displayDate = slot.displayDate || formatDate(slot.date, { weekday: 'short', month: 'short', day: 'numeric' });
                const displayTime = slot.displayTime || (slot.time ? formatTime(slot.time) : '');
                
                return `
                    <button type="button" onclick="selectBookingSlot('${slot.date}', '${slot.time || ''}', '${slot.groomerId || ''}')" 
                        class="flex flex-col items-center p-4 rounded-xl border-2 transition-all min-w-[110px] min-h-[70px] touch-target active:scale-95 ${isSlotSelected ? 'border-primary bg-primary/10 dark:bg-primary/20' : 'border-slate-200 dark:border-slate-600 hover:border-primary/50 bg-white dark:bg-slate-800'}">
                        <span class="text-sm font-semibold ${isSlotSelected ? 'text-primary' : 'text-slate-700 dark:text-slate-200'}">${displayDate}</span>
                        ${displayTime ? `<span class="text-lg font-bold ${isSlotSelected ? 'text-primary' : 'text-slate-900 dark:text-white'} mt-1">${displayTime}</span>` : ''}
                    </button>
                `;
            };
            
            // Filter out any null/invalid slots
            const validBest = best.filter(s => s && s.date);
            const validMore = more.filter(s => s && s.date);
            
            // Contact section HTML (reusable)
            const contactSection = (message) => `
                <div class="p-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-primary">support_agent</span>
                        <div class="flex-1">
                            <p class="font-medium text-slate-700 dark:text-slate-300">${message}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">We may be able to accommodate your schedule.</p>
                            <div class="flex gap-3 mt-3">
                                <a href="tel:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-lg">call</span>
                                    Call
                                </a>
                                <a href="sms:6268636926" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-lg">chat</span>
                                    Text
                                </a>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 text-center">(626) 863-6926</p>
                        </div>
                    </div>
                </div>
            `;
            
            let html = '<div class="space-y-4">';
            
            // Best Available Times
            if (validBest.length > 0) {
                html += `
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-emerald-600 fill-1">star</span>
                            <span class="font-semibold text-emerald-700 dark:text-emerald-400">Best Available Times</span>
                            <span class="text-xs text-emerald-600 dark:text-emerald-500 ml-1">(groomer nearby)</span>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            ${validBest.slice(0, 8).map(s => renderSlotCard(s, selectedSlot)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // More Available Times
            if (validMore.length > 0) {
                html += `
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-slate-500">calendar_today</span>
                            <span class="font-semibold text-slate-700 dark:text-slate-300">More Available Times</span>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            ${validMore.slice(0, 12).map(s => renderSlotCard(s, selectedSlot)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Show contact section in different scenarios
            if (validBest.length === 0 && validMore.length === 0) {
                // No times at all
                html += `
                    <div class="p-4 bg-slate-100 dark:bg-slate-800 rounded-xl text-center">
                        <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">event_busy</span>
                        <p class="text-slate-600 dark:text-slate-400 mb-4">No available times in the next 30 days for your area.</p>
                    </div>
                `;
                html += contactSection("Don't see any times that work?");
            } else if (validBest.length === 0 && validMore.length > 0) {
                // Only "More Available" - no optimal times nearby
                html += contactSection("Don't see a convenient time?");
            }
            
            html += '</div>';
            return html;
        }
        
        // Select a booking slot (date + time + groomer)
        function selectBookingSlot(dateStr, timeStr, groomerId) {
            state.selectedBookingDate = dateStr;
            state.selectedBookingTime = timeStr;
            state.selectedBookingGroomer = groomerId;
            
            // Update hidden inputs
            const dateInput = document.getElementById('booking-date');
            if (dateInput) dateInput.value = dateStr;
            
            // If time is provided, auto-select it
            if (timeStr) {
                const timeSelect = document.getElementById('booking-time');
                if (timeSelect) {
                    // Check if option exists, if not add it
                    let option = Array.from(timeSelect.options).find(o => o.value === timeStr);
                    if (!option) {
                        option = document.createElement('option');
                        option.value = timeStr;
                        option.textContent = formatTime(timeStr);
                        timeSelect.appendChild(option);
                    }
                    timeSelect.value = timeStr;
                }
                
                // Show time selection wrapper
                const timeWrapper = document.getElementById('time-selection-wrapper');
                if (timeWrapper) timeWrapper.classList.remove('hidden');
            }
            
            // Enable submit button - use button ID directly
            const submitBtn = document.getElementById('booking-submit-btn');
            if (submitBtn) {
                // Enable only when both date AND time are selected
                submitBtn.disabled = !dateStr || !timeStr;
                console.log('Submit button state:', { dateStr, timeStr, disabled: submitBtn.disabled });
            } else {
                console.warn('Could not find submit button #booking-submit-btn');
            }
            
            // Update the picker UI
            const pickerContainer = document.getElementById('smart-date-picker');
            if (pickerContainer && state.smartBookingData) {
                pickerContainer.innerHTML = renderSmartDatePicker(state.smartBookingData, { date: dateStr, time: timeStr });
            }
            
            // Load available times for selected date (if time not pre-selected)
            if (!timeStr) {
                loadTimeSlotsForDate(dateStr);
            }
        }
        
        // Debounce timer for address input
        let addressChangeTimer = null;
        let lastAddressValue = '';
        
        // Debounced address change handler
        function debounceAddressChange(value) {
            // Clear previous timer
            if (addressChangeTimer) {
                clearTimeout(addressChangeTimer);
            }
            
            // Don't refresh if address is the same
            if (value.trim() === lastAddressValue) return;
            
            // Show loading indicator immediately
            const pickerContainer = document.getElementById('smart-date-picker');
            if (pickerContainer && value.trim().length > 5) {
                pickerContainer.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full spinner"></div>
                        <span class="ml-2 text-sm text-slate-500">Updating times for new address...</span>
                    </div>
                `;
            }
            
            // Wait 800ms after user stops typing
            addressChangeTimer = setTimeout(() => {
                if (value.trim().length >= 5) {
                    lastAddressValue = value.trim();
                    loadSmartDatePicker();
                }
            }, 800);
        }
        
        // Service area validation - check if coordinates are within LA County service area
        // Excludes: Pomona/Claremont (far east) and Lancaster/Palmdale (far north)
        function isWithinServiceArea(lat, lng) {
            // Boundary-based exclusions for areas we don't service
            const EXCLUDED_AREAS = {
                // Far East - Pomona, Claremont, Diamond Bar (longitude > -117.75)
                farEast: { check: (lat, lng) => lng > -117.75, name: 'Pomona/Claremont area' },
                // Far North - Lancaster, Palmdale, Antelope Valley (latitude > 34.55)
                farNorth: { check: (lat, lng) => lat > 34.55, name: 'Lancaster/Palmdale area' }
            };
            
            // Check each exclusion zone
            for (const [zone, config] of Object.entries(EXCLUDED_AREAS)) {
                if (config.check(lat, lng)) {
                    return {
                        withinArea: false,
                        excludedZone: config.name,
                        reason: 'outside_boundary'
                    };
                }
            }
            
            // Also do a sanity check - must be roughly in Southern California
            // LA County roughly: lat 33.7-34.8, lng -118.9 to -117.6
            const inSoCal = lat >= 33.5 && lat <= 35.0 && lng >= -119.5 && lng <= -117.0;
            
            if (!inSoCal) {
                return {
                    withinArea: false,
                    excludedZone: 'Outside Southern California',
                    reason: 'outside_region'
                };
            }
            
            return {
                withinArea: true,
                excludedZone: null,
                reason: null
            };
        }
        
        // Load smart date picker based on address
        async function loadSmartDatePicker() {
            const addressInput = document.getElementById('booking-address');
            const pickerContainer = document.getElementById('smart-date-picker');
            
            if (!addressInput || !pickerContainer) return;
            
            const address = addressInput.value.trim();
            if (!address) {
                showToast('Please enter an address first', 'error');
                return;
            }
            
            // Show loading
            pickerContainer.innerHTML = `
                <div class="flex items-center justify-center p-8">
                    <div class="w-8 h-8 border-3 border-primary border-t-transparent rounded-full spinner"></div>
                    <span class="ml-3 text-slate-600 dark:text-slate-400">Finding best dates for your location...</span>
                </div>
            `;
            pickerContainer.classList.remove('hidden');
            
            try {
                // Parse address to extract city and zip if possible
                // Smart parsing: detect zip codes, handle various formats
                let street = address;
                let city = '';
                let zip = '';
                
                // Try to extract zip code (5 digits or 5+4 format)
                const zipMatch = address.match(/\b(\d{5})(?:-\d{4})?\b/);
                if (zipMatch) {
                    zip = zipMatch[1];
                    // Remove zip from street address for cleaner geocoding
                    street = address.replace(/\b\d{5}(?:-\d{4})?\b/, '').trim();
                }
                
                // Try to extract city from comma-separated parts
                const parts = street.split(',').map(p => p.trim());
                if (parts.length > 1) {
                    street = parts[0];
                    // Second part might be "City" or "City CA" or "City, CA"
                    const cityPart = parts[1].replace(/\b(CA|California)\b/gi, '').trim();
                    if (cityPart) city = cityPart;
                }
                
                // Use user's saved data as fallback
                if (!city) city = state.currentUser?.city || '';
                if (!zip) zip = state.currentUser?.zip_code || '';
                
                console.log('Parsed address:', { street, city, zip, original: address });
                
                // Geocode the address
                const coords = await geocodeAddress(street, city, 'CA', zip);
                
                // Update address status indicator
                const addressStatus = document.getElementById('address-status');
                const addressStatusText = document.getElementById('address-status-text');
                
                if (!coords) {
                    if (addressStatus) {
                        addressStatus.classList.remove('hidden');
                        addressStatus.className = 'mt-1 text-xs text-red-500';
                        if (addressStatusText) addressStatusText.textContent = 'âŒ Could not find this address';
                    }
                    state.smartBookingData = { noCoordinates: true };
                    pickerContainer.innerHTML = renderSmartDatePicker(state.smartBookingData, null);
                    return;
                }
                
                console.log('Customer coords:', coords);
                
                // Check if within service area
                const serviceAreaCheck = isWithinServiceArea(coords.latitude, coords.longitude);
                console.log('Service area check:', serviceAreaCheck);
                
                if (!serviceAreaCheck.withinArea) {
                    // Update status to show outside area
                    if (addressStatus) {
                        addressStatus.classList.remove('hidden');
                        addressStatus.className = 'mt-1 text-xs text-red-500';
                        if (addressStatusText) addressStatusText.textContent = `âŒ Outside service area (${serviceAreaCheck.excludedZone})`;
                    }
                    state.smartBookingData = { outsideServiceArea: true, excludedZone: serviceAreaCheck.excludedZone };
                    pickerContainer.innerHTML = `
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-amber-600">wrong_location</span>
                                <div class="flex-1">
                                    <p class="font-semibold text-amber-800 dark:text-amber-200">Outside Our Regular Service Area</p>
                                    <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">
                                        This address appears to be in the ${serviceAreaCheck.excludedZone}, which is outside our regular service area.
                                    </p>
                                    <p class="text-sm text-amber-600 dark:text-amber-400 mt-2">
                                        Contact us - we may be able to make special arrangements!
                                    </p>
                                    <div class="flex gap-3 mt-4">
                                        <a href="tel:6268636926" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-primary hover:bg-primary-dark text-white font-semibold rounded-xl transition-colors">
                                            <span class="material-symbols-outlined text-xl">call</span>
                                            Call Us
                                        </a>
                                        <a href="sms:6268636926" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition-colors">
                                            <span class="material-symbols-outlined text-xl">chat</span>
                                            Text Us
                                        </a>
                                    </div>
                                    <p class="text-xs text-amber-600 dark:text-amber-400 mt-3 text-center">(626) 863-6926</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Update status to show success - extract accurate info from display_name
                if (addressStatus) {
                    addressStatus.classList.remove('hidden');
                    
                    // Extract zip code from the geocoded result
                    const returnedZipMatch = coords.display_name?.match(/\b(\d{5})\b/);
                    const returnedZip = returnedZipMatch ? returnedZipMatch[1] : null;
                    
                    // Extract neighborhood/city from display name
                    const displayParts = coords.display_name?.split(',').map(p => p.trim()) || [];
                    // Typically: street, neighborhood, city, county, state, zip, country
                    // Find the city/neighborhood (skip street number and street name)
                    let detectedArea = '';
                    for (let i = 1; i < Math.min(displayParts.length, 4); i++) {
                        const part = displayParts[i];
                        // Skip if it's a number, state name, or zip
                        if (part && !part.match(/^\d+$/) && !part.match(/^(CA|California)$/i) && !part.match(/^\d{5}/)) {
                            detectedArea = part;
                            break;
                        }
                    }
                    detectedArea = detectedArea || 'Los Angeles area';
                    
                    // Check if user-entered zip matches returned zip
                    if (zip && returnedZip && zip !== returnedZip) {
                        // ZIP MISMATCH - warn user!
                        addressStatus.className = 'mt-1 text-xs text-amber-600 dark:text-amber-400';
                        if (addressStatusText) {
                            addressStatusText.innerHTML = `âš ï¸ Found "${detectedArea}" (${returnedZip}) - You entered ${zip}. <span class="underline cursor-pointer" onclick="document.getElementById('booking-address').focus()">Check address?</span>`;
                        }
                    } else {
                        // All good - show success
                        addressStatus.className = 'mt-1 text-xs text-emerald-600 dark:text-emerald-400';
                        const zipDisplay = returnedZip || zip || '';
                        if (addressStatusText) addressStatusText.textContent = `âœ“ Found: ${detectedArea}${zipDisplay ? ' (' + zipDisplay + ')' : ''}`;
                    }
                }
                
                // Store coordinates for later
                state.customerBookingCoords = coords;
                
                // Get smart date recommendations
                const recommendations = await getSmartDateRecommendations(coords.latitude, coords.longitude);
                
                state.smartBookingData = recommendations;
                state.selectedBookingDate = null;
                state.selectedBookingTime = null;
                state.selectedBookingGroomer = null;
                state.bookingTravelFee = 0;
                
                pickerContainer.innerHTML = renderSmartDatePicker(recommendations, null);
                
            } catch (err) {
                console.error('Error loading smart date picker:', err);
                state.smartBookingData = { error: true };
                pickerContainer.innerHTML = renderSmartDatePicker(state.smartBookingData, null);
            }
        }
        
        // Select a booking date from smart picker
        async function selectBookingDate(dateStr) {
            // Legacy function - redirect to new slot-based selection
            selectBookingSlot(dateStr, '', '');
        }
        
        // Load time slots for a specific date
        async function loadTimeSlotsForDate(dateStr) {
            const timeSelect = document.getElementById('booking-time');
            const timeHint = document.getElementById('booking-time-hint');
            const serviceSelect = document.getElementById('booking-service-select');
            const timeWrapper = document.getElementById('time-selection-wrapper');
            
            if (timeWrapper) timeWrapper.classList.remove('hidden');
            if (!timeSelect) return;
            
            // Show loading state
            timeSelect.innerHTML = '<option value="">Loading available times...</option>';
            timeSelect.disabled = true;
            
            try {
                const serviceId = serviceSelect?.value;
                const slots = await getAvailableSlots(dateStr, serviceId);
                
                if (slots.length === 0) {
                    timeSelect.innerHTML = '<option value="">No available times</option>';
                    if (timeHint) {
                        timeHint.textContent = 'This date is fully booked. Please try another date.';
                        timeHint.classList.remove('hidden');
                    }
                } else {
                    const options = slots.map(slot => {
                        const display = formatTime(slot);
                        return `<option value="${slot}">${display}</option>`;
                    });
                    timeSelect.innerHTML = '<option value="">Select time</option>' + options.join('');
                    if (timeHint) {
                        timeHint.textContent = `${slots.length} time slot${slots.length > 1 ? 's' : ''} available`;
                        timeHint.classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Failed to load time slots:', err);
                // Fallback to 2-hour slots
                timeSelect.innerHTML = `
                    <option value="">Select time</option>
                    <option value="07:00">7:00 AM</option>
                    <option value="09:00">9:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="17:00">5:00 PM</option>
                `;
            }
            
            timeSelect.disabled = false;
        }
        
        // Fallback date change handler
        function handleFallbackDateChange() {
            const dateInput = document.getElementById('booking-date-fallback');
            if (dateInput) {
                state.selectedBookingDate = dateInput.value;
                document.getElementById('booking-date').value = dateInput.value;
                
                const timeWrapper = document.getElementById('time-selection-wrapper');
                if (timeWrapper) timeWrapper.classList.remove('hidden');
                
                const submitBtn = document.querySelector('#booking-form button[type="submit"]');
                if (submitBtn) submitBtn.disabled = false;
                
                handleBookingDateChange();
            }
        }
        
        // Handle date change - load available time slots dynamically
        async function handleBookingDateChange() {
            const dateInput = document.getElementById('booking-date');
            const timeSelect = document.getElementById('booking-time');
            const timeHint = document.getElementById('booking-time-hint');
            const serviceSelect = document.getElementById('booking-service-select');
            
            if (!dateInput || !timeSelect) return;
            
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                timeSelect.innerHTML = '<option value="">Select a date first</option>';
                return;
            }
            
            // Show loading state
            timeSelect.innerHTML = '<option value="">Loading available times...</option>';
            timeSelect.disabled = true;
            
            try {
                const serviceId = serviceSelect?.value;
                const slots = await getAvailableSlots(selectedDate, serviceId);
                
                if (slots.length === 0) {
                    // Check if it's a closed day
                    const dayOfWeek = new Date(selectedDate).getDay();
                    const hours = state.businessHours.find(h => h.day_of_week === dayOfWeek);
                    
                    if (!hours || hours.is_closed) {
                        timeSelect.innerHTML = '<option value="">We are closed on this day</option>';
                        if (timeHint) {
                            timeHint.textContent = 'Please select a different date. We are open Monday-Saturday.';
                            timeHint.classList.remove('hidden');
                        }
                    } else {
                        timeSelect.innerHTML = '<option value="">No available times - fully booked</option>';
                        if (timeHint) {
                            timeHint.textContent = 'This date is fully booked. Please try another date.';
                            timeHint.classList.remove('hidden');
                        }
                    }
                } else {
                    // Format slots for display (convert 24hr to 12hr)
                    const options = slots.map(slot => {
                        const [hour, min] = slot.split(':');
                        const h = parseInt(hour);
                        const ampm = h >= 12 ? 'PM' : 'AM';
                        const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                        const display = `${h12}:${min} ${ampm}`;
                        return `<option value="${slot}">${display}</option>`;
                    });
                    
                    timeSelect.innerHTML = '<option value="">Select time</option>' + options.join('');
                    if (timeHint) {
                        timeHint.textContent = `${slots.length} time slot${slots.length > 1 ? 's' : ''} available`;
                        timeHint.classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Failed to load available slots:', err);
                // Fallback to default times if dynamic loading fails
                timeSelect.innerHTML = `
                    <option value="">Select time</option>
                    <option value="09:00">9:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="16:00">4:00 PM</option>
                `;
                if (timeHint) {
                    timeHint.textContent = 'Could not verify availability. Please call to confirm.';
                    timeHint.classList.remove('hidden');
                }
            }
            
            timeSelect.disabled = false;
        }

        function renderAdminDashboard() {
            const navItems = [
                {id:'dashboard',label:'Dashboard',icon:'dashboard'},
                {id:'appointments',label:'Appointments',icon:'calendar_month'},
                {id:'customers',label:'Customers',icon:'group'},
                {id:'groomers',label:'Groomers',icon:'content_cut'},
                {id:'loyalty',label:'Loyalty',icon:'favorite', badge: state.pendingRedemptions?.length || 0},
                {id:'messages',label:'Messages',icon:'chat_bubble', badge: state.adminMessages?.filter(m => !m.is_read && m.to_admin)?.length || 0},
                {id:'services',label:'Services/Products',icon:'storefront'}
            ];
            
            const todayAppts = data.appointments.filter(a => a.status === 'confirmed' || a.status === 'pending');
            // Calculate actual revenue from appointment prices (not hardcoded)
            const totalRevenue = data.appointments
                .filter(a => a.status === 'confirmed' || a.status === 'completed')
                .reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.base_price) || 85), 0);
            
            return `
            <div class="flex h-screen w-full bg-admin-bg dark:bg-background-dark">
                <!-- Sidebar -->
                <aside class="w-[280px] flex-shrink-0 flex-col bg-admin-sidebar dark:bg-surface-dark border-r border-amber-100 dark:border-border-dark hidden lg:flex z-20">
                    <div class="p-6 flex flex-col h-full">
                        <div class="flex items-center gap-4 mb-6 px-2">
                            <div class="w-12 h-12 rounded-2xl shadow-md shadow-admin-primary/20 overflow-hidden">
                                <img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/>
                            </div>
                            <div class="flex flex-col">
                                <h1 class="text-slate-900 dark:text-white text-lg font-extrabold tracking-tight">Dogfathers<span class="text-admin-primary">plus</span></h1>
                                <p class="text-admin-primary dark:text-amber-400 text-[11px] font-bold uppercase tracking-wider mt-0.5">Admin Portal</p>
                            </div>
                        </div>
                        <nav class="flex flex-col gap-4 pt-4">
                            ${navItems.map(item => `
                                <button onclick="setTab('${item.id}')" class="flex items-center gap-4 px-5 py-4 rounded-xl transition-all group touch-target ${state.currentTab === item.id ? 'bg-gradient-to-r from-admin-primary/10 to-transparent text-admin-primary font-bold shadow-sm border-l-4 border-admin-primary' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-amber-50 dark:hover:bg-slate-800'}">
                                    <span class="material-symbols-outlined text-[24px] ${state.currentTab === item.id ? 'text-admin-primary' : 'text-slate-400 group-hover:text-admin-primary'}">${item.icon}</span>
                                    <span class="text-[16px] flex-1 ${state.currentTab === item.id ? '' : 'font-medium'}">${item.label}</span>
                                    ${item.badge > 0 ? `<span class="px-2.5 py-1 bg-admin-accent text-white text-xs font-bold rounded-full">${item.badge}</span>` : ''}
                                </button>
                            `).join('')}
                        </nav>
                        <div class="flex-1"></div>
                    </div>
                    <div class="p-6 border-t border-amber-100 dark:border-border-dark">
                        <button onclick="openChangePassword()" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-amber-50 dark:hover:bg-slate-800 font-medium transition-colors mb-2 touch-target">
                            <span class="material-symbols-outlined text-lg">password</span>Change Password
                        </button>
                        <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium transition-colors touch-target">
                            <span class="material-symbols-outlined text-lg">logout</span>Sign Out
                        </button>
                    </div>
                </aside>

                <!-- Mobile Header -->
                <div class="lg:hidden fixed top-0 left-0 right-0 z-50 flex items-center justify-between p-4 bg-admin-sidebar dark:bg-surface-dark border-b border-amber-100 dark:border-border-dark shadow-sm safe-top">
                    <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-lg overflow-hidden"><img src="${LOGO_MAIN}" alt="Dogfathersplus" class="w-full h-full object-cover"/></div><span class="text-lg font-bold text-slate-900 dark:text-white">Dogfathers<span class="text-admin-primary">plus</span></span></div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleNotifications()" class="text-slate-600 dark:text-slate-400 p-2.5 rounded-xl hover:bg-amber-50 dark:hover:bg-slate-800 touch-target relative" title="Notifications">
                            <span class="material-symbols-outlined">notifications</span>
                            ${state.unreadNotifications > 0 ? `<span class="absolute top-0 right-0 w-5 h-5 bg-admin-accent text-white text-xs font-bold rounded-full flex items-center justify-center">${state.unreadNotifications > 9 ? '9+' : state.unreadNotifications}</span>` : ''}
                        </button>
                        <button onclick="refreshData()" class="text-slate-600 dark:text-slate-400 p-2.5 rounded-xl hover:bg-amber-50 dark:hover:bg-slate-800 touch-target" title="Refresh"><span class="material-symbols-outlined">refresh</span></button>
                        <button onclick="toggleMobileMenu()" class="text-slate-600 dark:text-slate-400 p-2.5 rounded-xl hover:bg-amber-50 dark:hover:bg-slate-800 touch-target"><span class="material-symbols-outlined">menu</span></button>
                    </div>
                </div>

                ${state.showMobileMenu ? `
                <div class="lg:hidden fixed inset-0 z-40 bg-black/50" onclick="toggleMobileMenu()">
                    <div class="absolute left-0 top-0 bottom-0 w-72 bg-admin-sidebar dark:bg-surface-dark" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-amber-100 dark:border-border-dark">
                            <p class="text-admin-primary font-bold text-sm uppercase">Admin Portal</p>
                        </div>
                        <nav class="p-4">${navItems.map(i => `<button onclick="setTab('${i.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 touch-target ${state.currentTab === i.id ? 'bg-admin-primary/10 text-admin-primary font-bold' : 'hover:bg-amber-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400'}"><span class="material-symbols-outlined">${i.icon}</span>${i.label}</button>`).join('')}</nav>
                        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-amber-100 dark:border-border-dark safe-bottom">
                            <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-amber-50 dark:hover:bg-slate-800 mb-1 touch-target"><span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>${state.darkMode ? 'Light Mode' : 'Dark Mode'}</button>
                            <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 touch-target"><span class="material-symbols-outlined">logout</span>Sign Out</button>
                        </div>
                    </div>
                </div>` : ''}

                <!-- Main Content -->
                <main class="flex-1 flex flex-col h-full overflow-hidden relative">
                    <!-- Top Header Bar (Desktop) -->
                    <div class="hidden lg:flex items-center justify-end gap-2 px-8 py-4 border-b border-amber-100/50 dark:border-border-dark bg-white/50 dark:bg-surface-dark/50 backdrop-blur-sm z-20">
                        <button onclick="refreshData()" class="p-2.5 rounded-xl text-slate-500 hover:text-admin-primary hover:bg-amber-50 dark:hover:bg-slate-800 transition-all" title="Refresh Data">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                        <button onclick="toggleNotifications()" class="p-2.5 rounded-xl text-slate-500 hover:text-admin-primary hover:bg-amber-50 dark:hover:bg-slate-800 transition-all relative" title="Notifications">
                            <span class="material-symbols-outlined">notifications</span>
                            ${state.unreadNotifications > 0 ? `<span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>` : ''}
                        </button>
                        <button onclick="toggleDarkMode()" class="p-2.5 rounded-xl text-slate-500 hover:text-admin-primary hover:bg-amber-50 dark:hover:bg-slate-800 transition-all" title="${state.darkMode ? 'Light Mode' : 'Dark Mode'}">
                            <span class="material-symbols-outlined">${state.darkMode ? 'light_mode' : 'dark_mode'}</span>
                        </button>
                        <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                        <div class="flex items-center gap-2 pl-2">
                            <div class="w-8 h-8 bg-admin-accent rounded-full flex items-center justify-center text-white font-bold text-sm">${(state.currentUser?.name || 'A').charAt(0).toUpperCase()}</div>
                        </div>
                    </div>
                    
                    <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-amber-50/50 to-transparent pointer-events-none z-0 lg:top-[65px]"></div>
                    <div class="flex-1 overflow-y-auto p-4 lg:p-8 pt-20 lg:pt-6 pb-8 z-10 relative safe-bottom scroll-smooth">
                        <div class="max-w-[1600px] mx-auto space-y-8">${renderAdminContent()}</div>
                    </div>
                </main>
            </div>
            ${state.editModal ? renderEditModal() : ''}
            ${state.confirmDialog ? renderConfirmDialog() : ''}
            ${state.showAddGroomerModal ? renderAddGroomerModal() : ''}
            ${state.showEditGroomerModal ? renderEditGroomerModal() : ''}
            ${state.showGroomerScheduleModal ? renderGroomerScheduleModal() : ''}
            ${state.showAdminAddAppointment ? renderAdminAddAppointmentModal() : ''}
            ${state.showNotifications ? renderNotificationsPanel() : ''}
            ${state.quickViewAppointment ? renderQuickViewAppointmentModal() : ''}
            ${state.groomingServiceModal ? renderGroomingServiceModal() : ''}`;
        }

        function renderAdminContent() {
            const todayAppts = data.appointments;
            const confirmedCount = data.appointments.filter(a => a.status === 'confirmed').length;
            const pendingCount = data.appointments.filter(a => a.status === 'pending').length;
            // Calculate actual revenue from appointment prices
            const totalRevenue = data.appointments
                .filter(a => a.status === 'confirmed' || a.status === 'completed')
                .reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.base_price) || 0), 0);

            if (state.currentTab === 'dashboard') {
                return `
                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-2">
                    <div>
                        <p class="text-admin-primary text-sm font-bold uppercase tracking-widest mb-2">Premium Management</p>
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">Welcome back, ${state.currentUser.name.split(' ')[0]}</h1>
                        <p class="text-slate-500 text-base font-medium mt-2 flex items-center gap-2"><span class="material-symbols-outlined text-lg text-admin-primary">calendar_today</span>Your schedule is looking great today</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportDashboardData()" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-white border border-amber-200 rounded-xl text-slate-700 font-bold hover:bg-amber-50 hover:border-amber-300 transition-all text-sm shadow-sm"><span class="material-symbols-outlined text-lg">download</span>Export</button>
                        <button onclick="openAdminAddAppointment()" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-admin-accent hover:bg-teal-600 text-white rounded-xl font-bold transition-all shadow-lg shadow-admin-accent/25 text-sm"><span class="material-symbols-outlined text-lg">add</span>New Booking</button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="group p-6 rounded-2xl bg-white border border-amber-100 shadow-sm hover:shadow-lg hover:border-admin-primary/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div><p class="text-admin-primary text-xs font-bold uppercase tracking-wider">Today's Revenue</p><h3 class="text-3xl font-bold text-slate-900 mt-1">$${totalRevenue.toLocaleString()}</h3></div>
                            <div class="w-12 h-12 rounded-xl bg-amber-50 flex items-center justify-center text-admin-primary group-hover:scale-110 transition-transform"><span class="material-symbols-outlined text-2xl">payments</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-sm"><span class="flex items-center gap-1 font-bold text-green-600 bg-green-100 px-2.5 py-1 rounded-lg"><span class="material-symbols-outlined text-sm">trending_up</span>12%</span><span class="text-slate-400">vs yesterday</span></div>
                    </div>
                    <div class="group p-6 rounded-2xl bg-white border border-amber-100 shadow-sm hover:shadow-lg hover:border-admin-primary/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div><p class="text-admin-primary text-xs font-bold uppercase tracking-wider">Active Bookings</p><h3 class="text-3xl font-bold text-slate-900 mt-1">${todayAppts.length}</h3></div>
                            <div class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center text-admin-accent group-hover:scale-110 transition-transform"><span class="material-symbols-outlined text-2xl">calendar_today</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-sm"><span class="flex items-center gap-1 font-bold text-admin-accent bg-teal-100 px-2.5 py-1 rounded-lg"><span class="material-symbols-outlined text-sm">arrow_upward</span>+${confirmedCount}</span><span class="text-slate-400">confirmed</span></div>
                    </div>
                    <div class="group p-6 rounded-2xl bg-white border border-amber-100 shadow-sm hover:shadow-lg hover:border-admin-primary/30 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div><p class="text-admin-primary text-xs font-bold uppercase tracking-wider">In Grooming</p><h3 class="text-3xl font-bold text-slate-900 mt-1">${data.appointments.filter(a => a.status === 'in_progress').length}</h3></div>
                            <div class="w-12 h-12 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600 group-hover:scale-110 transition-transform"><span class="material-symbols-outlined text-2xl">content_cut</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-sm"><span class="text-slate-400">Current capacity</span></div>
                    </div>
                    <div class="group p-6 rounded-2xl bg-admin-accent text-white shadow-lg hover:shadow-xl transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div><p class="text-teal-100 text-xs font-bold uppercase tracking-wider">Loyalty Points</p><h3 class="text-3xl font-bold mt-1">${(state.allCustomers.reduce((sum, c) => sum + (c.loyalty_points || 0), 0) / 1000).toFixed(1)}k</h3></div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform"><span class="material-symbols-outlined text-2xl">favorite</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-sm"><span class="text-teal-100">Total Issued</span></div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Schedule Table -->
                    <div class="xl:col-span-2 flex flex-col gap-6">
                        <div class="flex items-center justify-between px-1">
                            <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2"><span class="w-1.5 h-6 bg-admin-primary rounded-full"></span>Appointment Schedule</h2>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-1 p-1 bg-slate-100 rounded-lg">
                                    <button onclick="setDashboardView('day')" class="px-3 py-1.5 rounded-md text-sm font-bold ${(state.dashboardScheduleView || 'day') === 'day' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}">Day</button>
                                    <button onclick="setDashboardView('week')" class="px-3 py-1.5 rounded-md text-sm font-bold ${state.dashboardScheduleView === 'week' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}">Week</button>
                                    <button onclick="setDashboardView('month')" class="px-3 py-1.5 rounded-md text-sm font-bold ${state.dashboardScheduleView === 'month' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}">Month</button>
                                </div>
                                <button onclick="setTab('appointments')" class="text-sm font-bold text-admin-primary hover:text-amber-600 flex items-center gap-1">View All <span class="material-symbols-outlined text-base">arrow_forward</span></button>
                            </div>
                        </div>
                        
                        ${(state.dashboardScheduleView || 'day') === 'day' ? `
                        <!-- Day View -->
                        <div class="bg-white rounded-2xl border border-amber-100 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-amber-50 flex items-center justify-between">
                                <p class="text-sm text-slate-500">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
                                <span class="text-xs font-bold text-admin-primary">${data.appointments.filter(a => a.appointment_date === getTodayPacific()).length} appointments</span>
                            </div>
                            <div class="divide-y divide-slate-100">
                                ${(() => {
                                    const todayAppts = data.appointments.filter(a => a.appointment_date === getTodayPacific());
                                    return todayAppts.length > 0 ? todayAppts.slice(0, 6).map(a => `
                                    <div class="flex items-center gap-4 px-6 py-4 hover:bg-amber-50/50 transition-colors">
                                        <div class="text-sm font-bold text-slate-400 w-16">${formatTime(a.start_time)}</div>
                                        <div class="flex-1 flex items-center gap-3 px-4 py-3 rounded-xl border-l-4 ${a.status === 'confirmed' ? 'bg-teal-50 border-admin-accent' : a.status === 'pending' ? 'bg-amber-50 border-admin-primary' : a.status === 'in_progress' ? 'bg-purple-50 border-purple-500' : a.status === 'completed' ? 'bg-green-50 border-green-500' : 'bg-slate-50 border-slate-300'}">
                                            <div class="w-10 h-10 rounded-full bg-white shadow-sm overflow-hidden flex items-center justify-center">
                                                ${a.petPhoto ? `<img src="${a.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-slate-400">pets</span>`}
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-bold text-slate-900">${a.petName || 'Pet'} <span class="font-normal text-slate-500">(${a.petBreed || 'Pet'})</span></p>
                                                <p class="text-xs text-slate-500 uppercase tracking-wide">${a.serviceName || 'Full Grooming'} â€¢ ${a.customerName || ''}</p>
                                            </div>
                                            ${a.status === 'pending' ? `<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded-full">Pending</span>` : ''}
                                            ${a.status === 'in_progress' ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded-full animate-pulse">In Progress</span>` : ''}
                                            ${a.status === 'completed' ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">Done</span>` : ''}
                                        </div>
                                        <button onclick="openQuickViewAppointment('${a.id}')" class="p-2.5 text-slate-400 hover:text-admin-primary hover:bg-amber-50 rounded-xl transition-all" title="Quick View">
                                            <span class="material-symbols-outlined">visibility</span>
                                        </button>
                                    </div>`).join('') : '<div class="px-6 py-8 text-center text-slate-400">No appointments scheduled for today</div>';
                                })()}
                            </div>
                        </div>
                        ` : state.dashboardScheduleView === 'week' ? `
                        <!-- Week View -->
                        <div class="bg-white rounded-2xl border border-amber-100 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-amber-50 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button onclick="adminDashboardPrevWeek()" class="p-1 hover:bg-slate-100 rounded-full"><span class="material-symbols-outlined text-slate-600">chevron_left</span></button>
                                    <p class="text-sm font-bold text-slate-700">${getAdminDashboardWeekLabel()}</p>
                                    <button onclick="adminDashboardNextWeek()" class="p-1 hover:bg-slate-100 rounded-full"><span class="material-symbols-outlined text-slate-600">chevron_right</span></button>
                                </div>
                                <button onclick="state.adminDashboardWeekStart = null; render();" class="text-xs font-bold text-admin-primary hover:underline">This Week</button>
                            </div>
                            <div class="grid grid-cols-7 border-b border-slate-100">
                                ${getAdminDashboardWeekDays().map(day => `
                                    <div class="p-3 text-center border-r border-slate-100 last:border-r-0 ${day.isToday ? 'bg-admin-primary/5' : ''}">
                                        <p class="text-xs font-bold text-slate-400 uppercase">${day.dayName}</p>
                                        <p class="text-lg font-bold ${day.isToday ? 'text-admin-primary' : 'text-slate-700'}">${day.dayNum}</p>
                                        <p class="text-xs ${day.count > 0 ? 'text-admin-accent font-bold' : 'text-slate-400'}">${day.count} appt${day.count !== 1 ? 's' : ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="p-4 max-h-[300px] overflow-y-auto">
                                ${(() => {
                                    const weekAppts = getAdminDashboardWeekAppointments();
                                    return weekAppts.length > 0 ? weekAppts.slice(0, 8).map(a => `
                                    <div class="flex items-center gap-3 p-3 mb-2 rounded-lg hover:bg-slate-50 border border-slate-100">
                                        <div class="text-xs font-bold text-slate-400 w-20">${formatDate(a.appointment_date)}</div>
                                        <div class="w-8 h-8 rounded-full bg-slate-100 overflow-hidden flex items-center justify-center">
                                            ${a.petPhoto ? `<img src="${a.petPhoto}" class="w-full h-full object-cover"/>` : `<span class="material-symbols-outlined text-sm text-slate-400">pets</span>`}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-bold text-slate-900 truncate">${a.petName || 'Pet'}</p>
                                            <p class="text-xs text-slate-500">${formatTime(a.start_time)} â€¢ ${a.serviceName || 'Grooming'}</p>
                                        </div>
                                        <span class="px-2 py-0.5 text-xs font-bold rounded-full ${a.status === 'confirmed' ? 'bg-teal-100 text-teal-700' : a.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">${a.status}</span>
                                        <button onclick="openQuickViewAppointment('${a.id}')" class="p-1.5 text-slate-400 hover:text-admin-primary hover:bg-amber-50 rounded-lg transition-all" title="Quick View">
                                            <span class="material-symbols-outlined text-lg">visibility</span>
                                        </button>
                                    </div>`).join('') : '<div class="text-center py-6 text-slate-400">No appointments this week</div>';
                                })()}
                            </div>
                        </div>
                        ` : `
                        <!-- Month View -->
                        <div class="bg-white rounded-2xl border border-amber-100 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-amber-50 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button onclick="adminDashboardPrevMonth()" class="p-2 hover:bg-slate-100 rounded-full touch-target"><span class="material-symbols-outlined text-slate-600">chevron_left</span></button>
                                    <p class="text-sm font-bold text-slate-700">${getAdminDashboardMonthLabel()}</p>
                                    <button onclick="adminDashboardNextMonth()" class="p-2 hover:bg-slate-100 rounded-full touch-target"><span class="material-symbols-outlined text-slate-600">chevron_right</span></button>
                                </div>
                                <button onclick="resetDashboardMonth()" class="text-xs font-bold text-admin-primary hover:underline">This Month</button>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-7 gap-1 mb-2">
                                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div class="text-center text-xs font-bold text-slate-400 py-2">${d}</div>`).join('')}
                                </div>
                                <div class="grid grid-cols-7 gap-1">
                                    ${getAdminDashboardMonthDays().map(day => {
                                        if (day.empty) return `<div class="aspect-square min-h-[40px]"></div>`;
                                        return `
                                        <button onclick="${day.count > 0 ? `selectDashboardDate('${day.dateStr}')` : ''}" 
                                            class="aspect-square min-h-[40px] flex flex-col items-center justify-center rounded-lg text-sm active:scale-95 ${day.isToday ? 'bg-admin-primary text-white font-bold' : day.count > 0 ? 'bg-admin-accent/10 text-admin-accent font-medium cursor-pointer hover:bg-admin-accent/20' : 'text-slate-600 hover:bg-slate-50'} transition-all">
                                            <span>${day.day}</span>
                                            ${day.count > 0 ? `<span class="text-[10px] ${day.isToday ? 'text-white/80' : 'text-admin-accent'}">${day.count}</span>` : ''}
                                        </button>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        `}
                    </div>

                    <!-- Sidebar Widgets -->
                    <div class="flex flex-col gap-6">
                        <!-- Loyalty Watch -->
                        <div class="bg-white rounded-2xl border border-amber-100 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-5">
                                <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2"><span class="material-symbols-outlined text-admin-primary">favorite</span>Loyalty Watch</h3>
                                <button onclick="setTab('loyalty')" class="text-xs font-bold text-slate-400 hover:text-admin-primary">View All</button>
                            </div>
                            <div class="flex flex-col gap-3">
                                ${state.allCustomers.length > 0 ? state.allCustomers
                                    .filter(c => c.role === 'customer')
                                    .sort((a, b) => (b.loyalty_points || 0) - (a.loyalty_points || 0))
                                    .slice(0, 3)
                                    .map((c, i) => {
                                        const initials = (c.full_name || 'C').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                                        const points = c.loyalty_points || 0;
                                        const tier = points >= 500 ? 'Gold' : points >= 200 ? 'Silver' : 'Bronze';
                                        const tierColor = points >= 500 ? 'amber' : points >= 200 ? 'teal' : 'slate';
                                        return `<div class="flex items-center gap-4 p-3 rounded-xl ${i === 0 ? 'bg-gradient-to-r from-amber-50 to-white border border-amber-100 relative overflow-hidden' : 'hover:bg-slate-50 transition-all'}">
                                            ${i === 0 ? '<div class="absolute left-0 top-0 w-1 h-full bg-admin-primary"></div>' : ''}
                                            <div class="w-10 h-10 rounded-full bg-${tierColor}-100 flex items-center justify-center text-${tierColor}-600 font-bold text-xs ${i === 0 ? 'shadow-sm ring-2 ring-amber-100' : ''}">${initials}</div>
                                            <div class="flex-1"><p class="text-sm font-bold text-slate-900">${c.full_name || 'Customer'}</p><p class="text-xs ${i === 0 ? 'text-rose-600 font-medium' : 'text-slate-500'}">${points} points</p></div>
                                            <span class="text-sm font-bold text-${tierColor}-500">${tier}</span>
                                        </div>`;
                                    }).join('') : '<p class="text-sm text-slate-400 text-center py-4">No customers yet</p>'}
                            </div>
                        </div>

                        <!-- Pending Redemptions -->
                        ${state.pendingRedemptions?.length > 0 ? `
                        <div class="bg-white rounded-2xl border border-amber-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-amber-500">redeem</span>
                                    Pending Redemptions
                                </h3>
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded-full">${state.pendingRedemptions.length}</span>
                            </div>
                            <button onclick="setTab('loyalty')" class="w-full py-2.5 bg-amber-50 hover:bg-amber-100 text-amber-700 font-bold text-sm rounded-lg transition-colors">
                                Review Redemptions
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            }

            if (state.currentTab === 'appointments') {
                return `
                <!-- Stats Section -->
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <div class="flex flex-col gap-2 rounded-xl p-5 border border-slate-200 bg-white shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Today's Appointments</p>
                            <span class="material-symbols-outlined text-primary p-2 bg-primary/10 rounded-full">calendar_today</span>
                        </div>
                        <div class="flex items-end gap-3 mt-1">
                            <p class="text-slate-900 text-3xl font-bold">${confirmedCount + pendingCount}</p>
                            <p class="text-green-600 bg-green-100 text-xs font-bold px-1.5 py-0.5 rounded flex items-center mb-1"><span class="material-symbols-outlined text-xs mr-0.5">arrow_upward</span>+1</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 rounded-xl p-5 border border-slate-200 bg-white shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Pending Confirmations</p>
                            <span class="material-symbols-outlined text-orange-500 p-2 bg-orange-100 rounded-full">pending_actions</span>
                        </div>
                        <div class="flex items-end gap-3 mt-1">
                            <p class="text-slate-900 text-3xl font-bold">${pendingCount}</p>
                            <p class="text-slate-500 text-xs font-medium mb-1">Needs attention</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 rounded-xl p-5 border border-slate-200 bg-white shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Total Revenue Today</p>
                            <span class="material-symbols-outlined text-green-600 p-2 bg-green-100 rounded-full">payments</span>
                        </div>
                        <div class="flex items-end gap-3 mt-1">
                            <p class="text-slate-900 text-3xl font-bold">$${totalRevenue}</p>
                            <p class="text-green-600 bg-green-100 text-xs font-bold px-1.5 py-0.5 rounded flex items-center mb-1"><span class="material-symbols-outlined text-xs mr-0.5">trending_up</span>+$120</p>
                        </div>
                    </div>
                </section>

                <!-- Content Split: Table & Calendar -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Left: Filters & Table -->
                    <div class="xl:col-span-2 flex flex-col gap-4">
                        <!-- Header -->
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div>
                                <h1 class="text-2xl font-extrabold text-slate-900">Appointments</h1>
                                <p class="text-slate-500 text-sm">Manage your grooming schedule and bookings</p>
                            </div>
                            <button onclick="openAdminAddAppointment()" class="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-5 py-2.5 rounded-lg shadow-sm transition-all">
                                <span class="material-symbols-outlined text-lg">add</span>
                                <span class="text-sm font-bold">New Appointment</span>
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="relative flex-1">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">search</span>
                                <input id="appointmentSearchInput" oninput="handleAppointmentSearch(this.value)" value="${state.appointmentSearchQuery || ''}" class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="Search customer, email, phone..." type="text"/>
                            </div>
                            <div class="relative min-w-[180px]">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">filter_list</span>
                                <select onchange="state.appointmentStatusFilter = this.value; state.appointmentPage = 1; render();" class="w-full pl-11 pr-10 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 appearance-none focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none cursor-pointer">
                                    <option value="" ${!state.appointmentStatusFilter ? 'selected' : ''}>All Statuses</option>
                                    <option value="confirmed" ${state.appointmentStatusFilter === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="pending" ${state.appointmentStatusFilter === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in_progress" ${state.appointmentStatusFilter === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${state.appointmentStatusFilter === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${state.appointmentStatusFilter === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400 pointer-events-none">expand_more</span>
                            </div>
                        </div>

                        <!-- Appointments Table/Cards -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            ${(() => {
                                // Filter appointments based on search and status
                                let filteredAppointments = data.appointments;
                                
                                // Apply status filter
                                if (state.appointmentStatusFilter) {
                                    filteredAppointments = filteredAppointments.filter(a => a.status === state.appointmentStatusFilter);
                                }
                                
                                // Apply search filter
                                if (state.appointmentSearchQuery) {
                                    const query = state.appointmentSearchQuery.toLowerCase().trim();
                                    filteredAppointments = filteredAppointments.filter(a => {
                                        const customerName = (a.customerName || '').toLowerCase();
                                        const customerEmail = (a.customerEmail || '').toLowerCase();
                                        const customerPhone = (a.customerPhone || '').toLowerCase();
                                        const petName = (a.petName || '').toLowerCase();
                                        const serviceName = (a.serviceName || '').toLowerCase();
                                        const groomerName = (a.groomerName || '').toLowerCase();
                                        
                                        return customerName.includes(query) ||
                                               customerEmail.includes(query) ||
                                               customerPhone.includes(query) ||
                                               petName.includes(query) ||
                                               serviceName.includes(query) ||
                                               groomerName.includes(query);
                                    });
                                }
                                
                                // Apply pagination
                                const page = state.appointmentPage || 1;
                                const perPage = 10;
                                const startIndex = (page - 1) * perPage;
                                const paginatedAppointments = filteredAppointments.slice(startIndex, startIndex + perPage);
                                
                                // Store filtered count for pagination display
                                state.filteredAppointmentsCount = filteredAppointments.length;
                                
                                const statusStyles = {
                                    confirmed: 'bg-primary/10 text-primary border-primary/20',
                                    pending: 'bg-orange-100 text-orange-700 border-orange-200',
                                    in_progress: 'bg-purple-100 text-purple-700 border-purple-200',
                                    completed: 'bg-green-100 text-green-700 border-green-200',
                                    cancelled: 'bg-red-100 text-red-700 border-red-200'
                                };
                                
                                const statusBorderColors = {
                                    confirmed: 'border-l-primary',
                                    pending: 'border-l-orange-500',
                                    in_progress: 'border-l-purple-500',
                                    completed: 'border-l-green-500',
                                    cancelled: 'border-l-red-500'
                                };
                                
                                if (paginatedAppointments.length === 0) {
                                    return `<div class="px-6 py-12 text-center text-slate-400"><span class="material-symbols-outlined text-4xl mb-2 block">calendar_month</span>${state.appointmentSearchQuery || state.appointmentStatusFilter ? 'No appointments match your search' : 'No appointments yet'}</div>`;
                                }
                                
                                // Mobile Cards View
                                const mobileCards = `
                                <div class="md:hidden divide-y divide-slate-100">
                                    ${paginatedAppointments.map(a => `
                                    <div class="p-4 border-l-4 ${statusBorderColors[a.status] || 'border-l-slate-300'}">
                                        <div class="flex items-start justify-between gap-3 mb-3">
                                            <div class="flex items-center gap-3 min-w-0">
                                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0">
                                                    <span class="material-symbols-outlined text-slate-500">person</span>
                                                </div>
                                                <div class="min-w-0">
                                                    <p class="font-bold text-slate-900 truncate">${a.customerName || 'Customer'}</p>
                                                    <p class="text-xs text-slate-500 truncate">${a.petName || 'Pet'} â€¢ ${a.petBreed || 'Dog'}</p>
                                                </div>
                                            </div>
                                            <button onclick="openQuickViewAppointment('${a.id}')" class="p-2 text-slate-400 hover:text-primary hover:bg-slate-100 rounded-lg flex-shrink-0 touch-target">
                                                <span class="material-symbols-outlined">visibility</span>
                                            </button>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3 mb-3">
                                            <div class="flex items-center gap-2">
                                                <span class="material-symbols-outlined text-sm text-slate-400">calendar_today</span>
                                                <span class="text-sm text-slate-700">${formatDate(a.appointment_date)}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="material-symbols-outlined text-sm text-slate-400">schedule</span>
                                                <span class="text-sm text-slate-700">${formatTime(a.start_time)}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="material-symbols-outlined text-sm text-slate-400">content_cut</span>
                                                <span class="text-sm text-slate-700 truncate">${a.serviceName || 'Grooming'}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="material-symbols-outlined text-sm text-slate-400">badge</span>
                                                <span class="text-sm text-slate-700 truncate">${a.groomerName || 'Unassigned'}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center justify-between gap-2">
                                            <select onchange="updateAppointmentStatus('${a.id}', this.value)" class="flex-1 px-3 py-2 rounded-lg text-sm font-bold ${statusStyles[a.status] || statusStyles.pending} border cursor-pointer touch-target">
                                                <option value="pending" ${a.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="confirmed" ${a.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                <option value="in_progress" ${a.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                <option value="completed" ${a.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                <option value="cancelled" ${a.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                            <select onchange="assignGroomer('${a.id}', this.value)" class="flex-1 px-3 py-2 rounded-lg text-sm border ${a.assigned_groomer_id ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-slate-200 bg-white text-slate-600'} cursor-pointer touch-target">
                                                <option value="">Assign</option>
                                                ${state.groomers.filter(g => g.is_active !== false).map(g => `<option value="${g.id}" ${a.assigned_groomer_id === g.id ? 'selected' : ''}>${g.full_name}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>`;
                                
                                // Desktop Table View
                                const desktopTable = `
                                <div class="hidden md:block overflow-x-auto">
                                    <table class="w-full text-left border-collapse">
                                        <thead>
                                            <tr class="bg-slate-50 border-b border-slate-200">
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Customer</th>
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Date & Time</th>
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Service</th>
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Groomer</th>
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            ${paginatedAppointments.map((a, i) => `
                                            <tr class="group hover:bg-slate-50 transition-colors">
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center">
                                                            <span class="material-symbols-outlined text-slate-500">person</span>
                                                        </div>
                                                        <div class="min-w-0">
                                                            <p class="text-sm font-bold text-slate-900 truncate">${a.customerName || 'Customer'}</p>
                                                            <p class="text-xs text-slate-500 truncate">${a.petName || 'Pet'} â€¢ ${a.petBreed || ''}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="flex flex-col">
                                                        <span class="text-sm font-medium text-slate-900">${formatDate(a.appointment_date)}</span>
                                                        <span class="text-xs text-slate-500">${formatTime(a.start_time)}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><span class="material-symbols-outlined text-base">content_cut</span></div>
                                                        <span class="text-sm font-medium text-slate-700 truncate max-w-[120px]">${a.serviceName || 'Grooming'}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <select onchange="assignGroomer('${a.id}', this.value)" 
                                                        class="text-sm px-3 py-1.5 rounded-lg border ${a.assigned_groomer_id ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-slate-200 bg-white text-slate-600'} cursor-pointer focus:ring-2 focus:ring-emerald-500 outline-none">
                                                        <option value="">Assign Groomer</option>
                                                        ${state.groomers.filter(g => g.is_active !== false).map(g => `<option value="${g.id}" ${a.assigned_groomer_id === g.id ? 'selected' : ''}>${g.full_name}</option>`).join('')}
                                                    </select>
                                                    ${a.groomerName ? `<p class="text-xs text-emerald-600 mt-1 truncate">âœ“ ${a.groomerName}</p>` : ''}
                                                </td>
                                                <td class="px-6 py-4">
                                                    <select onchange="updateAppointmentStatus('${a.id}', this.value)" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold ${statusStyles[a.status] || statusStyles.pending} border cursor-pointer bg-transparent">
                                                        <option value="pending" ${a.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                        <option value="confirmed" ${a.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                        <option value="in_progress" ${a.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                        <option value="completed" ${a.status === 'completed' ? 'selected' : ''}>âœ“ Completed</option>
                                                        <option value="cancelled" ${a.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                        <option value="no_show" ${a.status === 'no_show' ? 'selected' : ''}>No Show</option>
                                                    </select>
                                                </td>
                                                <td class="px-6 py-4 text-right">
                                                    <div class="flex justify-end gap-1">
                                                        <button onclick="openQuickViewAppointment('${a.id}')" class="p-2 text-slate-400 hover:text-primary hover:bg-slate-100 rounded-full transition-colors" title="View Details">
                                                            <span class="material-symbols-outlined">visibility</span>
                                                        </button>
                                                        <button onclick="openEditAppointmentModal('${a.id}')" class="p-2 text-slate-400 hover:text-primary hover:bg-slate-100 rounded-full transition-colors" title="Edit">
                                                            <span class="material-symbols-outlined">edit</span>
                                                        </button>
                                                        <button onclick="confirmDeleteAppointment('${a.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Delete">
                                                            <span class="material-symbols-outlined">delete</span>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>`;
                                
                                return mobileCards + desktopTable;
                            })()}
                            <div class="px-4 md:px-6 py-4 border-t border-slate-200 bg-slate-50 flex flex-col sm:flex-row items-center justify-between gap-3">
                                <p class="text-sm text-slate-500 text-center sm:text-left">Showing ${Math.min((state.appointmentPage || 1) * 10, state.filteredAppointmentsCount || data.appointments.length)} of ${state.filteredAppointmentsCount || data.appointments.length} appointments ${state.appointmentSearchQuery || state.appointmentStatusFilter ? '(filtered)' : ''}</p>
                                <div class="flex gap-2 flex-wrap justify-center">
                                    ${state.appointmentSearchQuery || state.appointmentStatusFilter ? `<button onclick="state.appointmentSearchQuery = ''; state.appointmentStatusFilter = ''; state.appointmentPage = 1; render();" class="px-3 py-2 rounded-lg border border-slate-200 text-sm font-medium text-red-600 hover:bg-red-50 touch-target">Clear</button>` : ''}
                                    <button onclick="prevAppointmentPage()" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-medium text-slate-700 hover:bg-white disabled:opacity-50 touch-target" ${(state.appointmentPage || 1) <= 1 ? 'disabled' : ''}>Previous</button>
                                    <button onclick="nextAppointmentPage()" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-medium text-slate-700 hover:bg-white disabled:opacity-50 touch-target" ${(state.appointmentPage || 1) * 10 >= (state.filteredAppointmentsCount || data.appointments.length) ? 'disabled' : ''}>Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Calendar Widget -->
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-slate-900 text-base font-bold">Select Date</p>
                                <button onclick="goToMiniCalendarToday()" class="text-primary text-sm font-bold">Today</button>
                            </div>
                            <div class="flex flex-col gap-0.5">
                                <div class="flex items-center p-1 justify-between mb-2">
                                    <button onclick="miniCalendarPrevMonth()" class="p-1 hover:bg-slate-100 rounded-full transition-colors"><span class="material-symbols-outlined text-slate-900 text-lg">chevron_left</span></button>
                                    <p class="text-slate-900 text-sm font-bold">${getMiniCalendarMonthLabel()}</p>
                                    <button onclick="miniCalendarNextMonth()" class="p-1 hover:bg-slate-100 rounded-full transition-colors"><span class="material-symbols-outlined text-slate-900 text-lg">chevron_right</span></button>
                                </div>
                                <div class="grid grid-cols-7 text-center mb-2">
                                    ${['S','M','T','W','T','F','S'].map(d => `<p class="text-slate-400 text-xs font-bold">${d}</p>`).join('')}
                                </div>
                                <div class="grid grid-cols-7 gap-y-1">
                                    ${generateMiniCalendarDays().map(day => {
                                        if (day.empty) return '<span></span>';
                                        const dateStr = day.dateStr;
                                        const hasAppt = data.appointments.some(a => a.appointment_date === dateStr);
                                        return `<button onclick="selectMiniCalendarDate('${dateStr}')" class="w-9 h-9 mx-auto flex items-center justify-center rounded-full text-sm ${day.isToday ? 'bg-primary text-white shadow-md font-bold' : day.isSelected ? 'ring-2 ring-primary bg-primary/10 text-primary font-bold' : hasAppt ? 'bg-primary/10 text-primary font-medium' : 'text-slate-700 hover:bg-slate-100'} transition-colors">${day.day}</button>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Today -->
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="text-slate-900 font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary">schedule</span>Upcoming Today</h3>
                            <div class="flex flex-col gap-3">
                                ${data.appointments.filter(a => a.status === 'confirmed' || a.status === 'pending').slice(0, 3).map(a => `
                                <div onclick="viewAppointmentDetails('${a.id}')" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm">${(a.petName || 'P').charAt(0)}</div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-slate-900 truncate">${a.petName || 'Pet'}</p>
                                        <p class="text-xs text-slate-500">${formatTime(a.start_time)} â€¢ ${a.serviceName || 'Grooming'}</p>
                                    </div>
                                    <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                                </div>`).join('') || '<div class="text-center py-4 text-slate-400 text-sm">No appointments today</div>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // =============================================
            // CUSTOMERS TAB
            // =============================================
            if (state.currentTab === 'customers') {
                // Get all customers with their data
                const customers = state.allCustomers.filter(c => c.role === 'customer');
                
                // Apply search filter
                let filteredCustomers = customers;
                if (state.customerSearchQuery) {
                    const query = state.customerSearchQuery.toLowerCase().trim();
                    filteredCustomers = customers.filter(c => {
                        const name = (c.full_name || '').toLowerCase();
                        const email = (c.email || '').toLowerCase();
                        const phone = (c.phone || '').toLowerCase();
                        const address = (c.address || '').toLowerCase();
                        return name.includes(query) || email.includes(query) || phone.includes(query) || address.includes(query);
                    });
                }
                
                // Sort customers
                const sortedCustomers = [...filteredCustomers].sort((a, b) => {
                    if (state.customerSort === 'points') {
                        return (b.loyalty_points || 0) - (a.loyalty_points || 0);
                    } else if (state.customerSort === 'recent') {
                        // Sort by most recent appointment
                        const aLastAppt = data.appointments.filter(apt => apt.customer_id === a.id).sort((x, y) => (y.appointment_date || '').localeCompare(x.appointment_date || ''))[0];
                        const bLastAppt = data.appointments.filter(apt => apt.customer_id === b.id).sort((x, y) => (y.appointment_date || '').localeCompare(x.appointment_date || ''))[0];
                        return ((bLastAppt?.appointment_date || '') || '').localeCompare((aLastAppt?.appointment_date || '') || '');
                    } else {
                        return (a.full_name || '').localeCompare(b.full_name || '');
                    }
                });
                
                // Pagination
                const page = state.customerPage || 1;
                const perPage = 10;
                const totalPages = Math.ceil(sortedCustomers.length / perPage);
                const paginatedCustomers = sortedCustomers.slice((page - 1) * perPage, page * perPage);
                
                return `
                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
                    <div>
                        <p class="text-admin-primary text-xs font-bold uppercase tracking-wider mb-1">Customer Management</p>
                        <h1 class="text-3xl font-bold text-slate-900 dark:text-white">All Customers</h1>
                        <p class="text-slate-500 mt-1">${customers.length} total customers â€¢ ${customers.filter(c => (c.loyalty_points || 0) >= 100).length} VIP members</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportCustomerData()" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 transition-all">
                            <span class="material-symbols-outlined text-lg">download</span>Export
                        </button>
                    </div>
                </div>
                
                <!-- Filters & Search -->
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="relative flex-1">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-slate-400">search</span>
                        <input id="customerSearchInput" oninput="handleCustomerSearch(this.value)" value="${state.customerSearchQuery || ''}" class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-admin-primary/50 focus:border-admin-primary outline-none transition-all" placeholder="Search by name, email, phone, address..." type="text"/>
                    </div>
                    <div class="flex gap-2">
                        <select onchange="state.customerSort = this.value; render();" class="px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 text-sm font-medium cursor-pointer">
                            <option value="name" ${(state.customerSort || 'name') === 'name' ? 'selected' : ''}>Sort by Name</option>
                            <option value="points" ${state.customerSort === 'points' ? 'selected' : ''}>Sort by Points</option>
                            <option value="recent" ${state.customerSort === 'recent' ? 'selected' : ''}>Sort by Recent</option>
                        </select>
                    </div>
                </div>
                
                <!-- Customer Cards Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    ${paginatedCustomers.length > 0 ? paginatedCustomers.map(customer => {
                        const customerPets = (state.pets || []).filter(p => p.owner_id === customer.id);
                        const customerAppts = (data.appointments || []).filter(a => a.customer_id === customer.id);
                        const lastAppt = [...customerAppts].sort((a, b) => (b.appointment_date || '').localeCompare(a.appointment_date || ''))[0];
                        const totalSpent = customerAppts.filter(a => a.status === 'completed').reduce((sum, a) => sum + (parseFloat(a.total_price) || parseFloat(a.base_price) || 0), 0);
                        const initials = (customer.full_name || 'C').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        const loyaltyTier = (customer.loyalty_points || 0) >= 200 ? 'Gold' : (customer.loyalty_points || 0) >= 100 ? 'Silver' : 'Bronze';
                        const tierColors = { Gold: 'bg-amber-100 text-amber-700 border-amber-200', Silver: 'bg-slate-100 text-slate-600 border-slate-200', Bronze: 'bg-orange-100 text-orange-700 border-orange-200' };
                        
                        return `
                        <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-border-dark p-5 hover:shadow-lg transition-all">
                            <div class="flex items-start gap-4">
                                <!-- Avatar -->
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-admin-primary to-admin-accent flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                                    ${initials}
                                </div>
                                
                                <!-- Main Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-slate-900 dark:text-white truncate">${customer.full_name || 'Unknown'}</h3>
                                        <span class="px-2 py-0.5 text-xs font-bold rounded-full border ${tierColors[loyaltyTier]}">${loyaltyTier}</span>
                                    </div>
                                    
                                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-slate-500 mb-3">
                                        ${customer.phone ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-sm">phone</span>${customer.phone}</span>` : ''}
                                        ${customer.email ? `<span class="flex items-center gap-1 truncate"><span class="material-symbols-outlined text-sm">mail</span>${customer.email}</span>` : ''}
                                    </div>
                                    
                                    ${customer.address ? `<p class="text-xs text-slate-400 mb-3 truncate"><span class="material-symbols-outlined text-xs align-middle">location_on</span> ${customer.address}</p>` : ''}
                                    
                                    <!-- Pets -->
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-xs font-bold text-slate-400 uppercase">Pets:</span>
                                        ${customerPets.length > 0 ? customerPets.slice(0, 3).map(pet => `
                                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs font-medium text-slate-700 dark:text-slate-300">
                                                <span class="material-symbols-outlined text-xs">pets</span>${pet.name}
                                            </span>
                                        `).join('') + (customerPets.length > 3 ? `<span class="text-xs text-slate-400">+${customerPets.length - 3} more</span>` : '') : '<span class="text-xs text-slate-400">No pets</span>'}
                                    </div>
                                    
                                    <!-- Stats Row -->
                                    <div class="flex items-center gap-4 pt-3 border-t border-slate-100 dark:border-slate-700">
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-admin-primary">${customer.loyalty_points || 0}</p>
                                            <p class="text-xs text-slate-400">Points</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-slate-900 dark:text-white">${customerAppts.length}</p>
                                            <p class="text-xs text-slate-400">Visits</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-green-600">$${totalSpent.toFixed(0)}</p>
                                            <p class="text-xs text-slate-400">Spent</p>
                                        </div>
                                        <div class="flex-1 text-right">
                                            <p class="text-xs text-slate-400">Last Visit</p>
                                            <p class="text-sm font-medium text-slate-700 dark:text-slate-300">${lastAppt ? formatDate(lastAppt.appointment_date) : 'Never'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex flex-col gap-1">
                                    <button onclick="openCustomerDetailModal('${customer.id}')" class="p-2 text-slate-400 hover:text-admin-primary hover:bg-admin-primary/10 rounded-lg transition-all" title="View Details">
                                        <span class="material-symbols-outlined">visibility</span>
                                    </button>
                                    <button onclick="openAdminAddAppointment(); state.adminSelectedCustomer = '${customer.id}';" class="p-2 text-slate-400 hover:text-admin-accent hover:bg-admin-accent/10 rounded-lg transition-all" title="Book Appointment">
                                        <span class="material-symbols-outlined">calendar_add_on</span>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    }).join('') : `
                        <div class="col-span-2 text-center py-12 text-slate-400">
                            <span class="material-symbols-outlined text-5xl mb-3 block">person_search</span>
                            <p class="text-lg font-medium">${state.customerSearchQuery ? 'No customers match your search' : 'No customers yet'}</p>
                            <p class="text-sm mt-1">Customers will appear here after their first appointment</p>
                        </div>
                    `}
                </div>
                
                <!-- Pagination -->
                <div class="flex items-center justify-between bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark px-6 py-4">
                    <p class="text-sm text-slate-500">Showing ${paginatedCustomers.length} of ${sortedCustomers.length} customers ${state.customerSearchQuery ? '(filtered)' : ''}</p>
                    <div class="flex gap-2">
                        ${state.customerSearchQuery ? `<button onclick="state.customerSearchQuery = ''; state.customerPage = 1; render();" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-medium text-red-600 hover:bg-red-50">Clear Search</button>` : ''}
                        <button onclick="state.customerPage = Math.max(1, (state.customerPage || 1) - 1); render();" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50" ${page <= 1 ? 'disabled' : ''}>Previous</button>
                        <span class="px-3 py-1.5 text-sm font-medium text-slate-600">Page ${page} of ${totalPages || 1}</span>
                        <button onclick="state.customerPage = Math.min(${totalPages}, (state.customerPage || 1) + 1); render();" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50" ${page >= totalPages ? 'disabled' : ''}>Next</button>
                    </div>
                </div>
                
                ${state.customerDetailModal ? renderCustomerDetailModal() : ''}`;
            }

            // =============================================
            // GROOMERS TAB
            // =============================================
            if (state.currentTab === 'groomers') {
                const activeGroomers = state.groomers.filter(g => g.is_active !== false);
                const inactiveGroomers = state.groomers.filter(g => g.is_active === false);
                const displayGroomers = state.groomerFilter === 'all' ? state.groomers : 
                    state.groomerFilter === 'active' ? activeGroomers : inactiveGroomers;
                
                return `
                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
                    <div>
                        <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">Groomer Management</h1>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Manage your grooming team, schedules, and assignments</p>
                    </div>
                    <button onclick="openAddGroomerModal()" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-emerald-600/25 text-sm">
                        <span class="material-symbols-outlined text-lg">person_add</span>Add Groomer
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-xl p-5 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Active Groomers</p>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">${activeGroomers.length}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center">
                                <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400 text-2xl">badge</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-xl p-5 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Appointments This Month</p>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">${state.groomers.reduce((sum, g) => sum + (g.appointmentsThisMonth || 0), 0)}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center">
                                <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl">calendar_month</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-xl p-5 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Revenue This Month</p>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">$${state.groomers.reduce((sum, g) => sum + (g.revenueThisMonth || 0), 0).toFixed(0)}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-green-50 dark:bg-green-900/30 flex items-center justify-center">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-2xl">payments</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Filter:</span>
                    <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                        <button onclick="state.groomerFilter = 'all'; render();" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${state.groomerFilter === 'all' ? 'bg-white dark:bg-surface-dark text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}">
                            All (${state.groomers.length})
                        </button>
                        <button onclick="state.groomerFilter = 'active'; render();" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${state.groomerFilter === 'active' ? 'bg-white dark:bg-surface-dark text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}">
                            Active (${activeGroomers.length})
                        </button>
                        <button onclick="state.groomerFilter = 'inactive'; render();" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${state.groomerFilter === 'inactive' ? 'bg-white dark:bg-surface-dark text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}">
                            Inactive (${inactiveGroomers.length})
                        </button>
                    </div>
                </div>

                <!-- Groomers Grid -->
                ${displayGroomers.length > 0 ? `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${displayGroomers.map(g => renderGroomerCard(g)).join('')}
                </div>
                ` : `
                <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-2xl p-12 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                        <span class="material-symbols-outlined text-3xl text-slate-400">content_cut</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">No ${state.groomerFilter === 'inactive' ? 'Inactive ' : ''}Groomers</h3>
                    <p class="text-slate-500 dark:text-slate-400 mb-6">${state.groomerFilter === 'inactive' ? 'All your groomers are currently active.' : 'Add your first groomer to start managing your team.'}</p>
                    ${state.groomerFilter !== 'inactive' ? `
                    <button onclick="openAddGroomerModal()" class="inline-flex items-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold transition-all">
                        <span class="material-symbols-outlined">person_add</span>Add First Groomer
                    </button>` : ''}
                </div>
                `}
                `;
            }

            if (state.currentTab === 'loyalty') {
                // Store rewards for editing
                data.rewards.forEach((r, i) => { state.editItems['reward_' + i] = {...r}; });
                const pending = state.pendingRedemptions || [];
                const loyaltySubTab = state.loyaltySubTab || 'rewards';
                
                return `
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-6">
                    <div><h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">Loyalty Program</h1><p class="text-slate-500 dark:text-slate-400 mt-1">Manage rewards and customer redemptions</p></div>
                </div>
                
                <!-- Sub-tabs -->
                <div class="flex items-center gap-2 mb-6 border-b border-slate-200 dark:border-slate-700">
                    <button onclick="state.loyaltySubTab = 'rewards'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all ${loyaltySubTab === 'rewards' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">redeem</span>Rewards</span>
                    </button>
                    <button onclick="state.loyaltySubTab = 'redemptions'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all ${loyaltySubTab === 'redemptions' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'} flex items-center gap-2">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">pending_actions</span>Redemptions</span>
                        ${pending.length > 0 ? `<span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-bold rounded-full">${pending.length}</span>` : ''}
                    </button>
                    <button onclick="state.loyaltySubTab = 'customers'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all ${loyaltySubTab === 'customers' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">group</span>Customers</span>
                    </button>
                </div>
                
                ${loyaltySubTab === 'rewards' ? `
                    <!-- Rewards Management -->
                    <div class="flex justify-end mb-6">
                        <button onclick="openEditModal('reward', {})" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-primary hover:bg-sky-600 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary/25 text-sm"><span class="material-symbols-outlined text-lg">add</span>Add Reward</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        ${data.rewards.map((r, i) => `
                        <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark rounded-2xl p-6 shadow-sm hover:shadow-lg hover:border-primary/30 transition-all">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 rounded-xl bg-rose-50 dark:bg-rose-900/30 flex items-center justify-center"><span class="material-symbols-outlined text-rose-500 text-2xl">redeem</span></div>
                                <div class="flex gap-1"><button onclick="openEditModal('reward', ${i})" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button><button onclick="confirmDeleteReward('${r.id}', '${(r.name || '').replace(/'/g, "\\'")}')" class="p-2 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg text-slate-400 hover:text-red-600"><span class="material-symbols-outlined text-lg">delete</span></button></div>
                            </div>
                            <h4 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${r.name}</h4>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${r.description || ''}</p>
                            <div class="flex items-center justify-between pt-4 border-t border-slate-100 dark:border-slate-700"><span class="text-2xl font-bold text-primary">${r.points_required || r.points}</span><span class="text-sm text-slate-500 dark:text-slate-400">points required</span></div>
                        </div>`).join('')}
                    </div>
                ` : loyaltySubTab === 'redemptions' ? `
                    <!-- Redemptions Queue -->
                    ${pending.length > 0 ? `
                        <div class="space-y-4">
                            ${pending.map(r => `
                                <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4">
                                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 rounded-xl bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center">
                                                <span class="material-symbols-outlined text-rose-500">redeem</span>
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-900 dark:text-white">${r.reward_name || r.rewardName || 'Reward'}</p>
                                                <p class="text-sm text-slate-500 dark:text-slate-400">${r.customer_name || r.customerName || 'Customer'}</p>
                                                <p class="text-xs text-slate-400">${r.points_cost || r.pointsRequired || 0} pts â€¢ ${new Date(r.redeemed_at || r.created_at).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="fulfillRedemption('${r.id}')" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg text-sm">Fulfill</button>
                                            <button onclick="cancelRedemption('${r.id}', prompt('Reason for cancellation:'))" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold rounded-lg text-sm">Cancel & Refund</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-12 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-4">celebration</span>
                            <p class="text-slate-500 dark:text-slate-400">No pending redemptions</p>
                            <p class="text-sm text-slate-400 mt-1">All caught up!</p>
                        </div>
                    `}
                ` : `
                    <!-- Customers with Points -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark overflow-hidden">
                        <!-- Mobile Cards -->
                        <div class="md:hidden divide-y divide-slate-100 dark:divide-slate-700">
                            ${state.allCustomers
                                .filter(c => c.role === 'customer')
                                .sort((a, b) => (b.loyalty_points || 0) - (a.loyalty_points || 0))
                                .slice(0, 20)
                                .map(c => {
                                    const points = c.loyalty_points || 0;
                                    const tier = points >= 500 ? 'Gold' : points >= 200 ? 'Silver' : 'Bronze';
                                    const tierColor = points >= 500 ? 'amber' : points >= 200 ? 'slate' : 'orange';
                                    return `
                                    <div class="p-4">
                                        <div class="flex items-center justify-between gap-3">
                                            <div class="flex items-center gap-3 min-w-0">
                                                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold flex-shrink-0">${(c.full_name || 'C').charAt(0)}</div>
                                                <div class="min-w-0">
                                                    <p class="font-bold text-slate-900 dark:text-white truncate">${c.full_name || 'Customer'}</p>
                                                    <p class="text-xs text-slate-500 truncate">${c.email || c.phone || ''}</p>
                                                </div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <p class="text-xl font-bold text-primary">${points}</p>
                                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-${tierColor}-100 text-${tierColor}-700">${tier}</span>
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('') || '<div class="p-8 text-center text-slate-400">No customers yet</div>'}
                        </div>
                        
                        <!-- Desktop Table -->
                        <table class="hidden md:table w-full">
                            <thead class="bg-slate-50 dark:bg-slate-800">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Customer</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Points</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Tier</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Redemptions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${state.allCustomers
                                    .filter(c => c.role === 'customer')
                                    .sort((a, b) => (b.loyalty_points || 0) - (a.loyalty_points || 0))
                                    .slice(0, 20)
                                    .map(c => {
                                        const points = c.loyalty_points || 0;
                                        const tier = points >= 500 ? 'Gold' : points >= 200 ? 'Silver' : 'Bronze';
                                        const tierColor = points >= 500 ? 'amber' : points >= 200 ? 'slate' : 'orange';
                                        return `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">${(c.full_name || 'C').charAt(0)}</div>
                                                    <div class="min-w-0">
                                                        <p class="font-bold text-slate-900 dark:text-white truncate">${c.full_name || 'Customer'}</p>
                                                        <p class="text-xs text-slate-500 truncate">${c.email || c.phone || ''}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4"><span class="text-lg font-bold text-primary">${points}</span></td>
                                            <td class="px-6 py-4"><span class="px-2.5 py-1 rounded-full text-xs font-bold bg-${tierColor}-100 text-${tierColor}-700">${tier}</span></td>
                                            <td class="px-6 py-4 text-slate-500">${c.total_redemptions || 0}</td>
                                        </tr>`;
                                    }).join('') || '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No customers yet</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `}`;
            }

            // Redemptions Tab - redirect to loyalty (for backwards compatibility)
            if (state.currentTab === 'redemptions') {
                state.currentTab = 'loyalty';
                state.loyaltySubTab = 'redemptions';
                return renderAdminContent();
            }

            // Old rewards tab - redirect to loyalty (for backwards compatibility)  
            if (state.currentTab === 'rewards') {
                state.currentTab = 'loyalty';
                state.loyaltySubTab = 'rewards';
                return renderAdminContent();
            }

            // Messages Tab - Admin-Groomer Communication
            if (state.currentTab === 'messages') {
                return renderAdminMessagesTab();
            }

            // Combined Services/Products Tab
            if (state.currentTab === 'services') {
                const servicesSubTab = state.adminServicesSubTab || 'products';
                const activeProducts = data.products.filter(p => !p.inactive);
                const inactiveProducts = data.products.filter(p => p.inactive);
                
                return `
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-6">
                    <div class="flex items-center gap-4">
                        <img src="${LOGO_ACADEMY}" alt="Dogfathersplus Academy" class="h-14 w-auto"/>
                        <div>
                            <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">Services & Products</h1>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">Manage products, ride-alongs, and education courses</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-tabs -->
                <div class="flex items-center gap-2 mb-6 border-b border-slate-200 dark:border-slate-700 overflow-x-auto">
                    <button onclick="state.adminServicesSubTab = 'grooming'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all whitespace-nowrap ${servicesSubTab === 'grooming' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">content_cut</span>Grooming Services</span>
                    </button>
                    <button onclick="state.adminServicesSubTab = 'products'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all whitespace-nowrap ${servicesSubTab === 'products' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">inventory_2</span>Products</span>
                    </button>
                    <button onclick="state.adminServicesSubTab = 'ridealongs'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all whitespace-nowrap ${servicesSubTab === 'ridealongs' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">directions_car</span>Ride-Alongs</span>
                    </button>
                    <button onclick="state.adminServicesSubTab = 'education'; render();" class="px-4 py-3 text-sm font-bold border-b-2 transition-all whitespace-nowrap ${servicesSubTab === 'education' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700'}">
                        <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">school</span>Education</span>
                    </button>
                </div>
                
                ${servicesSubTab === 'grooming' ? `
                    <!-- Grooming Services Content -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Grooming Services</h2>
                            <p class="text-sm text-slate-500">Manage the services customers can book</p>
                        </div>
                        <button onclick="openGroomingServiceModal()" class="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                            <span class="material-symbols-outlined text-lg">add</span>Add Service
                        </button>
                    </div>
                    
                    <!-- Services Table -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        <th class="text-left px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Service</th>
                                        <th class="text-left px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Price</th>
                                        <th class="text-left px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Duration</th>
                                        <th class="text-center px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                                        <th class="text-center px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                    ${state.services && state.services.length > 0 ? state.services.map((service, idx) => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                                                        <span class="material-symbols-outlined text-primary">content_cut</span>
                                                    </div>
                                                    <div>
                                                        <p class="font-bold text-slate-900 dark:text-white">${service.name}</p>
                                                        <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-1">${service.description || 'No description'}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="text-lg font-bold text-slate-900 dark:text-white">$${(service.base_price || 0).toFixed(2)}</span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="text-slate-600 dark:text-slate-300">${service.duration_minutes || 60} min</span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <button onclick="toggleGroomingServiceStatus('${service.id}', ${service.is_active !== false})" class="px-3 py-1 rounded-full text-xs font-bold ${service.is_active !== false ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400'}">
                                                    ${service.is_active !== false ? 'Active' : 'Inactive'}
                                                </button>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center justify-center gap-1">
                                                    <button onclick="openGroomingServiceModal('${service.id}')" class="p-2 text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Edit">
                                                        <span class="material-symbols-outlined text-lg">edit</span>
                                                    </button>
                                                    <button onclick="confirmDeleteGroomingService('${service.id}', '${(service.name || '').replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" title="Delete">
                                                        <span class="material-symbols-outlined text-lg">delete</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="5" class="px-6 py-12 text-center">
                                                <div class="flex flex-col items-center">
                                                    <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4">
                                                        <span class="material-symbols-outlined text-3xl text-slate-400">content_cut</span>
                                                    </div>
                                                    <p class="text-slate-500 dark:text-slate-400 font-medium mb-2">No grooming services yet</p>
                                                    <p class="text-sm text-slate-400 mb-4">Add your first service to start accepting bookings</p>
                                                    <button onclick="openGroomingServiceModal()" class="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                                        <span class="material-symbols-outlined text-lg">add</span>Add First Service
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4">
                            <p class="text-sm text-slate-500 dark:text-slate-400">Total Services</p>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">${state.services?.length || 0}</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4">
                            <p class="text-sm text-slate-500 dark:text-slate-400">Active</p>
                            <p class="text-2xl font-bold text-green-600">${state.services?.filter(s => s.is_active !== false).length || 0}</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4">
                            <p class="text-sm text-slate-500 dark:text-slate-400">Avg Price</p>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">$${state.services?.length > 0 ? (state.services.reduce((sum, s) => sum + (s.base_price || 0), 0) / state.services.length).toFixed(0) : '0'}</p>
                        </div>
                        <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark p-4">
                            <p class="text-sm text-slate-500 dark:text-slate-400">Avg Duration</p>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">${state.services?.length > 0 ? Math.round(state.services.reduce((sum, s) => sum + (s.duration_minutes || 60), 0) / state.services.length) : '0'} min</p>
                        </div>
                    </div>
                ` : servicesSubTab === 'products' ? `
                    <!-- Products Content -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-2">
                            <button onclick="state.productFilter = 'all'; render();" class="px-4 py-2 rounded-lg ${(state.productFilter || 'all') === 'all' ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400'} text-sm font-bold">All (${data.products.length})</button>
                            <button onclick="state.productFilter = 'active'; render();" class="px-4 py-2 rounded-lg ${state.productFilter === 'active' ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400'} text-sm font-medium">Active (${activeProducts.length})</button>
                            <button onclick="state.productFilter = 'inactive'; render();" class="px-4 py-2 rounded-lg ${state.productFilter === 'inactive' ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400'} text-sm font-medium">Inactive (${inactiveProducts.length})</button>
                        </div>
                        <button onclick="openEditModal('product', {})" class="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                            <span class="material-symbols-outlined text-lg">add</span>Add Product
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${(state.productFilter === 'active' ? activeProducts : state.productFilter === 'inactive' ? inactiveProducts : data.products).map((p, i) => {
                            const originalIndex = data.products.findIndex(prod => prod.id === p.id);
                            state.editItems['product_' + originalIndex] = { id: p.id, name: p.name, description: p.description || '', price: p.price, category: p.category || 'grooming', affiliate_url: p.affiliate_url || '', image_url: p.image_url || '', is_active: p.is_active };
                            return `
                            <div class="group bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark overflow-hidden hover:shadow-xl transition-all flex flex-col h-full">
                                <div class="relative aspect-[4/3] overflow-hidden bg-slate-100 dark:bg-slate-800">
                                    <div class="w-full h-full bg-cover bg-center group-hover:scale-105 transition-all duration-500" style="background-image: url('${p.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}')"></div>
                                    <div class="absolute top-3 right-3"><span class="px-2 py-1 ${p.is_active !== false ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'} text-xs font-bold rounded-md">${p.is_active !== false ? 'Active' : 'Inactive'}</span></div>
                                </div>
                                <div class="p-4 flex flex-col flex-1">
                                    <h3 class="text-slate-900 dark:text-white font-bold text-lg leading-tight mb-1 line-clamp-1">${p.name || 'Unnamed Product'}</h3>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-3 line-clamp-2">${p.description || 'No description'}</p>
                                    <div class="mt-auto pt-4 border-t border-slate-100 dark:border-slate-700 flex items-center justify-between">
                                        <span class="text-slate-900 dark:text-white font-bold">$${(p.price || 0).toFixed(2)}</span>
                                        <div class="flex gap-1">
                                            <button onclick="openEditModal('product', ${originalIndex})" class="p-2 text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"><span class="material-symbols-outlined text-lg">edit</span></button>
                                            <button onclick="confirmDeleteProduct('${p.id}', '${(p.name || '').replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-red-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"><span class="material-symbols-outlined text-lg">delete</span></button>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                        <button onclick="openEditModal('product', {})" class="group flex flex-col h-full min-h-[300px] border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-primary rounded-xl items-center justify-center p-6 text-center transition-all bg-slate-50/50 dark:bg-slate-800/50 hover:bg-primary/5">
                            <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 group-hover:bg-primary group-hover:text-white text-slate-400 flex items-center justify-center mb-4 transition-colors"><span class="material-symbols-outlined text-3xl">add</span></div>
                            <h3 class="text-slate-900 dark:text-white font-bold text-lg">Add New Product</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-2">Link a product from Amazon, Chewy, etc.</p>
                        </button>
                    </div>
                ` : servicesSubTab === 'ridealongs' ? `
                    <!-- Ride-Alongs Content -->
                    <div class="flex justify-end mb-6">
                        <button onclick="openEditModal('ridealong', {})" class="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                            <span class="material-symbols-outlined text-lg">add</span>Add Package
                        </button>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        ${data.rideAlongs.map((pkg, i) => {
                            state.editItems['ridealong_' + i] = {...pkg};
                            const features = Array.isArray(pkg.features) ? pkg.features : [];
                            return `
                            <div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border ${pkg.popular || pkg.is_popular ? 'border-primary/30 ring-2 ring-primary/20' : 'border-slate-200 dark:border-border-dark'} flex flex-col overflow-hidden h-full">
                                <div class="p-6 flex flex-col gap-4 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="px-2.5 py-1 rounded-full ${pkg.popular || pkg.is_popular ? 'bg-primary text-white' : 'bg-primary/10 text-primary'}"><p class="text-xs font-bold uppercase">${pkg.popular || pkg.is_popular ? 'Most Popular' : 'Package'}</p></div>
                                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-md">Active</span>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-black text-slate-900 dark:text-white">${pkg.name}</h3>
                                        <p class="text-3xl font-bold text-primary mt-2">$${pkg.price}</p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">${pkg.duration || ''}</p>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">${pkg.description || ''}</p>
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Included Features</p>
                                        <div class="flex flex-col gap-2">
                                            ${features.map(f => `<div class="flex gap-2 items-center"><span class="material-symbols-outlined text-primary text-lg">check_circle</span><span class="text-sm text-slate-700 dark:text-slate-300">${f}</span></div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                    <button onclick="confirmDeleteRideAlong('${pkg.id}', '${(pkg.name || '').replace(/'/g, "\\'")}')" class="text-xs font-bold text-red-500 hover:text-red-600 flex items-center gap-1"><span class="material-symbols-outlined text-sm">delete</span>Delete</button>
                                    <button onclick="openEditModal('ridealong', ${i})" class="text-xs font-bold text-primary hover:text-sky-600 flex items-center gap-1"><span class="material-symbols-outlined text-sm">edit</span>Edit</button>
                                </div>
                            </div>`;
                        }).join('')}
                        <button onclick="openEditModal('ridealong', {})" class="group flex flex-col h-full min-h-[400px] border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-primary rounded-xl items-center justify-center p-6 text-center transition-all bg-slate-50/50 dark:bg-slate-800/50 hover:bg-primary/5">
                            <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 group-hover:bg-primary group-hover:text-white text-slate-400 flex items-center justify-center mb-4 transition-colors"><span class="material-symbols-outlined text-3xl">add</span></div>
                            <h3 class="text-slate-900 dark:text-white font-bold text-lg">Add New Package</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-2">Create a new ride-along mentorship package.</p>
                        </button>
                    </div>
                ` : `
                    <!-- Education Content -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-border-dark shadow-sm p-6 md:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2 text-slate-900 dark:text-white">
                                <span class="material-symbols-outlined text-primary">school</span>
                                <h3 class="text-xl font-bold">Skool Community</h3>
                            </div>
                            <span class="px-2.5 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">Published</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Course Title</label>
                                <input class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white h-12 px-4" value="Dogfathersplus Academy"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Instructor</label>
                                <input class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white h-12 px-4" value="Rosa & Gerardo"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Price</label>
                                <input class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white h-12 px-4" type="number" value="49.00"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Skool Link</label>
                                <input class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white h-12 px-4" value="https://www.skool.com/dogfathersplus"/>
                            </div>
                        </div>
                        <div class="mt-6 flex items-center gap-4">
                            <a href="https://www.skool.com/dogfathersplus" target="_blank" class="flex items-center gap-2 text-primary hover:text-sky-600 font-bold text-sm">
                                <span class="material-symbols-outlined text-lg">open_in_new</span>Open Skool Community
                            </a>
                            <button onclick="saveEducationSettings()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-sky-600 text-white font-bold text-sm rounded-lg">
                                <span class="material-symbols-outlined text-lg">save</span>Save Changes
                            </button>
                        </div>
                    </div>
                `}`;
            }

            // Backwards compatibility redirects for old tab names
            if (state.currentTab === 'products') {
                state.currentTab = 'services';
                state.adminServicesSubTab = 'products';
                return renderAdminContent();
            }
            if (state.currentTab === 'ridealongs') {
                state.currentTab = 'services';
                state.adminServicesSubTab = 'ridealongs';
                return renderAdminContent();
            }
            if (state.currentTab === 'education') {
                state.currentTab = 'services';
                state.adminServicesSubTab = 'education';
                return renderAdminContent();
            }

            return '';
        }
        
        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        
        // Load notifications for current user
        async function loadNotifications() {
            if (!state.currentUser) return;
            
            try {
                const { data: notifications, error } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) {
                    console.log('Notifications table may not exist yet:', error.message);
                    state.notifications = [];
                    state.unreadNotifications = 0;
                    return;
                }
                
                state.notifications = notifications || [];
                state.unreadNotifications = notifications?.filter(n => !n.is_read).length || 0;
            } catch (err) {
                console.error('Error loading notifications:', err);
                state.notifications = [];
                state.unreadNotifications = 0;
            }
        }
        
        // Toggle notifications panel
        function toggleNotifications() {
            state.showNotifications = !state.showNotifications;
            render();
        }
        
        // Close notifications panel
        function closeNotifications() {
            state.showNotifications = false;
            render();
        }
        
        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const { error } = await supabaseClient
                    .rpc('mark_notification_read', {
                        p_notification_id: notificationId,
                        p_user_id: state.currentUser.id
                    });
                
                if (error) {
                    // Fallback to direct update
                    await supabaseClient
                        .from('notifications')
                        .update({ is_read: true, read_at: new Date().toISOString() })
                        .eq('id', notificationId);
                }
                
                // Update local state
                const notification = state.notifications.find(n => n.id === notificationId);
                if (notification && !notification.is_read) {
                    notification.is_read = true;
                    notification.read_at = new Date().toISOString();
                    state.unreadNotifications = Math.max(0, state.unreadNotifications - 1);
                    render();
                }
            } catch (err) {
                console.error('Error marking notification read:', err);
            }
        }
        
        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const { error } = await supabaseClient
                    .rpc('mark_all_notifications_read', {
                        p_user_id: state.currentUser.id
                    });
                
                if (error) {
                    // Fallback to direct update
                    await supabaseClient
                        .from('notifications')
                        .update({ is_read: true, read_at: new Date().toISOString() })
                        .eq('user_id', state.currentUser.id)
                        .eq('is_read', false);
                }
                
                // Update local state
                state.notifications.forEach(n => {
                    n.is_read = true;
                    n.read_at = new Date().toISOString();
                });
                state.unreadNotifications = 0;
                render();
                showToast('All notifications marked as read', 'success');
            } catch (err) {
                console.error('Error marking all notifications read:', err);
            }
        }
        
        // Create notification (called after actions)
        async function createNotification(userId, title, message, type, referenceType = null, referenceId = null) {
            try {
                const { error } = await supabaseClient
                    .rpc('create_notification', {
                        p_user_id: userId,
                        p_title: title,
                        p_message: message,
                        p_type: type,
                        p_reference_type: referenceType,
                        p_reference_id: referenceId
                    });
                
                if (error) {
                    // Fallback to direct insert
                    await supabaseClient
                        .from('notifications')
                        .insert({
                            user_id: userId,
                            title: title,
                            message: message,
                            type: type,
                            reference_type: referenceType,
                            reference_id: referenceId
                        });
                }
            } catch (err) {
                console.error('Error creating notification:', err);
            }
        }
        
        // Notify all admins
        async function notifyAllAdmins(title, message, type, referenceType = null, referenceId = null) {
            try {
                // Get all admin IDs
                const { data: admins } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('role', 'admin')
                    .eq('is_active', true);
                
                if (admins) {
                    for (const admin of admins) {
                        await createNotification(admin.id, title, message, type, referenceType, referenceId);
                    }
                }
            } catch (err) {
                console.error('Error notifying admins:', err);
            }
        }
        
        // Render notifications panel
        function renderNotificationsPanel() {
            const notifications = state.notifications || [];
            const notificationIcons = {
                booking_created: 'calendar_add_on',
                booking_confirmed: 'event_available',
                booking_cancelled: 'event_busy',
                appointment_started: 'play_circle',
                appointment_completed: 'check_circle',
                groomer_assigned: 'person_add',
                points_earned: 'stars',
                reward_redeemed: 'redeem',
                reward_fulfilled: 'celebration',
                time_off_requested: 'event_note',
                time_off_approved: 'thumb_up',
                time_off_denied: 'thumb_down',
                system: 'info'
            };
            
            const notificationColors = {
                booking_created: 'text-blue-500 bg-blue-100 dark:bg-blue-900/30',
                booking_confirmed: 'text-green-500 bg-green-100 dark:bg-green-900/30',
                booking_cancelled: 'text-red-500 bg-red-100 dark:bg-red-900/30',
                appointment_started: 'text-purple-500 bg-purple-100 dark:bg-purple-900/30',
                appointment_completed: 'text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30',
                groomer_assigned: 'text-blue-500 bg-blue-100 dark:bg-blue-900/30',
                points_earned: 'text-amber-500 bg-amber-100 dark:bg-amber-900/30',
                reward_redeemed: 'text-pink-500 bg-pink-100 dark:bg-pink-900/30',
                reward_fulfilled: 'text-green-500 bg-green-100 dark:bg-green-900/30',
                time_off_approved: 'text-green-500 bg-green-100 dark:bg-green-900/30',
                time_off_denied: 'text-red-500 bg-red-100 dark:bg-red-900/30',
                system: 'text-slate-500 bg-slate-100 dark:bg-slate-800'
            };
            
            const formatTime = (dateStr) => {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            };
            
            return `
                <div class="fixed inset-0 z-[100] bg-black/50" onclick="closeNotifications()">
                    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-white dark:bg-surface-dark shadow-2xl overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div class="p-4 border-b border-slate-200 dark:border-border-dark flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-primary">notifications</span>
                                <h2 class="text-lg font-bold dark:text-white">Notifications</h2>
                                ${state.unreadNotifications > 0 ? `
                                    <span class="px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full">${state.unreadNotifications}</span>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.unreadNotifications > 0 ? `
                                    <button onclick="markAllNotificationsRead()" class="text-sm text-primary hover:underline">
                                        Mark all read
                                    </button>
                                ` : ''}
                                <button onclick="closeNotifications()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Notifications List -->
                        <div class="flex-1 overflow-y-auto">
                            ${notifications.length > 0 ? notifications.map(n => `
                                <div class="p-4 border-b border-slate-100 dark:border-border-dark hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer ${n.is_read ? 'opacity-70' : ''}"
                                     onclick="markNotificationRead('${n.id}')">
                                    <div class="flex gap-3">
                                        <div class="w-10 h-10 rounded-full ${notificationColors[n.type] || notificationColors.system} flex items-center justify-center flex-shrink-0">
                                            <span class="material-symbols-outlined text-lg">${notificationIcons[n.type] || 'info'}</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between gap-2">
                                                <p class="font-semibold text-slate-900 dark:text-white text-sm">${n.title}</p>
                                                ${!n.is_read ? '<span class="w-2 h-2 bg-primary rounded-full flex-shrink-0"></span>' : ''}
                                            </div>
                                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-0.5">${n.message}</p>
                                            <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${formatTime(n.created_at)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="p-8 text-center">
                                    <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-3">notifications_off</span>
                                    <p class="text-slate-500 dark:text-slate-400">No notifications yet</p>
                                    <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">You'll see updates about your appointments here</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // =============================================
        // GROOMER AVAILABILITY SYSTEM
        // =============================================
        
        // Load groomer's availability schedule
        async function loadGroomerAvailability(groomerId) {
            try {
                const { data: availability, error } = await supabaseClient
                    .from('groomer_availability')
                    .select('*')
                    .eq('groomer_id', groomerId)
                    .order('day_of_week');
                
                if (!error) {
                    state.groomerAvailability = availability || [];
                }
                
                // Load time off requests
                const { data: timeOff } = await supabaseClient
                    .from('groomer_time_off')
                    .select('*')
                    .eq('groomer_id', groomerId)
                    .order('start_date', { ascending: false });
                
                state.groomerTimeOffRequests = timeOff || [];
            } catch (err) {
                console.error('Error loading groomer availability:', err);
            }
        }
        
        // Request time off (Groomer)
        async function requestTimeOff(startDate, endDate, reason) {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .rpc('request_time_off', {
                        p_groomer_id: state.currentUser.id,
                        p_start_date: startDate,
                        p_end_date: endDate,
                        p_reason: reason
                    });
                
                hideLoading();
                
                if (error) throw error;
                
                if (!data.success) {
                    showToast(data.error, 'error');
                    return;
                }
                
                if (data.warning) {
                    showToast(data.warning, 'warning');
                }
                
                showToast('Time off request submitted!', 'success');
                state.showTimeOffModal = false;
                await loadGroomerAvailability(state.currentUser.id);
                render();
            } catch (err) {
                hideLoading();
                showToast('Failed to submit request: ' + err.message, 'error');
            }
        }
        
        // Review time off request (Admin)
        async function reviewTimeOffRequest(requestId, approved, notes = null) {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .rpc('review_time_off_request', {
                        p_request_id: requestId,
                        p_admin_id: state.currentUser.id,
                        p_approved: approved,
                        p_admin_notes: notes
                    });
                
                hideLoading();
                
                if (error) throw error;
                
                if (!data.success) {
                    showToast(data.error, 'error');
                    return;
                }
                
                showToast(`Time off ${approved ? 'approved' : 'denied'}`, 'success');
                await loadPendingTimeOffRequests();
                render();
            } catch (err) {
                hideLoading();
                showToast('Failed to review request: ' + err.message, 'error');
            }
        }
        
        // Load pending time off requests (Admin)
        async function loadPendingTimeOffRequests() {
            try {
                const { data, error } = await supabaseClient
                    .from('groomer_time_off')
                    .select(`
                        *,
                        groomer:groomer_id(name, email)
                    `)
                    .eq('status', 'pending')
                    .order('requested_at');
                
                if (!error) {
                    state.pendingTimeOffRequests = data || [];
                }
            } catch (err) {
                console.error('Error loading time off requests:', err);
            }
        }
        
        // Check groomer capacity before assignment
        async function checkGroomerCapacity(groomerId, date) {
            try {
                const { data, error } = await supabaseClient
                    .rpc('can_groomer_accept_appointment', {
                        p_groomer_id: groomerId,
                        p_date: date
                    });
                
                if (error) {
                    console.log('Capacity check function not available:', error);
                    return { can_accept: true };
                }
                
                return data;
            } catch (err) {
                console.error('Error checking capacity:', err);
                return { can_accept: true };
            }
        }
        
        // =============================================
        // REDEMPTION FULFILLMENT SYSTEM
        // =============================================
        
        // Load pending redemptions (Admin)
        async function loadPendingRedemptions() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_pending_redemptions');
                
                if (error) {
                    // Fallback query
                    const { data: redemptions } = await supabaseClient
                        .from('reward_redemptions')
                        .select(`
                            *,
                            customer:customer_id(name, email, phone),
                            reward:reward_id(name, type, points_cost)
                        `)
                        .in('status', ['pending', 'processing'])
                        .order('redeemed_at');
                    
                    state.pendingRedemptions = redemptions || [];
                } else {
                    state.pendingRedemptions = data || [];
                }
            } catch (err) {
                console.error('Error loading pending redemptions:', err);
            }
        }
        
        // Fulfill redemption (Admin)
        async function fulfillRedemption(redemptionId, notes = null) {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .rpc('fulfill_redemption', {
                        p_redemption_id: redemptionId,
                        p_admin_id: state.currentUser.id,
                        p_notes: notes
                    });
                
                if (error) {
                    // Fallback to direct update
                    console.log('fulfill_redemption RPC not available, using direct update');
                    const { error: updateError } = await supabaseClient
                        .from('reward_redemptions')
                        .update({
                            status: 'fulfilled',
                            fulfilled_at: new Date().toISOString(),
                            fulfilled_by: state.currentUser.id,
                            notes: notes
                        })
                        .eq('id', redemptionId);
                    
                    hideLoading();
                    
                    if (updateError) {
                        showToast('Failed to fulfill: ' + updateError.message, 'error');
                        return;
                    }
                    
                    showToast('Redemption fulfilled!', 'success');
                    state.showRedemptionModal = null;
                    await loadPendingRedemptions();
                    render();
                    return;
                }
                
                hideLoading();
                
                if (!data.success) {
                    showToast(data.error, 'error');
                    return;
                }
                
                showToast('Redemption fulfilled! Customer notified.', 'success');
                state.showRedemptionModal = null;
                await loadPendingRedemptions();
                render();
            } catch (err) {
                hideLoading();
                showToast('Failed to fulfill: ' + err.message, 'error');
            }
        }
        
        // Cancel redemption with refund (Admin)
        async function cancelRedemption(redemptionId, reason) {
            if (!reason || reason.trim() === '') {
                showToast('Please provide a reason for cancellation', 'error');
                return;
            }
            
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .rpc('cancel_redemption', {
                        p_redemption_id: redemptionId,
                        p_admin_id: state.currentUser.id,
                        p_reason: reason
                    });
                
                if (error) {
                    // Fallback to direct update with manual refund
                    console.log('cancel_redemption RPC not available, using direct update');
                    
                    // Get redemption details first
                    const { data: redemption } = await supabaseClient
                        .from('reward_redemptions')
                        .select('*, reward:reward_id(points_cost), customer_id')
                        .eq('id', redemptionId)
                        .single();
                    
                    if (redemption) {
                        // Update redemption status
                        await supabaseClient
                            .from('reward_redemptions')
                            .update({
                                status: 'cancelled',
                                cancelled_at: new Date().toISOString(),
                                cancelled_by: state.currentUser.id,
                                cancellation_reason: reason
                            })
                            .eq('id', redemptionId);
                        
                        // Refund points to customer
                        const pointsToRefund = redemption.reward?.points_cost || 0;
                        if (pointsToRefund > 0 && redemption.customer_id) {
                            const { data: customer } = await supabaseClient
                                .from('profiles')
                                .select('loyalty_points')
                                .eq('id', redemption.customer_id)
                                .single();
                            
                            if (customer) {
                                await supabaseClient
                                    .from('profiles')
                                    .update({ loyalty_points: (customer.loyalty_points || 0) + pointsToRefund })
                                    .eq('id', redemption.customer_id);
                            }
                        }
                        
                        hideLoading();
                        showToast(`Redemption cancelled. ${pointsToRefund} points refunded.`, 'success');
                        state.showRedemptionModal = null;
                        await loadPendingRedemptions();
                        render();
                        return;
                    }
                    
                    hideLoading();
                    showToast('Failed to cancel redemption', 'error');
                    return;
                }
                
                hideLoading();
                
                if (!data.success) {
                    showToast(data.error, 'error');
                    return;
                }
                
                showToast(`Redemption cancelled. ${data.points_refunded} points refunded.`, 'success');
                state.showRedemptionModal = null;
                await loadPendingRedemptions();
                render();
            } catch (err) {
                hideLoading();
                showToast('Failed to cancel: ' + err.message, 'error');
            }
        }
        
        // Open redemption modal
        function openRedemptionModal(redemption, action) {
            state.showRedemptionModal = { redemption, action };
            render();
        }
        
        // Close redemption modal
        function closeRedemptionModal() {
            state.showRedemptionModal = null;
            render();
        }

        // =============================================
        // ADMIN MESSAGES FUNCTIONS
        // =============================================
        
        function renderAdminMessagesTab() {
            const groomers = state.groomers || [];
            const messages = state.adminMessages || [];
            const activeGroomer = state.adminActiveConversation;
            
            // Group messages by groomer
            const groomerMessages = {};
            groomers.forEach(g => {
                groomerMessages[g.id] = messages.filter(m => 
                    (m.sender_id === g.id && m.to_admin) || 
                    (m.recipient_id === g.id && m.is_admin)
                );
            });
            
            // Also include messages from unknown groomers
            const unknownGroomerIds = [...new Set(messages.filter(m => m.to_admin).map(m => m.sender_id))].filter(id => !groomers.find(g => g.id === id));
            
            return `
            <div class="mb-8">
                <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">Messages</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Communicate with your grooming team</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-280px)]">
                <!-- Conversations List -->
                <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-border-dark flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-800">
                        <h3 class="font-bold dark:text-white">Groomer Conversations</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        ${groomers.filter(g => g.is_active !== false).map(g => {
                            const gMessages = groomerMessages[g.id] || [];
                            const lastMsg = gMessages[gMessages.length - 1];
                            const unread = gMessages.filter(m => !m.is_read && m.to_admin).length;
                            const initials = (g.full_name || 'G').split(' ').map(n => n.charAt(0)).join('').toUpperCase().slice(0, 2);
                            
                            return `
                            <button onclick="openAdminConversation('${g.id}')" class="w-full p-4 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-800 ${activeGroomer === g.id ? 'bg-primary/10' : ''}">
                                <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                                    <span class="text-emerald-600 font-bold">${initials}</span>
                                </div>
                                <div class="flex-1 text-left min-w-0">
                                    <p class="font-bold dark:text-white truncate">${g.full_name || g.name || 'Groomer'}</p>
                                    <p class="text-sm text-slate-500 truncate">${lastMsg ? lastMsg.message?.substring(0, 30) + '...' : 'No messages yet'}</p>
                                </div>
                                ${unread > 0 ? `<span class="w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">${unread}</span>` : ''}
                            </button>`;
                        }).join('')}
                        ${groomers.filter(g => g.is_active !== false).length === 0 ? `
                            <div class="p-8 text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">group</span>
                                <p class="text-slate-500 text-sm">No active groomers</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Message Thread -->
                <div class="lg:col-span-2 bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-border-dark flex flex-col overflow-hidden">
                    ${activeGroomer ? renderAdminMessageThread(activeGroomer, groomerMessages[activeGroomer] || []) : `
                        <div class="flex-1 flex items-center justify-center">
                            <div class="text-center">
                                <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">forum</span>
                                <p class="text-slate-500">Select a groomer to start messaging</p>
                            </div>
                        </div>
                    `}
                </div>
            </div>`;
        }
        
        function renderAdminMessageThread(groomerId, messages) {
            const groomer = state.groomers.find(g => g.id === groomerId);
            const groomerName = groomer?.full_name || groomer?.name || 'Groomer';
            const initials = groomerName.split(' ').map(n => n.charAt(0)).join('').toUpperCase().slice(0, 2);
            
            return `
                <!-- Header -->
                <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                        <span class="text-emerald-600 font-bold text-sm">${initials}</span>
                    </div>
                    <div>
                        <p class="font-bold dark:text-white">${groomerName}</p>
                        <p class="text-xs text-slate-500">${groomer?.phone || 'Groomer'}</p>
                    </div>
                </div>
                
                <!-- Messages -->
                <div id="admin-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    ${messages.length > 0 ? messages.map(m => {
                        const isAdmin = m.is_admin || m.sender_id === state.currentUser?.id;
                        const time = new Date(m.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const date = new Date(m.created_at).toLocaleDateString();
                        return `
                        <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[70%] ${isAdmin ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white'} rounded-2xl px-4 py-3">
                                <p class="text-sm">${m.message}</p>
                                <p class="text-[10px] ${isAdmin ? 'text-primary-200 opacity-70' : 'text-slate-400'} mt-1">${time}</p>
                            </div>
                        </div>`;
                    }).join('') : `
                        <div class="h-full flex items-center justify-center">
                            <div class="text-center">
                                <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">chat</span>
                                <p class="text-slate-500">No messages yet. Say hello!</p>
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- Input -->
                <div class="p-4 border-t border-slate-100 dark:border-slate-800">
                    <form onsubmit="sendAdminMessage(event, '${groomerId}')" class="flex gap-3">
                        <input type="text" id="admin-message-input" placeholder="Type a message..." class="flex-1 h-12 px-4 rounded-xl bg-slate-100 dark:bg-slate-800 border-0 focus:ring-2 focus:ring-primary dark:text-white" autocomplete="off"/>
                        <button type="submit" class="h-12 px-6 bg-primary text-white font-bold rounded-xl hover:bg-sky-600 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </form>
                </div>
            `;
        }
        
        function openAdminConversation(groomerId) {
            state.adminActiveConversation = groomerId;
            loadAdminMessages();
            render();
            // Scroll to bottom
            setTimeout(() => {
                const container = document.getElementById('admin-messages-container');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function loadAdminMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .or('to_admin.eq.true,is_admin.eq.true')
                    .order('created_at', { ascending: true });
                
                if (!error && data) {
                    state.adminMessages = data;
                }
            } catch (err) {
                console.log('Messages table may not exist yet');
                state.adminMessages = [];
            }
        }
        
        async function sendAdminMessage(e, groomerId) {
            e.preventDefault();
            const input = document.getElementById('admin-message-input');
            const message = input?.value?.trim();
            if (!message) return;
            
            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .insert({
                        sender_id: state.currentUser.id,
                        recipient_id: groomerId,
                        message: message,
                        is_admin: true,
                        is_read: false
                    });
                
                if (error) {
                    console.log('Messages table may not exist:', error);
                }
                
                // Add to local state for immediate feedback
                state.adminMessages = state.adminMessages || [];
                state.adminMessages.push({
                    id: Date.now(),
                    sender_id: state.currentUser.id,
                    recipient_id: groomerId,
                    message: message,
                    is_admin: true,
                    created_at: new Date().toISOString()
                });
                
                input.value = '';
                render();
                
                // Scroll to bottom
                setTimeout(() => {
                    const container = document.getElementById('admin-messages-container');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);
            } catch (err) {
                console.error('Error sending message:', err);
                showToast('Failed to send message', 'error');
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icons = { success: 'check_circle', error: 'error', warning: 'warning', info: 'info' };
            const colors = { 
                success: 'bg-green-500', 
                error: 'bg-red-500', 
                warning: 'bg-amber-500', 
                info: 'bg-blue-500' 
            };
            toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white ${colors[type]} toast-enter`;
            toast.innerHTML = `<span class="material-symbols-outlined">${icons[type]}</span><span class="font-medium">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Confirm Dialog System
        function showConfirm(title, message, onConfirm, onCancel = () => {}) {
            const modal = document.getElementById('confirm-modal');
            modal.innerHTML = `
                <div class="fixed inset-0 z-[150] bg-black/50 flex items-center justify-center p-4" onclick="closeConfirm()">
                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-amber-600 dark:text-amber-400 text-2xl">warning</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold dark:text-white">${title}</h3>
                                <p class="text-sm text-text-sub-light dark:text-text-sub-dark">${message}</p>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeConfirm()" class="flex-1 h-11 rounded-lg border border-border-light dark:border-border-dark font-bold hover:bg-background-light dark:hover:bg-background-dark dark:text-white touch-target">Cancel</button>
                            <button onclick="confirmAction()" class="flex-1 h-11 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold touch-target">Delete</button>
                        </div>
                    </div>
                </div>`;
            state.confirmDialog = { onConfirm, onCancel };
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').innerHTML = '';
            if (state.confirmDialog?.onCancel) state.confirmDialog.onCancel();
            state.confirmDialog = null;
        }

        function confirmAction() {
            if (state.confirmDialog?.onConfirm) state.confirmDialog.onConfirm();
            document.getElementById('confirm-modal').innerHTML = '';
            state.confirmDialog = null;
        }

        // Loading State
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Simulate async action with loading
        async function withLoading(action, delay = 800) {
            showLoading();
            await new Promise(resolve => setTimeout(resolve, delay));
            await action();
            hideLoading();
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            render();
            showToast(state.darkMode ? 'Dark mode enabled' : 'Light mode enabled', 'info', 2000);
        }

        // Password Toggle
        function togglePassword() {
            state.showPassword = !state.showPassword;
            render();
        }

        // Remember Me Toggle
        function toggleRememberMe() {
            state.rememberMe = !state.rememberMe;
            localStorage.setItem('rememberMe', state.rememberMe);
        }

        // Booking Handler with Toast
        async function handleBooking(e) { 
            e.preventDefault();
            
            // Get form values using IDs (more reliable than array indices)
            const petId = document.getElementById('booking-pet')?.value;
            const serviceSelect = document.getElementById('booking-service-select');
            const selectedOption = serviceSelect?.selectedOptions[0];
            const serviceId = selectedOption?.value;
            const serviceName = selectedOption?.dataset?.name || 'Full Groom';
            const servicePrice = parseFloat(selectedOption?.dataset?.price) || 85;
            const serviceDuration = parseInt(selectedOption?.dataset?.duration) || 60;
            const date = document.getElementById('booking-date')?.value;
            const time = document.getElementById('booking-time')?.value;
            const address = document.getElementById('booking-address')?.value;
            const notes = document.getElementById('booking-notes')?.value || '';
            
            // Get coordinates from smart booking state (for route optimization)
            const customerCoords = state.customerBookingCoords || null;
            
            // Get pre-selected groomer from smart booking (if available)
            const selectedGroomerId = state.selectedBookingGroomer || null;
            
            // Validate required fields
            if (!petId || petId === '') {
                showToast('Please add a pet first', 'error');
                return;
            }
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }
            
            // Validate date is not in the past (using Pacific time)
            const todayPacific = getTodayPacific(); // YYYY-MM-DD
            if (date < todayPacific) {
                showToast('Cannot book appointments in the past', 'error');
                return;
            }
            
            if (!time || time === '') {
                showToast('Please select a time', 'error');
                return;
            }
            if (!address) {
                showToast('Please enter an address', 'error');
                return;
            }
            
            // Double-check availability before booking (prevent race conditions)
            showLoading();
            try {
                const slots = await getAvailableSlots(date, serviceId);
                // Convert time to 24hr format if needed for comparison
                const time24 = time.includes(':') ? time.slice(0, 5) : time;
                
                if (!slots.includes(time24)) {
                    hideLoading();
                    showToast('Sorry, this time slot is no longer available. Please select another time.', 'error');
                    // Refresh the available slots
                    handleBookingDateChange();
                    return;
                }
            } catch (err) {
                console.error('Availability check failed:', err);
                // Continue anyway if check fails - the slot might still be available
            }
            hideLoading();
            
            console.log('Booking appointment:', { petId, serviceId, serviceName, servicePrice, serviceDuration, date, time, address, notes, customerCoords, selectedGroomerId });
            
            // Create the appointment with coordinates and groomer assignment
            const result = await createAppointment({
                petId,
                serviceId: serviceId !== 'default' ? serviceId : null,  // Don't store invalid IDs
                date,
                time,
                address,
                city: state.currentUser.city || '',
                zip: state.currentUser.zip || '',
                price: servicePrice,
                duration: serviceDuration,
                notes,
                serviceName: serviceName,
                latitude: customerCoords?.latitude || null,
                longitude: customerCoords?.longitude || null,
                groomerId: selectedGroomerId  // Auto-assign groomer from smart booking
            });
            
            if (result) {
                // Reset smart booking state
                state.smartBookingData = null;
                state.selectedBookingDate = null;
                state.selectedBookingTime = null;
                state.selectedBookingGroomer = null;
                state.customerBookingCoords = null;
                closeBookingModal();
            }
        }

        // Delete with Confirmation
        function deleteItem(type, id, name) {
            showConfirm(
                'Confirm Delete',
                `Are you sure you want to delete "${name}"? This action cannot be undone.`,
                async () => {
                    await withLoading(async () => {
                        // Simulate delete
                        showToast(`${name} has been deleted`, 'success');
                    });
                    render();
                }
            );
        }

        function setAuthTab(tab) { state.authTab = tab; state.showPassword = false; render(); }
        function setTab(tab) { state.currentTab = tab; state.showMobileMenu = false; render(); }
        function setStoreCategory(cat) { state.storeCategory = cat; render(); }
        function toggleMobileMenu() { state.showMobileMenu = !state.showMobileMenu; render(); }
        
        // Dashboard view toggle with scroll preservation
        function setDashboardView(view) {
            // Find the scrollable content area
            const scrollContainer = document.querySelector('.overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            // Update state
            state.dashboardScheduleView = view;
            
            // Render
            render();
            
            // Restore scroll position after render
            requestAnimationFrame(() => {
                const newScrollContainer = document.querySelector('.overflow-y-auto');
                if (newScrollContainer) {
                    newScrollContainer.scrollTop = scrollTop;
                }
            });
        }
        
        // Select a date from calendar and switch to day view (preserves scroll)
        function selectDashboardDate(dateStr) {
            const scrollContainer = document.querySelector('.overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            state.dashboardScheduleView = 'day';
            state.adminDashboardSelectedDate = dateStr;
            
            render();
            
            requestAnimationFrame(() => {
                const newScrollContainer = document.querySelector('.overflow-y-auto');
                if (newScrollContainer) {
                    newScrollContainer.scrollTop = scrollTop;
                }
            });
        }
        
        function openBookingModal(options = {}) { 
            state.showBookingModal = true;
            // Store pre-selected options for the modal
            state.bookingPreselect = {
                petId: options.petId || null,
                serviceId: options.serviceId || null,
                serviceName: options.serviceName || null
            };
            render();
            
            // Auto-load smart date picker after modal renders (Recommendation #2)
            setTimeout(() => {
                if (!state.smartBookingData) {
                    loadSmartDatePicker();
                }
            }, 100);
        }
        
        // Open booking modal with a specific pet pre-selected (Recommendation #7)
        function openBookingModalForPet(petId) {
            openBookingModal({ petId });
        }
        
        // Quick rebook from past appointment (Recommendation #8)
        function rebookAppointment(appointmentId) {
            const appointments = state.appointments || [];
            const appt = appointments.find(a => a.id === appointmentId);
            if (appt) {
                openBookingModal({
                    petId: appt.pet_id,
                    serviceId: appt.service_id,
                    serviceName: appt.serviceName || appt.service
                });
            }
        }
        
        function closeBookingModal() { 
            state.showBookingModal = false;
            // Reset smart booking state
            state.smartBookingData = null;
            state.selectedBookingDate = null;
            state.customerBookingCoords = null;
            state.bookingPreselect = null;
            render(); 
        }
        
        function logout() { 
            showConfirm(
                'Sign Out',
                'Are you sure you want to sign out?',
                async () => {
                    await handleSignOut();
                }
            );
        }

        // Handle auth form submission
        function attachEventListeners() {
            // Cancel reason dropdown handler
            const cancelReason = document.getElementById('cancel-reason');
            if (cancelReason) {
                cancelReason.addEventListener('change', function() {
                    const otherDiv = document.getElementById('cancel-other-reason');
                    if (this.value === 'Other') {
                        otherDiv.classList.remove('hidden');
                    } else {
                        otherDiv.classList.add('hidden');
                    }
                });
            }
            
            // Auth form
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    
                    if (state.authTab === 'signup') {
                        const name = document.getElementById('auth-name')?.value || '';
                        const phone = document.getElementById('auth-phone')?.value || '';
                        await handleSignUp(email, password, name, phone);
                    } else {
                        await handleSignIn(email, password);
                    }
                });
            }

            // Admin login form
            const adminLoginForm = document.getElementById('admin-login-form');
            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('admin-email').value;
                    const password = document.getElementById('admin-password').value;
                    await handleAdminLogin(email, password);
                });
            }
            
            // Groomer login form
            const groomerLoginForm = document.getElementById('groomer-login-form');
            if (groomerLoginForm) {
                groomerLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('groomer-email').value;
                    const password = document.getElementById('groomer-password').value;
                    await handleGroomerLogin(email, password);
                });
            }
            
            // Booking form
            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) bookingForm.addEventListener('submit', handleBooking);

            // Onboarding forms
            const onboardingForm1 = document.getElementById('onboarding-form-1');
            if (onboardingForm1) {
                onboardingForm1.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await nextOnboardingStep();
                });
            }

            const onboardingForm2 = document.getElementById('onboarding-form-2');
            if (onboardingForm2) {
                onboardingForm2.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await nextOnboardingStep();
                });
            }

            // Edit forms
            const editPetForm = document.getElementById('edit-pet-form');
            if (editPetForm) editPetForm.addEventListener('submit', saveEditPet);

            const editProfileForm = document.getElementById('edit-profile-form');
            if (editProfileForm) editProfileForm.addEventListener('submit', saveEditProfile);

            const editRewardForm = document.getElementById('edit-reward-form');
            if (editRewardForm) editRewardForm.addEventListener('submit', saveEditReward);

            const editProductForm = document.getElementById('edit-product-form');
            if (editProductForm) editProductForm.addEventListener('submit', saveEditProduct);

            const editAppointmentForm = document.getElementById('edit-appointment-form');
            if (editAppointmentForm) editAppointmentForm.addEventListener('submit', saveEditAppointment);

            const editRideAlongForm = document.getElementById('edit-ridealong-form');
            if (editRideAlongForm) editRideAlongForm.addEventListener('submit', saveEditRideAlong);

            const editCourseForm = document.getElementById('edit-course-form');
            if (editCourseForm) editCourseForm.addEventListener('submit', saveEditCourse);
        }

        // =============================================
        // PWA SERVICE WORKER REGISTRATION
        // =============================================
        
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('ServiceWorker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                if (confirm('A new version is available! Reload to update?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.log('ServiceWorker registration failed:', error);
                }
            });
        }
        
        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button if not already installed
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                state.showInstallPrompt = true;
                render();
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                        showToast('App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                    state.showInstallPrompt = false;
                    render();
                });
            }
        }
        
        // Detect if running as PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }

        // Initialize the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOM is already ready
            initApp();
        }
    </script>
</body>
</html>
